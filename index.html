<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Manutenção de Equipamentos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
        }

        body {
            background-color: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 40px; /* Espaço para o rodapé */
        }

        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.4rem;
            color: white !important;
        }

        .card {
            border-radius: 8px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
            font-weight: bold;
            border-radius: 8px 8px 0 0 !important;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .list-group-item {
            border-left: none;
            border-right: none;
            padding: 15px 20px;
        }

        .status-badge {
            font-size: 0.8em;
            padding: 5px 10px;
            border-radius: 20px;
        }

        .checklist-item {
            margin-bottom: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
        }

        .checklist-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .image-preview {
            max-width: 100%;
            height: auto;
            object-fit: cover;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .image-container {
            display: inline-block;
            margin: 5px;
            position: relative;
        }

        .image-container img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ddd;
            cursor: pointer; /* Para indicar que é clicável */
        }

        .image-container .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.7); /* Vermelho para destaque */
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            padding: 0;
            font-size: 14px;
            line-height: 1;
        }
        .image-container .delete-btn:hover {
             background-color: rgba(255, 0, 0, 0.9);
        }

        /* Botão de anotação */
        .image-container .btn-annotate {
             position: absolute;
             top: 5px;
             left: 5px; /* Ajustado para esquerda */
             background-color: rgba(0, 123, 255, 0.7); /* Azul */
             color: white;
             border-radius: 50%;
             width: 25px;
             height: 25px;
             display: flex;
             align-items: center;
             justify-content: center;
             cursor: pointer;
             border: none;
             padding: 0;
             font-size: 12px; /* Ícone menor */
             line-height: 1;
        }
        .image-container .btn-annotate:hover {
             background-color: rgba(0, 123, 255, 0.9);
        }


        /* Status colors */
        .status-aguardando {
            background-color: #fff3cd !important; /* Use !important se necessário para sobrescrever BS */
            color: #856404 !important;
        }

        .status-em-manutencao {
            background-color: #cce5ff !important;
            color: #004085 !important;
        }

        .status-concluido {
            background-color: #d4edda !important;
            color: #155724 !important;
        }

        .status-disponivel {
            background-color: #d1e7dd !important;
            color: #0f5132 !important;
        }

        /* Dashboard */
        .stat-card {
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            min-height: 120px;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .stat-title {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .recent-activity {
            max-height: 400px;
            overflow-y: auto;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
            flex-shrink: 0; /* Evita que encolha */
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .card-body {
                padding: 15px;
            }

            .container {
                padding-left: 10px;
                padding-right: 10px;
            }

            .btn {
                padding: 0.375rem 0.75rem;
                font-size: 0.9rem; /* Ajuste opcional */
            }
             .btn-sm { /* Ajuste específico para botões pequenos */
                padding: 0.25rem 0.5rem;
                font-size: 0.8rem;
            }


            .stat-card {
                padding: 10px;
                min-height: 100px;
            }

            .stat-card .stat-value {
                font-size: 1.5rem;
            }

            .image-container img {
                width: 100px;
                height: 100px;
            }
            .navbar-nav {
                text-align: center; /* Centraliza itens no mobile */
            }
             /* Ajuste tabela no mobile */
            .table thead {
                 display: none; /* Esconde cabeçalho tradicional */
            }
            .table, .table tbody, .table tr, .table td {
                display: block;
                width: 100%;
            }
            .table tr {
                margin-bottom: 1rem;
                border: 1px solid #dee2e6;
                border-radius: .25rem;
            }
            .table td {
                text-align: right; /* Alinha valor à direita */
                padding-left: 50%; /* Espaço para label */
                position: relative;
                border-top: none; /* Remove borda superior padrão da célula */
                border-bottom: 1px solid #dee2e6; /* Adiciona borda inferior */
            }
             .table td:last-child {
                 border-bottom: none; /* Remove borda da última célula */
            }
            .table td::before {
                content: attr(data-label); /* Pega o label do data attribute */
                position: absolute;
                left: .5rem; /* Posição do label */
                width: 45%; /* Largura do label */
                padding-right: .5rem;
                text-align: left; /* Alinha label à esquerda */
                font-weight: bold;
            }
             /* Remove pseudo-elementos onde não faz sentido (ex: ações) */
            .table td:last-child::before {
                 content: "";
            }
             /* Garante que botões de ação fiquem visíveis */
             .table td:last-child {
                 text-align: center; /* Centraliza botões */
                 padding-left: 0; /* Remove padding esquerdo */
            }
        }

        /* Camera styles */
        .camera-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }

        /* Corrigido: Assegura que o ID seja aplicado */
        #camera-preview-pre, #camera-preview-pos, #camera-modal-preview {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 10px;
            background-color: #333; /* Fundo escuro para vídeo */
        }


        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Anotação */
         #annotation-container {
             overflow: auto; /* Permite scroll se a imagem for grande */
             max-height: 60vh; /* Limita altura no modal */
             text-align: center; /* Centraliza a imagem/canvas */
             background-color: #f0f0f0; /* Fundo para melhor visualização */
             padding: 10px;
             border-radius: 5px;
         }
        /* Corrigido: Assegura que o ID seja aplicado */
        #annotation-canvas {
             cursor: crosshair;
             /* Estilos de posição e display são aplicados via JS */
        }

        .annotation-controls .btn.active {
             background-color: var(--primary-color);
             color: white;
        }

        /* Footer */
        .footer-dev {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f8f9fa; /* Cor de fundo suave */
            padding: 5px 0;
            text-align: center;
            font-size: 0.8em;
            color: #6c757d; /* Cinza secundário */
            border-top: 1px solid #dee2e6;
            z-index: 1000; /* Garante que fique acima de outros elementos */
        }

        /* Outros ajustes */
        .checklist-item .btn-group .btn {
             padding: 0.25rem 0.5rem; /* Menor padding nos botões do checklist */
             font-size: 0.8rem; /* Fonte menor */
        }
        .checklist-item .btn-group .btn i {
             margin-right: 3px !important; /* Espaço menor para ícone */
        }

        /* Classe para indicar loading de imagem */
        .image-loading {
            background-color: #f8f9fa; /* Fundo suave */
            border: 1px dashed #ced4da; /* Borda tracejada */
        }

        /* Ajuste de estilo para os previews de imagem */
        .photo-preview-img {
            max-width: 150px; /* Garante tamanho consistente */
            max-height: 150px;
            object-fit: cover;
            margin: 5px; /* Adiciona margem entre as imagens */
            vertical-align: top; /* Alinha melhor com outros elementos inline-block */
        }

    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-tools me-2"></i>Sistema de Manutenção
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="nav-dashboard">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-lista">
                            <i class="bi bi-list-ul me-1"></i>Lista
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-novo">
                            <i class="bi bi-plus-circle me-1"></i>Nova Manutenção
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-ferramentas">
                            <i class="bi bi-tools me-1"></i>Ferramentas
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="conteudo-principal">

            <!-- Tela Dashboard -->
            <div id="tela-dashboard" class="view-content">
                <h2 class="mb-4">Dashboard de Manutenções</h2>

                <div class="row mb-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card bg-light">
                            <div class="stat-title">Equipamentos</div>
                            <div class="stat-value" id="total-equipamentos">0</div>
                            <div>Total cadastrado</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card bg-light">
                            <div class="stat-title">Aguardando</div>
                            <div class="stat-value text-warning" id="total-aguardando">0</div>
                            <div>Manutenções pendentes</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card bg-light">
                            <div class="stat-title">Em Manutenção</div>
                            <div class="stat-value text-primary" id="total-em-manutencao">0</div>
                            <div>Em andamento</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card bg-light">
                            <div class="stat-title">Concluídas</div>
                            <div class="stat-value text-success" id="total-concluidas">0</div>
                            <div>Finalizadas</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-wrench me-2"></i>Manutenções Recentes
                            </div>
                            <div class="card-body p-0">
                                <ul class="list-group list-group-flush" id="manutencoes-recentes">
                                    <!-- Itens serão adicionados via JS -->
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-activity me-2"></i>Atividade Recente
                            </div>
                            <div class="card-body p-0 recent-activity">
                                <ul class="list-group list-group-flush" id="atividade-recente">
                                    <!-- Itens serão adicionados via JS -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-bar-chart me-2"></i>Manutenções por Tipo de Equipamento
                            </div>
                            <div class="card-body" id="grafico-tipos" style="min-height: 300px;">
                                <!-- Gráfico será adicionado via JS -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-pie-chart me-2"></i>Manutenções por Categoria
                            </div>
                            <div class="card-body" id="grafico-categorias" style="min-height: 300px;">
                                <!-- Gráfico será adicionado via JS -->
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-clock-history me-2"></i>Tempo Médio de Manutenção
                            </div>
                           <div class="card-body" id="grafico-tempo-medio" style="min-height: 300px;">
                               <!-- Gráfico será adicionado via JS -->
                           </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-calendar-check me-2"></i>Manutenções por Período
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-end mb-3">
                                    <select id="filtro-periodo-grafico" class="form-select form-select-sm" style="width: auto;">
                                        <option value="7">Últimos 7 dias</option>
                                        <option value="30" selected>Últimos 30 dias</option>
                                        <option value="90">Últimos 90 dias</option>
                                        <option value="365">Último ano</option>
                                    </select>
                                </div>
                                <div id="grafico-periodo" style="min-height: 250px;">
                                    <!-- Gráfico será adicionado via JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-truck me-2"></i>Status dos Equipamentos
                    </div>
                    <div class="card-body">
                        <div class="row" id="status-equipamentos">
                            <!-- Status serão adicionados via JS -->
                        </div>
                    </div>
                </div>

            </div> <!-- Fim tela-dashboard -->

            <!-- Tela Lista -->
            <div id="tela-lista" class="view-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2"> <!-- Flex-wrap para mobile -->
                    <h2>Lista de Manutenções</h2>
                    <button class="btn btn-primary" id="btn-nova-manutencao">
                        <i class="bi bi-plus-circle me-1"></i>Nova Manutenção
                    </button>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3 col-sm-6">
                                <label for="filtro-status" class="form-label visually-hidden">Status</label> <!-- Label para acessibilidade -->
                                <select class="form-select" id="filtro-status" aria-label="Filtrar por Status">
                                    <option value="">Todos os Status</option>
                                    <option value="Aguardando Manutenção">Aguardando</option>
                                    <option value="Em Manutenção">Em Manutenção</option>
                                    <option value="Manutenção Concluída">Concluídas</option>
                                    <option value="Equipamento Disponível">Disponíveis</option>
                                </select>
                            </div>
                            <div class="col-md-3 col-sm-6">
                               <label for="filtro-placa" class="form-label visually-hidden">Placa</label>
                                <input type="text" class="form-control" id="filtro-placa" placeholder="Filtrar por Placa" aria-label="Filtrar por Placa">
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <button class="btn btn-primary w-100" id="btn-filtrar">
                                    <i class="bi bi-search me-1"></i>Filtrar
                                </button>
                            </div>
                            <div class="col-md-3 col-sm-6">
                                <button class="btn btn-outline-secondary w-100" id="btn-limpar-filtro">
                                    <i class="bi bi-x-circle me-1"></i>Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Placa</th>
                                        <th>Tipo</th>
                                        <th>Data</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-manutencoes">
                                    <!-- Linhas serão adicionadas via JS -->
                                    <!-- Exemplo de como o JS vai gerar as células com data-label para mobile -->
                                    <!--
                                    <tr>
                                        <td data-label="Placa">ABC-1234</td>
                                        <td data-label="Tipo">Caminhão Vácuo</td>
                                        <td data-label="Data">25/10/2023</td>
                                        <td data-label="Status"><span class="badge status-aguardando status-badge">Aguardando</span></td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary btn-visualizar" title="Visualizar" data-id="1"><i class="bi bi-eye"></i></button>
                                            <button class="btn btn-sm btn-outline-secondary btn-editar" title="Editar" data-id="1"><i class="bi bi-pencil"></i></button>
                                            <button class="btn btn-sm btn-outline-danger btn-excluir" title="Excluir" data-id="1"><i class="bi bi-trash"></i></button>
                                        </td>
                                    </tr>
                                     -->
                                </tbody>
                            </table>
                        </div>
                        <div id="sem-registros" class="text-center py-4" style="display: none;">
                            <i class="bi bi-exclamation-circle fs-1 text-muted"></i>
                            <p class="mt-2 text-muted">Nenhum registro encontrado</p>
                        </div>
                    </div>
                </div>
            </div> <!-- Fim tela-lista -->

            <!-- Tela Pré-Manutenção -->
            <div id="tela-pre-manutencao" class="view-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                    <h2>Registro de Pré-Manutenção</h2>
                    <button class="btn btn-outline-secondary btn-voltar">
                        <i class="bi bi-arrow-left me-1"></i>Voltar para Lista
                    </button>
                </div>

                <form id="form-pre-manutencao" novalidate> <!-- novalidate para usar validação customizada -->
                    <input type="hidden" id="pre-id" name="id">

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-truck me-2"></i>Informações do Equipamento
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="pre-tipo-equipamento" class="form-label">Tipo de Equipamento*</label>
                                    <select class="form-select" id="pre-tipo-equipamento" name="tipoEquipamento" required>
                                        <option value="">Selecione...</option>
                                        <option value="Caminhão Alta Pressão">Caminhão Alta Pressão</option>
                                        <option value="Caminhão Auto Vácuo">Caminhão Auto Vácuo</option>
                                        <option value="Caminhão Hiper Vácuo">Caminhão Hiper Vácuo</option>
                                        <option value="Caminhão Conjugado">Caminhão Conjugado</option>
                                        <option value="Caminhão Brook">Caminhão Brook</option>
                                        <option value="Aspirador de Pó">Aspirador de Pó</option>
                                        <option value="Outro Tipo">Outro Tipo</option>
                                        <!-- Outras opções podem ser adicionadas dinamicamente -->
                                    </select>
                                     <div class="invalid-feedback">Por favor, selecione o tipo de equipamento.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="pre-placa-select" class="form-label">Equipamento/Placa*</label>
                                    <select class="form-select" id="pre-placa-select" style="display: none;" aria-describedby="placaValidationFeedback">
                                        <option value="">Selecione o Equipamento...</option>
                                        <!-- Opções preenchidas via JS -->
                                    </select>
                                    <input type="text" class="form-control mt-2" id="pre-placa-outro-valor" style="display: none;" placeholder="Digite a placa ou nome" aria-describedby="placaValidationFeedback">
                                    <div id="placaValidationFeedback" class="invalid-feedback">Por favor, selecione ou informe o equipamento/placa.</div>
                                    <input type="hidden" id="pre-placa" name="placa" required>
                                    <input type="hidden" id="pre-modelo" name="modelo">
                                </div>
                            </div>
                        </div>
                    </div> <!-- Fim card equipamento -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-exclamation-triangle me-2"></i>Detalhes do Problema
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="pre-categoria-problema" class="form-label">Categoria do Problema*</label>
                                    <select class="form-select" id="pre-categoria-problema" name="categoriaProblema" required>
                                        <option value="">Selecione...</option>
                                        <!-- Opções preenchidas via JS -->
                                    </select>
                                     <div class="invalid-feedback">Por favor, selecione a categoria do problema.</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="pre-urgencia" class="form-label">Urgência*</label>
                                    <select class="form-select" id="pre-urgencia" name="urgencia" required>
                                        <option value="">Selecione...</option>
                                        <!-- Opções preenchidas via JS -->
                                    </select>
                                     <div class="invalid-feedback">Por favor, selecione o nível de urgência.</div>
                                </div>
                                <div class="col-12" id="motivo-outro-container" style="display: none;">
                                    <label for="pre-motivo-outro" class="form-label">Especifique o Problema*</label>
                                    <input type="text" class="form-control" id="pre-motivo-outro" name="motivoOutro"> <!-- required é setado via JS -->
                                    <div class="invalid-feedback">Por favor, especifique o problema.</div>
                                </div>
                                <div class="col-12">
                                    <label for="pre-descricao-problema" class="form-label">Descrição do Problema*</label>
                                    <textarea class="form-control" id="pre-descricao-problema" name="descricaoProblema" rows="3" required></textarea>
                                    <div class="invalid-feedback">Por favor, descreva o problema encontrado.</div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- Fim card problema -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-check-square me-2"></i>Checklist Pré-Manutenção
                        </div>
                        <div class="card-body">
                            <div id="pre-checklist-container">
                                <!-- Checklist gerado via JS -->
                            </div>
                            <div class="mb-3 mt-3"> <!-- Adicionado mt-3 -->
                                <label for="pre-observacoes" class="form-label">Observações Adicionais</label>
                                <textarea class="form-control" id="pre-observacoes" name="observacoesPre" rows="3"></textarea>
                            </div>
                        </div>
                    </div> <!-- Fim card checklist pre -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-camera me-2"></i>Registro Fotográfico
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="d-flex gap-2 mb-3 flex-wrap">
                                    <button type="button" class="btn btn-primary" id="btn-abrir-camera-pre">
                                        <i class="bi bi-camera-fill me-1"></i>Abrir Câmera
                                    </button>
                                    <label class="btn btn-outline-secondary" for="input-imagem-pre"> <!-- Usar label para estilizar -->
                                        <i class="bi bi-image me-1"></i>Da Galeria
                                    </label>
                                    <input type="file" id="input-imagem-pre" accept="image/*" multiple style="display: none;">
                                </div>

                                <div id="camera-container-pre" class="camera-container" style="display: none;">
                                    <video id="camera-preview-pre" autoplay playsinline></video>
                                    <div class="camera-controls">
                                        <button type="button" class="btn btn-primary" id="btn-capturar-pre">
                                            <i class="bi bi-camera-fill me-1"></i>Capturar
                                        </button>
                                        <button type="button" class="btn btn-danger" id="btn-fechar-camera-pre">
                                            <i class="bi bi-x-circle me-1"></i>Fechar
                                        </button>
                                    </div>
                                </div>

                                <div id="imagens-preview-pre" class="d-flex flex-wrap gap-2 mt-3 border p-2 rounded bg-light" style="min-height: 100px;">
                                    <!-- Imagens serão adicionadas via JS -->
                                     <small class="text-muted w-100 text-center" id="imagens-preview-pre-placeholder" style="display: block;">Nenhuma imagem adicionada.</small> <!-- Placeholder -->
                                </div>
                            </div>
                        </div>
                    </div> <!-- Fim card fotos pre -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-person me-2"></i>Responsável pelo Registro
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="pre-responsavel" class="form-label">Nome do Responsável*</label>
                                <input type="text" class="form-control" id="pre-responsavel" name="responsavel" required>
                                <div class="invalid-feedback">Por favor, informe o nome do responsável.</div>
                            </div>
                        </div>
                    </div> <!-- Fim card responsável -->

                    <div class="d-flex justify-content-between mb-4">
                        <button type="button" class="btn btn-outline-secondary btn-voltar">
                            <i class="bi bi-arrow-left me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>Salvar e Avançar
                        </button>
                    </div>
                </form>
            </div> <!-- Fim tela-pre-manutencao -->

            <!-- Tela Pós-Manutenção -->
            <div id="tela-pos-manutencao" class="view-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                    <h2>Registro de Pós-Manutenção</h2>
                    <!-- Removido botão voltar padrão, usar o botão específico abaixo -->
                </div>

                <form id="form-pos-manutencao" novalidate>
                    <input type="hidden" id="pos-id" name="id">

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-truck me-2"></i>Resumo do Equipamento
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <p class="form-label mb-1 fw-bold">Placa/Equipamento</p> <!-- Label em negrito -->
                                    <p class="form-control-plaintext ps-0" id="pos-placa-display"></p>
                                </div>
                                <div class="col-md-6">
                                    <p class="form-label mb-1 fw-bold">Tipo de Equipamento</p>
                                    <p class="form-control-plaintext ps-0" id="pos-tipo-display"></p>
                                </div>
                            </div>
                        </div>
                    </div> <!-- Fim card resumo -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-check-square me-2"></i>Checklist Pós-Manutenção
                        </div>
                        <div class="card-body">
                            <div id="pos-checklist-container">
                                <!-- Checklist gerado via JS -->
                            </div>
                            <div class="mb-3 mt-3">
                                <label for="pos-observacoes" class="form-label">Observações da Manutenção</label>
                                <textarea class="form-control" id="pos-observacoes" name="observacoesPos" rows="3"></textarea>
                            </div>
                        </div>
                    </div> <!-- Fim card checklist pos -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-camera me-2"></i>Registro Fotográfico Pós-Manutenção
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="d-flex gap-2 mb-3 flex-wrap">
                                    <button type="button" class="btn btn-primary" id="btn-abrir-camera-pos">
                                        <i class="bi bi-camera-fill me-1"></i>Abrir Câmera
                                    </button>
                                     <label class="btn btn-outline-secondary" for="input-imagem-pos">
                                        <i class="bi bi-image me-1"></i>Da Galeria
                                    </label>
                                    <input type="file" id="input-imagem-pos" accept="image/*" multiple style="display: none;">
                                </div>

                                <div id="camera-container-pos" class="camera-container" style="display: none;">
                                    <video id="camera-preview-pos" autoplay playsinline></video>
                                    <div class="camera-controls">
                                        <button type="button" class="btn btn-primary" id="btn-capturar-pos">
                                            <i class="bi bi-camera-fill me-1"></i>Capturar
                                        </button>
                                        <button type="button" class="btn btn-danger" id="btn-fechar-camera-pos">
                                            <i class="bi bi-x-circle me-1"></i>Fechar
                                        </button>
                                    </div>
                                </div>

                                <div id="imagens-preview-pos" class="d-flex flex-wrap gap-2 mt-3 border p-2 rounded bg-light" style="min-height: 100px;">
                                    <!-- Imagens serão adicionadas via JS -->
                                     <small class="text-muted w-100 text-center" id="imagens-preview-pos-placeholder" style="display: block;">Nenhuma imagem adicionada.</small> <!-- Placeholder -->
                                </div>
                            </div>
                        </div>
                    </div> <!-- Fim card fotos pos -->

                    <div class="d-flex justify-content-between mb-4 flex-wrap gap-2"> <!-- Flex-wrap para mobile -->
                        <button type="button" class="btn btn-outline-secondary" id="btn-voltar-pre">
                            <i class="bi bi-arrow-left me-1"></i>Voltar para Pré-Manutenção
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i>Finalizar Manutenção
                        </button>
                    </div>
                </form>
            </div> <!-- Fim tela-pos-manutencao -->

            <!-- Tela Visualização -->
            <div id="tela-visualizacao" class="view-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                    <h2>Detalhes da Manutenção</h2>
                    <div class="btn-group flex-wrap gap-1"> <!-- Gap entre botões -->
                        <button class="btn btn-outline-secondary btn-voltar">
                            <i class="bi bi-arrow-left me-1"></i>Voltar para Lista
                        </button>
                        <button class="btn btn-outline-primary" id="btn-editar-manutencao">
                            <i class="bi bi-pencil me-1"></i>Editar
                        </button>
                         <div class="dropdown d-inline-block">
                          <button class="btn btn-outline-info dropdown-toggle" type="button" id="btnRelatorioOpcoes" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-file-earmark-arrow-down me-1"></i>Relatórios
                          </button>
                          <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="btnRelatorioOpcoes"> <!-- dropdown-menu-end para alinhar à direita -->
                            <li><a class="dropdown-item" href="#" id="btn-gerar-pdf-basico"><i class="bi bi-file-pdf me-2"></i>Relatório PDF Básico</a></li>
                            <li><a class="dropdown-item" href="#" id="btn-gerar-pdf-avancado"><i class="bi bi-file-earmark-pdf me-2"></i>Relatório PDF Avançado</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="btn-gerar-excel"><i class="bi bi-file-earmark-excel me-2"></i>Exportar para Excel</a></li>
                            <li><a class="dropdown-item" href="#" id="btn-gerar-csv"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Exportar para CSV</a></li>
                          </ul>
                        </div>
                    </div>
                </div>

                <div id="detalhes-manutencao">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-info-circle me-2"></i>Informações Gerais
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 col-sm-6 mb-3"> <!-- Ajuste colunas mobile -->
                                    <h6 class="text-muted mb-1">ID</h6>
                                    <p id="view-id" class="fw-bold"></p> <!-- Negrito para destaque -->
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <h6 class="text-muted mb-1">Data de Abertura</h6>
                                    <p id="view-data-criacao"></p>
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <h6 class="text-muted mb-1">Status</h6>
                                    <p><span class="badge fs-6" id="view-status"></span></p> <!-- Aumenta fonte badge -->
                                </div>
                                <div class="col-md-3 col-sm-6 mb-3">
                                    <h6 class="text-muted mb-1">Responsável</h6>
                                    <p id="view-responsavel"></p>
                                </div>
                            </div>
                            <hr class="my-3"> <!-- Ajusta margem hr -->
                             <div class="row">
                                <div class="col-md-6 mb-3">
                                    <h6 class="text-muted mb-1">Placa/Equipamento</h6>
                                    <p id="view-placa"></p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <h6 class="text-muted mb-1">Tipo de Equipamento</h6>
                                    <p id="view-tipo-equipamento"></p>
                                </div>
                             </div>
                        </div>
                    </div> <!-- Fim card geral -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-exclamation-triangle me-2"></i>Detalhes do Problema
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <h6 class="text-muted mb-1">Categoria</h6>
                                    <p id="view-categoria-problema"></p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <h6 class="text-muted mb-1">Urgência</h6>
                                    <p id="view-urgencia"></p>
                                </div>
                            </div>
                            <div class="row mb-3" id="view-motivo-outro-container" style="display: none;">
                                <div class="col-12">
                                    <h6 class="text-muted mb-1">Especificação do Problema (Outro)</h6>
                                    <p id="view-motivo-outro" class="fst-italic"></p> <!-- Itálico para destaque -->
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="text-muted mb-1">Descrição Detalhada</h6>
                                    <p id="view-descricao-problema" style="white-space: pre-wrap;"></p>
                                </div>
                            </div>
                        </div>
                    </div> <!-- Fim card problema -->

                    <!-- Abas para Pré e Pós -->
                    <div class="card mb-4">
                        <div class="card-header">
                             <ul class="nav nav-tabs card-header-tabs" id="registroTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="pre-tab" data-bs-toggle="tab" data-bs-target="#pre-tab-pane" type="button" role="tab" aria-controls="pre-tab-pane" aria-selected="true">
                                        <i class="bi bi-clipboard-check me-1"></i>Pré-Manutenção
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                     <button class="nav-link" id="pos-tab" data-bs-toggle="tab" data-bs-target="#pos-tab-pane" type="button" role="tab" aria-controls="pos-tab-pane" aria-selected="false" disabled> <!-- Começa desabilitada -->
                                         <i class="bi bi-clipboard-check me-1"></i>Pós-Manutenção
                                     </button>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body tab-content" id="registroTabsContent">
                            <!-- Aba Pré-Manutenção -->
                            <div class="tab-pane fade show active" id="pre-tab-pane" role="tabpanel" aria-labelledby="pre-tab" tabindex="0">
                                <h5 class="mb-3"><i class="bi bi-list-check me-2"></i>Checklist Pré-Manutenção</h5>
                                <div id="view-checklist-pre" class="mb-4">
                                    <!-- Checklist preenchido via JS -->
                                </div>
                                <hr>
                                <h5 class="mb-2"><i class="bi bi-chat-left-text me-2"></i>Observações</h5>
                                <p id="view-observacoes-pre" class="mb-4 text-muted" style="white-space: pre-wrap;"></p>
                                <hr>
                                <h5 class="mb-2"><i class="bi bi-images me-2"></i>Imagens</h5>
                                <div id="view-imagens-pre" class="d-flex flex-wrap gap-2 bg-light p-2 rounded">
                                    <!-- Imagens preenchidas via JS -->
                                </div>
                            </div>
                            <!-- Aba Pós-Manutenção -->
                            <div class="tab-pane fade" id="pos-tab-pane" role="tabpanel" aria-labelledby="pos-tab" tabindex="0">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6 class="mb-1">Data da Manutenção</h6>
                                        <p id="view-data-manutencao"></p>
                                    </div>
                                </div>
                                <hr>
                                <h5 class="mb-3"><i class="bi bi-list-check me-2"></i>Checklist Pós-Manutenção</h5>
                                <div id="view-checklist-pos" class="mb-4">
                                    <!-- Checklist preenchido via JS -->
                                </div>
                                <hr>
                                <h5 class="mb-2"><i class="bi bi-chat-left-text me-2"></i>Observações</h5>
                                <p id="view-observacoes-pos" class="mb-4 text-muted" style="white-space: pre-wrap;"></p>
                                <hr>
                                <h5 class="mb-2"><i class="bi bi-images me-2"></i>Imagens</h5>
                                <div id="view-imagens-pos" class="d-flex flex-wrap gap-2 bg-light p-2 rounded">
                                    <!-- Imagens preenchidas via JS -->
                                </div>
                            </div>
                        </div>
                    </div><!-- Fim Card Abas Pré/Pós -->


                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-arrow-repeat me-2"></i>Atualizar Status da Manutenção
                        </div>
                        <div class="card-body">
                            <div class="d-flex gap-2 flex-wrap justify-content-center"> <!-- Centraliza botões -->
                                <button class="btn btn-outline-warning btn-status flex-grow-1" data-status="Aguardando Manutenção">
                                    <i class="bi bi-hourglass-split me-1"></i>Aguardando
                                </button>
                                <button class="btn btn-outline-primary btn-status flex-grow-1" data-status="Em Manutenção">
                                    <i class="bi bi-tools me-1"></i>Em Manutenção
                                </button>
                                <button class="btn btn-outline-success btn-status flex-grow-1" data-status="Manutenção Concluída">
                                    <i class="bi bi-check-circle-fill me-1"></i>Concluído
                                </button>
                                <button class="btn btn-outline-info btn-status flex-grow-1" data-status="Equipamento Disponível">
                                    <i class="bi bi-check-all me-1"></i>Disponível
                                </button>
                            </div>
                        </div>
                    </div> <!-- Fim card status -->
                </div> <!-- Fim #detalhes-manutencao -->
            </div> <!-- Fim tela-visualizacao -->

            <!-- Tela Ferramentas -->
            <div id="tela-ferramentas" class="view-content" style="display: none;">
                <h2 class="mb-4">Ferramentas e Configurações</h2>

                <div class="row">
                    <!-- Card Integração Planilha -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header bg-light border-bottom-0">
                                <h5 class="mb-0"><i class="bi bi-table me-2 text-primary"></i>Integração com Planilha de Turnos</h5>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <p class="card-text text-muted">
                                    Transfira automaticamente os dados de equipamentos em manutenção para a planilha de controle de turnos.
                                </p>
                                <div class="mb-3">
                                    <label for="id-planilha-turnos" class="form-label">ID da Planilha de Turnos Google</label>
                                    <input type="text" class="form-control" id="id-planilha-turnos" placeholder="Cole o ID da planilha aqui">
                                    <div class="form-text">
                                        Encontre o ID na URL da planilha (entre `/d/` e `/edit`).
                                    </div>
                                </div>
                                 <div class="mt-auto"> <!-- Push content to bottom -->
                                    <button class="btn btn-primary w-100 mb-2" id="btn-executar-integracao">
                                        <i class="bi bi-arrow-repeat me-1"></i>Executar Integração Agora
                                    </button>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="integracao-automatica">
                                        <label class="form-check-label small" for="integracao-automatica">
                                            Ativar integração automática diária (aprox. 6h)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Notificações por E-mail -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 shadow-sm">
                            <div class="card-header bg-light border-bottom-0">
                                <h5 class="mb-0"><i class="bi bi-envelope-at me-2 text-success"></i>Notificações por E-mail</h5>
                            </div>
                            <div class="card-body d-flex flex-column">
                                <p class="card-text text-muted">
                                    Configure e-mails para receber atualizações e alertas sobre manutenções importantes.
                                </p>
                                <div class="mb-3">
                                    <label for="emails-notificacao" class="form-label">E-mails para Notificação (separados por vírgula)</label>
                                    <textarea class="form-control" id="emails-notificacao" rows="2" placeholder="exemplo@dominio.com, outro@dominio.com"></textarea>
                                </div>
                                <div class="d-grid mb-3">
                                    <button class="btn btn-success" id="btn-salvar-emails">
                                        <i class="bi bi-save me-1"></i>Salvar Configuração de E-mails
                                    </button>
                                 </div>
                                <div class="mt-auto">
                                     <label for="tipo-email-teste" class="form-label small">Enviar e-mail de teste:</label>
                                    <div class="input-group">
                                        <select class="form-select form-select-sm" id="tipo-email-teste">
                                            <option value="nova">Nova Manutenção</option>
                                            <option value="atualizacao">Atualização de Status</option>
                                            <option value="conclusao">Conclusão</option>
                                            <option value="alerta">Alerta Urgente</option>
                                        </select>
                                        <button class="btn btn-outline-secondary btn-sm" id="btn-teste-email">
                                            <i class="bi bi-send me-1"></i>Enviar Teste
                                         </button>
                                    </div>
                                    <div class="form-text small">Usa a primeira manutenção da lista para o teste.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Card Configurações do Sistema -->
                    <div class="col-lg-6 mb-4">
                        <div class="card h-100 shadow-sm">
                             <div class="card-header bg-light border-bottom-0">
                                <h5 class="mb-0"><i class="bi bi-gear-wide-connected me-2 text-info"></i>Configurações do Sistema</h5>
                             </div>
                            <div class="card-body d-flex flex-column">
                                <p class="card-text text-muted">
                                    Gerencie tarefas automáticas e verifique a versão do sistema.
                                </p>
                                <div class="d-grid gap-2 mb-3">
                                    <button class="btn btn-info text-white" id="btn-configurar-gatilhos">
                                        <i class="bi bi-clock-history me-1"></i>(Re)Configurar Tarefas Automáticas
                                     </button>
                                    <button class="btn btn-outline-secondary" id="btn-verificar-atualizacoes">
                                        <i class="bi bi-cloud-download me-1"></i>Verificar Versão
                                    </button>
                                 </div>
                                <div class="mt-auto text-center pt-3 border-top">
                                    <span class="small text-muted">Versão Atual do Sistema:</span>
                                    <span class="badge bg-dark ms-1" id="versao-sistema">?.?.?</span>
                                </div>
                            </div>
                        </div>
                    </div>

                </div> <!-- Fim da row -->
            </div> <!-- Fim tela-ferramentas -->

        </div> <!-- Fim #conteudo-principal -->
    </div> <!-- Fim .container -->

    <!-- Modals -->
    <div class="modal fade" id="cameraModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-camera-video me-2"></i>Capturar Imagem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="camera-container">
                        <video id="camera-modal-preview" autoplay playsinline class="border rounded"></video> <!-- Adicionado ID correto e estilo -->
                        <canvas id="camera-canvas" style="display: none;"></canvas>
                    </div>
                    <div id="camera-error-message" class="alert alert-danger mt-2" style="display: none;"></div>
                </div>
                <div class="modal-footer justify-content-center"> <!-- Centraliza botões -->
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-lg me-1"></i>Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-capturar-modal">
                        <i class="bi bi-camera-fill me-1"></i>Capturar Imagem
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered"> <!-- Centraliza verticalmente -->
            <div class="modal-content">
                <div class="modal-header bg-warning border-0">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Confirmação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirm-message">Tem certeza que deseja realizar esta ação?</p>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" id="confirm-yes">Confirmar</button> <!-- Botão confirmação amarelo -->
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
         <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" id="alertModalHeader"> <!-- ID para estilização dinâmica -->
                    <h5 class="modal-title" id="alert-title">Aviso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="alert-message" style="white-space: pre-wrap;"></p>
                </div>
                <div class="modal-footer border-0" id="alertModalFooter">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="choiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white border-0">
                    <h5 class="modal-title"><i class="bi bi-check-circle-fill me-2"></i>Registro Salvo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>O registro de pré-manutenção foi salvo com sucesso!</p>
                    <p class="fw-bold">O que deseja fazer agora?</p>
                </div>
                <div class="modal-footer border-0 justify-content-center flex-wrap gap-2"> <!-- Centraliza e permite quebra -->
                    <button type="button" class="btn btn-outline-secondary" id="btn-choice-lista">
                        <i class="bi bi-list-ul me-1"></i>Ir para Lista
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="btn-choice-novo">
                        <i class="bi bi-plus-circle me-1"></i>Novo Registro
                    </button>
                    <button type="button" class="btn btn-success" id="btn-choice-pos">
                        <i class="bi bi-arrow-right-circle me-1"></i>Ir para Pós-Manutenção
                    </button>
                </div>
            </div>
        </div>
    </div>

     <div class="modal fade" id="modal-anotacao" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl"> <!-- Modal extra large para mais espaço -->
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Anotar Imagem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                 </div>
                <div class="modal-body">
                    <!-- Container do anotador é preenchido/controlado pela classe ImageAnnotator -->
                    <div id="annotation-container">
                         <!-- Conteúdo dinâmico aqui (controles, imagem, canvas) -->
                    </div>
                </div>
                 <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-save-annotation"><i class="bi bi-save me-1"></i>Salvar Anotação</button>
                </div>
             </div>
        </div>
    </div>

    <footer class="footer-dev">
        &lt;/> Desenvolvido por Warlison Abreu
    </footer>

    <!-- Scripts JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script> <!-- Versão específica ou use @latest -->

    <script>
        /**
         * ImageAnnotator - Ferramenta para anotações em imagens (Círculo/Retângulo)
         * Adaptada para Bootstrap 5 e melhorias de usabilidade.
         */
        class ImageAnnotator {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                if (!this.container) {
                    console.error(`Container #${containerId} não encontrado.`);
                    return;
                }
                this.imageElement = null;
                this.canvas = null;
                this.context = null;
                this.isDrawing = false;
                this.startX = 0;
                this.startY = 0;
                this.currentShape = 'circle'; // Default shape
                this.history = []; // Stores annotation steps { shape, startX, startY, endX, endY }
                this.contextoTipo = null; // 'pre' or 'pos' - set when loading image
                this.contextoContainer = null; // Reference to the image preview container element
                this.contextoIdOriginal = null; // Original ID/URL of the image being annotated

                this.initContainer();
            }

            initContainer() {
                // Clear previous content
                this.container.innerHTML = '';
                // Create the structure for controls, image, and canvas
                this.container.innerHTML = `
                    <div class="annotation-controls text-center mb-3">
                        <div class="btn-group btn-group-sm" role="group" aria-label="Ferramentas de Anotação">
                            <button type="button" class="btn btn-outline-primary active" id="btn-circle-${this.container.id}" title="Desenhar Círculo">
                                <i class="bi bi-circle fs-5"></i><span class="visually-hidden">Círculo</span>
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="btn-rectangle-${this.container.id}" title="Desenhar Retângulo">
                                <i class="bi bi-square fs-5"></i><span class="visually-hidden">Retângulo</span>
                            </button>
                        </div>
                         <div class="btn-group btn-group-sm ms-3" role="group" aria-label="Ações de Anotação">
                             <button type="button" class="btn btn-outline-danger" id="btn-clear-${this.container.id}" title="Desfazer Última Anotação">
                                 <i class="bi bi-arrow-counterclockwise fs-5"></i><span class="visually-hidden">Desfazer</span>
                             </button>
                             <button type="button" class="btn btn-outline-danger" id="btn-clear-all-${this.container.id}" title="Limpar Todas Anotações">
                                 <i class="bi bi-trash fs-5"></i><span class="visually-hidden">Limpar Tudo</span>
                             </button>
                         </div>
                    </div>
                    <div class="image-wrapper position-relative text-center border rounded p-1 bg-secondary bg-opacity-10">
                        <img src="" id="annotation-image-${this.container.id}" style="display: none; max-width: 100%; height: auto; vertical-align: top; background-color: white;">
                        <canvas id="annotation-canvas-${this.container.id}" style="position: absolute; top: 0; left: 0; display: none; touch-action: none;"></canvas> <!-- touch-action: none for better touch drawing -->
                    </div>
                `;
                // Get references to the created elements
                this.imageElement = document.getElementById(`annotation-image-${this.container.id}`);
                this.canvas = document.getElementById(`annotation-canvas-${this.container.id}`);
                this.context = this.canvas.getContext('2d');

                // Set up event listeners for the control buttons
                 document.getElementById(`btn-circle-${this.container.id}`).addEventListener('click', () => this.setShape('circle'));
                 document.getElementById(`btn-rectangle-${this.container.id}`).addEventListener('click', () => this.setShape('rectangle'));
                 document.getElementById(`btn-clear-${this.container.id}`).addEventListener('click', () => this.clearLastAnnotation());
                 document.getElementById(`btn-clear-all-${this.container.id}`).addEventListener('click', () => this.clearAllAnnotations());

                // --- Drawing Event Listeners (Mouse) ---
                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(this.getMousePos(e)));
                this.canvas.addEventListener('mousemove', (e) => this.draw(this.getMousePos(e)));
                this.canvas.addEventListener('mouseup', (e) => this.stopDrawing(this.getMousePos(e)));
                this.canvas.addEventListener('mouseout', (e) => { if (this.isDrawing) this.stopDrawing(this.getMousePos(e), true); }); // Stop if mouse leaves canvas while drawing

                // --- Drawing Event Listeners (Touch) ---
                this.canvas.addEventListener('touchstart', (e) => {
                    // e.preventDefault(); // Prevent default scroll/zoom only when drawing
                    if (e.touches.length === 1) { // Only draw with one finger
                        this.startDrawing(this.getTouchPos(e));
                    }
                }, { passive: false }); // passive: false needed to preventDefault inside listener

                this.canvas.addEventListener('touchmove', (e) => {
                    if (this.isDrawing && e.touches.length === 1) {
                        e.preventDefault(); // Prevent scroll ONLY when drawing
                        this.draw(this.getTouchPos(e));
                    }
                }, { passive: false });

                this.canvas.addEventListener('touchend', (e) => {
                     // Use changedTouches for touchend position
                    if (this.isDrawing) {
                         this.stopDrawing(this.getTouchPos(e, true)); // Pass final touch position
                    }
                });
                 this.canvas.addEventListener('touchcancel', (e) => { // Handle interruption
                     if (this.isDrawing) {
                         this.isDrawing = false; // Reset drawing state
                         this.redrawAnnotations(); // Redraw history without the interrupted shape
                     }
                 });
            }

            // Load an image into the annotator
            loadImage(src) {
                return new Promise((resolve, reject) => {
                    this.imageElement.onload = () => {
                        // Set canvas dimensions to match the natural image size
                        this.canvas.width = this.imageElement.naturalWidth;
                        this.canvas.height = this.imageElement.naturalHeight;

                        // Style the canvas to overlay the image precisely
                        // Match the displayed size of the image
                        this.canvas.style.width = `${this.imageElement.clientWidth}px`;
                        this.canvas.style.height = `${this.imageElement.clientHeight}px`;
                        // Position canvas over the image within the wrapper
                        this.canvas.style.position = 'absolute';
                        this.canvas.style.top = `${this.imageElement.offsetTop}px`;
                        this.canvas.style.left = `${this.imageElement.offsetLeft}px`;

                        // Make elements visible
                        this.canvas.style.display = 'block';
                        this.imageElement.style.display = 'block';

                        this.history = []; // Clear history for the new image
                        this.redrawAnnotations(); // Draw initial state (empty)
                        resolve(); // Promise resolves when image is loaded and canvas is ready
                    };
                    this.imageElement.onerror = (err) => {
                        console.error("Error loading image in annotator:", src, err);
                        reject(err); // Promise rejects on error
                    };
                    this.imageElement.src = src; // Set the image source
                });
            }

            // Set the current drawing shape (circle or rectangle)
            setShape(shape) {
                this.currentShape = shape;
                // Update button active states
                document.getElementById(`btn-circle-${this.container.id}`).classList.toggle('active', shape === 'circle');
                document.getElementById(`btn-rectangle-${this.container.id}`).classList.toggle('active', shape === 'rectangle');
            }

             // Redraw all annotations from history
            redrawAnnotations() {
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height); // Clear canvas
                this.context.strokeStyle = 'red'; // Annotation color
                this.context.lineWidth = Math.max(2, this.canvas.width * 0.005); // Line width relative to image size (min 2px)
                this.context.fillStyle = 'rgba(255, 0, 0, 0.1)'; // Slight fill for visibility

                this.history.forEach(annotation => {
                    this.context.beginPath();
                    if (annotation.shape === 'circle') {
                        const dx = annotation.endX - annotation.startX;
                        const dy = annotation.endY - annotation.startY;
                        const radius = Math.sqrt(dx*dx + dy*dy) / 2; // Radius based on diameter
                        const centerX = annotation.startX + dx / 2;
                        const centerY = annotation.startY + dy / 2;
                        this.context.arc(centerX, centerY, radius, 0, Math.PI * 2);
                    } else if (annotation.shape === 'rectangle') {
                        const width = annotation.endX - annotation.startX;
                        const height = annotation.endY - annotation.startY;
                        this.context.rect(annotation.startX, annotation.startY, width, height);
                    }
                    this.context.stroke();
                    // this.context.fill(); // Optional fill
                });
            }

            // Clear the last drawn annotation
             clearLastAnnotation() {
                 if (this.history.length > 0) {
                     this.history.pop(); // Remove last item from history
                     this.redrawAnnotations(); // Redraw remaining annotations
                 }
             }

            // Clear all annotations
            clearAllAnnotations() {
                this.history = []; // Clear history array
                this.redrawAnnotations(); // Redraw (clears the canvas)
            }

            // Get mouse position relative to the canvas, scaled to natural image size
            getMousePos(event) {
                 const rect = this.canvas.getBoundingClientRect();
                 const scaleX = this.canvas.width / rect.width;
                 const scaleY = this.canvas.height / rect.height;
                 return {
                     x: (event.clientX - rect.left) * scaleX,
                     y: (event.clientY - rect.top) * scaleY
                 };
            }

            // Get touch position relative to the canvas, scaled
            getTouchPos(event, isEndEvent = false) {
                const rect = this.canvas.getBoundingClientRect();
                const scaleX = this.canvas.width / rect.width;
                const scaleY = this.canvas.height / rect.height;
                 // Use changedTouches for 'touchend' as 'touches' will be empty
                 const touch = isEndEvent ? event.changedTouches[0] : event.touches[0];
                 if (!touch) return null; // Safety check
                return {
                     x: (touch.clientX - rect.left) * scaleX,
                     y: (touch.clientY - rect.top) * scaleY
                };
            }

            // Start drawing operation
            startDrawing(pos) {
                 if (!pos) return;
                this.isDrawing = true;
                this.startX = pos.x;
                this.startY = pos.y;
                // Draw temporary shape immediately for feedback
                this.draw(pos);
            }

            // Draw the shape as the mouse/touch moves
            draw(pos) {
                 if (!this.isDrawing || !pos) return;

                 // Clear canvas and redraw history first
                 this.redrawAnnotations();

                // Draw the current shape being created
                 this.context.beginPath();
                 this.context.strokeStyle = 'rgba(255, 0, 0, 0.5)'; // Lighter red for temporary drawing
                 this.context.lineWidth = Math.max(2, this.canvas.width * 0.005);
                 // this.context.fillStyle = 'rgba(255, 0, 0, 0.05)';

                 if (this.currentShape === 'circle') {
                     const dx = pos.x - this.startX;
                     const dy = pos.y - this.startY;
                     const radius = Math.sqrt(dx*dx + dy*dy) / 2;
                     const centerX = this.startX + dx / 2;
                     const centerY = this.startY + dy / 2;
                     this.context.arc(centerX, centerY, radius, 0, Math.PI * 2);
                 } else if (this.currentShape === 'rectangle') {
                     const width = pos.x - this.startX;
                     const height = pos.y - this.startY;
                     this.context.rect(this.startX, this.startY, width, height);
                 }
                 this.context.stroke();
                 // this.context.fill();
            }

            // Stop drawing and add the final shape to history
            stopDrawing(pos, isMouseOut = false) {
                 if (!this.isDrawing) return;
                this.isDrawing = false;

                // If stopping because mouse/touch left canvas, don't add shape
                 if (isMouseOut || !pos) {
                     this.redrawAnnotations(); // Just clear temporary shape
                     return;
                 }


                 const endX = pos.x;
                 const endY = pos.y;

                 // Avoid adding tiny dots if start and end are too close
                 if (Math.abs(endX - this.startX) < 5 && Math.abs(endY - this.startY) < 5) {
                     this.redrawAnnotations(); // Clear the dot
                     return;
                 }

                 // Add the completed annotation to history
                 this.history.push({
                     shape: this.currentShape,
                     startX: this.startX,
                     startY: this.startY,
                     endX: endX,
                     endY: endY
                 });

                 // Redraw all annotations including the new one
                 this.redrawAnnotations();
            }

            // Capture the final image with annotations
            captureImage() {
                // Create a temporary canvas to merge image and annotations
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = this.canvas.width; // Use natural image dimensions
                tempCanvas.height = this.canvas.height;
                const tempContext = tempCanvas.getContext('2d');

                // Draw the original image onto the temporary canvas
                tempContext.drawImage(this.imageElement, 0, 0, tempCanvas.width, tempCanvas.height);

                // Draw the annotations (from the overlay canvas) on top
                // Ensure redrawAnnotations was called last to have the final state
                this.redrawAnnotations(); // Make sure canvas has the latest history drawn
                tempContext.drawImage(this.canvas, 0, 0);

                // Return the merged image as a JPEG data URL
                return tempCanvas.toDataURL('image/jpeg', 0.9); // Adjust quality (0.0 to 1.0)
            }
        }

        // --- Global Variables & Constants ---
        // (Keep the same variables as before: tiposEquipamentosOptions, categoriasProblemas, etc.)
        // --- Variáveis Globais ---
        let tiposEquipamentosOptions = [];
        let categoriasProblemas = [];
        let niveisUrgencia = [];
        let checklistItens = [];
        let equipamentos = []; // Lista completa de equipamentos cadastrados (se carregada da API)
        let manutencoes = []; // Lista de manutenções carregadas (da lista ou busca)
        let manutencaoAtual = null; // Armazena a manutenção sendo visualizada/editada
        let imagenesPreUpload = []; // Armazena { url: '...', id: '...', timestamp: '...', isLocal?: true }
        let imagenesPosUpload = [];
        let mediaStream = null; // Stream da câmera
        let anotadorImagem = null; // Instância do ImageAnnotator

        // --- Constantes Globais ---
        const STATUS_AGUARDANDO = 'Aguardando Manutenção';
        const STATUS_EM_MANUTENCAO = 'Em Manutenção';
        const STATUS_CONCLUIDO = 'Manutenção Concluída';
        const STATUS_DISPONIVEL = 'Equipamento Disponível';
        const VERSAO_APP = '1.2'; // Atualize conforme necessário


        // Dados dos equipamentos para os selects dinâmicos (Exemplo - manter como antes)
         const equipamentosData = {
            "Caminhão Alta Pressão": [
                'PUB-2G02', 'LUX-3201', 'FLX7617', 'EZS-8765', 'EZS-8764', 'EVK-0291',
                'EOF-5C06', 'EOF-5208', 'EGC-2989', 'EGC-2985', 'EGC-2983', 'EGC-2978',
                'EAM-3262', 'EAM-3256', 'EAM-3255', 'EAM-3253', 'EAM-3010', 'DSY-6475',
                'DSY-6474', 'DSY-6472', 'CZC-0453'
            ],
             "Caminhão Auto Vácuo": [
                 'PUB-2F80', 'NFF-0235', 'HJS-1097', 'FSA-3D71', 'EGC-2993', 'EGC-2979',
                 'EAM-3257', 'EAM-3251', 'DYB-7210', 'DSY-6577', 'DSY-6473', 'CUB-0763',
                 'ANF-2676', 'FTW-4D99', 'FTD-6368', 'FMD-2200', 'FHD-9264', 'EZS-9753'
             ],
             "Caminhão Hiper Vácuo": [ // Mesma lista como exemplo
                 'PUB-2F80', 'NFF-0235', 'HJS-1097', 'FSA-3D71', 'EGC-2993', 'EGC-2979',
                 'EAM-3257', 'EAM-3251', 'DYB-7210', 'DSY-6577', 'DSY-6473', 'CUB-0763',
                 'ANF-2676', 'FTW-4D99', 'FTD-6368', 'FMD-2200', 'FHD-9264', 'EZS-9753'
             ],
             "Caminhão Conjugado": [],
             "Caminhão Brook": [],
             "Aspirador de Pó": ["ASP-01", "ASP-02"], // Exemplo IDs
             "Outro Tipo": []
        };
        // Adiciona a opção 'OUTRO EQUIPAMENTO' a todas as listas
         Object.keys(equipamentosData).forEach(tipo => {
             if(Array.isArray(equipamentosData[tipo]) && !equipamentosData[tipo].includes('OUTRO EQUIPAMENTO')) { // Evita duplicar
                equipamentosData[tipo].push('OUTRO EQUIPAMENTO');
             }
         });


        // --- Elementos da Interface (DOM Cache) ---
        const views = {
            dashboard: document.getElementById('tela-dashboard'),
            lista: document.getElementById('tela-lista'),
            preManu: document.getElementById('tela-pre-manutencao'),
            posManu: document.getElementById('tela-pos-manutencao'),
            visualizacao: document.getElementById('tela-visualizacao'),
            ferramentas: document.getElementById('tela-ferramentas')
        };

        // --- Modals (Bootstrap Instances) ---
        // Inicializa os modais para poder chamá-los via JS
        const modals = {};
        document.addEventListener('DOMContentLoaded', () => {
            modals.camera = new bootstrap.Modal(document.getElementById('cameraModal'));
            modals.confirm = new bootstrap.Modal(document.getElementById('confirmModal'));
            modals.alert = new bootstrap.Modal(document.getElementById('alertModal'));
            modals.choice = new bootstrap.Modal(document.getElementById('choiceModal'));
            modals.anotacao = new bootstrap.Modal(document.getElementById('modal-anotacao'));
        });


        // --- Gráficos (Chart.js Instances) ---
        let graficoTipos = null;
        let graficoCategorias = null;
        let graficoTempoMedio = null;
        let graficoPeriodo = null;

        // --- Funções de Controle de Interface ---

        /**
         * Mostra uma tela específica e esconde as outras. Atualiza a navegação.
         * @param {string} telaId Chave do objeto 'views' (ex: 'dashboard', 'lista')
         */
        function mostrarTela(telaId) {
            const tela = views[telaId];
            if (!tela) {
                console.error("Tela não encontrada:", telaId);
                return;
            }

            // Esconde todas as telas
            Object.values(views).forEach(view => {
                 if (view) view.style.display = 'none';
            });
            // Mostra a tela desejada
            tela.style.display = 'block';
             window.scrollTo(0, 0); // Rola para o topo ao mudar de tela

            // Atualizar classe ativa no menu de navegação
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                link.ariaCurrent = 'false';
            });

            const navLink = document.getElementById(`nav-${telaId}`);
             if (navLink) {
                 navLink.classList.add('active');
                 navLink.ariaCurrent = 'page';
             } else if (telaId === 'preManu' || telaId === 'posManu' || telaId === 'visualizacao') {
                 // Se for tela de formulário/visualização, manter 'Lista' ativo no menu
                 const navLista = document.getElementById('nav-lista');
                 if (navLista) {
                     navLista.classList.add('active');
                     navLista.ariaCurrent = 'page';
                 }
             }

            // Ações específicas ao mostrar tela (carregar dados)
            if (telaId === 'dashboard') {
                carregarDashboard();
            } else if (telaId === 'lista') {
                carregarListaManutencoes();
            } else if (telaId === 'ferramentas') {
                carregarDadosFerramentas();
            }
        }

        /**
         * Exibe um modal de alerta customizável.
         * @param {string} mensagem Mensagem a ser exibida.
         * @param {string} [titulo='Aviso'] Título do modal.
         * @param {'info'|'sucesso'|'erro'|'aviso'|'aguarde'} [tipo='info'] Tipo do alerta para estilização.
         */
        function mostrarAlerta(mensagem, titulo = 'Aviso', tipo = 'info') {
             if (!modals.alert) { // Garante que modal está inicializado
                 console.error("Modal de alerta não inicializado.");
                 alert(`${titulo}: ${mensagem}`); // Fallback para alert nativo
                 return;
             }
             const alertTitle = document.getElementById('alert-title');
             const alertMessage = document.getElementById('alert-message');
             const alertModalHeader = document.getElementById('alertModalHeader'); // Usar ID
             const alertModalFooter = document.getElementById('alertModalFooter');
             const alertOkButton = alertModalFooter.querySelector('button');

             alertTitle.textContent = titulo;
             alertMessage.innerHTML = String(mensagem).replace(/\n/g, '<br>'); // Permite quebras de linha e garante string

             // Remover classes de cor anteriores
             alertModalHeader.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'text-white');
             alertTitle.classList.remove('text-white'); // Garante que o título não fique branco em fundos claros
             alertTitle.innerHTML = titulo; // Resetar HTML do título (remove spinner)

             // Esconder/Mostrar botão OK
             alertOkButton.style.display = 'block';

             // Adicionar classe de cor baseada no tipo
             let iconClass = 'bi-info-circle-fill'; // Default icon
             switch (tipo.toLowerCase()) {
                 case 'sucesso':
                     alertModalHeader.classList.add('bg-success', 'text-white');
                     alertTitle.classList.add('text-white');
                     iconClass = 'bi-check-circle-fill';
                     break;
                 case 'erro':
                     alertModalHeader.classList.add('bg-danger', 'text-white');
                      alertTitle.classList.add('text-white');
                      iconClass = 'bi-x-octagon-fill';
                     break;
                 case 'aviso':
                     alertModalHeader.classList.add('bg-warning');
                     iconClass = 'bi-exclamation-triangle-fill';
                     break;
                 case 'aguarde':
                      alertTitle.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>${titulo}`;
                      alertModalHeader.classList.add('bg-info', 'text-white');
                      alertTitle.classList.add('text-white');
                      alertOkButton.style.display = 'none'; // Esconde o botão OK
                      iconClass = ''; // Sem ícone extra no aguarde
                      break;
                 default: // Info
                      alertModalHeader.classList.add('bg-info', 'text-white');
                      alertTitle.classList.add('text-white');
                      iconClass = 'bi-info-circle-fill';
             }

             // Adiciona ícone ao título (se não for 'aguarde')
             if (iconClass) {
                 alertTitle.innerHTML = `<i class="bi ${iconClass} me-2"></i>` + alertTitle.innerHTML;
             }


             // Garante que o modal não seja fechável no modo 'aguarde'
             const modalElement = document.getElementById('alertModal');
             if (tipo === 'aguarde') {
                 modalElement.setAttribute('data-bs-backdrop', 'static');
                 modalElement.setAttribute('data-bs-keyboard', 'false');
             } else {
                 modalElement.removeAttribute('data-bs-backdrop');
                 modalElement.removeAttribute('data-bs-keyboard');
             }


            modals.alert.show();
        }

        /**
         * Exibe um modal de confirmação com callback para ação.
         * @param {string} mensagem Mensagem da confirmação.
         * @param {function} callback Função a ser executada se o usuário confirmar.
         */
        function mostrarConfirmacao(mensagem, callback) {
             if (!modals.confirm) { // Garante que modal está inicializado
                 console.error("Modal de confirmação não inicializado.");
                 if (confirm(mensagem)) { // Fallback para confirm nativo
                     if (typeof callback === 'function') callback();
                 }
                 return;
             }
            document.getElementById('confirm-message').textContent = mensagem;
             const confirmBtn = document.getElementById('confirm-yes');
             // Remove listener antigo clonando o botão
             const newConfirmBtn = confirmBtn.cloneNode(true);
             confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

             newConfirmBtn.addEventListener('click', () => {
                 modals.confirm.hide();
                 if (typeof callback === 'function') {
                    callback();
                 }
             }, { once: true }); // Listener único

            modals.confirm.show();
        }

        // --- Comunicação com Backend (Google Apps Script via Fetch) ---
       async function apiRequest(action, params = {}) {
          // !!! SUBSTITUA PELA URL DE IMPLANTAÇÃO DO SEU WEB APP !!!
          const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzlNPkK--a7jLhCiuBwcrW3qzY1K8J2J99a8ydVjQrzNaI_pRUl6w2I6fY0bUxuikEO/exec'; // <<< COLOQUE SUA URL AQUI
          // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
        
          if (SCRIPT_URL === 'DO_SEU_WEB_APP_AQUI' || !SCRIPT_URL) {
            console.error("!!!! URGENTE: Defina a URL de implantação do seu Web App na variável SCRIPT_URL !!!!");
            mostrarAlerta("Erro de configuração: A URL do Web App não foi definida no código HTML. A comunicação com o servidor falhará.", "Erro Crítico", "erro");
            return Promise.resolve({ success: false, message: "URL do Web App não configurada." });
          }
        
          // Adiciona a ação aos parâmetros
          params.action = action;
          
          // Adicionar o origin atual para validação no servidor
          params.origin = window.location.origin;
        
          // Determina o método e prepara os dados
          let method = 'GET';
          let body = null;
          let requestUrl = new URL(SCRIPT_URL);
          let headers = { 'Content-Type': 'application/json' }; // Default header
        
          // Ações que devem SEMPRE usar POST (para enviar dados no corpo)
          const postActions = ['salvarManutencao', 'uploadImagem', 'excluirImagem', 'salvarConfiguracao', 'configurarGatilhoAutomatico', 'enviarEmailNotificacao', 'integrarComPlanilhaTurnos', 'excluirManutencao']; // Adicione outras ações POST aqui
        
          if (postActions.includes(action)) {
            method = 'POST';
            body = JSON.stringify(params); // Envia todos os params no corpo
            requestUrl = SCRIPT_URL; // Usa URL base para POST
          } else {
            // Para GET, adiciona parâmetros à URL
            Object.keys(params).forEach(key => {
              const value = params[key];
              if (value !== undefined && value !== null) {
                if (typeof value === 'object') {
                  requestUrl.searchParams.append(key, JSON.stringify(value));
                } else {
                  requestUrl.searchParams.append(key, value);
                }
              }
            });
            requestUrl = requestUrl.toString();
            // Para GET, não enviamos Content-Type JSON
            delete headers['Content-Type'];
          }
          
          const fetchOptions = {
            method: 'POST',
            mode: 'no-cors', // Esta é a chave para evitar o erro de CORS
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              action: action,
              dados: params,
              origin: window.location.origin
            })
          };
          
          try {
            console.log(`Enviando requisição para ${action} com modo no-cors`);
            await fetch(SCRIPT_URL, fetchOptions);
            
            // IMPORTANTE: Com modo 'no-cors', não podemos ler a resposta!
            // Retornamos uma resposta padrão de sucesso
            return { 
              success: true, 
              message: "Solicitação enviada. A resposta não pode ser lida devido às restrições de CORS."
            };
          } catch (error) {
            console.error(`Erro na requisição ${action}:`, error);
            return { success: false, message: `Erro de comunicação: ${error.message}` };
          }
        }
        

        // --- Funções de Carregamento e Preparação --- (Manter as mesmas: carregarDadosIniciais, preencherSelect, criarChecklist, obterDadosFormulario, configurarSelectsEquipamentos)

        /**
         * Carrega dados iniciais essenciais (configurações, equipamentos) ao iniciar.
         */
        async function carregarDadosIniciais() {
            mostrarAlerta('Carregando configurações e dados...', 'Aguarde', 'aguarde');
            try {
                // 1. Carregar Configurações Iniciais (tipos, categorias, checklist, etc.)
                const resConfig = await apiRequest('obterConfiguracoesIniciais');
                if (!resConfig || !resConfig.success) {
                    throw new Error(resConfig.message || "Falha ao carregar configurações básicas.");
                }

                tiposEquipamentosOptions = resConfig.tiposEquipamentos || [];
                categoriasProblemas = resConfig.categoriasProblemas || [];
                niveisUrgencia = resConfig.niveisUrgencia || [];
                checklistItens = resConfig.checklistItens || [];

                // Preencher selects fixos com dados carregados
                preencherSelect('pre-tipo-equipamento', tiposEquipamentosOptions);
                preencherSelect('pre-categoria-problema', categoriasProblemas);
                preencherSelect('pre-urgencia', niveisUrgencia);

                // Criar estruturas de checklist (vazias inicialmente)
                criarChecklist('pre-checklist-container', 'pre', checklistItens);
                criarChecklist('pos-checklist-container', 'pos', checklistItens);

                // 2. (Opcional) Carregar Lista de Equipamentos da API se necessário
                // Se a lista de equipamentos for dinâmica, carregue-a aqui
                // const resEquip = await apiRequest('obterEquipamentos');
                // if (resEquip && resEquip.success) {
                //    equipamentos = resEquip.equipamentos || [];
                //    // Atualizar equipamentosData se vier da API
                // } else {
                //    console.warn("Falha ao carregar equipamentos da API, usando dados locais.");
                // }

                // Configurar listeners dos selects dinâmicos (agora que os elementos existem)
                configurarSelectsEquipamentos();

                // 3. Iniciar na tela de dashboard
                modals.alert.hide(); // Esconde o "Aguarde"
                mostrarTela('dashboard'); // Carrega dados do dashboard

            } catch (error) {
                modals.alert.hide();
                console.error("Erro crítico ao carregar dados iniciais:", error);
                mostrarAlerta(`Erro crítico ao carregar dados: ${error.message}. A aplicação pode não funcionar corretamente.`, 'Erro Fatal', 'erro');
            }
        }

        /**
         * Preenche um elemento <select> com opções.
         * @param {string} elementId ID do select.
         * @param {Array<string|{value: string, text: string}>} options Array de opções.
         * @param {boolean} [addEmptyOption=true] Adiciona uma opção vazia inicial ("Selecione...").
         */
        function preencherSelect(elementId, options, addEmptyOption = true) {
            const select = document.getElementById(elementId);
            if (!select) {
                console.warn("Elemento select não encontrado:", elementId);
                return;
            }
            select.innerHTML = ''; // Limpa opções existentes

            if (addEmptyOption) {
                 const emptyOpt = document.createElement('option');
                 emptyOpt.value = "";
                 emptyOpt.textContent = "Selecione...";
                 select.appendChild(emptyOpt);
            }

            if (!Array.isArray(options)) {
                console.warn("Opções inválidas para preencher select:", elementId, options);
                return;
            }

            options.forEach(option => {
                if (!option) return; // Pula opções nulas ou vazias
                const optElement = document.createElement('option');
                 if (typeof option === 'object' && option !== null && option.value !== undefined) {
                     optElement.value = option.value;
                     optElement.textContent = option.text || option.value;
                 } else { // Assume que é string ou número
                     optElement.value = String(option);
                     optElement.textContent = String(option);
                 }
                select.appendChild(optElement);
            });
        }

        /**
         * Cria a estrutura HTML do checklist em um container.
         * @param {string} containerId ID do container do checklist.
         * @param {'pre'|'pos'} prefix Prefixo para nomes e IDs dos inputs ('pre' ou 'pos').
         * @param {Array<string>} itens Lista dos itens do checklist.
         */
        function criarChecklist(containerId, prefix, itens) {
            const container = document.getElementById(containerId);
             if (!container) {
                 console.error("Container do checklist não encontrado:", containerId);
                 return;
             }
             // Limpa container antes de recriar
             container.innerHTML = '<p class="text-muted text-center small">Carregando itens...</p>'; // Placeholder

             if (!Array.isArray(itens) || itens.length === 0) {
                 console.warn("Nenhum item de checklist fornecido para:", containerId);
                 container.innerHTML = '<p class="text-muted text-center small">Nenhum item de checklist configurado.</p>';
                 return;
             }

            container.innerHTML = ''; // Limpa placeholder

            itens.forEach((item, index) => {
                 if (!item || typeof item !== 'string' || item.trim() === '') return; // Pular itens inválidos ou vazios

                const itemDiv = document.createElement('div');
                itemDiv.className = 'checklist-item mb-3 p-3 border rounded bg-light shadow-sm'; // Estilo melhorado

                const title = document.createElement('label'); // Usar label associado ao primeiro radio
                title.className = 'checklist-title mb-2 fw-bold d-block'; // Destaque e block
                title.textContent = item;
                 title.htmlFor = `${prefix}-checklist-${index}-ok`; // Aponta para o ID do primeiro radio

                const radioGroup = document.createElement('div');
                radioGroup.className = 'btn-group w-100';
                radioGroup.setAttribute('role', 'group');
                 radioGroup.setAttribute('aria-label', `Status para ${item}`);

                const options = [
                    { value: 'OK', label: 'OK', icon: 'bi-check-circle-fill', className: 'btn-outline-success' },
                    { value: 'Danificado', label: 'Danificado', icon: 'bi-exclamation-triangle-fill', className: 'btn-outline-danger' },
                    { value: 'N/A', label: 'N/A', icon: 'bi-slash-circle-fill', className: 'btn-outline-secondary' }
                ];

                options.forEach(option => {
                    const inputId = `${prefix}-checklist-${index}-${option.value.toLowerCase().replace(/[^a-z0-9]/gi, '')}`;
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.className = 'btn-check';
                    input.name = `${prefix}-checklist-${index}`;
                    input.id = inputId;
                    input.value = option.value;
                    input.dataset.item = item;
                     input.autocomplete = 'off';

                    const label = document.createElement('label');
                    label.className = `btn ${option.className} flex-fill`;
                    label.setAttribute('for', inputId);

                    const icon = document.createElement('i');
                    icon.className = `bi ${option.icon} me-1`;

                    label.appendChild(icon);
                    label.appendChild(document.createTextNode(` ${option.label}`));

                    radioGroup.appendChild(input);
                    radioGroup.appendChild(label);
                });

                itemDiv.appendChild(title);
                itemDiv.appendChild(radioGroup);
                container.appendChild(itemDiv);
            });
        }


        /**
         * Obtém os dados de um formulário, incluindo checklist e imagens.
         * @param {string} formId ID do formulário ('form-pre-manutencao' ou 'form-pos-manutencao').
         * @returns {object} Objeto com os dados do formulário.
         */
        function obterDadosFormulario(formId) {
            const form = document.getElementById(formId);
             if (!form) {
                 console.error("Formulário não encontrado:", formId);
                 return {};
             }
            const formData = new FormData(form);
            const dados = {};

             // Processa entradas normais e hidden
             for (const [key, value] of formData.entries()) {
                  // Trata valores undefined/null que podem vir de campos desabilitados etc.
                  dados[key] = (typeof value === 'string') ? value.trim() : value;
             }

            // Processar checklist
            const isPreForm = formId === 'form-pre-manutencao';
            const checklistContainerId = isPreForm ? 'pre-checklist-container' : 'pos-checklist-container';
            const checklistContainer = document.getElementById(checklistContainerId);
            const checklist = {};

            if (checklistContainer) {
                 checklistContainer.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                     if (radio.dataset.item) {
                         checklist[radio.dataset.item] = radio.value;
                     }
                 });
            }
             // Adiciona o checklist aos dados principais
             if (isPreForm) dados.checklistPre = checklist;
             else dados.checklistPos = checklist;


             // Adiciona as imagens processadas (url, id, timestamp) - IMPORTANTE: Mantém base64 se for local
             if (isPreForm) {
                 dados.imagensPre = imagenesPreUpload.map(img => ({ url: img.url, id: img.id, timestamp: img.timestamp, isLocal: img.isLocal }));
             } else {
                 dados.imagensPos = imagenesPosUpload.map(img => ({ url: img.url, id: img.id, timestamp: img.timestamp, isLocal: img.isLocal }));
             }

            // Tratamento especial para placa/equipamento "Outro" no form PRE
             if (isPreForm) {
                 const tipoEquipSelect = document.getElementById('pre-tipo-equipamento');
                 const placaSelect = document.getElementById('pre-placa-select');
                 const placaOutroInput = document.getElementById('pre-placa-outro-valor');

                 // Se o select de placa está visível e selecionado 'OUTRO EQUIPAMENTO', ou se o input de texto está visível
                 if ((placaSelect && placaSelect.style.display !== 'none' && placaSelect.value === 'OUTRO EQUIPAMENTO') ||
                     (placaOutroInput && placaOutroInput.style.display !== 'none'))
                 {
                     dados.placa = placaOutroInput ? placaOutroInput.value.trim() : 'Outro - Não especificado';
                 } else {
                     // Caso contrário, pega o valor do select (que está no hidden 'pre-placa')
                     dados.placa = document.getElementById('pre-placa')?.value || '';
                 }
                 // O modelo vem do hidden correspondente
                 dados.modelo = document.getElementById('pre-modelo')?.value || '';
             }
             // Remove o campo auxiliar se existir
             delete dados['pre-placa-outro-valor']; // Nome do campo no formulário que não deve ir pro backend

             // Garante que campos essenciais existam, mesmo que vazios (ajuda consistência no backend)
             const chavesEsperadasPre = ['id', 'tipoEquipamento', 'placa', 'modelo', 'categoriaProblema', 'urgencia', 'motivoOutro', 'descricaoProblema', 'responsavel', 'observacoesPre', 'checklistPre', 'imagensPre'];
             const chavesEsperadasPos = ['id', 'observacoesPos', 'checklistPos', 'imagensPos'];
             const chavesEsperadas = isPreForm ? chavesEsperadasPre : chavesEsperadasPos;

             chavesEsperadas.forEach(chave => {
                 if (dados[chave] === undefined) {
                     if (chave.startsWith('imagens') || chave.startsWith('checklist')) {
                         dados[chave] = chave.startsWith('imagens') ? [] : {}; // Default para array ou objeto
                     } else {
                         dados[chave] = ''; // Default para string vazia
                     }
                 }
             });


            // console.log("Dados do formulário obtidos:", formId, JSON.stringify(dados)); // Debug
            return dados;
        }


        /**
         * Configura os listeners para os selects dinâmicos de tipo e placa/equipamento.
         */
        function configurarSelectsEquipamentos() {
            const tipoEquipSelect = document.getElementById('pre-tipo-equipamento');
            const placaSelect = document.getElementById('pre-placa-select');
            const placaOutroInput = document.getElementById('pre-placa-outro-valor');
            const hiddenPlaca = document.getElementById('pre-placa');
            const hiddenModelo = document.getElementById('pre-modelo');
             const placaValidationFeedback = document.getElementById('placaValidationFeedback'); // Feedback de validação

            if (!tipoEquipSelect || !placaSelect || !placaOutroInput || !hiddenPlaca || !hiddenModelo || !placaValidationFeedback) {
                console.warn("Elementos dos selects dinâmicos não encontrados. Funcionalidade comprometida.");
                return;
            }

            // --- Listener para mudança no TIPO de equipamento ---
            tipoEquipSelect.addEventListener('change', function() {
                 const tipoSelecionado = this.value;
                 // Limpa e reseta campos dependentes
                 placaSelect.innerHTML = '<option value="">Selecione o Equipamento...</option>';
                 placaSelect.value = '';
                 placaSelect.style.display = 'none';
                 placaSelect.required = false; // Reset required
                 placaOutroInput.style.display = 'none';
                 placaOutroInput.required = false;
                 placaOutroInput.value = '';
                 hiddenPlaca.value = '';
                 hiddenModelo.value = '';
                 // Limpa validação
                  placaSelect.classList.remove('is-invalid');
                  placaOutroInput.classList.remove('is-invalid');


                 if (tipoSelecionado) {
                     // Busca opções de placa/equipamento para o tipo selecionado (do objeto local)
                     const opcoesPlaca = equipamentosData[tipoSelecionado] || [];

                     if (opcoesPlaca.length > 1 || (opcoesPlaca.length === 1 && opcoesPlaca[0] !== 'OUTRO EQUIPAMENTO')) { // Verifica se há opções além de 'OUTRO'
                         // Preenche o select de placas
                         opcoesPlaca.forEach(placa => {
                             if (!placa) return;
                             const option = document.createElement('option');
                             option.value = placa;
                             option.textContent = placa;
                             placaSelect.appendChild(option);
                         });
                         placaSelect.style.display = 'block';
                         placaSelect.required = true; // Select é obrigatório
                     } else {
                         // Se não há opções ou só tem 'OUTRO', mostra direto o input de texto
                         placaOutroInput.style.display = 'block';
                         placaOutroInput.required = true; // Input é obrigatório
                         placaOutroInput.focus();
                     }
                 }
                 // Atualiza hidden (necessário mesmo se nada for selecionado ainda)
                 hiddenPlaca.value = '';
                 hiddenModelo.value = '';

            });

            // --- Listener para mudança na PLACA/EQUIPAMENTO selecionado ---
            placaSelect.addEventListener('change', function() {
                 const placaSelecionada = this.value;
                 hiddenPlaca.value = placaSelecionada; // Atualiza hidden

                 if (placaSelecionada === 'OUTRO EQUIPAMENTO') {
                     placaOutroInput.style.display = 'block';
                     placaOutroInput.required = true;
                     placaOutroInput.value = '';
                     placaOutroInput.focus();
                     hiddenPlaca.value = ''; // Limpa hidden temporariamente
                     hiddenModelo.value = 'Outro';
                 } else if (placaSelecionada) {
                     // Se selecionou uma placa específica
                     placaOutroInput.style.display = 'none';
                     placaOutroInput.required = false;
                     placaOutroInput.value = '';
                     // Tenta encontrar o modelo (se a lista 'equipamentos' fosse carregada da API)
                     // hiddenModelo.value = equipamentos.find(eq => eq.Placa === placaSelecionada)?.Modelo || '';
                     hiddenModelo.value = ''; // Deixa modelo vazio por enquanto
                 } else {
                     // Se voltou para "Selecione..."
                     placaOutroInput.style.display = 'none';
                     placaOutroInput.required = false;
                     hiddenPlaca.value = '';
                     hiddenModelo.value = '';
                 }
                  // Limpa validação ao mudar
                  placaSelect.classList.remove('is-invalid');
                  placaOutroInput.classList.remove('is-invalid');
            });

            // --- Listener para digitação no input de "Outro Equipamento" ---
            placaOutroInput.addEventListener('input', function() {
                 hiddenPlaca.value = this.value.trim();
                 hiddenModelo.value = 'Outro';
                 // Limpa validação ao digitar
                  placaOutroInput.classList.remove('is-invalid');
            });
        }

        // --- Funções do Dashboard --- (Manter as mesmas: carregarDashboard, carregarGraficoTipos, carregarGraficoCategorias, carregarGraficoTempoMedio, carregarGraficoPeriodo)
        /**
         * Carrega e atualiza os dados da tela de Dashboard.
         */
        async function carregarDashboard() {
            mostrarAlerta('Carregando dashboard...', 'Aguarde', 'aguarde');
             try {
                 const resDashboard = await apiRequest('obterDadosDashboard');


                 if (!resDashboard || !resDashboard.success) {
                      modals.alert.hide(); // Esconde "Aguarde" antes de mostrar erro
                      mostrarAlerta('Erro ao carregar dados do dashboard: ' + (resDashboard?.message || 'Erro desconhecido'), 'Erro', 'erro');
                     return;
                 }

                 const data = resDashboard.dados || {}; // Assume que os dados estão em 'dados'

                 // --- Atualizar Contadores ---
                 const contadoresStatus = data.contadores?.statusManutencao || {};
                 document.getElementById('total-equipamentos').textContent = data.statusEquipamentos?.total ?? '0';
                 document.getElementById('total-aguardando').textContent = contadoresStatus[STATUS_AGUARDANDO] ?? '0';
                 document.getElementById('total-em-manutencao').textContent = contadoresStatus[STATUS_EM_MANUTENCAO] ?? '0';
                 const totalConcluidas = (contadoresStatus[STATUS_CONCLUIDO] ?? 0) + (contadoresStatus[STATUS_DISPONIVEL] ?? 0);
                 document.getElementById('total-concluidas').textContent = totalConcluidas;


                 // --- Manutenções Recentes ---
                 const listaRecentes = document.getElementById('manutencoes-recentes');
                 listaRecentes.innerHTML = ''; // Limpa antes de adicionar
                 if (!data.manutencoesRecentes || data.manutencoesRecentes.length === 0) {
                     listaRecentes.innerHTML = '<li class="list-group-item text-center text-muted small p-3">Nenhuma manutenção recente</li>';
                 } else {
                     data.manutencoesRecentes.slice(0, 5).forEach(manutencao => { // Limita a 5 recentes
                         const statusClass = getStatusClass(manutencao.status || '');
                         const dataFormatada = formatarData(manutencao.dataCriacao);

                         const item = document.createElement('li');
                         item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center py-2 px-3'; // Padding menor
                         item.style.cursor = 'pointer';
                         item.onclick = () => visualizarManutencao(manutencao.id);

                         const divInfo = document.createElement('div');
                         divInfo.innerHTML = `
                             <strong class="d-block">${manutencao.placa || 'Sem Placa'}</strong>
                             <small class="text-muted">${manutencao.tipoEquipamento || 'N/A'} - ${dataFormatada}</small>
                         `;

                         const badgeStatus = document.createElement('span');
                         badgeStatus.className = `badge ${statusClass} status-badge`;
                         badgeStatus.textContent = manutencao.status || 'N/A';

                         item.appendChild(divInfo);
                         item.appendChild(badgeStatus);
                         listaRecentes.appendChild(item);
                     });
                 }

                 // --- Atividade Recente ---
                 const listaAtividade = document.getElementById('atividade-recente');
                 listaAtividade.innerHTML = '';
                 if (!data.atividadeRecente || data.atividadeRecente.length === 0) {
                     listaAtividade.innerHTML = '<li class="list-group-item text-center text-muted small p-3">Nenhuma atividade registrada</li>';
                 } else {
                     data.atividadeRecente.slice(0, 7).forEach(atividade => { // Limita a 7 atividades
                         const dataFormatada = formatarDataHora(atividade.data);
                         const item = document.createElement('li');
                         item.className = 'list-group-item py-2 px-3'; // Padding menor

                         const row = document.createElement('div');
                         row.className = 'd-flex align-items-start';

                         const avatar = document.createElement('div');
                         avatar.className = 'avatar bg-light text-secondary me-2 flex-shrink-0';
                         const iconClass = getIconForStatusChange(atividade.statusNovo); // Função auxiliar para ícone
                         avatar.innerHTML = `<i class="bi ${iconClass}"></i>`;

                         const content = document.createElement('div');
                         content.innerHTML = `
                             <div class="small"><strong>${atividade.placa || 'Sem Placa'}</strong>: Status alterado</div>
                             <div class="small"><span class="badge ${getStatusClass(atividade.statusAnterior)} status-badge small">${atividade.statusAnterior || 'Novo'}</span> <i class="bi bi-arrow-right-short"></i> <span class="badge ${getStatusClass(atividade.statusNovo)} status-badge small">${atividade.statusNovo || 'N/A'}</span></div>
                             <div class="text-muted small mt-1" style="font-size: 0.75rem;"><i class="bi bi-clock me-1"></i>${dataFormatada}</div>
                         `;

                         row.appendChild(avatar);
                         row.appendChild(content);
                         item.appendChild(row);
                         listaAtividade.appendChild(item);
                     });
                 }

                // --- Carregar Gráficos ---
                if (graficoTipos) graficoTipos.destroy();
                if (graficoCategorias) graficoCategorias.destroy();
                if (graficoTempoMedio) graficoTempoMedio.destroy();
                if (graficoPeriodo) graficoPeriodo.destroy();

                carregarGraficoTipos(data.contadores?.tipoEquipamento || {});
                carregarGraficoCategorias(data.contadores?.categoriaProblema || {});
                carregarGraficoTempoMedio(data.tempoMedioPorTipo || {});
                // Carrega gráfico de período (vai chamar a API específica)
                // É importante que a ação 'obterManutencoesPorPeriodo' exista no doGet do seu Apps Script
                await carregarGraficoPeriodo();


                // --- Status dos Equipamentos ---
                const statusContainer = document.getElementById('status-equipamentos');
                statusContainer.innerHTML = '';
                const statusEquip = data.statusEquipamentos || {};
                const statusMap = {
                    total: { label: 'Total', icon: 'bi-truck', color: 'text-secondary' },
                    disponivel: { label: 'Disponível', icon: 'bi-check-circle-fill', color: 'text-success' },
                    em_manutencao: { label: 'Em Manutenção', icon: 'bi-tools', color: 'text-primary' },
                    aguardando: { label: 'Aguardando', icon: 'bi-hourglass-split', color: 'text-warning' },
                };

                Object.entries(statusMap).forEach(([key, config]) => {
                    const count = statusEquip[key] ?? 0;
                    const col = document.createElement('div');
                    col.className = 'col-lg-3 col-md-6 col-6 mb-3'; // Ajuste responsivo
                    col.innerHTML = `
                        <div class="text-center p-3 bg-white rounded shadow-sm h-100 d-flex flex-column justify-content-center align-items-center">
                             <i class="bi ${config.icon} display-6 mb-2 ${config.color}"></i>
                            <h4 class="mb-1 fw-bold">${count}</h4>
                            <small class="text-muted text-uppercase" style="font-size: 0.75rem;">${config.label}</small>
                        </div>
                    `;
                    statusContainer.appendChild(col);
                });

                 modals.alert.hide(); // Esconde "Aguarde" APÓS tudo carregar

             } catch (error) {
                  if (modals.alert) modals.alert.hide(); // Garante que fecha o modal de aguarde
                 console.error('Erro ao carregar dashboard:', error);
                 mostrarAlerta(`Erro ao carregar dashboard: ${error.message}`, 'Erro', 'erro');
             }
        }

        /** Retorna um ícone Bootstrap baseado no status (para Atividade Recente) */
        function getIconForStatusChange(status) {
            switch (status) {
                case STATUS_CONCLUIDO:
                case STATUS_DISPONIVEL:
                    return 'bi-check-lg text-success';
                case STATUS_EM_MANUTENCAO:
                    return 'bi-tools text-primary';
                case STATUS_AGUARDANDO:
                    return 'bi-hourglass-split text-warning';
                default:
                    return 'bi-pencil-fill text-secondary'; // Edição genérica
            }
        }


        /** Carrega o gráfico de barras para Tipos de Equipamento */
        function carregarGraficoTipos(dados) {
            const container = document.getElementById('grafico-tipos');
            if (!container) return;
            container.innerHTML = '<canvas id="chart-tipos"></canvas>';
            const ctx = document.getElementById('chart-tipos')?.getContext('2d');
            if (!ctx) {
                 console.error("Canvas 'chart-tipos' não encontrado.");
                 container.innerHTML = '<p class="text-center text-muted mt-3 small">Erro ao carregar gráfico.</p>';
                 return;
            }
             if (!dados || Object.keys(dados).length === 0) {
                container.innerHTML = '<p class="text-center text-muted mt-3 small">Sem dados de tipos para exibir.</p>';
                return;
            }

            const labels = Object.keys(dados);
            const dataValues = Object.values(dados);
             const backgroundColors = Chart.helpers.color; // Usa helper do Chart.js se disponível ou define manualmente
             const colors = [
                 'rgba(54, 162, 235, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(75, 192, 192, 0.6)',
                 'rgba(255, 206, 86, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)'
                 ];

            graficoTipos = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Manutenções',
                        data: dataValues,
                        backgroundColor: labels.map((_, i) => colors[i % colors.length]), // Cicla cores
                        borderColor: labels.map((_, i) => colors[i % colors.length].replace('0.6','1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Barras horizontais para melhor leitura de labels longos
                    scales: {
                        x: { beginAtZero: true, ticks: { precision: 0 } }, // Garante números inteiros no eixo X
                        y: { ticks: { autoSkip: false } } // Evita pular labels no eixo Y
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Manutenções por Tipo de Equipamento' }
                    }
                }
            });
        }

        /** Carrega o gráfico de pizza para Categorias de Problema */
        function carregarGraficoCategorias(dados) {
             const container = document.getElementById('grafico-categorias');
             if (!container) return;
             container.innerHTML = '<canvas id="chart-categorias"></canvas>';
             const ctx = document.getElementById('chart-categorias')?.getContext('2d');
              if (!ctx) {
                 console.error("Canvas 'chart-categorias' não encontrado.");
                 container.innerHTML = '<p class="text-center text-muted mt-3 small">Erro ao carregar gráfico.</p>';
                 return;
             }
             if (!dados || Object.keys(dados).length === 0) {
                 container.innerHTML = '<p class="text-center text-muted mt-3 small">Sem dados de categorias para exibir.</p>';
                 return;
             }

            const labels = Object.keys(dados);
            const dataValues = Object.values(dados);
             const colors = [
                 'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
                 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
                 'rgba(201, 203, 207, 0.7)'
             ];

            graficoCategorias = new Chart(ctx, {
                type: 'doughnut', // Usar doughnut é visualmente melhor que pie muitas vezes
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Categorias',
                        data: dataValues,
                         backgroundColor: labels.map((_, i) => colors[i % colors.length]),
                         borderColor: '#fff', // Borda branca para separar fatias
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { padding: 15 } }, // Legenda abaixo com padding
                        title: { display: true, text: 'Distribuição por Categoria de Problema' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    const value = context.parsed || 0;
                                     const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                     const percentage = total > 0 ? ((value / total) * 100).toFixed(1) + '%' : '0%';
                                    label += `${value} (${percentage})`;
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        /** Carrega o gráfico de tempo médio de manutenção por tipo */
        function carregarGraficoTempoMedio(dados) {
             const container = document.getElementById('grafico-tempo-medio');
             if (!container) return;
             container.innerHTML = '<canvas id="chart-tempo-medio"></canvas>';
             const ctx = document.getElementById('chart-tempo-medio')?.getContext('2d');
              if (!ctx) {
                 console.error("Canvas 'chart-tempo-medio' não encontrado.");
                 container.innerHTML = '<p class="text-center text-muted mt-3 small">Erro ao carregar gráfico.</p>';
                 return;
             }
              if (!dados || Object.keys(dados).length === 0) {
                  container.innerHTML = '<p class="text-center text-muted mt-3 small">Sem dados de tempo médio para exibir.</p>';
                 return;
             }

            const labels = Object.keys(dados);
            const dataValues = labels.map(label => dados[label]?.mediaHoras ?? 0);
             const colors = [
                 'rgba(255, 159, 64, 0.6)', 'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)',
                 'rgba(54, 162, 235, 0.6)', 'rgba(255, 99, 132, 0.6)', 'rgba(255, 206, 86, 0.6)'
                 ];

            graficoTempoMedio = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tempo Médio (horas)',
                        data: dataValues,
                        backgroundColor: labels.map((_, i) => colors[i % colors.length]),
                        borderColor: labels.map((_, i) => colors[i % colors.length].replace('0.6','1')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Horas' }
                         }
                    },
                    plugins: {
                        legend: { display: false },
                         title: { display: true, text: 'Tempo Médio de Manutenção por Tipo' },
                        tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     let label = context.dataset.label || '';
                                     if (label) label += ': ';
                                      const horas = context.parsed.y || 0;
                                      label += `${horas.toFixed(1)}h`;
                                     // Adiciona contagem
                                     const contagem = dados[context.label]?.contagem;
                                     if (contagem) label += ` (${contagem} regs)`;
                                     return label;
                                 }
                             }
                         }
                    }
                }
            });
        }

        /** Carrega o gráfico de linha de manutenções por período */
        async function carregarGraficoPeriodo() {
            const diasSelect = document.getElementById('filtro-periodo-grafico');
            const dias = parseInt(diasSelect?.value || '30');
            const container = document.getElementById('grafico-periodo');
            if (!container) return;

            container.innerHTML = '<div class="text-center mt-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>';

             try {
                 // Ação no backend: obterManutencoesPorPeriodo
                 const res = await apiRequest('obterManutencoesPorPeriodo', { dias: dias });

                 if (!res || !res.success) {
                     // Usa a mensagem de erro do backend, se disponível
                     throw new Error(res?.message || "Erro ao buscar dados do período.");
                 }

                 container.innerHTML = '<canvas id="chart-periodo"></canvas>';
                 const ctx = document.getElementById('chart-periodo')?.getContext('2d');
                 if (!ctx) throw new Error("Elemento canvas 'chart-periodo' não encontrado.");

                 const dados = res.dados || {}; // Ex: { '2023-10-20': 5, '2023-10-21': 3, ... }
                 const labels = Object.keys(dados).sort(); // Ordena as datas
                 const dataValues = labels.map(label => dados[label]);

                 if (labels.length === 0) {
                     container.innerHTML = '<p class="text-center text-muted mt-3 small">Nenhuma manutenção encontrada no período.</p>';
                     return;
                 }

                 graficoPeriodo = new Chart(ctx, {
                     type: 'line',
                     data: {
                         labels: labels.map(l => formatarData(l)), // Formata data para exibição
                         datasets: [{
                             label: `Manutenções Diárias`,
                             data: dataValues,
                             fill: true,
                             borderColor: 'rgb(75, 192, 192)',
                             backgroundColor: 'rgba(75, 192, 192, 0.2)',
                             tension: 0.2, // Linha levemente curvada
                             pointBackgroundColor: 'rgb(75, 192, 192)',
                             pointRadius: 3,
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         scales: {
                             y: { beginAtZero: true, ticks: { precision: 0 } } // Eixo Y com inteiros
                         },
                         plugins: {
                            legend: { display: false },
                             title: { display: true, text: `Manutenções nos Últimos ${dias} Dias` }
                         }
                     }
                 });

             } catch (error) {
                 console.error("Erro ao carregar gráfico de período:", error);
                 container.innerHTML = `<p class="text-center text-danger mt-3 small"><i class="bi bi-exclamation-triangle me-1"></i> Erro: ${error.message}</p>`;
             }
        }


        // --- Funções da Lista de Manutenções --- (Manter as mesmas: carregarListaManutencoes, adicionarListenersAcoesLista)
         /**
         * Carrega e exibe a lista de manutenções, aplicando filtros.
         */
        async function carregarListaManutencoes() {
            const filtroStatus = document.getElementById('filtro-status')?.value || '';
            const filtroPlaca = document.getElementById('filtro-placa')?.value.trim() || '';
            const tbody = document.getElementById('lista-manutencoes');
            const semRegistrosDiv = document.getElementById('sem-registros');

            if (!tbody || !semRegistrosDiv) return;

            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></td></tr>';
            semRegistrosDiv.style.display = 'none';

             try {
                 const res = await apiRequest('listarManutencoes', {
                     status: filtroStatus,
                     placa: filtroPlaca
                 });

                 if (!res || !res.success) {
                     throw new Error(res.message || 'Erro ao carregar lista de manutenções');
                 }

                 manutencoes = res.manutencoes || []; // Atualiza a lista global
                 tbody.innerHTML = ''; // Limpa a tabela

                 if (manutencoes.length === 0) {
                     semRegistrosDiv.style.display = 'block';
                 } else {
                     semRegistrosDiv.style.display = 'none';
                     manutencoes.forEach(manutencao => {
                         const tr = document.createElement('tr');
                         const statusClass = getStatusClass(manutencao.Status || '');
                         const dataFormatada = formatarData(manutencao.Data_Criacao);

                         // Adiciona data-label para responsividade CSS
                         tr.innerHTML = `
                             <td data-label="Placa">${manutencao.Placa || 'N/A'}</td>
                             <td data-label="Tipo">${manutencao.Tipo_Equipamento || 'N/A'}</td>
                             <td data-label="Data">${dataFormatada}</td>
                             <td data-label="Status"><span class="badge ${statusClass} status-badge">${manutencao.Status || 'N/A'}</span></td>
                             <td>
                                 <div class="btn-group btn-group-sm" role="group"> <!-- Grupo de botões -->
                                     <button class="btn btn-outline-primary btn-visualizar" title="Visualizar" data-id="${manutencao.ID}">
                                         <i class="bi bi-eye-fill"></i><span class="visually-hidden">Visualizar</span>
                                     </button>
                                     <button class="btn btn-outline-secondary btn-editar" title="Editar" data-id="${manutencao.ID}">
                                         <i class="bi bi-pencil-fill"></i><span class="visually-hidden">Editar</span>
                                     </button>
                                     <button class="btn btn-outline-danger btn-excluir" title="Excluir" data-id="${manutencao.ID}">
                                         <i class="bi bi-trash-fill"></i><span class="visually-hidden">Excluir</span>
                                     </button>
                                 </div>
                             </td>
                         `;
                         tbody.appendChild(tr);
                     });

                     adicionarListenersAcoesLista();
                 }

             } catch (error) {
                 console.error('Erro ao carregar lista de manutenções:', error);
                 tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">Erro ao carregar dados: ${error.message}</td></tr>`;
                 semRegistrosDiv.style.display = 'none';
             }
        }

        /**
         * Adiciona event listeners aos botões de ação (visualizar, editar, excluir) da lista.
         */
        function adicionarListenersAcoesLista() {
            // Remove listeners antigos para evitar duplicação (importante se a tabela for recarregada)
            const container = document.getElementById('lista-manutencoes');
             if (!container) return;

             container.removeEventListener('click', handleListaAcoesClick); // Remove listener anterior se existir
             container.addEventListener('click', handleListaAcoesClick); // Adiciona novo listener
        }

        /** Handler unificado para cliques nos botões da lista */
        function handleListaAcoesClick(event) {
             const button = event.target.closest('button'); // Encontra o botão clicado, mesmo se clicar no ícone
             if (!button) return; // Sai se o clique não foi em um botão

             const id = button.dataset.id;
             if (!id) return; // Sai se o botão não tiver data-id

             if (button.classList.contains('btn-visualizar')) {
                 visualizarManutencao(id);
             } else if (button.classList.contains('btn-editar')) {
                 editarManutencao(id);
             } else if (button.classList.contains('btn-excluir')) {
                 excluirManutencao(id);
             }
        }


        // --- Funções CRUD (Visualizar, Editar, Excluir) --- (Manter as mesmas: visualizarManutencao, preencherChecklistVisualizacao, preencherImagensVisualizacao, editarManutencao, excluirManutencao)

        /**
         * Carrega e exibe os detalhes de uma manutenção específica na tela de visualização.
         * @param {string} id ID da manutenção.
         */
        async function visualizarManutencao(id) {
             if (!id) return;
             mostrarAlerta('Carregando detalhes da manutenção...', 'Aguarde', 'aguarde');

             try {
                 const res = await apiRequest('obterManutencao', { id: id });

                 if (!res || !res.success || !res.manutencao) {
                     throw new Error(res.message || 'Manutenção não encontrada ou erro ao carregar.');
                 }

                 manutencaoAtual = res.manutencao; // Armazena na variável global
                 const manut = manutencaoAtual;

                 // --- Preencher Campos Gerais ---
                 document.getElementById('view-id').textContent = manut.ID || 'N/A';
                 document.getElementById('view-data-criacao').textContent = formatarDataHora(manut.Data_Criacao);
                 const statusBadge = document.getElementById('view-status');
                 statusBadge.textContent = manut.Status || 'N/A';
                 statusBadge.className = `badge fs-6 ${getStatusClass(manut.Status || '')} status-badge`; // Atualiza classe e tamanho
                 document.getElementById('view-responsavel').textContent = manut.Responsavel || 'N/A';
                 document.getElementById('view-placa').textContent = manut.Placa || 'N/A';
                 document.getElementById('view-tipo-equipamento').textContent = manut.Tipo_Equipamento || 'N/A';

                 // --- Preencher Detalhes do Problema ---
                 document.getElementById('view-categoria-problema').textContent = manut.Categoria_Problema || 'N/A';
                 document.getElementById('view-urgencia').textContent = manut.Urgencia || 'N/A';
                 const motivoOutroContainer = document.getElementById('view-motivo-outro-container');
                 if (manut.Categoria_Problema === 'Outro' && manut.Motivo_Outro) {
                     document.getElementById('view-motivo-outro').textContent = manut.Motivo_Outro;
                     motivoOutroContainer.style.display = 'block';
                 } else {
                     motivoOutroContainer.style.display = 'none';
                 }
                 document.getElementById('view-descricao-problema').textContent = manut.Descricao_Problema || 'Nenhuma descrição fornecida.';

                  // --- Abas Pré/Pós ---
                 const preTabPane = document.getElementById('pre-tab-pane');
                 const posTabPane = document.getElementById('pos-tab-pane');
                 const posTabButton = document.getElementById('pos-tab'); // Botão da aba Pós

                 // Preencher Pré-Manutenção (Sempre visível)
                 preencherChecklistVisualizacao(document.getElementById('view-checklist-pre'), manut.Checklist_Pre);
                 document.getElementById('view-observacoes-pre').textContent = manut.Observacoes_Pre || 'Nenhuma observação registrada.';
                 preencherImagensVisualizacao(document.getElementById('view-imagens-pre'), manut.Imagens_Pre);

                 // Preencher e Habilitar/Desabilitar Pós-Manutenção
                 const isPosRelevant = manut.Status === STATUS_CONCLUIDO || manut.Status === STATUS_DISPONIVEL || manut.Data_Manutencao;

                 if (isPosRelevant) {
                      document.getElementById('view-data-manutencao').textContent = formatarDataHora(manut.Data_Manutencao) || 'Não registrada';
                      preencherChecklistVisualizacao(document.getElementById('view-checklist-pos'), manut.Checklist_Pos);
                      document.getElementById('view-observacoes-pos').textContent = manut.Observacoes_Pos || 'Nenhuma observação registrada.';
                      preencherImagensVisualizacao(document.getElementById('view-imagens-pos'), manut.Imagens_Pos);
                      posTabButton.disabled = false; // Habilita a aba Pós
                      posTabButton.classList.remove('disabled'); // Remove classe visualmente
                 } else {
                      // Limpa campos Pós e desabilita aba
                       document.getElementById('view-data-manutencao').textContent = '---';
                       document.getElementById('view-checklist-pos').innerHTML = '<p class="text-muted small">Manutenção ainda não concluída.</p>';
                       document.getElementById('view-observacoes-pos').textContent = '---';
                       document.getElementById('view-imagens-pos').innerHTML = '<p class="text-muted small">Nenhuma imagem pós-manutenção.</p>';
                      posTabButton.disabled = true;
                      posTabButton.classList.add('disabled');
                       // Garante que a aba Pré esteja ativa se a Pós for desabilitada
                       bootstrap.Tab.getOrCreateInstance(document.getElementById('pre-tab')).show();
                 }


                 // --- Configurar Botões de Status ---
                 document.querySelectorAll('#tela-visualizacao .btn-status').forEach(btn => {
                     btn.disabled = (btn.dataset.status === manut.Status);
                 });

                 modals.alert.hide(); // Esconde "Aguarde"
                 mostrarTela('visualizacao'); // Mostra a tela de visualização

             } catch (error) {
                 modals.alert.hide();
                 console.error(`Erro ao visualizar manutenção ${id}:`, error);
                 mostrarAlerta(`Erro ao carregar detalhes: ${error.message}`, 'Erro', 'erro');
                 mostrarTela('lista'); // Volta para a lista em caso de erro
             }
        }

        /**
         * Preenche a área de checklist na tela de visualização.
         * @param {HTMLElement} container Elemento onde o checklist será inserido.
         * @param {object} checklistData Objeto com os dados do checklist { Item: Valor }.
         */
        function preencherChecklistVisualizacao(container, checklistData) {
            if (!container) return;
            container.innerHTML = ''; // Limpa

            if (!checklistData || typeof checklistData !== 'object' || Object.keys(checklistData).length === 0) {
                container.innerHTML = '<p class="text-muted fst-italic small">Nenhum item de checklist respondido.</p>';
                return;
            }

            const list = document.createElement('ul');
            list.className = 'list-group list-group-flush'; // Estilo de lista

            // Ordena os itens do checklist para exibição consistente (opcional)
             const sortedItems = Object.keys(checklistData).sort();

            sortedItems.forEach(item => {
                const valor = checklistData[item];
                if (!item) return; // Pula itens sem nome

                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center py-2 px-0 border-bottom'; // Padding e borda

                const spanItem = document.createElement('span');
                 spanItem.textContent = item;
                 spanItem.className = 'me-3'; // Margem direita

                const spanValor = document.createElement('span');
                let badgeClass = 'bg-secondary';
                let iconClass = 'bi-question-circle';
                switch (String(valor).toUpperCase()) {
                    case 'OK':
                        badgeClass = 'bg-success-light text-success-emphasis'; // Usa cores light de BS5.3
                        iconClass = 'bi-check-circle-fill';
                        break;
                    case 'DANIFICADO':
                        badgeClass = 'bg-danger-light text-danger-emphasis';
                        iconClass = 'bi-exclamation-triangle-fill';
                        break;
                    case 'N/A':
                        badgeClass = 'bg-secondary-light text-secondary-emphasis';
                        iconClass = 'bi-slash-circle-fill';
                        break;
                }
                // Usa badge com texto claro se o fundo for escuro (opcional, depende das cores light)
                spanValor.className = `badge ${badgeClass} rounded-pill px-2 py-1 fw-normal`; // Padding e fonte normais
                spanValor.innerHTML = `<i class="bi ${iconClass} me-1"></i>${valor || 'N/A'}`;

                li.appendChild(spanItem);
                li.appendChild(spanValor);
                list.appendChild(li);
            });
            container.appendChild(list);
        }

        /**
         * Preenche a área de imagens na tela de visualização.
         * @param {HTMLElement} container Elemento onde as imagens serão inseridas.
         * @param {Array<{url: string, id: string, timestamp?: string}>} imagens Array de objetos de imagem.
         */
        function preencherImagensVisualizacao(container, imagens) {
            if (!container) return;
            container.innerHTML = ''; // Limpa

            if (!Array.isArray(imagens) || imagens.length === 0) {
                container.innerHTML = '<p class="text-muted fst-italic small">Nenhuma imagem registrada.</p>';
                // Remove placeholder se existir
                 const placeholder = container.querySelector('.placeholder-imagem');
                 if(placeholder) placeholder.remove();
                return;
            }
             // Remove placeholder se existir
             const placeholder = container.querySelector('.placeholder-imagem');
             if(placeholder) placeholder.remove();


            imagens.forEach(imgData => {
                if (!imgData || !imgData.url) return;

                const imgContainer = document.createElement('a'); // Usar link para abrir direto
                imgContainer.href = imgData.url;
                imgContainer.target = '_blank'; // Abrir em nova aba
                imgContainer.className = 'image-container position-relative d-inline-block me-2 mb-2 text-decoration-none';
                 imgContainer.title = `Imagem ${imgData.id || ''}\nData: ${formatarDataHora(imgData.timestamp) || 'N/A'}`; // Tooltip com info

                const img = document.createElement('img');
                img.src = imgData.url; // Idealmente, usar URL de thumbnail se disponível no backend
                img.alt = `Imagem ${imgData.id || ''}`;
                img.className = 'img-thumbnail photo-preview-img shadow-sm'; // Adiciona sombra
                img.loading = 'lazy';

                // Opcional: Adicionar timestamp visualmente discreto
                // const timestampDiv = document.createElement('div');
                // timestampDiv.className = 'small text-muted text-center mt-1' style='font-size: 0.7rem;';
                // timestampDiv.textContent = formatarDataHora(imgData.timestamp);

                imgContainer.appendChild(img);
                // imgContainer.appendChild(timestampDiv);
                container.appendChild(imgContainer);
            });
        }


        /**
         * Carrega os dados de uma manutenção no formulário Pré para edição.
         * @param {string} id ID da manutenção.
         */
        async function editarManutencao(id) {
            if (!id) return;
             mostrarAlerta('Carregando dados para edição...', 'Aguarde', 'aguarde');

             try {
                 const res = await apiRequest('obterManutencao', { id: id });

                 if (!res || !res.success || !res.manutencao) {
                     throw new Error(res.message || 'Manutenção não encontrada para edição');
                 }
                 manutencaoAtual = res.manutencao; // Armazena na variável global
                 const manut = manutencaoAtual;
                 modals.alert.hide(); // Esconde "Aguarde" APÓS buscar dados

                 // --- Limpar Formulário Pré ANTES de preencher ---
                 const formPre = document.getElementById('form-pre-manutencao');
                 if(formPre) formPre.reset();
                 document.getElementById('motivo-outro-container').style.display = 'none';
                 document.getElementById('imagens-preview-pre').innerHTML = '';
                 // Limpa placeholders de imagem
                  const placeholderPre = document.getElementById('imagens-preview-pre-placeholder');
                  if(placeholderPre) placeholderPre.style.display = 'block';

                 imagenesPreUpload = []; // Limpa array global pré
                 imagenesPosUpload = Array.isArray(manut.Imagens_Pos) ? [...manut.Imagens_Pos] : []; // Preserva imagens PÓS existentes ao editar PRE

                 // Resetar selects de placa
                 const placaSelect = document.getElementById('pre-placa-select');
                 const placaOutroInput = document.getElementById('pre-placa-outro-valor');
                 if(placaSelect) {
                     placaSelect.innerHTML = '<option value="">Selecione o Equipamento...</option>';
                     placaSelect.style.display = 'none';
                     placaSelect.required = false;
                      placaSelect.classList.remove('is-invalid');
                 }
                  if(placaOutroInput) {
                     placaOutroInput.style.display = 'none';
                     placaOutroInput.value = '';
                     placaOutroInput.required = false;
                      placaOutroInput.classList.remove('is-invalid');
                  }
                   // Limpa validações de outros campos
                   formPre?.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));


                 // --- Preencher Formulário Pré com dados da manutenção ---
                 document.getElementById('pre-id').value = manut.ID || '';
                 document.getElementById('pre-tipo-equipamento').value = manut.Tipo_Equipamento || '';

                 // Disparar evento 'change' no tipo para carregar as placas corretas
                 document.getElementById('pre-tipo-equipamento').dispatchEvent(new Event('change'));

                 // Aguardar um instante para o select de placa ser preenchido (se aplicável)
                 await new Promise(resolve => setTimeout(resolve, 150)); // Aumentar delay ligeiramente

                 // Tenta selecionar a placa ou preencher o 'outro' (Refatorado)
                 const hiddenPlaca = document.getElementById('pre-placa');
                 const hiddenModelo = document.getElementById('pre-modelo');
                 let placaEncontradaNoSelect = false;

                 if (placaSelect && manut.Placa) {
                      // Tenta encontrar a placa exata nas opções do select
                      for (let option of placaSelect.options) {
                          if (option.value === manut.Placa) {
                              placaSelect.value = manut.Placa;
                              placaEncontradaNoSelect = true;
                              break;
                          }
                      }
                      // Se não encontrou a placa exata E o input de "outro" existe,
                      // assume que era um valor digitado e seleciona 'OUTRO EQUIPAMENTO'
                      if (!placaEncontradaNoSelect && placaOutroInput && placaSelect.querySelector('option[value="OUTRO EQUIPAMENTO"]')) {
                          placaSelect.value = 'OUTRO EQUIPAMENTO';
                      }
                      // Dispara o evento change do select de placa para mostrar/esconder o input de texto corretamente
                       placaSelect.dispatchEvent(new Event('change'));
                 }

                  // Se a placa não foi encontrada no select (ou não havia select), preenche o input 'outro'
                  if (!placaEncontradaNoSelect && placaOutroInput && manut.Placa) {
                      placaOutroInput.value = manut.Placa;
                      // Garante que o input esteja visível se ele tiver valor
                      if(placaOutroInput.value) {
                           placaOutroInput.style.display = 'block';
                           placaOutroInput.required = true;
                      }
                  }


                 // Atualiza os hiddens com os valores carregados
                 if (hiddenPlaca) hiddenPlaca.value = manut.Placa || '';
                 if (hiddenModelo) hiddenModelo.value = manut.Modelo || '';


                 document.getElementById('pre-categoria-problema').value = manut.Categoria_Problema || '';
                 document.getElementById('pre-urgencia').value = manut.Urgencia || '';
                 // Mostrar/preencher 'Outro Motivo' se necessário
                 const motivoOutroInput = document.getElementById('pre-motivo-outro');
                 const motivoOutroContainer = document.getElementById('motivo-outro-container');
                 if (manut.Categoria_Problema === 'Outro') {
                     motivoOutroInput.value = manut.Motivo_Outro || '';
                     motivoOutroContainer.style.display = 'block';
                     motivoOutroInput.required = true;
                 } else {
                      motivoOutroContainer.style.display = 'none';
                      motivoOutroInput.required = false;
                 }
                 document.getElementById('pre-descricao-problema').value = manut.Descricao_Problema || '';
                 document.getElementById('pre-responsavel').value = manut.Responsavel || '';
                 document.getElementById('pre-observacoes').value = manut.Observacoes_Pre || '';

                 // --- Preencher Checklist Pré ---
                 const checklistPreContainer = document.getElementById('pre-checklist-container');
                 checklistPreContainer.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                 const checklistPreData = manut.Checklist_Pre || {};
                 Object.entries(checklistPreData).forEach(([item, valor]) => {
                     const radioToCheck = checklistPreContainer.querySelector(`input[type="radio"][data-item="${CSS.escape(item)}"][value="${CSS.escape(valor)}"]`);
                     if (radioToCheck) radioToCheck.checked = true;
                 });

                 // --- Preencher Imagens Pré ---
                 const imagensPreContainer = document.getElementById('imagens-preview-pre');
                 imagenesPreUpload = Array.isArray(manut.Imagens_Pre) ? [...manut.Imagens_Pre] : []; // Carrega no array global
                  if (imagenesPreUpload.length > 0 && placeholderPre) placeholderPre.style.display = 'none'; // Esconde placeholder
                 imagenesPreUpload.forEach(imgData => {
                     if (imgData && imgData.url && imgData.id) {
                         adicionarImagemPreview(imgData.url, 'pre', imgData.id);
                     }
                 });

                 // --- Mostrar tela Pré ---
                 mostrarTela('preManu');

             } catch (error) {
                 if(modals.alert) modals.alert.hide(); // Fecha modal de aguarde
                 console.error(`Erro ao carregar manutenção ${id} para edição:`, error);
                 mostrarAlerta(`Erro ao carregar dados para edição: ${error.message}`, 'Erro', 'erro');
                 mostrarTela('lista');
             }
        }

        /**
         * Exclui uma manutenção após confirmação do usuário.
         * @param {string} id ID da manutenção a ser excluída.
         */
        function excluirManutencao(id) {
            if (!id) return;

            const manutencao = manutencoes.find(m => m.ID === id);
            const placa = manutencao?.Placa || `ID ${id}`;

            mostrarConfirmacao(`Tem certeza que deseja excluir permanentemente a manutenção para "${placa}"? Esta ação não pode ser desfeita e excluirá todos os dados e imagens associadas.`, async () => {
                mostrarAlerta('Excluindo manutenção e arquivos associados...', 'Aguarde', 'aguarde');
                try {
                    // A ação no backend deve cuidar de excluir dados da planilha E arquivos do Drive
                    const res = await apiRequest('excluirManutencao', { id: id });

                    if (!res || !res.success) {
                        throw new Error(res.message || 'Erro desconhecido ao excluir manutenção');
                    }

                    modals.alert.hide(); // Esconde "Aguarde"
                    mostrarAlerta('Manutenção excluída com sucesso!', 'Sucesso', 'sucesso');
                    carregarListaManutencoes(); // Recarrega a lista

                } catch (error) {
                    modals.alert.hide();
                    console.error(`Erro ao excluir manutenção ${id}:`, error);
                    mostrarAlerta(`Erro ao excluir: ${error.message}`, 'Erro Exclusão', 'erro');
                }
            });
        }



        // --- Funções de Câmera e Upload --- (Manter as mesmas: abrirCamera, fecharCamera, capturarImagem, processarGaleria, uploadImagem, salvarAposUploadImagem, adicionarImagemPreviewLoading, removerImagemPreviewLoading, adicionarImagemPreview)
       /**
         * Abre a câmera do dispositivo para captura.
         * @param {'pre'|'pos'} tipo Indica se é para o formulário pré ou pós.
         */
        async function abrirCamera(tipo) {
            const videoElementId = `camera-preview-${tipo}`;
            const containerId = `camera-container-${tipo}`;
            const video = document.getElementById(videoElementId);
            const container = document.getElementById(containerId);

            if (!video || !container) {
                console.error("Elementos da câmera não encontrados para tipo:", tipo);
                mostrarAlerta('Erro interno: Interface da câmera não encontrada.', 'Erro', 'erro');
                return;
            }

            // Fecha câmera anterior, se estiver aberta
            fecharCamera('pre');
            fecharCamera('pos');

            try {
                const constraints = {
                    video: { facingMode: { ideal: "environment" } }, // Prefere traseira
                    audio: false // Não precisa de áudio
                };

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                     mostrarAlerta('Seu navegador não suporta acesso à câmera (getUserMedia). Tente um navegador moderno.', 'Erro de Compatibilidade', 'erro');
                     return;
                }

                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = mediaStream;

                // Espera metadados carregarem para evitar erro de dimensão 0
                 video.onloadedmetadata = () => {
                     video.play().catch(playError => { // Adiciona catch para erro no play
                         console.error("Erro ao iniciar play do vídeo:", playError);
                         mostrarAlerta(`Erro ao iniciar a câmera: ${playError.message}. Verifique permissões ou reinicie o navegador.`, 'Erro Câmera', 'erro');
                         fecharCamera(tipo);
                     });
                     container.style.display = 'block';
                 };
                 video.onerror = (e) => {
                     console.error("Erro no elemento de vídeo:", e);
                     mostrarAlerta("Erro ao exibir o stream da câmera.", "Erro", "erro");
                     fecharCamera(tipo);
                 };

            } catch (err) {
                console.error('Erro ao abrir câmera getUserMedia:', err.name, err.message);
                let errorMsg = `Erro ao abrir câmera: ${err.name}.`;
                 if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                     errorMsg = 'Permissão para acessar a câmera foi negada. Verifique as configurações do navegador/site.';
                 } else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") {
                     errorMsg = 'Nenhuma câmera compatível foi encontrada.';
                 } else if (err.name === "NotReadableError" || err.name === "TrackStartError") {
                     errorMsg = 'Não foi possível acessar a câmera. Pode estar sendo usada por outro app ou houve um erro.';
                 } else if (err.name === "OverconstrainedError" || err.name === "ConstraintNotSatisfiedError") {
                     errorMsg = 'Não foi possível atender aos requisitos da câmera (ex: câmera traseira não disponível).';
                 } else if (err.name === "AbortError") {
                     errorMsg = 'Acesso à câmera foi interrompido.';
                 } else if (err.name === "TypeError") {
                      errorMsg = 'Erro de tipo. Verifique se está usando HTTPS.';
                  }
                mostrarAlerta(errorMsg, 'Erro Câmera', 'erro');
                fecharCamera(tipo);
            }
        }

        /**
         * Fecha a stream da câmera e esconde a interface.
         * @param {'pre'|'pos'} tipo Indica qual interface de câmera fechar.
         */
        function fecharCamera(tipo) {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            const container = document.getElementById(`camera-container-${tipo}`);
            if (container) container.style.display = 'none';
            const video = document.getElementById(`camera-preview-${tipo}`);
            if(video) {
                video.srcObject = null;
                video.pause();
                // video.load(); // load() pode causar problemas em alguns browsers, remover se necessário
            }
        }

        /**
         * Captura um quadro do vídeo da câmera e inicia o upload.
         * @param {'pre'|'pos'} tipo Indica de qual câmera capturar.
         */
        async function capturarImagem(tipo) {
            const video = document.getElementById(`camera-preview-${tipo}`);
            // Verifica se a stream e o vídeo estão ativos e prontos
            if (!mediaStream || !video || video.paused || video.ended || !video.videoWidth || !video.videoHeight || video.readyState < video.HAVE_CURRENT_DATA) {
                 mostrarAlerta("A câmera não está ativa ou pronta para capturar. Tente abrir novamente.", 'Erro Captura', 'erro');
                 fecharCamera(tipo);
                 return;
            }

            const canvas = document.createElement('canvas');
            // Define o tamanho do canvas igual ao do vídeo renderizado
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');

            try {
                 ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                 const base64 = canvas.toDataURL('image/jpeg', 0.85); // Qualidade 85% (bom equilíbrio)

                 fecharCamera(tipo); // Fecha a interface da câmera
                 await uploadImagem(base64, tipo); // Inicia upload

            } catch (e) {
                 console.error('Erro ao capturar ou processar imagem da câmera:', e);
                 mostrarAlerta('Erro ao processar a imagem capturada: ' + e.message, 'Erro', 'erro');
                 fecharCamera(tipo);
            }
        }

        /**
         * Processa a seleção de arquivos da galeria e inicia o upload.
         * @param {Event} event Evento 'change' do input file.
         * @param {'pre'|'pos'} tipo Tipo de formulário.
         */
        function processarGaleria(event, tipo) {
             const files = event.target.files;
             if (!files || files.length === 0) return;

             const MAX_SIZE_MB = 10; // Limite de tamanho em MB
             const MAX_SIZE_BYTES = MAX_SIZE_MB * 1024 * 1024;

             // Processa múltiplos arquivos
             Array.from(files).forEach(file => {
                 if (!file.type.startsWith('image/')) {
                     mostrarAlerta(`Arquivo "${file.name}" não parece ser uma imagem. Selecione apenas arquivos de imagem.`, 'Arquivo Inválido', 'aviso');
                     return;
                 }
                 if (file.size > MAX_SIZE_BYTES) {
                     mostrarAlerta(`Arquivo "${file.name}" (${(file.size / 1024 / 1024).toFixed(1)}MB) excede o limite de ${MAX_SIZE_MB}MB.`, 'Arquivo Grande', 'aviso');
                     return;
                 }

                 const reader = new FileReader();
                 reader.onload = async (e) => {
                     if (e.target && typeof e.target.result === 'string') {
                         await uploadImagem(e.target.result, tipo);
                     } else {
                         console.error("Erro ao ler arquivo, resultado inválido:", file.name);
                         mostrarAlerta(`Erro ao processar o arquivo ${file.name}.`, 'Erro Leitura', 'erro');
                     }
                 };
                 reader.onerror = (err) => {
                     console.error("Erro no FileReader:", file.name, err);
                     mostrarAlerta(`Erro ao ler o arquivo ${file.name}. Verifique o arquivo ou tente novamente.`, 'Erro Leitura', 'erro');
                 }
                 reader.readAsDataURL(file);
             });

             event.target.value = ''; // Limpa o input
        }


        /**
         * Faz o upload de uma imagem (base64) para o backend ou armazena localmente se for novo registro.
         * @param {string} base64 Imagem em formato base64 data URL.
         * @param {'pre'|'pos'} tipo Tipo de formulário.
         */
        async function uploadImagem(base64, tipo) {
             const tempId = `temp-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`;
             adicionarImagemPreviewLoading(tempId, tipo);

             try {
                 // Tenta pegar o ID da manutenção atual ou do campo hidden
                 const idManutencao = manutencaoAtual?.ID || document.getElementById(tipo === 'pre' ? 'pre-id' : 'pos-id')?.value;
                 const isEditing = !!idManutencao;

                 // 1. Se for um NOVO registro (sem ID ainda)
                 if (!isEditing) {
                     const imageData = {
                         url: base64, // Usa base64 como URL temporária
                         id: tempId,  // ID temporário
                         timestamp: new Date().toISOString(),
                         isLocal: true // Marca para upload posterior
                     };
                     const lista = tipo === 'pre' ? imagenesPreUpload : imagenesPosUpload;
                     lista.push(imageData);

                     removerImagemPreviewLoading(tempId, tipo);
                     adicionarImagemPreview(base64, tipo, tempId); // Mostra preview com base64
                     console.log("Imagem adicionada localmente (novo registro):", tempId);
                     return; // Upload será feito ao salvar o formulário
                 }

                 // 2. Se for EDIÇÃO de um registro existente
                 console.log(`Iniciando upload para manutenção ID: ${idManutencao}, tipo: ${tipo}`);
                 // Chama a API para fazer upload imediatamente
                 const res = await apiRequest('uploadImagem', {
                     id: idManutencao,
                     imagem: base64,
                     tipo: tipo
                 });

                 removerImagemPreviewLoading(tempId, tipo); // Remove loading

                 if (!res || !res.success || !res.url || !res.id) {
                     throw new Error(res.message || 'Falha no upload da imagem para o servidor.');
                 }
                 console.log("Upload concluído:", res);

                 // Adiciona à lista global correta com dados do Drive
                 const imageData = {
                     url: res.url,
                     id: res.id,
                     timestamp: res.timestamp || new Date().toISOString(),
                      isLocal: false // Já está no Drive
                 };
                 const lista = tipo === 'pre' ? imagenesPreUpload : imagenesPosUpload;
                 lista.push(imageData);

                 adicionarImagemPreview(res.url, tipo, res.id); // Mostra preview com URL do Drive

                 // Atualiza a manutenção no backend para incluir a nova imagem
                 await salvarAposUploadImagem(idManutencao);

             } catch (e) {
                 removerImagemPreviewLoading(tempId, tipo);
                 console.error('Erro durante o upload ou processamento da imagem:', e);
                 mostrarAlerta('Erro ao fazer upload da imagem: ' + e.message, 'Erro Upload', 'erro');
             }
        }

        /**
         * Salva a manutenção atual no backend para persistir a lista de imagens atualizada
         * após um upload bem-sucedido durante a *edição*.
         * @param {string} idManutencao ID da manutenção a ser atualizada.
         */
        async function salvarAposUploadImagem(idManutencao) {
             if (!idManutencao) {
                 console.warn("ID da manutenção inválido para salvar após upload.");
                 return;
             }
             // Certifica que 'manutencaoAtual' está atualizado ou busca novamente
             if (!manutencaoAtual || manutencaoAtual.ID !== idManutencao) {
                  console.log("Recarregando manutenção antes de salvar após upload...");
                  const resReload = await apiRequest('obterManutencao', { id: idManutencao });
                  if (!resReload || !resReload.success || !resReload.manutencao) {
                      mostrarAlerta("Não foi possível recarregar os dados da manutenção para salvar a imagem. A imagem pode não ter sido associada corretamente.", "Aviso", "aviso");
                      return;
                  }
                  manutencaoAtual = resReload.manutencao;
             }


            console.log("Atualizando manutenção após upload de imagem...");
            try {
                 // Pega as listas globais ATUALIZADAS
                 const imagensPreAtualizadas = imagenesPreUpload.map(({ url, id, timestamp }) => ({ url, id, timestamp }));
                 const imagensPosAtualizadas = imagenesPosUpload.map(({ url, id, timestamp }) => ({ url, id, timestamp }));

                 // Envia APENAS o ID e os arrays de imagens para atualização no backend
                 const res = await apiRequest('salvarManutencao', {
                     dados: JSON.stringify({
                         id: idManutencao,
                         imagensPre: imagensPreAtualizadas,
                         imagensPos: imagensPosAtualizadas
                         // Não envia outros campos para evitar sobrescrever dados concorrentes
                     })
                 });

                 if (!res || !res.success) {
                     throw new Error(res.message || "Erro ao atualizar o registro após upload de imagem.");
                 }
                 console.log("Manutenção atualizada com sucesso após upload.");

                 // Atualiza a 'manutencaoAtual' local com as novas listas de imagem (importante!)
                  if(manutencaoAtual) {
                    manutencaoAtual.Imagens_Pre = imagensPreAtualizadas;
                    manutencaoAtual.Imagens_Pos = imagensPosAtualizadas;
                  }


            } catch(error) {
                 console.error("Erro ao salvar manutenção após upload:", error);
                 mostrarAlerta("Erro ao atualizar o registro de imagens da manutenção: " + error.message, "Erro", "erro");
            }
        }

        /**
         * Adiciona um placeholder visual de loading para uma imagem sendo enviada.
         * @param {string} tempId ID temporário para identificar o placeholder.
         * @param {'pre'|'pos'} tipo Tipo de formulário.
         */
       function adicionarImagemPreviewLoading(tempId, tipo) {
           const container = document.getElementById(`imagens-preview-${tipo}`);
            const placeholder = document.getElementById(`imagens-preview-${tipo}-placeholder`);
           if (!container) return;
            // Esconde placeholder de "nenhuma imagem"
            if(placeholder) placeholder.style.display = 'none';

           const loadingContainer = document.createElement('div');
           loadingContainer.className = 'image-container image-loading text-center d-flex align-items-center justify-content-center border rounded me-2 mb-2 shadow-sm'; // Adiciona sombra
           loadingContainer.style.width = '150px';
           loadingContainer.style.height = '150px';
           loadingContainer.dataset.tempId = tempId;
           loadingContainer.innerHTML = `
               <div class="spinner-border text-primary" role="status" style="width: 2.5rem; height: 2.5rem;">
                   <span class="visually-hidden">Enviando...</span>
               </div>
           `;
           container.appendChild(loadingContainer);
       }

       /**
        * Remove o placeholder de loading de imagem.
        * @param {string} tempId ID temporário do placeholder a ser removido.
        * @param {'pre'|'pos'} tipo Tipo de formulário.
        */
       function removerImagemPreviewLoading(tempId, tipo) {
           const container = document.getElementById(`imagens-preview-${tipo}`);
           if (!container) return;
           const loadingElement = container.querySelector(`.image-loading[data-temp-id="${tempId}"]`);
           if (loadingElement) {
               loadingElement.remove();
           }
            // Mostra placeholder "nenhuma imagem" se o container ficar vazio
            const placeholder = document.getElementById(`imagens-preview-${tipo}-placeholder`);
             if (placeholder && container.childElementCount === 0) {
                placeholder.style.display = 'block';
            }
       }

        /**
         * Adiciona um preview de imagem (com botões de deletar/anotar) a um container.
         * @param {string} src URL da imagem (pode ser base64 para previews locais).
         * @param {'pre'|'pos'} tipo Tipo de formulário.
         * @param {string} imageIdentifier ID da imagem no Drive ou ID temporário para base64.
         */
       function adicionarImagemPreview(src, tipo, imageIdentifier) {
            const containerId = `imagens-preview-${tipo}`;
            const container = document.getElementById(containerId);
            const placeholder = document.getElementById(`imagens-preview-${tipo}-placeholder`);
            if (!container) {
                console.error("Container de preview não encontrado:", containerId);
                return;
            }
             // Esconde placeholder de "nenhuma imagem"
            if(placeholder) placeholder.style.display = 'none';


            const imgContainer = document.createElement('div');
            imgContainer.className = 'image-container position-relative d-inline-block me-2 mb-2 shadow-sm'; // Adiciona sombra
            imgContainer.dataset.fileId = imageIdentifier;

            const img = document.createElement('img');
            img.src = src;
            img.alt = 'Preview da Imagem';
            img.className = 'img-thumbnail photo-preview-img';
            img.style.cursor = 'pointer';
            img.loading = 'lazy';
            img.onclick = (e) => {
                 // Evita conflito com botões sobrepostos
                 if (e.target === img) {
                     window.open(src, '_blank');
                 }
             };

            // --- Botão Deletar ---
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button';
            deleteBtn.className = 'btn btn-danger btn-sm delete-btn p-0 lh-1'; // Botão pequeno e sem padding extra
            deleteBtn.style.position = 'absolute';
            deleteBtn.style.top = '2px'; // Ajuste fino posição
            deleteBtn.style.right = '2px';
             deleteBtn.style.width = '20px'; // Tamanho fixo
             deleteBtn.style.height = '20px';
             deleteBtn.style.borderRadius = '50%'; // Circular
             deleteBtn.style.opacity = '0.8';
            deleteBtn.setAttribute('aria-label', 'Remover Imagem');
            deleteBtn.title = 'Remover Imagem';
             deleteBtn.innerHTML = '<i class="bi bi-x-lg"></i>'; // Ícone X

            deleteBtn.onclick = function(e) {
                e.stopPropagation();
                const currentIdentifier = imgContainer.dataset.fileId;
                 const isLocalImage = src.startsWith('data:image'); // Verifica se é base64

                mostrarConfirmacao(`Tem certeza que deseja remover esta imagem${isLocalImage ? '' : ' (incluindo do servidor)'}?`, async () => {
                    imgContainer.remove(); // Remove visualmente

                    // Remove da lista global
                    let listaGlobal = tipo === 'pre' ? imagenesPreUpload : imagenesPosUpload;
                    const indexToRemove = listaGlobal.findIndex(imgData => (imgData.id || imgData.url) === currentIdentifier);
                     if (indexToRemove > -1) {
                        const removedImage = listaGlobal.splice(indexToRemove, 1)[0]; // Remove e pega o item removido
                        console.log("Imagem removida da lista global:", removedImage);

                        // Se NÃO for local E estiver editando, tenta excluir do Drive
                        if (!removedImage.isLocal && manutencaoAtual?.ID) {
                            console.log(`Tentando excluir imagem do Drive: ID=${currentIdentifier}`);
                            mostrarAlerta('Excluindo imagem do servidor...', 'Aguarde', 'aguarde');
                            try {
                                 const resDelete = await apiRequest('excluirImagem', {
                                     idManutencao: manutencaoAtual.ID,
                                     idImagem: currentIdentifier,
                                     tipo: tipo
                                 });
                                 if (resDelete && resDelete.success) {
                                     console.log("Imagem excluída do Drive com sucesso.");
                                     // Atualiza a manutenção no backend
                                     await salvarAposUploadImagem(manutencaoAtual.ID);
                                      modals.alert.hide();
                                      mostrarAlerta("Imagem removida com sucesso.", "Removido", "sucesso");
                                 } else {
                                     throw new Error(resDelete.message || "Erro ao excluir imagem do servidor.");
                                 }
                            } catch (deleteError) {
                                 modals.alert.hide();
                                 console.error("Erro ao excluir imagem do Drive:", deleteError);
                                 mostrarAlerta(`Não foi possível excluir a imagem do servidor: ${deleteError.message}. A imagem foi removida apenas da visualização atual. Recarregue para confirmar.`, "Erro Exclusão", "erro");
                                 // Opcional: Adicionar a imagem de volta? Ou deixar removida visualmente?
                            }
                        } else {
                             console.log("Imagem removida apenas localmente.");
                              // Mostra placeholder "nenhuma imagem" se o container ficar vazio
                              if (placeholder && container.childElementCount === 0) {
                                  placeholder.style.display = 'block';
                              }
                        }

                     } else {
                         console.warn("Imagem a ser removida não encontrada na lista global:", currentIdentifier);
                     }

                     // Mostra placeholder "nenhuma imagem" se o container ficar vazio
                    if (placeholder && container.childElementCount === 0) {
                        placeholder.style.display = 'block';
                    }
                });
            };

            // --- Botão Anotar ---
            if (typeof ImageAnnotator !== 'undefined' && anotadorImagem) {
                const btnAnnotate = document.createElement('button');
                btnAnnotate.type = 'button';
                btnAnnotate.className = 'btn btn-info btn-sm btn-annotate p-0 lh-1';
                btnAnnotate.style.position = 'absolute';
                btnAnnotate.style.top = '2px';
                btnAnnotate.style.left = '2px';
                btnAnnotate.style.width = '20px';
                btnAnnotate.style.height = '20px';
                btnAnnotate.style.borderRadius = '50%';
                btnAnnotate.style.opacity = '0.8';
                btnAnnotate.innerHTML = '<i class="bi bi-pencil-fill"></i>';
                btnAnnotate.title = 'Anotar imagem';
                btnAnnotate.dataset.imgSrc = src;
                btnAnnotate.dataset.originalId = imageIdentifier;

                btnAnnotate.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!manutencaoAtual || !manutencaoAtual.ID) {
                        mostrarAlerta("Salve a manutenção primeiro para poder anotar imagens.", "Ação Indisponível", "aviso");
                        return;
                    }
                    abrirEditorAnotacao(src, tipo, imgContainer);
                });
                imgContainer.appendChild(btnAnnotate);
            }

           imgContainer.appendChild(img);
           imgContainer.appendChild(deleteBtn);
           container.appendChild(imgContainer);
       }

        // --- Funções de Anotação de Imagem --- (Manter as mesmas: abrirEditorAnotacao, configurarSalvamentoAnotacao, salvarAposAnotacao)
       /**
         * Abre o modal de anotação com a imagem selecionada.
         * @param {string} imgSrc URL da imagem a ser anotada.
         * @param {'pre'|'pos'} tipo Tipo de formulário.
         * @param {HTMLElement} containerElement O elemento div.image-container da imagem clicada.
         */
       function abrirEditorAnotacao(imgSrc, tipo, containerElement) {
            if (!anotadorImagem) {
                mostrarAlerta("Ferramenta de anotação não inicializada.", "Erro Interno", "erro");
                return;
            }
            if (!manutencaoAtual || !manutencaoAtual.ID) {
                mostrarAlerta("É necessário estar editando uma manutenção salva para anotar imagens.", "Ação Indisponível", "aviso");
                return;
            }
            // Verifica se a imagem é base64 (não pode anotar imagens não salvas)
            if (imgSrc.startsWith('data:image')) {
                 mostrarAlerta("Imagens adicionadas localmente (base64) não podem ser anotadas antes de salvar a manutenção.", "Ação Indisponível", "aviso");
                 return;
            }

            mostrarAlerta('Carregando imagem para anotação...', 'Aguarde', 'aguarde');
            anotadorImagem.loadImage(imgSrc).then(() => {
                anotadorImagem.contextoTipo = tipo;
                anotadorImagem.contextoContainer = containerElement;
                anotadorImagem.contextoIdOriginal = containerElement.dataset.fileId;

                modals.alert.hide();
                modals.anotacao.show();
            }).catch(err => {
                modals.alert.hide();
                console.error('Erro ao carregar imagem para anotação:', err);
                mostrarAlerta('Erro ao carregar a imagem para anotação. Tente novamente.', 'Erro', 'erro');
            });
       }

       /**
        * Configura o listener para o botão de salvar anotação no modal.
        */
        function configurarSalvamentoAnotacao() {
             const btnSalvar = document.getElementById('btn-save-annotation');
             if (btnSalvar && anotadorImagem) {
                 btnSalvar.addEventListener('click', async () => {
                     const annotatedImageBase64 = anotadorImagem.captureImage();
                     const tipoImagem = anotadorImagem.contextoTipo;
                     const imageContainerElement = anotadorImagem.contextoContainer;
                     const idOriginal = anotadorImagem.contextoIdOriginal;

                     if (!tipoImagem || !imageContainerElement || !idOriginal || !manutencaoAtual?.ID) {
                         console.error("Contexto de anotação inválido.");
                         mostrarAlerta("Erro interno ao tentar salvar anotação.", "Erro", "erro");
                         return;
                     }

                     modals.anotacao.hide();
                     mostrarAlerta('Salvando imagem anotada e atualizando registro...', 'Aguarde', 'aguarde');

                     try {
                         const idManutencao = manutencaoAtual.ID;
                         // Faz upload da nova imagem (anotada) e pede para substituir a original
                         const resUpload = await apiRequest('uploadImagem', {
                             id: idManutencao,
                             imagem: annotatedImageBase64,
                             tipo: tipoImagem,
                             idOriginalParaSubstituir: idOriginal // Passa ID para backend substituir
                         });

                         if (!resUpload || !resUpload.success || !resUpload.url || !resUpload.id) {
                             throw new Error(resUpload.message || "Falha no upload da imagem anotada.");
                         }


                         // --- Atualizar Interface ---
                         const imgElementPreview = imageContainerElement.querySelector('img');
                          const btnAnnotatePreview = imageContainerElement.querySelector('.btn-annotate');
                          if (imgElementPreview) imgElementPreview.src = resUpload.url + '?' + Date.now(); // Adiciona timestamp para forçar refresh cache
                          if (btnAnnotatePreview) {
                              btnAnnotatePreview.dataset.imgSrc = resUpload.url;
                              btnAnnotatePreview.dataset.originalId = resUpload.id;
                          }
                         imageContainerElement.dataset.fileId = resUpload.id;

                         // --- Atualizar Lista Global ---
                         const listaUploads = tipoImagem === 'pre' ? imagenesPreUpload : imagenesPosUpload;
                         const indexOriginal = listaUploads.findIndex(img => img.id === idOriginal);
                         const novaImageData = {
                             url: resUpload.url, id: resUpload.id,
                             timestamp: resUpload.timestamp || new Date().toISOString(), isLocal: false
                         };
                         if (indexOriginal > -1) listaUploads[indexOriginal] = novaImageData;
                         else listaUploads.push(novaImageData); // Adiciona se não achar

                         // --- Persistir no Backend ---
                         await salvarAposAnotacao(idManutencao); // Salva manutenção com array atualizado

                         modals.alert.hide(); // Esconde "Aguarde"
                         mostrarAlerta('Anotação salva e imagem atualizada com sucesso!', 'Sucesso', 'sucesso');

                     } catch (error) {
                         modals.alert.hide();
                         console.error("Erro ao salvar imagem anotada:", error);
                         mostrarAlerta(`Erro ao salvar anotação: ${error.message}`, 'Erro', 'erro');
                     }
                 });
             }
        }

        /**
         * Função auxiliar para salvar a manutenção DEPOIS de anotar uma imagem.
         * @param {string} idManutencao ID da manutenção.
         */
        async function salvarAposAnotacao(idManutencao) {
             if (!idManutencao || !manutencaoAtual || manutencaoAtual.ID !== idManutencao) {
                 console.warn("Não foi possível salvar após anotação: ID ou manutenção atual inválidos.");
                 mostrarAlerta("A anotação foi processada, mas houve um problema ao atualizar o registro principal.", "Aviso", "aviso");
                 return;
             }
             console.log("Atualizando manutenção após anotação...");
             try {
                  const imagensPreAtualizadas = imagenesPreUpload.map(({ url, id, timestamp }) => ({ url, id, timestamp }));
                  const imagensPosAtualizadas = imagenesPosUpload.map(({ url, id, timestamp }) => ({ url, id, timestamp }));

                  const res = await apiRequest('salvarManutencao', {
                      dados: JSON.stringify({
                         id: idManutencao,
                         imagensPre: imagensPreAtualizadas,
                         imagensPos: imagensPosAtualizadas
                      })
                  });

                  if (!res || !res.success) {
                      throw new Error(res.message || "Erro ao atualizar o registro após anotação.");
                  }
                  console.log("Manutenção atualizada com sucesso após anotação.");

                  // Atualiza a 'manutencaoAtual' local
                  manutencaoAtual.Imagens_Pre = imagensPreAtualizadas;
                  manutencaoAtual.Imagens_Pos = imagensPosAtualizadas;

             } catch(error) {
                  console.error("Erro ao salvar manutenção após anotação:", error);
                  mostrarAlerta("Erro ao salvar a atualização das imagens no registro: " + error.message, "Erro", "erro");
             }
        }


        // --- Funções de Ferramentas e Configuração --- (Manter as mesmas: carregarDadosFerramentas, salvarConfiguracao)
       /**
         * Carrega os dados atuais das configurações na tela de Ferramentas.
         */
        async function carregarDadosFerramentas() {
             mostrarAlerta('Carregando configurações...', 'Aguarde', 'aguarde');
             try {
                 const versaoSistemaSpan = document.getElementById('versao-sistema');
                 const idPlanilhaInput = document.getElementById('id-planilha-turnos');
                 const emailsTextarea = document.getElementById('emails-notificacao');
                 const integracaoSwitch = document.getElementById('integracao-automatica');

                 // Busca versão e configurações em uma única chamada (se o backend suportar)
                 const res = await apiRequest('obterConfiguracoesGerais'); // Ação unificada no backend

                 if (!res || !res.success) {
                     throw new Error(res.message || "Erro ao buscar configurações gerais.");
                 }

                 // Preenche Versão
                 if (versaoSistemaSpan) {
                     versaoSistemaSpan.textContent = res.versaoApp || VERSAO_APP; // Usa backend ou fallback
                 }

                 // Preenche Configurações
                 const configs = res.configuracoes || {};
                 if (idPlanilhaInput) idPlanilhaInput.value = configs['ID_PLANILHA_TURNOS'] || '';
                 if (emailsTextarea) emailsTextarea.value = configs['EMAILS_NOTIFICACAO'] || '';
                 if (integracaoSwitch) integracaoSwitch.checked = configs['INTEGRACAO_AUTOMATICA'] === 'SIM';

                 modals.alert.hide(); // Esconde "Aguarde"

             } catch (error) {
                 modals.alert.hide();
                 console.error('Erro ao carregar dados de ferramentas:', error);
                 mostrarAlerta(`Erro ao carregar configurações: ${error.message}`, 'Erro', 'erro');
                 // Opcional: Limpar campos se falhar ao carregar?
                 if (document.getElementById('id-planilha-turnos')) document.getElementById('id-planilha-turnos').value = '';
                 if (document.getElementById('emails-notificacao')) document.getElementById('emails-notificacao').value = '';
                 if (document.getElementById('integracao-automatica')) document.getElementById('integracao-automatica').checked = false;
             }
        }

        /**
         * Salva uma configuração específica no backend.
         * @param {string} chave Nome da chave de configuração.
         * @param {string} valor Valor da configuração.
         * @param {string} [mensagemSucesso] Mensagem a ser exibida em caso de sucesso.
         * @returns {Promise<boolean>} True se sucesso, False se falha.
         */
        async function salvarConfiguracao(chave, valor, mensagemSucesso) {
            mostrarAlerta(`Salvando configuração (${chave})...`, 'Aguarde', 'aguarde');
            try {
                const res = await apiRequest('salvarConfiguracao', { chave: chave, valor: valor });

                if (res && res.success) {
                     modals.alert.hide(); // Fecha "aguarde" antes de mostrar sucesso
                    if (mensagemSucesso) {
                        mostrarAlerta(mensagemSucesso, 'Configuração Salva', 'sucesso');
                    }
                    console.log(`Configuração "${chave}" salva.`);
                    return true;
                } else {
                    throw new Error(res.message || `Erro desconhecido ao salvar "${chave}"`);
                }
            } catch (error) {
                 modals.alert.hide(); // Fecha "aguarde" antes de mostrar erro
                console.error(`Erro ao salvar configuração ${chave}:`, error);
                mostrarAlerta(`Erro ao salvar configuração (${chave}): ${error.message}`, 'Erro', 'erro');
                return false;
            }
        }


        // --- Funções de Geração de Relatórios (Chamadas) --- (Manter as mesmas: gerarRelatorioTextoParaPdf, gerarRelatorioAvancadoCliente)
       /**
         * Chama a função backend para gerar um PDF básico e abre o link retornado.
         * @param {string} id ID da manutenção.
         */
        async function gerarRelatorioTextoParaPdf(id) {
             if (!id) return;
             mostrarAlerta('Gerando PDF básico...', 'Aguarde', 'aguarde');
             try {
                 const res = await apiRequest('gerarPDFTextoBackend', { id: id });

                 if (res && res.success && res.url) {
                      modals.alert.hide(); // Fecha "aguarde" antes de abrir link
                     window.open(res.url, '_blank');
                     // mostrarAlerta('PDF Básico gerado! Verifique a nova aba.', 'Sucesso', 'sucesso'); // Opcional
                 } else {
                     throw new Error(res.message || 'Não foi possível gerar o link do PDF básico.');
                 }
             } catch (error) {
                 modals.alert.hide();
                 console.error("Erro ao gerar PDF básico:", error);
                 mostrarAlerta(`Erro ao gerar PDF básico: ${error.message}`, 'Erro', 'erro');
             }
        }

        /**
         * Chama a função backend para gerar relatórios avançados (PDF, Excel, CSV) e abre o link.
         * @param {string} id ID da manutenção.
         * @param {'pdf'|'excel'|'csv'} formato Formato desejado.
         */
        async function gerarRelatorioAvancadoCliente(id, formato) {
             if (!id) return;
             const formatoUpper = formato.toUpperCase();
             mostrarAlerta(`Gerando relatório ${formatoUpper}...`, 'Aguarde', 'aguarde');

             try {
                 const res = await apiRequest('gerarRelatorioAvancado', {
                     id: id,
                     formato: formato,
                     opcoes: JSON.stringify({ incluirImagens: true })
                 });

                 if (!res || !res.success) {
                     throw new Error(res.message || `Erro ao gerar relatório ${formatoUpper}`);
                 }

                 modals.alert.hide(); // Fecha "aguarde"

                 if (res.url) {
                     window.open(res.url, '_blank');
                     // mostrarAlerta(`Relatório ${formatoUpper} gerado! Verifique a nova aba ou seu Google Drive.`, 'Sucesso', 'sucesso');
                 } else {
                     mostrarAlerta(`Relatório ${formatoUpper} gerado no Google Drive (sem link de visualização).`, 'Sucesso', 'sucesso');
                 }

             } catch (error) {
                 modals.alert.hide();
                 console.error(`Erro ao gerar relatório ${formatoUpper}:`, error);
                 mostrarAlerta(`Erro ao gerar relatório ${formatoUpper}: ${error.message}`, 'Erro', 'erro');
             }
        }


        // --- Funções Utilitárias --- (Manter as mesmas: getStatusClass, formatarData, formatarDataHora)
        /**
         * Retorna a classe CSS correspondente ao status da manutenção.
         * @param {string} status Status da manutenção.
         * @returns {string} Classe CSS (ex: 'status-aguardando').
         */
        function getStatusClass(status) {
            switch (status) {
                case STATUS_AGUARDANDO: return 'status-aguardando';
                case STATUS_EM_MANUTENCAO: return 'status-em-manutencao';
                case STATUS_CONCLUIDO: return 'status-concluido';
                case STATUS_DISPONIVEL: return 'status-disponivel';
                default: return 'bg-secondary text-white';
            }
        }

        /**
         * Formata uma data (string ISO ou Date) para o formato DD/MM/YYYY.
         * @param {string|Date|null|undefined} dateInput Data a ser formatada.
         * @returns {string} Data formatada ou 'N/A'.
         */
        function formatarData(dateInput) {
            if (!dateInput) return 'N/A';
            try {
                // Tenta converter para Data, tratando possíveis erros
                const date = new Date(dateInput);
                if (isNaN(date.getTime())) return 'Inválida'; // Verifica se a data é válida

                // Extrai dia, mês e ano, garantindo 2 dígitos com padding
                const dia = String(date.getDate()).padStart(2, '0');
                const mes = String(date.getMonth() + 1).padStart(2, '0'); // Mês é base 0
                const ano = date.getFullYear();

                return `${dia}/${mes}/${ano}`;
            } catch (e) {
                console.error("Erro ao formatar data:", dateInput, e);
                return 'Erro Data';
            }
        }


        /**
         * Formata uma data (string ISO ou Date) para o formato DD/MM/YYYY HH:MM.
         * @param {string|Date|null|undefined} dateInput Data a ser formatada.
         * @returns {string} Data e hora formatada ou 'N/A'.
         */
        function formatarDataHora(dateInput) {
             if (!dateInput) return 'N/A';
             try {
                 const date = new Date(dateInput);
                 if (isNaN(date.getTime())) return 'Inválida';

                 const dia = String(date.getDate()).padStart(2, '0');
                 const mes = String(date.getMonth() + 1).padStart(2, '0');
                 const ano = date.getFullYear();
                 const hora = String(date.getHours()).padStart(2, '0');
                 const minuto = String(date.getMinutes()).padStart(2, '0');

                 return `${dia}/${mes}/${ano} ${hora}:${minuto}`;
             } catch (e) {
                 console.error("Erro ao formatar data/hora:", dateInput, e);
                 return 'Erro Data/Hora';
             }
        }

         /**
         * Valida o formulário de pré-manutenção usando Bootstrap 5 classes.
         * @returns {boolean} True se o formulário for válido, False caso contrário.
         */
        function validarFormPreManutencao() {
            const form = document.getElementById('form-pre-manutencao');
            if (!form) return false;
             let isValid = true;

             // Remove validações anteriores
             form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

             // Função auxiliar para marcar campo como inválido
             const markInvalid = (elementId) => {
                 const element = document.getElementById(elementId);
                 if (element) {
                     element.classList.add('is-invalid');
                     isValid = false;
                 }
             };

             // Validar Tipo Equipamento
             if (!document.getElementById('pre-tipo-equipamento').value) markInvalid('pre-tipo-equipamento');

             // Validar Placa/Equipamento (depende do que está visível)
             const placaSelect = document.getElementById('pre-placa-select');
             const placaOutro = document.getElementById('pre-placa-outro-valor');
             if (placaSelect.style.display !== 'none' && !placaSelect.value) {
                 markInvalid('pre-placa-select');
             } else if (placaOutro.style.display !== 'none' && !placaOutro.value.trim()) {
                 markInvalid('pre-placa-outro-valor');
             }

             // Validar Categoria e Urgência
             if (!document.getElementById('pre-categoria-problema').value) markInvalid('pre-categoria-problema');
             if (!document.getElementById('pre-urgencia').value) markInvalid('pre-urgencia');

             // Validar "Outro Motivo" se a categoria for "Outro"
             if (document.getElementById('pre-categoria-problema').value === 'Outro' && !document.getElementById('pre-motivo-outro').value.trim()) {
                 markInvalid('pre-motivo-outro');
             }

             // Validar Descrição e Responsável
             if (!document.getElementById('pre-descricao-problema').value.trim()) markInvalid('pre-descricao-problema');
             if (!document.getElementById('pre-responsavel').value.trim()) markInvalid('pre-responsavel');

             // Se inválido, foca no primeiro campo com erro
             if (!isValid) {
                 const firstInvalid = form.querySelector('.is-invalid');
                 if (firstInvalid) firstInvalid.focus();
                 mostrarAlerta("Por favor, preencha todos os campos obrigatórios (*) marcados em vermelho.", "Campos Obrigatórios", "aviso");
             }

             return isValid;
         }


        // --- Inicialização e Event Listeners Principais ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializa Modais (já movido para cima para garantir disponibilidade)

            // Carregar dados iniciais essenciais
            carregarDadosIniciais();

            // --- Navegação Principal ---
            document.getElementById('nav-dashboard')?.addEventListener('click', e => { e.preventDefault(); mostrarTela('dashboard'); });
            document.getElementById('nav-lista')?.addEventListener('click', e => { e.preventDefault(); mostrarTela('lista'); });
            document.getElementById('nav-ferramentas')?.addEventListener('click', e => { e.preventDefault(); mostrarTela('ferramentas'); });

            // --- Botão Nova Manutenção ---
            const setupNovoForm = () => {
                const formPre = document.getElementById('form-pre-manutencao');
                if (formPre) {
                    formPre.reset();
                     formPre.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid')); // Limpa validação
                }
                document.getElementById('pre-id').value = '';
                document.getElementById('pre-placa').value = '';
                document.getElementById('pre-modelo').value = '';
                document.getElementById('motivo-outro-container').style.display = 'none';
                document.getElementById('pre-motivo-outro').required = false;
                document.getElementById('imagens-preview-pre').innerHTML = '';
                 document.getElementById('imagens-preview-pos').innerHTML = ''; // Limpa pós também

                // Mostra placeholder "nenhuma imagem"
                const placeholderPre = document.getElementById('imagens-preview-pre-placeholder');
                if(placeholderPre) placeholderPre.style.display = 'block';
                const placeholderPos = document.getElementById('imagens-preview-pos-placeholder');
                if(placeholderPos) placeholderPos.style.display = 'block';

                // Resetar selects de placa
                const placaSelect = document.getElementById('pre-placa-select');
                const placaOutroInput = document.getElementById('pre-placa-outro-valor');
                if(placaSelect) {
                     placaSelect.innerHTML = '<option value="">Selecione o Equipamento...</option>';
                     placaSelect.style.display = 'none';
                     placaSelect.required = false;
                 }
                  if(placaOutroInput) {
                     placaOutroInput.style.display = 'none';
                     placaOutroInput.required = false;
                  }

                imagenesPreUpload = [];
                imagenesPosUpload = [];
                manutencaoAtual = null;

                const checklistPreContainer = document.getElementById('pre-checklist-container');
                checklistPreContainer?.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                const checklistPosContainer = document.getElementById('pos-checklist-container');
                checklistPosContainer?.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);


                fecharCamera('pre');
                fecharCamera('pos');
                mostrarTela('preManu');
            };
            document.getElementById('nav-novo')?.addEventListener('click', e => { e.preventDefault(); setupNovoForm(); });
            document.getElementById('btn-nova-manutencao')?.addEventListener('click', setupNovoForm);


            // --- Botões Voltar --- (Manter a mesma lógica)
            document.querySelectorAll('.btn-voltar').forEach(btn => {
                btn.addEventListener('click', () => {
                    mostrarTela('lista');
                    manutencaoAtual = null;
                    fecharCamera('pre');
                    fecharCamera('pos');
                });
            });
            document.getElementById('btn-voltar-pre')?.addEventListener('click', () => {
                const id = document.getElementById('pos-id').value;
                if (id && manutencaoAtual && manutencaoAtual.ID === id) {
                     editarManutencao(id);
                 } else {
                     console.warn("Tentando voltar para pré sem ID/dados válidos. Voltando para lista.");
                     mostrarTela('lista');
                 }
                 fecharCamera('pos');
            });


            // --- Botões de Ação na Visualização --- (Manter a mesma lógica)
            document.getElementById('btn-editar-manutencao')?.addEventListener('click', () => {
                if (manutencaoAtual && manutencaoAtual.ID) {
                    editarManutencao(manutencaoAtual.ID);
                } else {
                    mostrarAlerta("Nenhuma manutenção selecionada para editar.", "Aviso", "aviso");
                    mostrarTela('lista');
                }
            });
            document.querySelectorAll('#tela-visualizacao .btn-status').forEach(btn => {
                btn.addEventListener('click', async function() {
                     if (!manutencaoAtual || !manutencaoAtual.ID) return;
                     const novoStatus = this.dataset.status;
                     const statusAtual = manutencaoAtual.Status;
                     if (statusAtual === novoStatus) return;

                     mostrarConfirmacao(`Deseja realmente alterar o status de "${statusAtual || 'N/A'}" para "${novoStatus}"?`, async () => {
                         mostrarAlerta('Atualizando status...', 'Aguarde', 'aguarde');
                         try {
                             const res = await apiRequest('atualizarStatusManutencao', { id: manutencaoAtual.ID, status: novoStatus });
                             if (!res || !res.success) throw new Error(res.message || 'Erro ao atualizar status');
                             modals.alert.hide();
                             mostrarAlerta('Status atualizado com sucesso!', 'Sucesso', 'sucesso');
                             await visualizarManutencao(manutencaoAtual.ID); // Recarrega
                         } catch (error) {
                              modals.alert.hide();
                              mostrarAlerta(`Erro ao atualizar status: ${error.message}`, 'Erro', 'erro');
                         }
                     });
                });
            });


            // --- Botões de Relatórios na Visualização --- (Manter a mesma lógica)
            document.getElementById('btn-gerar-pdf-basico')?.addEventListener('click', e => { e.preventDefault(); if (manutencaoAtual?.ID) gerarRelatorioTextoParaPdf(manutencaoAtual.ID); });
            document.getElementById('btn-gerar-pdf-avancado')?.addEventListener('click', e => { e.preventDefault(); if (manutencaoAtual?.ID) gerarRelatorioAvancadoCliente(manutencaoAtual.ID, 'pdf'); });
            document.getElementById('btn-gerar-excel')?.addEventListener('click', e => { e.preventDefault(); if (manutencaoAtual?.ID) gerarRelatorioAvancadoCliente(manutencaoAtual.ID, 'excel'); });
            document.getElementById('btn-gerar-csv')?.addEventListener('click', e => { e.preventDefault(); if (manutencaoAtual?.ID) gerarRelatorioAvancadoCliente(manutencaoAtual.ID, 'csv'); });


            // --- Filtros da Lista --- (Manter a mesma lógica)
            document.getElementById('btn-filtrar')?.addEventListener('click', carregarListaManutencoes);
            document.getElementById('btn-limpar-filtro')?.addEventListener('click', () => {
                document.getElementById('filtro-status').value = '';
                document.getElementById('filtro-placa').value = '';
                carregarListaManutencoes();
            });
            document.getElementById('filtro-placa')?.addEventListener('keypress', e => { if (e.key === 'Enter') carregarListaManutencoes(); });


            // --- Listener para Categoria 'Outro' --- (Manter a mesma lógica)
            document.getElementById('pre-categoria-problema')?.addEventListener('change', function() {
                const motivoOutroContainer = document.getElementById('motivo-outro-container');
                const motivoOutroInput = document.getElementById('pre-motivo-outro');
                if (this.value === 'Outro') {
                    motivoOutroContainer.style.display = 'block';
                    motivoOutroInput.required = true;
                     motivoOutroInput.classList.remove('is-invalid'); // Limpa validação ao mostrar
                    motivoOutroInput.focus();
                } else {
                    motivoOutroContainer.style.display = 'none';
                    motivoOutroInput.required = false;
                    motivoOutroInput.value = '';
                     motivoOutroInput.classList.remove('is-invalid');
                }
            });


            // --- Submit Formulário Pré-Manutenção ---
            document.getElementById('form-pre-manutencao')?.addEventListener('submit', async function(e) {
                 e.preventDefault();
                 // Valida o formulário antes de prosseguir
                 if (!validarFormPreManutencao()) {
                     return; // Interrompe se inválido
                 }

                 mostrarAlerta('Salvando registro...', 'Aguarde', 'aguarde');
                 const dados = obterDadosFormulario('form-pre-manutencao');

                 try {
                     // Prepara payload (inclui dados POS se for edição)
                     const payload = { ...dados }; // Copia dados do formulário
                     if (payload.id && manutencaoAtual) { // Se for edição, preserva dados POS não editáveis aqui
                         payload.checklistPos = manutencaoAtual.Checklist_Pos || {};
                         payload.observacoesPos = manutencaoAtual.Observacoes_Pos || '';
                         payload.imagensPos = manutencaoAtual.Imagens_Pos || [];
                         payload.dataManutencao = manutencaoAtual.Data_Manutencao || null;
                          payload.status = manutencaoAtual.Status || STATUS_AGUARDANDO; // Mantém status atual na edição PRE
                     } else {
                         payload.status = STATUS_AGUARDANDO; // Status inicial para novo registro
                     }


                     const res = await apiRequest('salvarManutencao', { dados: JSON.stringify(payload) });

                     if (!res || !res.success || !res.id) {
                         throw new Error(res.message || 'Erro ao salvar. ID não retornado.');
                     }
                     const savedId = res.id;
                      manutencaoAtual = res.manutencao || null; // Atualiza com dados retornados se houver
                     modals.alert.hide(); // Fecha "aguarde" antes de mostrar escolha

                     // Modal de Escolha Pós-Salvamento
                     document.getElementById('btn-choice-lista').onclick = () => { modals.choice.hide(); mostrarTela('lista'); };
                     document.getElementById('btn-choice-novo').onclick = () => { modals.choice.hide(); setupNovoForm(); };
                     document.getElementById('btn-choice-pos').onclick = async () => {
                         modals.choice.hide();
                         await carregarParaPosManutencao(savedId); // Carrega para tela Pós
                     };
                     modals.choice.show();

                 } catch (error) {
                     modals.alert.hide();
                     console.error("Erro ao salvar formulário pré:", error);
                     mostrarAlerta(`Erro ao salvar: ${error.message}`, 'Erro Salvar', 'erro');
                 }
            });


            // --- Submit Formulário Pós-Manutenção ---
            document.getElementById('form-pos-manutencao')?.addEventListener('submit', async function(e) {
                 e.preventDefault();
                 mostrarAlerta('Finalizando manutenção...', 'Aguarde', 'aguarde');

                 const id = document.getElementById('pos-id').value;
                 if (!id || !manutencaoAtual || manutencaoAtual.ID !== id) {
                     modals.alert.hide();
                     mostrarAlerta('Dados da manutenção atual inconsistentes. Volte para a lista e tente novamente.', 'Erro Crítico', 'erro');
                     mostrarTela('lista');
                     return;
                 }

                 const dadosPos = obterDadosFormulario('form-pos-manutencao');

                 try {
                     // Monta payload final combinando dados PRE existentes com PÓS atuais
                     const dadosParaSalvar = {
                         ...manutencaoAtual, // Começa com todos os dados atuais
                         id: id,
                         dataManutencao: new Date().toISOString(), // Data atual
                         checklistPos: dadosPos.checklistPos,
                         observacoesPos: dadosPos.observacoesPos,
                         imagensPos: imagenesPosUpload, // Array global PÓS atualizado
                         status: STATUS_CONCLUIDO // Status final
                     };
                     // Remove campos que não são diretamente da planilha ou podem ser problemáticos
                     delete dadosParaSalvar.isLocal; // Exemplo se houver


                     const res = await apiRequest('salvarManutencao', { dados: JSON.stringify(dadosParaSalvar) });

                     if (!res || !res.success) {
                         throw new Error(res.message || 'Erro desconhecido ao finalizar');
                     }

                     modals.alert.hide();
                     mostrarAlerta('Manutenção finalizada com sucesso!', 'Sucesso', 'sucesso');
                     manutencaoAtual = null;
                     mostrarTela('lista');

                 } catch (error) {
                     modals.alert.hide();
                     console.error("Erro ao finalizar manutenção:", error);
                     mostrarAlerta(`Erro ao finalizar: ${error.message}`, 'Erro Finalizar', 'erro');
                 }
            });


            // --- Listeners para Câmera e Galeria --- (Manter a mesma lógica)
             document.getElementById('btn-abrir-camera-pre')?.addEventListener('click', () => abrirCamera('pre'));
            document.getElementById('btn-fechar-camera-pre')?.addEventListener('click', () => fecharCamera('pre'));
            document.getElementById('btn-capturar-pre')?.addEventListener('click', () => capturarImagem('pre'));
            document.getElementById('input-imagem-pre')?.addEventListener('change', (e) => processarGaleria(e, 'pre'));

            document.getElementById('btn-abrir-camera-pos')?.addEventListener('click', () => abrirCamera('pos'));
            document.getElementById('btn-fechar-camera-pos')?.addEventListener('click', () => fecharCamera('pos'));
            document.getElementById('btn-capturar-pos')?.addEventListener('click', () => capturarImagem('pos'));
            document.getElementById('input-imagem-pos')?.addEventListener('change', (e) => processarGaleria(e, 'pos'));


            // --- Listeners da Tela de Ferramentas --- (Manter a mesma lógica)
            document.getElementById('btn-executar-integracao')?.addEventListener('click', async function() {
                 const idPlanilhaInput = document.getElementById('id-planilha-turnos');
                 const idPlanilha = idPlanilhaInput?.value.trim();
                 if (!idPlanilha) { mostrarAlerta('Informe o ID da planilha.', 'Aviso', 'aviso'); idPlanilhaInput?.focus(); return; }
                 const saved = await salvarConfiguracao('ID_PLANILHA_TURNOS', idPlanilha);
                 if (!saved) return;
                 mostrarAlerta('Executando integração...', 'Aguarde', 'aguarde');
                 try {
                     const res = await apiRequest('integrarComPlanilhaTurnos', { idPlanilha: idPlanilha });
                     if (res && res.success) mostrarAlerta(res.message || 'Integração concluída!', 'Sucesso', 'sucesso');
                     else throw new Error(res.message || 'Erro na integração');
                 } catch (error) { mostrarAlerta(`Erro na integração: ${error.message}`, 'Erro', 'erro'); }
                 finally { if(modals.alert) modals.alert.hide(); } // Garante que fecha o modal
            });
            document.getElementById('btn-salvar-emails')?.addEventListener('click', async function() {
                 const emails = document.getElementById('emails-notificacao')?.value.trim() || '';
                 await salvarConfiguracao('EMAILS_NOTIFICACAO', emails, 'E-mails salvos!');
            });
            document.getElementById('integracao-automatica')?.addEventListener('change', async function() {
                 const valor = this.checked ? 'SIM' : 'NAO';
                 await salvarConfiguracao('INTEGRACAO_AUTOMATICA', valor, `Integração automática ${this.checked ? 'ativada' : 'desativada'}. (Re)Configure as Tarefas para aplicar.`);
            });
            document.getElementById('btn-teste-email')?.addEventListener('click', async function() {
                const emails = document.getElementById('emails-notificacao')?.value.trim();
                if (!emails) { mostrarAlerta('Informe e salve os e-mails antes de testar.', 'Aviso', 'aviso'); return; }
                const tipoEmail = document.getElementById('tipo-email-teste')?.value || 'nova';
                const emailList = emails.split(/[,;\s]+/).map(e => e.trim()).filter(e => e && e.includes('@'));
                if (emailList.length === 0) { mostrarAlerta('Nenhum e-mail válido encontrado.', 'Aviso', 'aviso'); return; }
                 mostrarAlerta('Buscando manutenção para teste...', 'Aguarde', 'aguarde');
                 try {
                    const resLista = await apiRequest('listarManutencoes', { limite: 1 });
                    if (!resLista?.success || !resLista.manutencoes?.length) { modals.alert.hide(); mostrarAlerta('Nenhuma manutenção encontrada para teste.', 'Aviso', 'aviso'); return; }
                    const idTeste = resLista.manutencoes[0].ID;
                     modals.alert.hide();
                    mostrarAlerta(`Enviando e-mail de teste (${tipoEmail})...`, 'Aguarde', 'aguarde');
                    const resEnvio = await apiRequest('enviarEmailNotificacao', { id: idTeste, destinatarios: JSON.stringify(emailList), tipo: tipoEmail });
                    if (resEnvio && resEnvio.success) mostrarAlerta(`E-mail de teste enviado para: ${emailList.join(', ')}`, 'Sucesso', 'sucesso');
                    else throw new Error(resEnvio.message || 'Erro ao enviar');
                } catch (error) { mostrarAlerta(`Erro no envio de teste: ${error.message}`, 'Erro', 'erro'); }
                 finally { if(modals.alert) modals.alert.hide(); }
            });
            document.getElementById('btn-configurar-gatilhos')?.addEventListener('click', async function() {
                mostrarConfirmacao("Configurar/Reconfigurar tarefas automáticas?", async () => {
                     mostrarAlerta('Configurando tarefas...', 'Aguarde', 'aguarde');
                     try {
                         const res = await apiRequest('configurarGatilhoAutomatico');
                         if (res && res.success) mostrarAlerta(res.message || 'Tarefas configuradas!', 'Sucesso', 'sucesso');
                         else throw new Error(res.message || 'Erro ao configurar');
                     } catch (error) { mostrarAlerta(`Erro: ${error.message}`, 'Erro', 'erro'); }
                      finally { if(modals.alert) modals.alert.hide(); }
                 });
            });
            document.getElementById('btn-verificar-atualizacoes')?.addEventListener('click', async function() {
                 mostrarAlerta('Verificando versão...', 'Aguarde', 'aguarde');
                 try {
                     const resVersao = await apiRequest('obterVersaoApp');
                     const vServidor = resVersao?.success ? resVersao.versao : 'N/A';
                     const vLocal = VERSAO_APP;
                     modals.alert.hide();
                     if (vServidor === 'N/A') mostrarAlerta(`Versão local: ${vLocal}. Não foi possível verificar servidor.`, 'Informação');
                     else if (vServidor === vLocal) mostrarAlerta(`Sistema atualizado (Versão ${vLocal})`, 'Atualizado', 'sucesso');
                     else mostrarAlerta(`Nova versão disponível: ${vServidor} (Atual: ${vLocal})`, 'Atualização', 'info');
                 } catch (error) { modals.alert.hide(); mostrarAlerta(`Erro ao verificar versão: ${error.message}`, 'Erro', 'erro'); }
            });


            // --- Filtro de Período do Gráfico --- (Manter)
            document.getElementById('filtro-periodo-grafico')?.addEventListener('change', carregarGraficoPeriodo);


            // --- Inicialização do Anotador --- (Manter)
             if (typeof ImageAnnotator !== 'undefined') {
                 anotadorImagem = new ImageAnnotator('annotation-container');
                 configurarSalvamentoAnotacao();
             } else {
                 console.warn("ImageAnnotator não definido.");
             }

            // --- Carregamento inicial ---
             console.log("Aplicação inicializada. Versão:", VERSAO_APP);

        }); // Fim DOMContentLoaded


         /**
          * Carrega os dados da manutenção na tela Pós. Chamada após salvar/editar Pré ou via modal 'choice'.
          * @param {string} id ID da manutenção.
          */
         async function carregarParaPosManutencao(id) {
             if (!id) {
                 mostrarAlerta("ID inválido para carregar pós-manutenção.", "Erro Interno", "erro");
                 mostrarTela('lista');
                 return;
             }
             mostrarAlerta('Carregando dados para pós-manutenção...', 'Aguarde', 'aguarde');
             try {
                 const resLoad = await apiRequest('obterManutencao', { id: id });
                 if (!resLoad?.success || !resLoad.manutencao) {
                     throw new Error(resLoad.message || "Erro ao recarregar dados.");
                 }
                 manutencaoAtual = resLoad.manutencao;
                  modals.alert.hide(); // Esconde "Aguarde"

                 // --- Limpar e Preencher Formulário Pós ---
                 const formPos = document.getElementById('form-pos-manutencao');
                 if(formPos) formPos.reset(); // Limpa campos
                 document.getElementById('imagens-preview-pos').innerHTML = ''; // Limpa imagens
                  const placeholderPos = document.getElementById('imagens-preview-pos-placeholder');
                  if(placeholderPos) placeholderPos.style.display = 'block'; // Mostra placeholder
                 imagenesPosUpload = []; // Limpa array global Pós

                 document.getElementById('pos-id').value = id;
                 document.getElementById('pos-placa-display').textContent = manutencaoAtual.Placa || 'N/A';
                 document.getElementById('pos-tipo-display').textContent = manutencaoAtual.Tipo_Equipamento || 'N/A';
                 document.getElementById('pos-observacoes').value = manutencaoAtual.Observacoes_Pos || '';

                 // Carrega imagens PÓS existentes
                 imagenesPosUpload = Array.isArray(manutencaoAtual.Imagens_Pos) ? [...manutencaoAtual.Imagens_Pos] : [];
                  if (imagenesPosUpload.length > 0 && placeholderPos) placeholderPos.style.display = 'none'; // Esconde placeholder
                 imagenesPosUpload.forEach(img => adicionarImagemPreview(img.url, 'pos', img.id));

                 // Preenche checklist PÓS
                 const checklistPosContainer = document.getElementById('pos-checklist-container');
                 checklistPosContainer.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                 const checklistPosData = manutencaoAtual.Checklist_Pos || {};
                 Object.entries(checklistPosData).forEach(([item, valor]) => {
                     const radioToCheck = checklistPosContainer.querySelector(`input[type="radio"][data-item="${CSS.escape(item)}"][value="${CSS.escape(valor)}"]`);
                     if (radioToCheck) radioToCheck.checked = true;
                 });

                 mostrarTela('posManu');

             } catch (loadError) {
                 modals.alert.hide();
                 console.error("Erro ao carregar para pós-manutenção:", loadError);
                 mostrarAlerta(`Erro ao carregar dados: ${loadError.message}`, "Erro Carregar Pós", "erro");
                 mostrarTela('lista');
             }
         }

    </script>

</body>
</html>
