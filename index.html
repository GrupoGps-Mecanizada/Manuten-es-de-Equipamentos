<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Manutenção de Equipamentos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
        }

        body {
            background-color: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 40px; /* Espaço para o rodapé */
        }

        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.4rem;
            color: white !important;
        }

        .card {
            border-radius: 8px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
            font-weight: bold;
            border-radius: 8px 8px 0 0 !important;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .list-group-item {
            border-left: none;
            border-right: none;
            padding: 15px 20px;
        }

        .status-badge {
            font-size: 0.8em;
            padding: 5px 10px;
            border-radius: 20px;
        }

        .checklist-item {
            margin-bottom: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
        }

        .checklist-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .image-preview {
            max-width: 100%;
            height: auto;
            object-fit: cover;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .image-container {
            display: inline-block;
            margin: 5px;
            position: relative;
        }

        .image-container img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ddd;
            cursor: pointer; /* Para indicar que é clicável */
        }

        .image-container .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.7); /* Vermelho para destaque */
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            padding: 0;
            font-size: 14px;
            line-height: 1;
        }
        .image-container .delete-btn:hover {
             background-color: rgba(255, 0, 0, 0.9);
        }

        /* Botão de anotação */
        .image-container .btn-annotate {
             position: absolute;
             top: 5px;
             left: 5px; /* Ajustado para esquerda */
             background-color: rgba(0, 123, 255, 0.7); /* Azul */
             color: white;
             border-radius: 50%;
             width: 25px;
             height: 25px;
             display: flex;
             align-items: center;
             justify-content: center;
             cursor: pointer;
             border: none;
             padding: 0;
             font-size: 12px; /* Ícone menor */
             line-height: 1;
        }
        .image-container .btn-annotate:hover {
             background-color: rgba(0, 123, 255, 0.9);
        }


        /* Status colors */
        .status-aguardando {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-em-manutencao {
            background-color: #cce5ff;
            color: #004085;
        }

        .status-concluido {
            background-color: #d4edda;
            color: #155724;
        }

        .status-disponivel {
            background-color: #d1e7dd;
            color: #0f5132;
        }

        /* Dashboard */
        .stat-card {
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            min-height: 120px;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .stat-title {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .recent-activity {
            max-height: 400px;
            overflow-y: auto;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .card-body {
                padding: 15px;
            }

            .container {
                padding-left: 10px;
                padding-right: 10px;
            }

            .btn {
                padding: 0.375rem 0.75rem;
            }

            .stat-card {
                padding: 10px;
                min-height: 100px;
            }

            .stat-card .stat-value {
                font-size: 1.5rem;
            }

            .image-container img {
                width: 100px;
                height: 100px;
            }
            .navbar-nav {
                text-align: center; /* Centraliza itens no mobile */
            }
        }

        /* Camera styles */
        .camera-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }

        #camera-preview {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Anotação */
         #annotation-container {
             overflow: auto; /* Permite scroll se a imagem for grande */
             max-height: 60vh; /* Limita altura no modal */
             text-align: center; /* Centraliza a imagem/canvas */
         }
        #annotation-canvas {
             cursor: crosshair;
        }
        .annotation-controls .btn.active {
             background-color: var(--primary-color);
             color: white;
        }

        /* Footer */
        .footer-dev {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f8f9fa; /* Cor de fundo suave */
            padding: 5px 0;
            text-align: center;
            font-size: 0.8em;
            color: #6c757d; /* Cinza secundário */
            border-top: 1px solid #dee2e6;
        }

        /* Outros ajustes */
        .checklist-item .btn-group .btn {
             padding: 0.25rem 0.5rem; /* Menor padding nos botões do checklist */
             font-size: 0.8rem; /* Fonte menor */
        }
        .checklist-item .btn-group .btn i {
             margin-right: 3px !important; /* Espaço menor para ícone */
        }

    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-tools me-2"></i>Sistema de Manutenção
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="nav-dashboard">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-lista">
                            <i class="bi bi-list-ul me-1"></i>Lista
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-novo">
                            <i class="bi bi-plus-circle me-1"></i>Nova Manutenção
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-ferramentas">
                            <i class="bi bi-tools me-1"></i>Ferramentas
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="conteudo-principal">

            <div id="tela-dashboard" class="view-content">
                <h2 class="mb-4">Dashboard de Manutenções</h2>

                <div class="row mb-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card bg-light">
                            <div class="stat-title">Equipamentos</div>
                            <div class="stat-value" id="total-equipamentos">0</div>
                            <div>Total cadastrado</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card bg-light">
                            <div class="stat-title">Aguardando</div>
                            <div class="stat-value text-warning" id="total-aguardando">0</div>
                            <div>Manutenções pendentes</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card bg-light">
                            <div class="stat-title">Em Manutenção</div>
                            <div class="stat-value text-primary" id="total-em-manutencao">0</div>
                            <div>Em andamento</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card bg-light">
                            <div class="stat-title">Concluídas</div>
                            <div class="stat-value text-success" id="total-concluidas">0</div>
                            <div>Finalizadas</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-wrench me-2"></i>Manutenções Recentes
                            </div>
                            <div class="card-body p-0">
                                <ul class="list-group list-group-flush" id="manutencoes-recentes"> </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-activity me-2"></i>Atividade Recente
                            </div>
                            <div class="card-body p-0 recent-activity">
                                <ul class="list-group list-group-flush" id="atividade-recente"> </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-bar-chart me-2"></i>Manutenções por Tipo de Equipamento
                            </div>
                            <div class="card-body" id="grafico-tipos" style="min-height: 300px;"> </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-pie-chart me-2"></i>Manutenções por Categoria
                            </div>
                            <div class="card-body" id="grafico-categorias" style="min-height: 300px;"> </div>
                        </div>
                    </div>
                </div>
                 <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-clock-history me-2"></i>Tempo Médio de Manutenção
                            </div>
                           <div class="card-body" id="grafico-tempo-medio" style="min-height: 300px;"> </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-calendar-check me-2"></i>Manutenções por Período
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-end mb-3">
                                    <select id="filtro-periodo-grafico" class="form-select form-select-sm" style="width: auto;">
                                        <option value="7">Últimos 7 dias</option>
                                        <option value="30" selected>Últimos 30 dias</option>
                                        <option value="90">Últimos 90 dias</option>
                                        <option value="365">Último ano</option>
                                    </select>
                                </div>
                                <div id="grafico-periodo" style="min-height: 250px;"> </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-truck me-2"></i>Status dos Equipamentos
                    </div>
                    <div class="card-body">
                        <div class="row" id="status-equipamentos">
                            </div>
                    </div>
                </div>

            </div> <div id="tela-lista" class="view-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Lista de Manutenções</h2>
                    <button class="btn btn-primary" id="btn-nova-manutencao">
                        <i class="bi bi-plus-circle me-1"></i>Nova Manutenção
                    </button>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select" id="filtro-status">
                                    <option value="">Todos os Status</option>
                                    <option value="Aguardando Manutenção">Aguardando</option>
                                    <option value="Em Manutenção">Em Manutenção</option>
                                    <option value="Manutenção Concluída">Concluídas</option>
                                    <option value="Equipamento Disponível">Disponíveis</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="filtro-placa" placeholder="Filtrar por Placa">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100" id="btn-filtrar">
                                    <i class="bi bi-search me-1"></i>Filtrar
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary w-100" id="btn-limpar-filtro">
                                    <i class="bi bi-x-circle me-1"></i>Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Placa</th>
                                        <th>Tipo</th> <th>Data</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-manutencoes">
                                    </tbody>
                            </table>
                        </div>
                        <div id="sem-registros" class="text-center py-4" style="display: none;">
                            <i class="bi bi-exclamation-circle fs-1 text-muted"></i>
                            <p class="mt-2 text-muted">Nenhum registro encontrado</p>
                        </div>
                    </div>
                </div>
            </div> <div id="tela-pre-manutencao" class="view-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Registro de Pré-Manutenção</h2>
                    <button class="btn btn-outline-secondary btn-voltar">
                        <i class="bi bi-arrow-left me-1"></i>Voltar
                    </button>
                </div>

                <form id="form-pre-manutencao">
                    <input type="hidden" id="pre-id" name="id">

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-truck me-2"></i>Informações do Equipamento
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="pre-tipo-equipamento" class="form-label">Tipo de Equipamento*</label>
                                    <select class="form-select" id="pre-tipo-equipamento" name="tipoEquipamento" required>
                                        <option value="">Selecione...</option>
                                        <option value="Caminhão Alta Pressão">Caminhão Alta Pressão</option>
                                        <option value="Caminhão Auto Vácuo">Caminhão Auto Vácuo</option>
                                        <option value="Caminhão Hiper Vácuo">Caminhão Hiper Vácuo</option>
                                        <option value="Caminhão Conjugado">Caminhão Conjugado</option>
                                        <option value="Caminhão Brook">Caminhão Brook</option>
                                        <option value="Aspirador de Pó">Aspirador de Pó</option>
                                        <option value="Outro Tipo">Outro Tipo</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="pre-placa-select" class="form-label">Equipamento/Placa*</label>
                                    <select class="form-select" id="pre-placa-select" style="display: none;">
                                        <option value="">Selecione o Equipamento...</option>
                                    </select>
                                    <input type="text" class="form-control mt-2" id="pre-placa-outro-valor" style="display: none;" placeholder="Digite a placa ou nome do equipamento">
                                    <input type="hidden" id="pre-placa" name="placa" required>
                                    <input type="hidden" id="pre-modelo" name="modelo"> </div>
                            </div>
                        </div>
                    </div> <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-exclamation-triangle me-2"></i>Detalhes do Problema
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="pre-categoria-problema" class="form-label">Categoria do Problema*</label>
                                    <select class="form-select" id="pre-categoria-problema" name="categoriaProblema" required>
                                        <option value="">Selecione...</option>
                                        </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="pre-urgencia" class="form-label">Urgência*</label>
                                    <select class="form-select" id="pre-urgencia" name="urgencia" required>
                                        <option value="">Selecione...</option>
                                        </select>
                                </div>
                                <div class="col-12" id="motivo-outro-container" style="display: none;">
                                    <label for="pre-motivo-outro" class="form-label">Especifique o Problema*</label>
                                    <input type="text" class="form-control" id="pre-motivo-outro" name="motivoOutro">
                                </div>
                                <div class="col-12">
                                    <label for="pre-descricao-problema" class="form-label">Descrição do Problema*</label>
                                    <textarea class="form-control" id="pre-descricao-problema" name="descricaoProblema" rows="3" required></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-check-square me-2"></i>Checklist Pré-Manutenção
                        </div>
                        <div class="card-body">
                            <div id="pre-checklist-container">
                                </div>
                            <div class="mb-3">
                                <label for="pre-observacoes" class="form-label">Observações Adicionais</label>
                                <textarea class="form-control" id="pre-observacoes" name="observacoesPre" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-camera me-2"></i>Registro Fotográfico
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="d-flex gap-2 mb-3 flex-wrap"> <button type="button" class="btn btn-primary" id="btn-abrir-camera-pre">
                                        <i class="bi bi-camera-fill me-1"></i>Abrir Câmera
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="btn-selecionar-imagem-pre">
                                        <i class="bi bi-image me-1"></i>Da Galeria
                                    </button>
                                    <input type="file" id="input-imagem-pre" accept="image/*" multiple style="display: none;"> </div>

                                <div id="camera-container-pre" class="camera-container" style="display: none;">
                                    <video id="camera-preview-pre" autoplay playsinline></video>
                                    <div class="camera-controls">
                                        <button type="button" class="btn btn-primary" id="btn-capturar-pre">
                                            <i class="bi bi-camera-fill me-1"></i>Capturar
                                        </button>
                                        <button type="button" class="btn btn-danger" id="btn-fechar-camera-pre">
                                            <i class="bi bi-x-circle me-1"></i>Fechar
                                        </button>
                                    </div>
                                </div>

                                <div id="imagens-preview-pre" class="d-flex flex-wrap gap-2 mt-3">
                                    </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-person me-2"></i>Responsável pelo Registro
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="pre-responsavel" class="form-label">Nome do Responsável*</label>
                                <input type="text" class="form-control" id="pre-responsavel" name="responsavel" required>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mb-4">
                        <button type="button" class="btn btn-outline-secondary btn-voltar">
                            <i class="bi bi-arrow-left me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>Salvar e Avançar
                        </button>
                    </div>
                </form>
            </div> <div id="tela-pos-manutencao" class="view-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Registro de Pós-Manutenção</h2>
                    <button class="btn btn-outline-secondary btn-voltar">
                        <i class="bi bi-arrow-left me-1"></i>Voltar
                    </button>
                </div>

                <form id="form-pos-manutencao">
                    <input type="hidden" id="pos-id" name="id">

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-truck me-2"></i>Resumo do Equipamento
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6"> <p class="form-label">Placa/Equipamento</p>
                                    <p class="form-control-plaintext" id="pos-placa-display"></p>
                                </div>
                                <div class="col-md-6"> <p class="form-label">Tipo de Equipamento</p>
                                    <p class="form-control-plaintext" id="pos-tipo-display"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-check-square me-2"></i>Checklist Pós-Manutenção
                        </div>
                        <div class="card-body">
                            <div id="pos-checklist-container">
                                </div>
                            <div class="mb-3">
                                <label for="pos-observacoes" class="form-label">Observações da Manutenção</label>
                                <textarea class="form-control" id="pos-observacoes" name="observacoesPos" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-camera me-2"></i>Registro Fotográfico Pós-Manutenção
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="d-flex gap-2 mb-3 flex-wrap"> <button type="button" class="btn btn-primary" id="btn-abrir-camera-pos">
                                        <i class="bi bi-camera-fill me-1"></i>Abrir Câmera
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="btn-selecionar-imagem-pos">
                                        <i class="bi bi-image me-1"></i>Da Galeria
                                    </button>
                                    <input type="file" id="input-imagem-pos" accept="image/*" multiple style="display: none;"> </div>

                                <div id="camera-container-pos" class="camera-container" style="display: none;">
                                    <video id="camera-preview-pos" autoplay playsinline></video>
                                    <div class="camera-controls">
                                        <button type="button" class="btn btn-primary" id="btn-capturar-pos">
                                            <i class="bi bi-camera-fill me-1"></i>Capturar
                                        </button>
                                        <button type="button" class="btn btn-danger" id="btn-fechar-camera-pos">
                                            <i class="bi bi-x-circle me-1"></i>Fechar
                                        </button>
                                    </div>
                                </div>

                                <div id="imagens-preview-pos" class="d-flex flex-wrap gap-2 mt-3">
                                    </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mb-4">
                        <button type="button" class="btn btn-outline-secondary" id="btn-voltar-pre">
                            <i class="bi bi-arrow-left me-1"></i>Voltar para Pré-Manutenção
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i>Finalizar Manutenção
                        </button>
                    </div>
                </form>
            </div> <div id="tela-visualizacao" class="view-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2"> <h2>Detalhes da Manutenção</h2>
                    <div class="btn-group flex-wrap"> <button class="btn btn-outline-secondary btn-voltar">
                            <i class="bi bi-arrow-left me-1"></i>Voltar
                        </button>
                        <button class="btn btn-outline-primary" id="btn-editar-manutencao">
                            <i class="bi bi-pencil me-1"></i>Editar
                        </button>
                         <div class="dropdown d-inline-block">
                          <button class="btn btn-outline-primary dropdown-toggle" type="button" id="btnRelatorioOpcoes" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-file-earmark me-1"></i>Relatórios
                          </button>
                          <ul class="dropdown-menu" aria-labelledby="btnRelatorioOpcoes">
                            <li><a class="dropdown-item" href="#" id="btn-gerar-pdf-basico">Relatório PDF Básico</a></li>
                            <li><a class="dropdown-item" href="#" id="btn-gerar-pdf-avancado">Relatório PDF Avançado</a></li>
                            <li><a class="dropdown-item" href="#" id="btn-gerar-excel">Exportar para Excel</a></li>
                            <li><a class="dropdown-item" href="#" id="btn-gerar-csv">Exportar para CSV</a></li>
                          </ul>
                        </div> </div>
                </div>

                <div id="detalhes-manutencao">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-info-circle me-2"></i>Informações Gerais
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <h6 class="text-muted">ID da Manutenção</h6>
                                    <p id="view-id"></p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <h6 class="text-muted">Data de Abertura</h6>
                                    <p id="view-data-criacao"></p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <h6 class="text-muted">Status</h6>
                                    <p><span class="badge" id="view-status"></span></p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <h6 class="text-muted">Responsável</h6>
                                    <p id="view-responsavel"></p>
                                </div>
                            </div>
                            <hr>
                             <div class="row">
                                <div class="col-md-6 mb-3"> <h6 class="text-muted">Placa do Equipamento</h6>
                                    <p id="view-placa"></p>
                                </div>
                                <div class="col-md-6 mb-3"> <h6 class="text-muted">Tipo de Equipamento</h6>
                                    <p id="view-tipo-equipamento"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-exclamation-triangle me-2"></i>Detalhes do Problema
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <h6 class="text-muted">Categoria do Problema</h6>
                                    <p id="view-categoria-problema"></p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <h6 class="text-muted">Urgência</h6>
                                    <p id="view-urgencia"></p>
                                </div>
                            </div>
                            <div class="row mb-3" id="view-motivo-outro-container" style="display: none;">
                                <div class="col-12">
                                    <h6 class="text-muted">Especificação do Problema</h6>
                                    <p id="view-motivo-outro"></p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="text-muted">Descrição do Problema</h6>
                                    <p id="view-descricao-problema" style="white-space: pre-wrap;"></p> </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-clipboard-check me-2"></i>Registro Pré-Manutenção
                        </div>
                        <div class="card-body">
                            <h6 class="mb-3">Checklist Pré-Manutenção</h6>
                            <div id="view-checklist-pre" class="mb-4">
                                </div>

                            <h6 class="mb-2">Observações</h6>
                            <p id="view-observacoes-pre" class="mb-4" style="white-space: pre-wrap;"></p> <h6 class="mb-2">Imagens</h6>
                            <div id="view-imagens-pre" class="d-flex flex-wrap gap-2">
                                </div>
                        </div>
                    </div>

                    <div class="card mb-4" id="view-section-pos-manutencao" style="display: none;"> <div class="card-header">
                            <i class="bi bi-clipboard-check me-2"></i>Registro Pós-Manutenção
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="mb-2">Data da Manutenção</h6>
                                    <p id="view-data-manutencao"></p>
                                </div>
                            </div>

                            <h6 class="mb-3">Checklist Pós-Manutenção</h6>
                            <div id="view-checklist-pos" class="mb-4">
                                </div>

                            <h6 class="mb-2">Observações</h6>
                            <p id="view-observacoes-pos" class="mb-4" style="white-space: pre-wrap;"></p> <h6 class="mb-2">Imagens</h6>
                            <div id="view-imagens-pos" class="d-flex flex-wrap gap-2">
                                </div>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-arrow-repeat me-2"></i>Atualizar Status
                        </div>
                        <div class="card-body">
                            <div class="d-flex gap-2 flex-wrap"> <button class="btn btn-outline-warning btn-status" data-status="Aguardando Manutenção">
                                    <i class="bi bi-hourglass me-1"></i>Aguardando
                                </button>
                                <button class="btn btn-outline-primary btn-status" data-status="Em Manutenção">
                                    <i class="bi bi-tools me-1"></i>Em Manutenção
                                </button>
                                <button class="btn btn-outline-success btn-status" data-status="Manutenção Concluída">
                                    <i class="bi bi-check-circle me-1"></i>Concluído
                                </button>
                                <button class="btn btn-outline-info btn-status" data-status="Equipamento Disponível">
                                    <i class="bi bi-check-all me-1"></i>Disponível
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <div id="tela-ferramentas" class="view-content" style="display: none;">
                <h2 class="mb-4">Ferramentas e Integrações</h2>

                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="bi bi-table me-2"></i>Integração com Planilha de Turnos
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    Transfira automaticamente os dados de equipamentos em manutenção para a planilha de turnos.
                                </p>
                                <div class="mb-3">
                                    <label for="id-planilha-turnos" class="form-label">ID da Planilha de Turnos</label>
                                    <input type="text" class="form-control" id="id-planilha-turnos" placeholder="Cole o ID da planilha aqui">
                                    <div class="form-text">
                                        Para encontrar o ID, abra a planilha de turnos e copie o código da URL entre /d/ e /edit
                                    </div>
                                </div>
                                 <div class="d-grid">
                                    <button class="btn btn-primary" id="btn-executar-integracao">
                                        <i class="bi bi-arrow-repeat me-1"></i>Executar Integração Agora
                                    </button>
                                </div>
                                <div class="mt-3 small">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="integracao-automatica" checked>
                                        <label class="form-check-label" for="integracao-automatica">
                                            Ativar integração automática diária
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer text-muted small">
                                A integração automática (se ativada) transfere dados todos os dias às 6h.
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="bi bi-envelope me-2"></i>Notificações por E-mail
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    Configure e-mails para receber atualizações e alertas sobre manutenções.
                                </p>
                                <div class="mb-3">
                                    <label for="emails-notificacao" class="form-label">E-mails para Notificação</label>
                                    <textarea class="form-control" id="emails-notificacao" rows="3" placeholder="exemplo@empresa.com, gerente@empresa.com"></textarea>
                                    <div class="form-text">
                                        Separe múltiplos e-mails por vírgula ou ponto-e-vírgula
                                    </div>
                                </div>
                                 <div class="d-grid">
                                    <button class="btn btn-primary" id="btn-salvar-emails">
                                        <i class="bi bi-save me-1"></i>Salvar Configuração de E-mails
                                    </button>
                                 </div>
                                <div class="mt-3">
                                    <div class="form-text mb-2">
                                        Enviar e-mail de teste para verificar a configuração (usa a primeira manutenção encontrada):
                                     </div>
                                    <div class="input-group">
                                        <select class="form-select" id="tipo-email-teste">
                                            <option value="nova">Nova Manutenção</option>
                                            <option value="atualizacao">Atualização de Status</option>
                                            <option value="conclusao">Conclusão</option>
                                            <option value="alerta">Alerta Urgente</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" id="btn-teste-email">
                                            <i class="bi bi-send me-1"></i>Enviar Teste
                                         </button>
                                    </div>
                                </div>
                            </div>
                             <div class="card-footer text-muted small">
                                Notificações automáticas são enviadas em eventos importantes de manutenção.
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                 <i class="bi bi-gear me-2"></i>Configurações do Sistema
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    Configure e atualize parâmetros e tarefas automáticas do sistema.
                                </p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" id="btn-configurar-gatilhos">
                                        <i class="bi bi-clock-history me-1"></i>(Re)Configurar Tarefas Automáticas
                                     </button>
                                    <button class="btn btn-outline-primary" id="btn-verificar-atualizacoes">
                                        <i class="bi bi-cloud-download me-1"></i>Verificar Atualizações
                                    </button>
                                 </div>
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">Versão do Sistema:</span>
                                         <span class="badge bg-info" id="versao-sistema"><?= VERSAO_APP ?></span>
                                    </div>
                                    <div class="progress" style="height: 5px;">
                                         <div class="progress-bar" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer text-muted small">
                                   Mantenha o sistema atualizado e configure as tarefas automáticas.
                            </div>
                        </div>
                    </div>
                </div>
            </div> </div> </div> <div class="modal fade" id="cameraModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Capturar Imagem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="camera-container">
                        <video id="camera-modal-preview" autoplay playsinline></video>
                        <canvas id="camera-canvas" style="display: none;"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-capturar-modal">
                        <i class="bi bi-camera-fill me-1"></i>Capturar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirm-message">Tem certeza que deseja realizar esta ação?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirm-yes">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alert-title">Aviso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="alert-message" style="white-space: pre-wrap;"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="choiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registro Salvo com Sucesso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>O registro de pré-manutenção foi salvo com sucesso!</p>
                    <p>O que deseja fazer agora?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" id="btn-choice-lista">
                        <i class="bi bi-list-ul me-1"></i>Ir para Lista
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="btn-choice-novo">
                        <i class="bi bi-plus-circle me-1"></i>Novo Registro
                    </button>
                    <button type="button" class="btn btn-primary" id="btn-choice-pos">
                        <i class="bi bi-arrow-right me-1"></i>Continuar para Pós-Manutenção
                    </button>
                </div>
            </div>
        </div>
    </div>

     <div class="modal fade" id="modal-anotacao" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Anotar Imagem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                 </div>
                <div class="modal-body">
                    <div id="annotation-container">
                         </div>
                </div>
                 <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-save-annotation">Salvar Anotação</button>
                </div>
             </div>
        </div>
    </div>

    <footer class="footer-dev">
        &lt;/> Desenvolvido por Warlison Abreu
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        /**
         * ImageAnnotator - Ferramenta para anotações em imagens
         * Permite circular e desenhar retângulos em imagens
         */
        class ImageAnnotator {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                if (!this.container) {
                    console.error(`Container #${containerId} não encontrado`);
                    return;
                }
                this.imageElement = null;
                this.canvas = null;
                this.context = null;
                this.isDrawing = false;
                this.startX = 0;
                this.startY = 0;
                this.currentShape = 'circle'; // circle ou rectangle
                this.history = []; // Para armazenar anotações

                this.initContainer();
            }

            initContainer() {
                // Limpar container
                this.container.innerHTML = '';
                // Criar estrutura
                this.container.innerHTML = `
                    <div class="annotation-controls text-center mb-2"> <div class="btn-group" role="group" aria-label="Ferramentas de Anotação">
                            <button type="button" class="btn btn-sm btn-outline-primary active" id="btn-circle-<span class="math-inline">\{this\.container\.id\}"\> <i class\="bi bi\-circle"\></i\> Círculo
</button\>
<button type\="button" class\="btn btn\-sm btn\-outline\-primary" id\="btn\-rectangle\-</span>{this.container.id}"> <i class="bi bi-square"></i> Retângulo
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="btn-clear-<span class="math-inline">\{this\.container\.id\}"\> <i class\="bi bi\-trash"\></i\> Limpar Última
</button\>
<button type\="button" class\="btn btn\-sm btn\-outline\-secondary" id\="btn\-clear\-all\-</span>{this.container.id}"> <i class="bi bi-x-octagon"></i> Limpar Todas
                            </button>
                        </div>
                    </div>
                    <div class="image-container position-relative text-center"> <img src="" id="annotation-image-<span class="math-inline">\{this\.container\.id\}" style\="display\: none; max\-width\: 100%; vertical\-align\: top;"\> <canvas id\="annotation\-canvas\-</span>{this.container.id}" style="position: absolute; top: 0; left: 0; max-width: 100%; display: none;"></canvas> </div>
                `;
                // Obter referências
                this.imageElement = document.getElementById(`annotation-image-${this.container.id}`);
                this.canvas = document.getElementById(`annotation-canvas-${this.container.id}`);
                this.context = this.canvas.getContext('2d');

                // Configurar event listeners dos botões
                 document.getElementById(`btn-circle-${this.container.id}`).addEventListener('click', () => this.setShape('circle'));
                 document.getElementById(`btn-rectangle-${this.container.id}`).addEventListener('click', () => this.setShape('rectangle'));
                 document.getElementById(`btn-clear-${this.container.id}`).addEventListener('click', () => this.clearLastAnnotation());
                 document.getElementById(`btn-clear-all-${this.container.id}`).addEventListener('click', () => this.clearAllAnnotations());


                // Listeners de desenho no canvas
                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', (e) => this.stopDrawing(e));
                this.canvas.addEventListener('mouseout', () => { if (this.isDrawing) this.stopDrawing(); }); // Cancela se sair com botão pressionado

                // Versão touch
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startDrawing(this.getTouchPos(e));
                }, { passive: false });
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    this.draw(this.getTouchPos(e));
                }, { passive: false });
                this.canvas.addEventListener('touchend', (e) => {
                     e.preventDefault();
                     this.stopDrawing(this.getTouchPos(e, true)); // Passa a posição final do toque
                 });
            }

            // Carrega uma imagem para anotação
            loadImage(src) {
                return new Promise((resolve, reject) => {
                    this.imageElement.onload = () => {
                        // Redimensionar canvas para tamanho da imagem
                        this.canvas.width = this.imageElement.naturalWidth; // Usar naturalWidth/Height
                        this.canvas.height = this.imageElement.naturalHeight;

                        // Ajustar estilo do canvas para sobrepor a imagem corretamente
                        this.canvas.style.position = 'absolute';
                        this.canvas.style.top = this.imageElement.offsetTop + 'px';
                        this.canvas.style.left = this.imageElement.offsetLeft + 'px';
                        this.canvas.style.width = this.imageElement.width + 'px'; // Match display size
                        this.canvas.style.height = this.imageElement.height + 'px'; // Match display size

                        this.canvas.style.display = 'block';
                        this.imageElement.style.display = 'block';
                        this.history = []; // Limpa histórico ao carregar nova imagem
                        this.redrawAnnotations(); // Redesenha (nenhuma no início)
                        resolve();
                    };
                    this.imageElement.onerror = (err) => {
                        console.error("Erro ao carregar imagem no anotador:", src, err);
                        reject(err);
                    };
                    this.imageElement.src = src;
                });
            }

            // Define a forma de desenho atual
            setShape(shape) {
                this.currentShape = shape;
                // Atualizar UI
                document.getElementById(`btn-circle-${this.container.id}`).classList.toggle('active', shape === 'circle');
                document.getElementById(`btn-rectangle-${this.container.id}`).classList.toggle('active', shape === 'rectangle');
            }

             // Redesenha todas as anotações do histórico
            redrawAnnotations() {
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.context.strokeStyle = 'red';
                this.context.lineWidth = 2;

                this.history.forEach(annotation => {
                    this.context.beginPath();
                    if (annotation.shape === 'circle') {
                        const radius = Math.sqrt(Math.pow(annotation.endX - annotation.startX, 2) + Math.pow(annotation.endY - annotation.startY, 2));
                        this.context.arc(annotation.startX, annotation.startY, radius, 0, Math.PI * 2);
                    } else if (annotation.shape === 'rectangle') {
                        const width = annotation.endX - annotation.startX;
                        const height = annotation.endY - annotation.startY;
                        this.context.rect(annotation.startX, annotation.startY, width, height);
                    }
                    this.context.stroke();
                });
            }

            // Limpa a última anotação
             clearLastAnnotation() {
                 if (this.history.length > 0) {
                     this.history.pop(); // Remove a última do histórico
                     this.redrawAnnotations(); // Redesenha sem a última
                 }
             }

            // Limpa todas as anotações
            clearAllAnnotations() {
                this.history = []; // Limpa histórico
                this.redrawAnnotations(); // Redesenha (canvas vazio)
            }


            // Inicia o desenho
            startDrawing(e) {
                 if (!e) return; // Safety check for touch events ending outside
                this.isDrawing = true;
                // Obter coordenadas relativas ao canvas
                const rect = this.canvas.getBoundingClientRect();
                const scaleX = this.canvas.width / rect.width; // Fator de escala X
                const scaleY = this.canvas.height / rect.height; // Fator de escala Y
                this.startX = (e.clientX - rect.left) * scaleX;
                this.startY = (e.clientY - rect.top) * scaleY;
            }

            // Desenha enquanto o mouse/touch se move
            draw(e) {
                 if (!this.isDrawing || !e) return;
                // Limpar canvas e redesenhar histórico antes de desenhar a forma atual
                this.redrawAnnotations();

                // Obter coordenadas atuais relativas ao canvas
                 const rect = this.canvas.getBoundingClientRect();
                 const scaleX = this.canvas.width / rect.width;
                 const scaleY = this.canvas.height / rect.height;
                 const x = (e.clientX - rect.left) * scaleX;
                 const y = (e.clientY - rect.top) * scaleY;


                // Configurar estilo para a forma atual
                this.context.strokeStyle = 'red';
                this.context.lineWidth = 2;

                // Desenhar forma atual (temporária)
                this.context.beginPath();
                if (this.currentShape === 'circle') {
                    const radius = Math.sqrt(Math.pow(x - this.startX, 2) + Math.pow(y - this.startY, 2));
                    this.context.arc(this.startX, this.startY, radius, 0, Math.PI * 2);
                } else if (this.currentShape === 'rectangle') {
                    const width = x - this.startX;
                    const height = y - this.startY;
                    this.context.rect(this.startX, this.startY, width, height);
                }
                 this.context.stroke();
            }

            // Finaliza o desenho e armazena no histórico
            stopDrawing(e) {
                 if (!this.isDrawing) return;
                this.isDrawing = false;

                 // Obter coordenadas finais relativas ao canvas
                 let endX = this.startX; // Default se não houver evento final (mouseout)
                 let endY = this.startY;
                 if (e) {
                     const rect = this.canvas.getBoundingClientRect();
                     const scaleX = this.canvas.width / rect.width;
                     const scaleY = this.canvas.height / rect.height;
                     endX = (e.clientX - rect.left) * scaleX;
                     endY = (e.clientY - rect.top) * scaleY;
                 }

                 // Evitar pontos ou formas muito pequenas
                 if (Math.abs(endX - this.startX) < 5 && Math.abs(endY - this.startY) < 5) {
                     this.redrawAnnotations(); // Apenas redesenha o histórico
                     return;
                 }

                 // Adiciona a anotação ao histórico
                 this.history.push({
                     shape: this.currentShape,
                     startX: this.startX,
                     startY: this.startY,
                     endX: endX,
                     endY: endY
                 });

                 // Redesenha todas as anotações do histórico
                 this.redrawAnnotations();
            }

            // Obtém posição do toque
            getTouchPos(touchEvent, isEndEvent = false) {
                 const touches = isEndEvent ? touchEvent.changedTouches : touchEvent.touches;
                 if (!touches || touches.length === 0) return null;
                 const touch = touches[0];
                return {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                };
            }

            // Captura a imagem com anotações
            captureImage() {
                // Criar canvas temporário
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = this.canvas.width; // Usar tamanho original
                tempCanvas.height = this.canvas.height;
                const tempContext = tempCanvas.getContext('2d');
                // Desenhar imagem original
                tempContext.drawImage(this.imageElement, 0, 0, this.canvas.width, this.canvas.height);
                // Desenhar anotações do canvas final (histórico redesenhado)
                tempContext.drawImage(this.canvas, 0, 0);

                // Retornar como data URL JPEG com qualidade
                return tempCanvas.toDataURL('image/jpeg', 0.9); // Qualidade 0.9
            }
        }

        // Inicialização e exportação da função construtora (se necessário globalmente)
        // window.ImageAnnotator = ImageAnnotator; // Descomente se precisar acessar de fora
    </script>

    <script>
        // Variáveis globais
        let tiposEquipamentosOptions = []; // Renomeado para evitar conflito
        let categoriasProblemas = [];
        let niveisUrgencia = [];
        let checklistItens = [];
        let equipamentos = []; // Lista completa de equipamentos cadastrados
        let manutencoes = []; // Lista de manutenções carregadas
        let manutencaoAtual = null;
        let imagenesPreUpload = []; // Armazena { url: '...', id: '...', base64: '...' } ou apenas { url: '...', id: '...' }
        let imagenesPosUpload = [];
        let mediaStream = null;
        let anotadorImagem = null; // Instância do anotador
        let imagemOriginalParaSalvar = null; // Guarda a URL original ao editar

        // Dados dos equipamentos para os selects dinâmicos
         const equipamentosData = {
            "Caminhão Alta Pressão": [
                'PUB-2G02', 'LUX-3201', 'FLX7617', 'EZS-8765', 'EZS-8764', 'EVK-0291',
                'EOF-5C06', 'EOF-5208', 'EGC-2989', 'EGC-2985', 'EGC-2983', 'EGC-2978',
                'EAM-3262', 'EAM-3256', 'EAM-3255', 'EAM-3253', 'EAM-3010', 'DSY-6475',
                'DSY-6474', 'DSY-6472', 'CZC-0453'
            ],
             "Caminhão Auto Vácuo": [ // Combina Auto e Hiper aqui se a lógica for a mesma
                 'PUB-2F80', 'NFF-0235', 'HJS-1097', 'FSA-3D71', 'EGC-2993', 'EGC-2979',
                 'EAM-3257', 'EAM-3251', 'DYB-7210', 'DSY-6577', 'DSY-6473', 'CUB-0763',
                 'ANF-2676', 'FTW-4D99', 'FTD-6368', 'FMD-2200', 'FHD-9264', 'EZS-9753'
             ],
             "Caminhão Hiper Vácuo": [ // Pode repetir ou ter lista diferente
                 'PUB-2F80', 'NFF-0235', 'HJS-1097', 'FSA-3D71', 'EGC-2993', 'EGC-2979',
                 'EAM-3257', 'EAM-3251', 'DYB-7210', 'DSY-6577', 'DSY-6473', 'CUB-0763',
                 'ANF-2676', 'FTW-4D99', 'FTD-6368', 'FMD-2200', 'FHD-9264', 'EZS-9753'
             ],
             "Caminhão Conjugado": [], // Adicionar placas se houver
             "Caminhão Brook": [], // Adicionar placas se houver
             "Aspirador de Pó": [], // Adicionar nomes/ids se houver
             "Outro Tipo": [] // Para equipamentos não listados
        };
        // Adiciona a opção 'OUTRO EQUIPAMENTO' a todas as listas
         Object.keys(equipamentosData).forEach(tipo => {
             equipamentosData[tipo].push('OUTRO EQUIPAMENTO');
         });


        // Elementos da interface
        const views = {
            dashboard: document.getElementById('tela-dashboard'),
            lista: document.getElementById('tela-lista'),
            preManu: document.getElementById('tela-pre-manutencao'),
            posManu: document.getElementById('tela-pos-manutencao'),
            visualizacao: document.getElementById('tela-visualizacao'),
            ferramentas: document.getElementById('tela-ferramentas') // Adicionado
        };

        // Modals
        const modals = {
            camera: new bootstrap.Modal(document.getElementById('cameraModal')),
            confirm: new bootstrap.Modal(document.getElementById('confirmModal')),
            alert: new bootstrap.Modal(document.getElementById('alertModal')),
            choice: new bootstrap.Modal(document.getElementById('choiceModal')),
            anotacao: new bootstrap.Modal(document.getElementById('modal-anotacao')) // Adicionado
        };

        // Gráficos
        let graficoTipos = null;
        let graficoCategorias = null;
        let graficoTempoMedio = null; // Adicionado
        let graficoPeriodo = null; // Adicionado

        // Variável global para versão (se necessário no JS)
        const VERSAO_APP_JS = '<?= VERSAO_APP ?>'; // Tenta pegar do backend

        // Função para exibir uma visualização e esconder as outras
        function mostrarTela(telaId) {
            const tela = views[telaId];
            if (!tela) {
                console.error("Tela não encontrada:", telaId);
                return;
            }

            Object.values(views).forEach(view => {
                 if (view) view.style.display = 'none';
            });
            tela.style.display = 'block';

            // Atualizar classe ativa no menu
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            const navLink = document.getElementById(`nav-${telaId}`);
             if (navLink) {
                 navLink.classList.add('active');
             } else if (telaId === 'preManu' || telaId === 'posManu' || telaId === 'visualizacao') {
                 // Se for tela de edição/visualização, manter lista ativa talvez? Ou nenhum?
                 const navLista = document.getElementById('nav-lista');
                 if (navLista) navLista.classList.add('active');
             }

            // Ações específicas ao mostrar tela
            if (telaId === 'dashboard') {
                carregarDashboard();
            } else if (telaId === 'lista') {
                carregarListaManutencoes();
            } else if (telaId === 'ferramentas') {
                carregarDadosFerramentas(); // Carrega dados ao abrir ferramentas
            }
        }

        // Função para mostrar alerta
        function mostrarAlerta(mensagem, titulo = 'Aviso', tipo = 'info') { // Adicionado tipo
             const alertTitle = document.getElementById('alert-title');
             const alertMessage = document.getElementById('alert-message');
             const alertModalHeader = document.querySelector('#alertModal .modal-header');

             alertTitle.textContent = titulo;
             alertMessage.textContent = mensagem;

             // Remover classes de cor anteriores
             alertModalHeader.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'text-white');
             alertTitle.classList.remove('text-white');


             // Adicionar classe de cor baseada no tipo
             switch (tipo.toLowerCase()) {
                 case 'sucesso':
                     alertModalHeader.classList.add('bg-success', 'text-white');
                     alertTitle.classList.add('text-white');
                     break;
                 case 'erro':
                     alertModalHeader.classList.add('bg-danger', 'text-white');
                      alertTitle.classList.add('text-white');
                     break;
                 case 'aviso':
                     alertModalHeader.classList.add('bg-warning');
                     break;
                 case 'aguarde': // Estilo para "Aguarde"
                      alertTitle.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>${titulo}`;
                      alertModalHeader.classList.add('bg-info', 'text-white');
                      alertTitle.classList.add('text-white');
                      break;
                 default: // Info ou padrão
                      alertModalHeader.classList.add('bg-info', 'text-white');
                      alertTitle.classList.add('text-white');
             }


            modals.alert.show();
        }

        // Função para mostrar confirmação
        function mostrarConfirmacao(mensagem, callback) {
            document.getElementById('confirm-message').textContent = mensagem;
             // Remove listener antigo antes de adicionar novo para evitar duplicação
             const confirmBtn = document.getElementById('confirm-yes');
             const newConfirmBtn = confirmBtn.cloneNode(true); // Clona para remover listeners
             confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

             newConfirmBtn.addEventListener('click', () => {
                 modals.confirm.hide();
                 callback(); // Executa o callback original
             });
            modals.confirm.show();
        }

        // Função para API (Google Apps Script)
        async function apiRequest(action, params = {}) {
             // Mostrar um indicador de carregamento sutil, se desejado
             // document.body.style.cursor = 'wait';

             return new Promise((resolve, reject) => {
                 google.script.run
                     .withSuccessHandler(response => {
                         // document.body.style.cursor = 'default'; // Resetar cursor
                         resolve(response);
                     })
                     .withFailureHandler(error => {
                         // document.body.style.cursor = 'default'; // Resetar cursor
                         console.error('Erro na API:', action, params, error);
                         mostrarAlerta(`Erro ao executar "${action}": ${error.message || error}`, 'Erro de API');
                         // Rejeitar a promise para que o .catch() no chamador funcione
                         reject({ success: false, message: error.message || error });
                     })
                     .doGet({ parameter: { action: action, ...params } }); // Passa parâmetros dentro do objeto 'parameter'
             });
         }

        // Carregar dados iniciais
        async function carregarDadosIniciais() {
            mostrarAlerta('Carregando dados iniciais...', 'Aguarde', 'aguarde');
            try {
                // Carregar configurações primeiro
                const resTipos = await apiRequest('obterTiposEquipamentos');
                if (resTipos.success) {
                    tiposEquipamentosOptions = resTipos.tiposEquipamentos || []; // Renomeado
                    categoriasProblemas = resTipos.categoriasProblemas || [];
                    niveisUrgencia = resTipos.niveisUrgencia || [];
                    checklistItens = resTipos.checklistItens || [];

                    // Preencher selects que dependem das configurações
                    preencherSelect('pre-categoria-problema', categoriasProblemas);
                    preencherSelect('pre-urgencia', niveisUrgencia);

                    // Criar checklist
                    criarChecklist('pre-checklist-container', 'pre', checklistItens);
                    criarChecklist('pos-checklist-container', 'pos', checklistItens);
                } else {
                     mostrarAlerta('Falha ao carregar configurações básicas.', 'Erro');
                }

                 // Carregar equipamentos (pode depender de obterPlanilha no backend)
                 const resEquip = await apiRequest('obterEquipamentos');
                 if (resEquip.success) {
                     equipamentos = resEquip.equipamentos || [];
                     // Agora que temos os equipamentos, podemos configurar os selects dinâmicos
                     configurarSelectsEquipamentos();
                 } else {
                      mostrarAlerta('Falha ao carregar lista de equipamentos.', 'Erro');
                 }


                // Iniciar na tela de dashboard
                modals.alert.hide(); // Esconde o "Aguarde"
                mostrarTela('dashboard');

            } catch (error) {
                modals.alert.hide(); // Esconde o "Aguarde" mesmo em erro
                mostrarAlerta(`Erro crítico ao carregar dados: ${error.message}`, 'Erro Fatal');
            }
        }

        // Função para preencher select
        function preencherSelect(elementId, options, addEmptyOption = true) { // Adicionado parâmetro addEmptyOption
            const select = document.getElementById(elementId);
            if (!select) {
                console.warn("Elemento select não encontrado:", elementId);
                return;
            }
            select.innerHTML = ''; // Limpa completamente

            if (addEmptyOption) {
                 const emptyOpt = document.createElement('option');
                 emptyOpt.value = "";
                 emptyOpt.textContent = "Selecione...";
                 select.appendChild(emptyOpt);
            }


            options.forEach(option => {
                const optElement = document.createElement('option');
                // Se option for objeto {value: '...', text: '...'}, usar isso
                 if (typeof option === 'object' && option !== null && option.value !== undefined) {
                     optElement.value = option.value;
                     optElement.textContent = option.text || option.value; // Usa text se disponível
                 } else { // Senão, assume que é string
                     optElement.value = option;
                     optElement.textContent = option;
                 }
                select.appendChild(optElement);
            });
        }

        // Função para criar checklist
        function criarChecklist(containerId, prefix, itens) {
            const container = document.getElementById(containerId);
             if (!container) return;
            container.innerHTML = '';

            itens.forEach((item, index) => {
                 if (!item) return; // Pular itens vazios

                const itemDiv = document.createElement('div');
                itemDiv.className = 'checklist-item';

                const title = document.createElement('div');
                title.className = 'checklist-title';
                title.textContent = item;

                const radioGroup = document.createElement('div');
                radioGroup.className = 'btn-group';
                radioGroup.setAttribute('role', 'group');
                 radioGroup.setAttribute('aria-label', `Status para ${item}`); // Acessibilidade

                const options = [
                    { value: 'OK', label: 'OK', icon: 'bi-check-circle-fill', className: 'btn-outline-success' },
                    { value: 'Danificado', label: 'Danificado', icon: 'bi-exclamation-triangle-fill', className: 'btn-outline-danger' },
                    { value: 'N/A', label: 'N/A', icon: 'bi-dash-circle-fill', className: 'btn-outline-secondary' }
                ];

                options.forEach(option => {
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.className = 'btn-check'; // Classe Bootstrap para estilizar label
                    input.name = `<span class="math-inline">\{prefix\}\-checklist\-</span>{index}`;
                    input.id = `<span class="math-inline">\{prefix\}\-checklist\-</span>{index}-${option.value.toLowerCase()}`; // ID único
                    input.value = option.value;
                    input.dataset.item = item;
                     input.autocomplete = 'off'; // Desliga autocomplete

                    const label = document.createElement('label');
                    label.className = `btn ${option.className}`;
                    label.setAttribute('for', input.id); // Associa label ao input

                    const icon = document.createElement('i');
                    icon.className = `bi ${option.icon} me-1`;

                    //label.appendChild(input); // Input vai antes no HTML para btn-check funcionar
                    label.appendChild(icon);
                    label.appendChild(document.createTextNode(option.label));

                    radioGroup.appendChild(input); // Input primeiro
                    radioGroup.appendChild(label); // Label depois
                });

                itemDiv.appendChild(title);
                itemDiv.appendChild(radioGroup);
                container.appendChild(itemDiv);
            });
        }

        // Função para obter dados do formulário (MODIFICADA para nova estrutura)
        function obterDadosFormulario(formId) {
            const form = document.getElementById(formId);
             if (!form) return {};
            const formData = new FormData(form);
            const dados = {};

             // Processa entradas normais e hidden
             for (const [key, value] of formData.entries()) {
                 dados[key] = value;
             }

            // Processar checklist
            const isPreForm = formId === 'form-pre-manutencao';
            const checklistContainerId = isPreForm ? 'pre-checklist-container' : 'pos-checklist-container';
            const checklistContainer = document.getElementById(checklistContainerId);
            const checklist = {};

            if (checklistContainer) {
                 checklistContainer.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                     if (radio.dataset.item) { // Garante que tem o dataset
                         checklist[radio.dataset.item] = radio.value;
                     }
                 });
            }

             // Adiciona o checklist aos dados principais
             if (isPreForm) {
                 dados.checklistPre = checklist;
             } else {
                 dados.checklistPos = checklist;
             }


             // Adiciona as imagens já processadas (com URLs do Drive)
             if (isPreForm) {
                 // Pega apenas url e id das imagens pré-upload
                 dados.imagensPre = imagenesPreUpload.map(img => ({ url: img.url, id: img.id, timestamp: img.timestamp }));
             } else {
                  // Pega apenas url e id das imagens pós-upload
                 dados.imagensPos = imagenesPosUpload.map(img => ({ url: img.url, id: img.id, timestamp: img.timestamp }));
             }

            // Garante que campos obrigatórios não enviados como vazios sejam tratados se necessário
             // Ex: Se placa for 'OUTRO EQUIPAMENTO', usa o valor do input de texto
             if (dados.placa === 'OUTRO EQUIPAMENTO') {
                 dados.placa = dados['placa-outro-valor'] || 'Outro - Não especificado'; // Usa o valor do input de texto
             }
             // Remove o campo auxiliar se existir
              delete dados['placa-outro-valor'];


             // Certifica que tipo de equipamento foi selecionado
             if (!dados.tipoEquipamento) {
                 console.warn("Tipo de equipamento não selecionado no formulário", formId);
             }
             // Certifica que placa/equipamento foi selecionado ou digitado
             if (!dados.placa) {
                  console.warn("Placa/Equipamento não selecionado ou informado no formulário", formId);
             }

            return dados;
        }

        // Função para carregar dashboard
        async function carregarDashboard() {
            mostrarAlerta('Carregando dashboard...', 'Aguarde', 'aguarde');
             try {
                 const resDashboard = await apiRequest('obterDadosDashboard');
                 modals.alert.hide(); // Esconde o "Aguarde"

                 if (!resDashboard || !resDashboard.success) {
                      mostrarAlerta('Erro ao carregar dados do dashboard.', 'Erro');
                     return;
                 };

                 const data = resDashboard;

                 // Atualizar contadores
                 document.getElementById('total-equipamentos').textContent = data.statusEquipamentos?.total ?? '0';
                 document.getElementById('total-aguardando').textContent = data.contadores?.statusManutencao?.[STATUS_AGUARDANDO] ?? '0';
                 document.getElementById('total-em-manutencao').textContent = data.contadores?.statusManutencao?.[STATUS_EM_MANUTENCAO] ?? '0';
                 document.getElementById('total-concluidas').textContent = (data.contadores?.statusManutencao?.[STATUS_CONCLUIDO] ?? 0) + (data.contadores?.statusManutencao?.[STATUS_DISPONIVEL] ?? 0);

                 // Manutenções recentes
                 const listaRecentes = document.getElementById('manutencoes-recentes');
                 listaRecentes.innerHTML = ''; // Limpa antes de adicionar

                 if (!data.manutencoesRecentes || data.manutencoesRecentes.length === 0) {
                     listaRecentes.innerHTML = '<li class="list-group-item text-center text-muted">Nenhuma manutenção recente</li>';
                 } else {
                     data.manutencoesRecentes.forEach(manutencao => {
                         const statusClass = getStatusClass(manutencao.status);
                         const item = document.createElement('li');
                         item.className = 'list-group-item d-flex justify-content-between align-items-center list-group-item-action'; // Adicionado list-group-item-action
                         item.style.cursor = 'pointer';
                         item.onclick = () => visualizarManutencao(manutencao.id);

                         const div = document.createElement('div');
                         div.innerHTML = `
                             <strong><span class="math-inline">\{manutencao\.placa \|\| 'Sem Placa'\}</strong\>
<small class\="text\-muted d\-block"\></span>{manutencao.dataCriacao || 'Sem Data'}</small> `;

                         const badge = document.createElement('span');
                         badge.className = `badge ${statusClass} rounded-pill`; // Adicionado rounded-pill
                         badge.textContent = manutencao.status || 'N/A';

                         item.appendChild(div);
                         item.appendChild(badge);
                         listaRecentes.appendChild(item);
                     });
                 }

                 // Atividade recente
                 const listaAtividade = document.getElementById('atividade-recente');
                 listaAtividade.innerHTML = ''; // Limpa antes de adicionar

                 if (!data.atividadeRecente || data.atividadeRecente.length === 0) {
                     listaAtividade.innerHTML = '<li class="list-group-item text-center text-muted">Nenhuma atividade registrada</li>';
                 } else {
                     data.atividadeRecente.forEach(atividade => {
                         const item = document.createElement('li');
                         item.className = 'list-group-item';

                         const row = document.createElement('div');
                         row.className = 'd-flex align-items-center'; // Alinha itens verticalmente

                         const avatar = document.createElement('div');
                         avatar.className = 'avatar bg-light text-secondary me-3'; // Ajuste margem
                         avatar.innerHTML = `<i class="bi bi-pencil-fill"></i>`; // Ícone de edição

                         const content = document.createElement('div');
                         content.innerHTML = `
                             <div><strong><span class="math-inline">\{atividade\.placa \|\| 'Sem Placa'\}</strong\>\: Status alterado</div\>
<div\><small class\="text\-muted"\></span>{atividade.statusAnterior || 'Novo'} <i class="bi bi-arrow-right-short"></i> <span class="math-inline">\{atividade\.statusNovo \|\| 'N/A'\}</small\></div\>
<div class\="text\-muted small mt\-1"\></span>{atividade.data || 'Sem Data'}</div>
                         `;

                         row.appendChild(avatar);
                         row.appendChild(content);
                         item.appendChild(row);
                         listaAtividade.appendChild(item);
                     });
                 }

                 // Gráfico de tipos de equipamento
                 const graficoTiposContainer = document.getElementById('grafico-tipos');
                 graficoTiposContainer.innerHTML = '<canvas id="chart-tipos"></canvas>';

                 const tiposLabels = Object.keys(data.contadores?.tipoEquipamento || {});
                 const tiposData = tiposLabels.map(tipo => data.contadores.tipoEquipamento[tipo]);

                 if (graficoTipos) graficoTipos.destroy(); // Destroi gráfico anterior
                 if (tiposLabels.length > 0) { // Só cria se tiver dados
                     graficoTipos = new Chart(document.getElementById('chart-tipos'), {
                         type: 'bar',
                         data: {
                             labels: tiposLabels,
                             datasets: [{
                                 label: 'Manutenções',
                                 data: tiposData,
                                 backgroundColor: 'rgba(13, 110, 253, 0.7)', // Cor primária com transparência
                                 borderColor: 'rgba(13, 110, 253, 1)',
                                 borderWidth: 1
                             }]
                         },
                         options: {
                             responsive: true,
                             maintainAspectRatio: false, // Permite controlar altura
                             plugins: {
                                 legend: {
                                     display: false
                                 }
                             },
                             scales: {
                                 y: {
                                     beginAtZero: true,
                                     ticks: {
                                         precision: 0
                                     }
                                 }
                             }
                         }
                     });
                 } else {
                     graficoTiposContainer.innerHTML = '<p class="text-center text-muted mt-3">Sem dados de tipo de equipamento.</p>';
                 }

                 // Gráfico de categorias
                 const graficoCategoriasContainer = document.getElementById('grafico-categorias');
                 graficoCategoriasContainer.innerHTML = '<canvas id="chart-categorias"></canvas>';

                 const categoriasLabels = Object.keys(data.contadores?.categoriaProblema || {});
                 const categoriasData = categoriasLabels.map(cat => data.contadores.categoriaProblema[cat]);
                  // Cores para o gráfico de pizza
                 const pieColors = [
                     'rgba(13, 110, 253, 0.7)',
                     'rgba(220, 53, 69, 0.7)',
                     'rgba(255, 193, 7, 0.7)',
                     'rgba(25, 135, 84, 0.7)',
                     'rgba(108, 117, 125, 0.7)',
                     'rgba(13, 202, 240, 0.7)', // Info
                     'rgba(102, 16, 242, 0.7)', // Indigo
                     'rgba(214, 51, 132, 0.7)' // Pink
                 ];


                 if (graficoCategorias) graficoCategorias.destroy(); // Destroi gráfico anterior
                  if (categoriasLabels.length > 0) { // Só cria se tiver dados
                     graficoCategorias = new Chart(document.getElementById('chart-categorias'), {
                         type: 'pie',
                         data: {
                             labels: categoriasLabels,
                             datasets: [{
                                 data: categoriasData,
                                 backgroundColor: pieColors.slice(0, categoriasLabels.length), // Usa cores definidas
                                 borderColor: pieColors.map(c => c.replace('0.7', '1')), // Cor sólida para borda
                                 borderWidth: 1
                             }]
                         },
                         options: {
                             responsive: true,
                             maintainAspectRatio: false, // Permite controlar altura
                             plugins: {
                                 legend: {
                                     position: 'bottom', // Legenda abaixo
                                 }
                             }
                         }
                     });
                 } else {
                     graficoCategoriasContainer.innerHTML = '<p class="text-center text-muted mt-3">Sem dados de categorias.</p>';
                 }

                 // --- NOVOS GRÁFICOS E STATS ---

                // Gráfico de tempo médio de manutenção
                const graficoTempoMedioContainer = document.getElementById('grafico-tempo-medio');
                graficoTempoMedioContainer.innerHTML = '<canvas id="chart-tempo-medio"></canvas>';

                 // Recalcular tempo médio (adaptado da atualização)
                 const manutencoesCompletasTempo = (await apiRequest('listarManutencoes')).manutencoes.filter(m => // Busca todos para calcular tempo médio
                     m.Status === STATUS_CONCLUIDO || m.Status === STATUS_DISPONIVEL
                 );

                 const tempoMedioPorTipo = {};
                 manutencoesCompletasTempo.forEach(m => {
                     if (!m.Data_Criacao || !m.Data_Manutencao) return;

                     const tipEquip = m.Tipo_Equipamento || 'Indefinido';

                     // Calcular diferença em dias
                     try {
                         const dataInicio = new Date(m.Data_Criacao);
                         const dataFim = new Date(m.Data_Manutencao);
                         if (isNaN(dataInicio.getTime()) || isNaN(dataFim.getTime())) return;

                         const diffTempo = dataFim.getTime() - dataInicio.getTime();
                         if (diffTempo < 0) return; // Ignora se data fim for antes do início

                         const diffDias = Math.round(diffTempo / (1000 * 60 * 60 * 24));

                         if (!tempoMedioPorTipo[tipEquip]) {
                             tempoMedioPorTipo[tipEquip] = { total: 0, count: 0 };
                         }

                         tempoMedioPorTipo[tipEquip].total += diffDias;
                         tempoMedioPorTipo[tipEquip].count++;
                     } catch (e) { console.warn("Erro ao calcular tempo médio:", e); }
                 });

                 const tiposEquipTempo = Object.keys(tempoMedioPorTipo);
                 const tempoMedioDados = tiposEquipTempo.map(tipo =>
                     tempoMedioPorTipo[tipo].count > 0 ?
                     (tempoMedioPorTipo[tipo].total / tempoMedioPorTipo[tipo].count).toFixed(1) : 0
                 );

                 if (graficoTempoMedio) graficoTempoMedio.destroy();
                 if (tiposEquipTempo.length > 0) {
                      graficoTempoMedio = new Chart(document.getElementById('chart-tempo-medio'), {
                          type: 'bar',
                          data: {
                              labels: tiposEquipTempo,
                              datasets: [{
                                  label: 'Tempo Médio (dias)',
                                  data: tempoMedioDados,
                                  backgroundColor: 'rgba(32, 201, 151, 0.7)', // Teal
                                  borderColor: 'rgba(32, 201, 151, 1)',
                                  borderWidth: 1
                              }]
                          },
                          options: {
                              responsive: true,
                              maintainAspectRatio: false,
                              plugins: {
                                  legend: { display: false }
                              },
                              scales: {
                                  y: {
                                      beginAtZero: true,
                                      title: { display: true, text: 'Dias' },
                                      ticks: { precision: 0 }
                                  }
                              }
                          }
                      });
                 } else {
                     graficoTempoMedioContainer.innerHTML = '<p class="text-center text-muted mt-3">Sem dados de tempo médio.</p>';
                 }


                 // Gráfico de manutenções por período (Função separada para recarregar)
                 const filtroPeriodo = document.getElementById('filtro-periodo-grafico');
                 carregarGraficoPeriodo(parseInt(filtroPeriodo.value) || 30); // Carrega inicial


                 // Status dos equipamentos
                 const statusEquipamentosContainer = document.getElementById('status-equipamentos');
                 if (statusEquipamentosContainer) {
                     statusEquipamentosContainer.innerHTML = ''; // Limpa
                     // Obter equipamentos (já carregados em `equipamentos`)
                     if (!equipamentos || equipamentos.length === 0) {
                         statusEquipamentosContainer.innerHTML = '<p class="text-center text-muted">Lista de equipamentos não carregada.</p>';
                     } else {
                          const equipPorTipo = {};
                          equipamentos.forEach(equip => {
                              const tipo = equip.Tipo_Equipamento || 'Indefinido';
                              if (!equipPorTipo[tipo]) {
                                  equipPorTipo[tipo] = { total: 0, disponiveis: 0, emManutencao: 0, aguardando: 0 };
                              }

                              equipPorTipo[tipo].total++;

                              if (equip.Status === 'Disponível') {
                                  equipPorTipo[tipo].disponiveis++;
                              } else if (equip.Status === 'Em Manutenção') {
                                  equipPorTipo[tipo].emManutencao++;
                              } else if (equip.Status === 'Aguardando Manutenção') {
                                  equipPorTipo[tipo].aguardando++;
                              }
                          });

                          // Criar cards para cada tipo
                          Object.entries(equipPorTipo).forEach(([tipo, dados]) => {
                              const disponibilidade = dados.total > 0 ? (dados.disponiveis / dados.total * 100) : 0;

                              const col = document.createElement('div');
                              col.className = 'col-md-4 mb-3'; // 3 colunas em desktop
                              col.innerHTML = `
                                  <div class="card h-100">
                                      <div class="card-header bg-light">
                                          <strong><span class="math-inline">\{tipo\}</strong\>
</div\>
<div class\="card\-body d\-flex flex\-column justify\-content\-between"\> <div\> <div class\="d\-flex justify\-content\-between mb\-2"\> <span\>Total\: <strong\></span>{dados.total}</strong></span>
                                                 <span>Disponibilidade: <strong class="<span class="math-inline">\{disponibilidade < 50 ? 'text\-danger' \: disponibilidade < 80 ? 'text\-warning' \: 'text\-success'\}"\></span>{disponibilidade.toFixed(0)}%</strong></span>
                                             </div>
                                             <div class="progress mb-3" style="height: 20px;">
                                                 <div class="progress-bar bg-success" role="progressbar" style="width: ${dados.total > 0 ? (dados.disponiveis / dados.total * 100) : 0}%;" title="Disponíveis: <span class="math-inline">\{dados\.disponiveis\}"\></span>{dados.disponiveis}</div>
                                                 <div class="progress-bar bg-warning" role="progressbar" style="width: ${dados.total > 0 ? (dados.aguardando / dados.total * 100) : 0}%;" title="Aguardando: <span class="math-inline">\{dados\.aguardando\}"\></span>{dados.aguardando}</div>
                                                 <div class="progress-bar bg-primary" role="progressbar" style="width: ${dados.total > 0 ? (dados.emManutencao / dados.total * 100) : 0}%;" title="Em Manutenção: <span class="math-inline">\{dados\.emManutencao\}"\></span>{dados.emManutencao}</div>
                                             </div>
                                         </div>
                                         <div class="d-flex justify-content-between small text-muted mt-auto"> <span><i class="bi bi-circle-fill text-success"></i> Disponíveis</span>
                                             <span><i class="bi bi-circle-fill text-warning"></i> Aguardando</span>
                                             <span><i class="bi bi-circle-fill text-primary"></i> Em Manutenção</span>
                                         </div>
                                      </div>
                                  </div>
                              `;
                              statusEquipamentosContainer.appendChild(col);
                          });
                      } // fim else equipamentos
                 } // fim if statusEquipamentosContainer

             } catch (error) {
                 modals.alert.hide(); // Esconde o "Aguarde" mesmo em erro
                 mostrarAlerta(`Erro ao carregar dashboard: ${error.message}`, 'Erro');
             } // Fim Try/Catch Carregar Dashboard
        } // Fim CarregarDashboard

        // Função para carregar gráfico de período (chamada ao mudar filtro)
        async function carregarGraficoPeriodo(dias) {
            const graficoPeriodoContainer = document.getElementById('grafico-periodo');
            if (!graficoPeriodoContainer) return;
             graficoPeriodoContainer.innerHTML = '<div class="text-center mt-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Carregando...</span></div> Carregando gráfico...</div>'; // Loading indicator

             try {
                 // Busca todas as manutenções (pode ser otimizado se a lista já estiver carregada)
                 const res = await apiRequest('listarManutencoes');
                 if (!res.success) throw new Error("Falha ao buscar dados para gráfico de período.");

                 const todasManutencoes = res.manutencoes || [];

                 // Data limite
                 const dataLimite = new Date();
                 dataLimite.setDate(dataLimite.getDate() - dias);
                 dataLimite.setHours(0, 0, 0, 0); // Zera a hora para comparar dias inteiros

                 // Filtrar manutenções no período
                 const manutencoesPeriodo = todasManutencoes.filter(m => {
                     if (!m.Data_Criacao) return false;
                     try {
                          const dataCriacao = new Date(m.Data_Criacao);
                          return !isNaN(dataCriacao.getTime()) && dataCriacao >= dataLimite;
                     } catch { return false; }
                 });

                 // Obter dados agrupados por dia
                 const dadosPorDia = {};
                 // Inicializar todos os dias no período
                 for (let i = 0; i < dias; i++) {
                     const data = new Date();
                     data.setDate(data.getDate() - i);
                     const dataStr = data.toISOString().slice(0, 10);
                     dadosPorDia[dataStr] = { abertas: 0, concluidas: 0 };
                 }

                 // Contar manutenções abertas no dia
                 manutencoesPeriodo.forEach(m => {
                     if (!m.Data_Criacao) return;
                      try {
                          const dataCriacao = new Date(m.Data_Criacao);
                          const dataStr = dataCriacao.toISOString().slice(0, 10);
                          if (dadosPorDia.hasOwnProperty(dataStr)) {
                              dadosPorDia[dataStr].abertas++;
                          }
                      } catch {}
                 });

                 // Contar manutenções concluídas no dia (dentro do período)
                 todasManutencoes.forEach(m => { // Usa todas para pegar conclusões de chamados antigos
                     if (!m.Data_Manutencao) return;
                     try {
                         const dataManutencao = new Date(m.Data_Manutencao);
                          if (isNaN(dataManutencao.getTime()) || dataManutencao < dataLimite) return; // Ignora se for antes do período

                         const dataStr = dataManutencao.toISOString().slice(0, 10);
                         if (dadosPorDia.hasOwnProperty(dataStr)) {
                             dadosPorDia[dataStr].concluidas++;
                         }
                     } catch {}
                 });


                 // Converter para arrays para o gráfico
                 const labels = Object.keys(dadosPorDia).sort(); // Ordena as datas
                 const abertasData = labels.map(data => dadosPorDia[data].abertas);
                 const concluidasData = labels.map(data => dadosPorDia[data].concluidas);

                 // Formatar datas para exibição (DD/MM)
                 const labelsFormatados = labels.map(data => {
                     try {
                         const partes = data.split('-');
                         return `<span class="math-inline">\{partes\[2\]\}/</span>{partes[1]}`;
                     } catch { return data; }
                 });

                 // Limpa o container e adiciona o canvas novamente
                 graficoPeriodoContainer.innerHTML = '<canvas id="chart-periodo"></canvas>';
                 const ctxPeriodo = document.getElementById('chart-periodo');
                 if (!ctxPeriodo) return;


                 // Criar ou atualizar gráfico
                 if (graficoPeriodo) { graficoPeriodo.destroy(); }

                 graficoPeriodo = new Chart(ctxPeriodo, {
                     type: 'line',
                     data: {
                         labels: labelsFormatados,
                         datasets: [
                             {
                                 label: 'Abertas',
                                 data: abertasData,
                                 borderColor: 'rgba(255, 193, 7, 1)', // Warning
                                 backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                 fill: true,
                                 tension: 0.1 // Linhas menos curvas
                             },
                             {
                                 label: 'Concluídas',
                                 data: concluidasData,
                                 borderColor: 'rgba(25, 135, 84, 1)', // Success
                                 backgroundColor: 'rgba(25, 135, 84, 0.1)',
                                 fill: true,
                                 tension: 0.1
                             }
                         ]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         scales: {
                             x: {
                                 grid: { display: false }
                             },
                             y: {
                                 beginAtZero: true,
                                 ticks: { precision: 0 }
                             }
                         },
                         plugins: {
                             legend: {
                                 position: 'top',
                             }
                         }
                     }
                 });
             } catch (error) {
                 console.error("Erro ao carregar gráfico de período:", error);
                 graficoPeriodoContainer.innerHTML = '<p class="text-center text-danger mt-3">Erro ao carregar gráfico.</p>';
             } // fim catch
        } // Fim carregarGraficoPeriodo

        // Função para carregar lista de manutenções
        async function carregarListaManutencoes() {
            const filtroStatus = document.getElementById('filtro-status').value;
            const filtroPlaca = document.getElementById('filtro-placa').value.trim();
            const tbody = document.getElementById('lista-manutencoes');
            const semRegistros = document.getElementById('sem-registros');

            tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Carregando...</span></div> Carregando...</td></tr>';
             semRegistros.style.display = 'none';

             try {
                 // Sempre busca todas e filtra no cliente por enquanto
                 // Poderia passar filtros para API no futuro
                 const resManutencoes = await apiRequest('listarManutencoes');

                 if (!resManutencoes.success) {
                     throw new Error(resManutencoes.message || "Erro ao buscar manutenções");
                 }

                 manutencoes = resManutencoes.manutencoes || [];

                 // Filtrar localmente
                 let manutencoesFiltradas = manutencoes;
                 if (filtroStatus) {
                      manutencoesFiltradas = manutencoesFiltradas.filter(m => m.Status === filtroStatus);
                 }
                 if (filtroPlaca) {
                      manutencoesFiltradas = manutencoesFiltradas.filter(m =>
                          m.Placa && m.Placa.toLowerCase().includes(filtroPlaca.toLowerCase())
                      );
                 }

                 tbody.innerHTML = ''; // Limpa o loading

                 if (manutencoesFiltradas.length === 0) {
                     semRegistros.style.display = 'block';
                     return;
                 }

                 semRegistros.style.display = 'none';

                 manutencoesFiltradas.forEach(m => {
                     const tr = document.createElement('tr');

                     // Formatar data
                     const dataCriacao = m.Data_Criacao ? new Date(m.Data_Criacao) : null;
                     const dataFormatada = dataCriacao ?
                         dataCriacao.toLocaleDateString('pt-BR') : // Só data na lista
                         'N/A';

                     const statusClass = getStatusClass(m.Status);

                     tr.innerHTML = `
                         <td><span class="math-inline">\{m\.Placa \|\| 'N/A'\}</td\>
<td\></span>{m.Tipo_Equipamento || 'N/A'}</td> <td>${dataFormatada}</td>
                         <td><span class="badge <span class="math-inline">\{statusClass\} rounded\-pill"\></span>{m.Status || 'N/A'}</span></td> <td>
                             <button class="btn btn-sm btn-outline-primary btn-visualizar m-1" data-id="<span class="math-inline">\{m\.ID\}" title\="Visualizar"\>
<i class\="bi bi\-eye"\></i\>
</button\>
<button class\="btn btn\-sm btn\-outline\-secondary btn\-editar m\-1" data\-id\="</span>{m.ID}" title="Editar">
                                 <i class="bi bi-pencil"></i>
                             </button>
                             </td>
                     `;

                     tbody.appendChild(tr);
                 });

                 // Adicionar eventos aos botões (DEPOIS que eles são adicionados ao DOM)
                 tbody.querySelectorAll('.btn-visualizar').forEach(btn => {
                     btn.addEventListener('click', () => visualizarManutencao(btn.dataset.id));
                 });

                 tbody.querySelectorAll('.btn-editar').forEach(btn => {
                     btn.addEventListener('click', () => editarManutencao(btn.dataset.id));
                 });

             } catch (error) {
                  console.error("Erro ao carregar lista:", error);
                  tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Erro ao carregar manutenções: ${error.message}</td></tr>`;
                  semRegistros.style.display = 'none';
             }
        }

        // Função para obter classe de status
        function getStatusClass(status) {
            switch (status) {
                case STATUS_AGUARDANDO: return 'status-aguardando';
                case STATUS_EM_MANUTENCAO: return 'status-em-manutencao';
                case STATUS_CONCLUIDO: return 'status-concluido';
                case STATUS_DISPONIVEL: return 'status-disponivel';
                default: return 'bg-secondary text-white'; // Default mais visível
            }
        }

        // Função para visualizar manutenção
        async function visualizarManutencao(id) {
             mostrarAlerta('Carregando detalhes...', 'Aguarde', 'aguarde');
             try {
                 const res = await apiRequest('obterManutencao', { id });
                 modals.alert.hide();

                 if (!res.success || !res.manutencao) {
                     mostrarAlerta('Erro ao carregar manutenção: ' + (res.message || 'Não encontrada'), 'Erro');
                     return;
                 }

                 manutencaoAtual = res.manutencao;

                 // Preencher os dados na tela de visualização
                 document.getElementById('view-id').textContent = manutencaoAtual.ID || 'N/A';
                 document.getElementById('view-data-criacao').textContent = formatarData(manutencaoAtual.Data_Criacao);
                 document.getElementById('view-status').textContent = manutencaoAtual.Status || 'N/A';
                 document.getElementById('view-status').className = `badge ${getStatusClass(manutencaoAtual.Status)} rounded-pill`; // Rounded pill
                 document.getElementById('view-responsavel').textContent = manutencaoAtual.Responsavel || 'N/A';

                 document.getElementById('view-placa').textContent = manutencaoAtual.Placa || 'N/A';
                  // document.getElementById('view-modelo').textContent = manutencaoAtual.Modelo || 'N/A'; // Modelo removido
                 document.getElementById('view-tipo-equipamento').textContent = manutencaoAtual.Tipo_Equipamento || 'N/A';

                 document.getElementById('view-categoria-problema').textContent = manutencaoAtual.Categoria_Problema || 'N/A';
                 document.getElementById('view-urgencia').textContent = manutencaoAtual.Urgencia || 'N/A';

                 // Motivo Outro
                 const viewMotivoOutroContainer = document.getElementById('view-motivo-outro-container');
                 if (manutencaoAtual.Categoria_Problema === 'Outro' && manutencaoAtual.Motivo_Outro) {
                     viewMotivoOutroContainer.style.display = 'block';
                     document.getElementById('view-motivo-outro').textContent = manutencaoAtual.Motivo_Outro;
                 } else {
                     viewMotivoOutroContainer.style.display = 'none';
                 }

                 document.getElementById('view-descricao-problema').textContent = manutencaoAtual.Descricao_Problema || 'Nenhuma descrição';

                 // Checklist Pré
                 const viewChecklistPre = document.getElementById('view-checklist-pre');
                 viewChecklistPre.innerHTML = ''; // Limpa

                 const checklistPre = manutencaoAtual.Checklist_Pre || {}; // Já deve ser objeto ou vazio

                 if (Object.keys(checklistPre).length > 0) {
                     Object.entries(checklistPre).forEach(([item, valor]) => {
                         const itemDiv = document.createElement('div');
                         itemDiv.className = 'mb-2 d-flex align-items-center'; // Alinha ícone e texto

                         let icon, textClass;
                         switch (valor) {
                             case 'OK':
                                 icon = 'bi-check-circle-fill text-success';
                                 textClass = 'text-success';
                                 break;
                             case 'Danificado':
                                 icon = 'bi-exclamation-triangle-fill text-danger';
                                 textClass = 'text-danger';
                                 break;
                             case 'N/A':
                                 icon = 'bi-dash-circle-fill text-secondary';
                                 textClass = 'text-secondary';
                                 break;
                             default:
                                 icon = 'bi-circle';
                                 textClass = '';
                         }

                         itemDiv.innerHTML = `
                             <i class="bi <span class="math-inline">\{icon\} me\-2 fs\-5"\></i\> <div\> <span class\="fw\-semibold"\></span>{item}:</span>
                                 <span class="<span class="math-inline">\{textClass\}"\></span>{valor}</span>
                             </div>
                         `;

                         viewChecklistPre.appendChild(itemDiv);
                     });
                 } else {
                     viewChecklistPre.innerHTML = '<p class="text-muted">Nenhum item verificado no checklist pré-manutenção.</p>';
                 }

                 document.getElementById('view-observacoes-pre').textContent = manutencaoAtual.Observacoes_Pre || 'Nenhuma observação registrada.';

                 // Imagens Pré
                 const viewImagensPre = document.getElementById('view-imagens-pre');
                 viewImagensPre.innerHTML = ''; // Limpa
                 const imagensPre = Array.isArray(manutencaoAtual.Imagens_Pre) ? manutencaoAtual.Imagens_Pre : []; // Garante que é array


                 if (imagensPre.length > 0) {
                     imagensPre.forEach(img => {
                          if (!img || !img.url) return; // Pula inválidas
                         const imgContainer = document.createElement('div');
                         imgContainer.className = 'image-container position-relative'; // Adicionado position-relative

                         const imgElement = document.createElement('img');
                         imgElement.src = img.url;
                         imgElement.alt = 'Imagem Pré-Manutenção';
                         imgElement.className = 'img-thumbnail'; // Usa thumbnail do bootstrap
                         imgElement.style.cursor = 'pointer';
                         imgElement.onclick = () => window.open(img.url, '_blank');

                         // Botão Anotar
                         const btnAnnotate = document.createElement('button');
                         btnAnnotate.className = 'btn btn-sm btn-info btn-annotate';
                         btnAnnotate.innerHTML = '<i class="bi bi-pencil-square"></i>';
                         btnAnnotate.title = 'Anotar imagem';
                         btnAnnotate.dataset.imgSrc = img.url;
                         btnAnnotate.addEventListener('click', (e) => {
                             e.stopPropagation(); // Evitar que abra a imagem
                             abrirEditorAnotacao(img.url);
                         });

                         imgContainer.appendChild(imgElement);
                         imgContainer.appendChild(btnAnnotate); // Adiciona botão
                         viewImagensPre.appendChild(imgContainer);
                     });
                 } else {
                     viewImagensPre.innerHTML = '<p class="text-muted">Nenhuma imagem registrada na pré-manutenção.</p>';
                 }

                 // Seção Pós-Manutenção
                 const viewSectionPosManutencao = document.getElementById('view-section-pos-manutencao');

                 if (manutencaoAtual.Status === STATUS_CONCLUIDO || manutencaoAtual.Status === STATUS_DISPONIVEL) {
                     viewSectionPosManutencao.style.display = 'block';

                     document.getElementById('view-data-manutencao').textContent = formatarData(manutencaoAtual.Data_Manutencao) || 'N/A';

                     // Checklist Pós
                     const viewChecklistPos = document.getElementById('view-checklist-pos');
                     viewChecklistPos.innerHTML = ''; // Limpa
                     const checklistPos = manutencaoAtual.Checklist_Pos || {}; // Já deve ser objeto


                     if (Object.keys(checklistPos).length > 0) {
                         Object.entries(checklistPos).forEach(([item, valor]) => {
                             const itemDiv = document.createElement('div');
                             itemDiv.className = 'mb-2 d-flex align-items-center';

                             let icon, textClass;
                             switch (valor) {
                                 case 'OK': icon = 'bi-check-circle-fill text-success'; textClass = 'text-success'; break;
                                 case 'Danificado': icon = 'bi-exclamation-triangle-fill text-danger'; textClass = 'text-danger'; break;
                                 case 'N/A': icon = 'bi-dash-circle-fill text-secondary'; textClass = 'text-secondary'; break;
                                 default: icon = 'bi-circle'; textClass = '';
                             }

                             itemDiv.innerHTML = `
                                 <i class="bi <span class="math-inline">\{icon\} me\-2 fs\-5"\></i\>
<div\>
<span class\="fw\-semibold"\></span>{item}:</span>
                                     <span class="<span class="math-inline">\{textClass\}"\></span>{valor}</span>
                                 </div>
                             `;
                             viewChecklistPos.appendChild(itemDiv);
                         });
                     } else {
                         viewChecklistPos.innerHTML = '<p class="text-muted">Nenhum item verificado no checklist pós-manutenção.</p>';
                     }

                     document.getElementById('view-observacoes-pos').textContent = manutencaoAtual.Observacoes_Pos || 'Nenhuma observação registrada.';

                     // Imagens Pós
                     const viewImagensPos = document.getElementById('view-imagens-pos');
                     viewImagensPos.innerHTML = ''; // Limpa
                     const imagensPos = Array.isArray(manutencaoAtual.Imagens_Pos) ? manutencaoAtual.Imagens_Pos : []; // Garante array

                     if (imagensPos.length > 0) {
                         imagensPos.forEach(img => {
                             if (!img || !img.url) return; // Pula inválidas
                             const imgContainer = document.createElement('div');
                             imgContainer.className = 'image-container position-relative';

                             const imgElement = document.createElement('img');
                             imgElement.src = img.url;
                             imgElement.alt = 'Imagem Pós-Manutenção';
                             imgElement.className = 'img-thumbnail';
                             imgElement.style.cursor = 'pointer';
                             imgElement.onclick = () => window.open(img.url, '_blank');

                              // Botão Anotar
                             const btnAnnotate = document.createElement('button');
                             btnAnnotate.className = 'btn btn-sm btn-info btn-annotate';
                             btnAnnotate.innerHTML = '<i class="bi bi-pencil-square"></i>';
                             btnAnnotate.title = 'Anotar imagem';
                             btnAnnotate.dataset.imgSrc = img.url;
                             btnAnnotate.addEventListener('click', (e) => {
                                 e.stopPropagation();
                                 abrirEditorAnotacao(img.url);
                             });


                             imgContainer.appendChild(imgElement);
                             imgContainer.appendChild(btnAnnotate); // Adiciona botão
                             viewImagensPos.appendChild(imgContainer);
                         });
                     } else {
                         viewImagensPos.innerHTML = '<p class="text-muted">Nenhuma imagem registrada na pós-manutenção.</p>';
                     }
                 } else {
                     viewSectionPosManutencao.style.display = 'none';
                 }

                 // Mostrar tela de visualização
                 mostrarTela('visualizacao');
             } catch (error) {
                  modals.alert.hide(); // Esconde o "Aguarde" em caso de erro
                  mostrarAlerta(`Erro ao exibir detalhes: ${error.message}`, 'Erro');
             }
        }

        // Função para editar manutenção
        async function editarManutencao(id) {
             mostrarAlerta('Carregando dados para edição...', 'Aguarde', 'aguarde');
             try {
                 const res = await apiRequest('obterManutencao', { id });
                 modals.alert.hide();

                 if (!res.success || !res.manutencao) {
                     mostrarAlerta('Erro ao carregar manutenção para edição.', 'Erro');
                     return;
                 }

                 manutencaoAtual = res.manutencao;

                 // --- Preencher Formulário Pré-Manutenção ---
                 document.getElementById('form-pre-manutencao').reset(); // Limpa antes de preencher
                 document.getElementById('pre-id').value = manutencaoAtual.ID || '';

                 // Preencher Tipo e Placa/Equipamento (Lógica mais complexa agora)
                 const tipoEquip = manutencaoAtual.Tipo_Equipamento || '';
                 const placaEquip = manutencaoAtual.Placa || '';
                 document.getElementById('pre-tipo-equipamento').value = tipoEquip;

                 // Dispara o evento change para carregar o select de placa correto
                 const event = new Event('change');
                 document.getElementById('pre-tipo-equipamento').dispatchEvent(event);

                 // Espera um pouco para o select ser populado (idealmente usar Promise se o JS for complexo)
                 await new Promise(resolve => setTimeout(resolve, 100));

                 const selectPlaca = document.getElementById('pre-placa-select');
                 const inputOutro = document.getElementById('pre-placa-outro-valor');
                 const hiddenPlacaInput = document.getElementById('pre-placa');
                 const hiddenModeloInput = document.getElementById('pre-modelo');


                 // Tenta selecionar a placa no select correspondente
                 let placaEncontradaNoSelect = false;
                 if (selectPlaca.style.display !== 'none') {
                     for (let option of selectPlaca.options) {
                         if (option.value === placaEquip) {
                             selectPlaca.value = placaEquip;
                             placaEncontradaNoSelect = true;
                             hiddenPlacaInput.value = placaEquip; // Atualiza hidden input
                              // Tenta encontrar o modelo associado (se existir no dataset)
                             const equipInfo = equipamentos.find(eq => eq.Placa === placaEquip && eq.Tipo_Equipamento === tipoEquip);
                              hiddenModeloInput.value = equipInfo?.Modelo || ''; // Usa modelo do equipamento encontrado
                             break;
                         }
                     }
                 }

                 // Se não encontrou no select, verifica se é 'OUTRO EQUIPAMENTO' ou tipo 'Outro'
                 if (!placaEncontradaNoSelect) {
                     selectPlaca.value = 'OUTRO EQUIPAMENTO'; // Seleciona 'OUTRO'
                     inputOutro.style.display = 'block'; // Mostra input de texto
                     inputOutro.value = placaEquip; // Coloca o valor no input de texto
                     hiddenPlacaInput.value = placaEquip; // Atualiza hidden input
                     hiddenModeloInput.value = ''; // Modelo desconhecido para 'Outro'
                 } else {
                      inputOutro.style.display = 'none'; // Esconde input de texto se achou no select
                      inputOutro.value = '';
                 }

                  // Preenche modelo (agora oculto, mas pode ser útil)
                 // O modelo é preenchido dentro da lógica de seleção acima

                 document.getElementById('pre-categoria-problema').value = manutencaoAtual.Categoria_Problema || '';
                 document.getElementById('pre-urgencia').value = manutencaoAtual.Urgencia || '';

                 // Dispara evento change para mostrar/ocultar campo "Outro Motivo"
                  document.getElementById('pre-categoria-problema').dispatchEvent(new Event('change'));
                  document.getElementById('pre-motivo-outro').value = manutencaoAtual.Motivo_Outro || '';


                 document.getElementById('pre-descricao-problema').value = manutencaoAtual.Descricao_Problema || '';
                 document.getElementById('pre-observacoes').value = manutencaoAtual.Observacoes_Pre || '';
                 document.getElementById('pre-responsavel').value = manutencaoAtual.Responsavel || '';

                 // Carregar checklist pré
                 const checklistPre = manutencaoAtual.Checklist_Pre || {};
                 const checklistPreContainer = document.getElementById('pre-checklist-container');
                  checklistPreContainer.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false); // Desmarca todos
                 Object.entries(checklistPre).forEach(([item, valor]) => {
                     const radioToCheck = checklistPreContainer.querySelector(`input[type="radio"][data-item="<span class="math-inline">\{CSS\.escape\(item\)\}"\]\[value\="</span>{CSS.escape(valor)}"]`);
                      if (radioToCheck) radioToCheck.checked = true;
                 });

                 // Carregar imagens pré
                 const imagensPreContainer = document.getElementById('imagens-preview-pre');
                 imagensPreContainer.innerHTML = ''; // Limpa
                 imagenesPreUpload = Array.isArray(manutencaoAtual.Imagens_Pre) ? [...manutencaoAtual.Imagens_Pre] : []; // Copia array
                 imagenesPreUpload.forEach(img => adicionarImagemPreview(img.url, 'pre', img.id)); // Passa ID para remoção


                 // --- Preencher Formulário Pós-Manutenção (se aplicável) ---
                 const formPos = document.getElementById('form-pos-manutencao');
                 formPos.reset(); // Limpa antes de preencher
                 document.getElementById('pos-id').value = manutencaoAtual.ID || '';
                 document.getElementById('pos-placa-display').textContent = manutencaoAtual.Placa || 'N/A';
                 // document.getElementById('pos-modelo-display').textContent = manutencaoAtual.Modelo || 'N/A'; // Removido
                 document.getElementById('pos-tipo-display').textContent = manutencaoAtual.Tipo_Equipamento || 'N/A';


                 if (manutencaoAtual.Status === STATUS_CONCLUIDO || manutencaoAtual.Status === STATUS_DISPONIVEL) {
                      document.getElementById('pos-observacoes').value = manutencaoAtual.Observacoes_Pos || '';

                      // Carregar checklist pós
                      const checklistPos = manutencaoAtual.Checklist_Pos || {};
                      const checklistPosContainer = document.getElementById('pos-checklist-container');
                      checklistPosContainer.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false); // Desmarca
                      Object.entries(checklistPos).forEach(([item, valor]) => {
                          const radioToCheck = checklistPosContainer.querySelector(`input[type="radio"][data-item="<span class="math-inline">\{CSS\.escape\(item\)\}"\]\[value\="</span>{CSS.escape(valor)}"]`);
                           if (radioToCheck) radioToCheck.checked = true;
                      });

                      // Carregar imagens pós
                      const imagensPosContainer = document.getElementById('imagens-preview-pos');
                      imagensPosContainer.innerHTML = ''; // Limpa
                      imagenesPosUpload = Array.isArray(manutencaoAtual.Imagens_Pos) ? [...manutencaoAtual.Imagens_Pos] : []; // Copia array
                      imagenesPosUpload.forEach(img => adicionarImagemPreview(img.url, 'pos', img.id)); // Passa ID

                      mostrarTela('posManu'); // Mostra tela pós se já concluído
                 } else {
                      // Se não está concluído, limpa dados pós e mostra tela pré
                       document.getElementById('pos-observacoes').value = '';
                       document.getElementById('imagens-preview-pos').innerHTML = '';
                       imagenesPosUpload = [];
                       const checklistPosContainer = document.getElementById('pos-checklist-container');
                       checklistPosContainer.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                       mostrarTela('preManu');
                 }
             } catch (error) {
                  modals.alert.hide();
                  mostrarAlerta(`Erro ao preparar edição: ${error.message}`, 'Erro');
             }
        }

        // Função para formatar data (revisada para consistência)
        function formatarData(dataInput) {
            if (!dataInput) return 'N/A';
            try {
                const dataObj = new Date(dataInput);
                // Verifica se a data é válida
                if (isNaN(dataObj.getTime())) {
                    return 'Data Inválida';
                }
                // Retorna formato DD/MM/YYYY HH:MM
                return dataObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' +
                       dataObj.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            } catch (e) {
                return 'Erro Data'; // Retorna erro se falhar
            }
        }


         // Função para adicionar imagem ao preview (Atualizada para incluir ID e botão de remover correto)
         function adicionarImagemPreview(src, tipo, fileId = null) { // Adicionado fileId opcional
             const container = document.getElementById(`imagens-preview-${tipo}`);
             if (!container) return;
           const imgContainer = document.createElement('div');
           imgContainer.className = 'image-container position-relative';
           imgContainer.dataset.fileId = fileId || src; // Usa ID do arquivo ou URL/base64 como identificador

           const img = document.createElement('img');
           img.src = src; // Pode ser URL ou base64
           img.alt = 'Imagem';
           img.className = 'img-thumbnail photo-preview-img'; // Adicionado classe para seleção
           img.style.cursor = 'pointer';
           img.onclick = () => window.open(src, '_blank'); // Abre em nova aba ao clicar

           const deleteBtn = document.createElement('button');
           deleteBtn.type = 'button'; // Importante para não submeter forms
           // Usar classes Bootstrap para estilo e acessibilidade do botão de fechar
           deleteBtn.className = 'btn-close delete-btn';
           deleteBtn.style.position = 'absolute'; // Ajuste fino da posição
           deleteBtn.style.top = '5px';
           deleteBtn.style.right = '5px';
           deleteBtn.style.backgroundColor = 'rgba(255, 255, 255, 0.7)'; // Fundo para contraste
           deleteBtn.style.borderRadius = '50%'; // Circular
           deleteBtn.style.padding = '0.25rem'; // Padding interno
           deleteBtn.setAttribute('aria-label', 'Remover Imagem');
           deleteBtn.title = 'Remover Imagem';
           deleteBtn.onclick = function(e) {
               e.stopPropagation(); // Evita abrir imagem ao clicar no X
               const imageIdentifier = imgContainer.dataset.fileId;
               imgContainer.remove(); // Remove o elemento do DOM

               // Remove da lista correspondente
               if (tipo === 'pre') {
                   imagenesPreUpload = imagenesPreUpload.filter(imgData => (imgData.id || imgData.url) !== imageIdentifier);
               } else {
                   imagenesPosUpload = imagenesPosUpload.filter(imgData => (imgData.id || imgData.url) !== imageIdentifier);
               }
               // TODO: Adicionar chamada à API para excluir imagem do Drive se necessário (requer backend)
               console.log("Imagem removida (localmente):", imageIdentifier);
           };

            // Botão Anotar (Adiciona APENAS se a ferramenta estiver integrada)
            if (typeof ImageAnnotator !== 'undefined') {
                const btnAnnotate = document.createElement('button');
                btnAnnotate.type = 'button';
                btnAnnotate.className = 'btn btn-sm btn-info btn-annotate'; // Mantém estilo original
                btnAnnotate.style.position = 'absolute'; // Posicionamento
                btnAnnotate.style.top = '5px';
                btnAnnotate.style.left = '5px';
                btnAnnotate.innerHTML = '<i class="bi bi-pencil-square"></i>';
                btnAnnotate.title = 'Anotar imagem';
                btnAnnotate.dataset.imgSrc = src; // Guarda a URL original
                btnAnnotate.dataset.originalId = fileId || src; // Identificador original
                btnAnnotate.addEventListener('click', (e) => {
                    e.stopPropagation();
                    // Passa o container da imagem e o tipo para a função de abrir
                    abrirEditorAnotacao(src, tipo, imgContainer);
                });
                imgContainer.appendChild(btnAnnotate); // Adiciona botão de anotar
            }


           imgContainer.appendChild(img);
           imgContainer.appendChild(deleteBtn); // Adiciona botão de deletar
           container.appendChild(imgContainer);
       }


        // --- Funções da Câmera ---
        async function abrirCamera(tipo) {
            try {
                const constraints = {
                    video: { facingMode: "environment" } // Tenta câmera traseira
                };

                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    mediaStream = await navigator.mediaDevices.getUserMedia(constraints);

                    const videoElementId = `camera-preview-${tipo}`;
                    const video = document.getElementById(videoElementId);
                     if (video) {
                         video.srcObject = mediaStream;
                         video.play(); // Garante que o vídeo comece
                         document.getElementById(`camera-container-${tipo}`).style.display = 'block';
                     } else {
                         console.error("Elemento de vídeo não encontrado:", videoElementId);
                         mostrarAlerta('Erro interno: Elemento de vídeo não encontrado.', 'Erro');
                     }
                } else {
                    mostrarAlerta('Seu navegador não suporta acesso à câmera.', 'Erro');
                }
            } catch (err) {
                console.error('Erro ao abrir câmera:', err);
                let errorMsg = 'Erro ao abrir câmera.';
                if (err.name === "NotAllowedError") {
                    errorMsg = 'Permissão para acessar a câmera foi negada.';
                } else if (err.name === "NotFoundError") {
                    errorMsg = 'Nenhuma câmera encontrada no dispositivo.';
                } else if (err.name === "NotReadableError") {
                    errorMsg = 'Não foi possível acessar a câmera. Pode estar sendo usada por outro app.';
                }
                mostrarAlerta(errorMsg, 'Erro Câmera', 'erro');
            }
        }

        function fecharCamera(tipo) {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            const container = document.getElementById(`camera-container-${tipo}`);
            if (container) container.style.display = 'none';
            const video = document.getElementById(`camera-preview-${tipo}`);
            if(video) video.srcObject = null; // Limpa o source object
        }

        async function capturarImagem(tipo) {
            try {
                const video = document.getElementById(`camera-preview-${tipo}`);
                if (!video || !video.videoWidth || !video.videoHeight) {
                    throw new Error("Preview da câmera não está pronto.");
                }
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const base64 = canvas.toDataURL('image/jpeg', 0.9); // Qualidade 0.9

                fecharCamera(tipo); // Fecha a câmera após captura
                await uploadImagem(base64, tipo);
            } catch (e) {
                console.error('Erro ao capturar imagem:', e);
                mostrarAlerta('Erro ao capturar imagem: ' + e.message, 'Erro', 'erro');
                fecharCamera(tipo); // Fecha a câmera mesmo em erro
            }
        }

        // Função de upload de imagem (atualizada para mostrar loading e tratar nova/edição)
        async function uploadImagem(base64, tipo) {
            // Mostra um loading específico para imagem
            const tempId = `temp-${Date.now()}`;
            adicionarImagemPreviewLoading(tempId, tipo);

            try {
                const idManutencao = document.getElementById(tipo === 'pre' ? 'pre-id' : 'pos-id').value;
                const isNew = !idManutencao; // Se ID está vazio, é uma nova manutenção

                 // Se for nova, apenas adiciona localmente com base64
                 if (isNew) {
                     const imageData = { url: base64, id: tempId, timestamp: new Date().toISOString(), isLocal: true }; // Marca como local
                     if (tipo === 'pre') {
                         imagenesPreUpload.push(imageData);
                     } else {
                         // Não deveria chegar aqui para pós se for nova, mas por segurança
                         imagenesPosUpload.push(imageData);
                     }
                     // Atualiza o preview que estava mostrando loading
                     removerImagemPreviewLoading(tempId, tipo);
                     adicionarImagemPreview(base64, tipo, tempId); // Usa tempId como identificador
                     return; // Não faz upload para o servidor ainda
                 }


                // Fazer upload para o servidor se for edição
                const res = await apiRequest('uploadImagem', {
                    id: idManutencao,
                    imagem: base64, // Envia base64
                    tipo: tipo
                });

                removerImagemPreviewLoading(tempId, tipo); // Remove loading

                if (!res || !res.success) {
                    throw new Error(res.message || 'Erro desconhecido no upload');
                }

                // Adicionar à lista de imagens com URL e ID do Drive
                const imageData = { url: res.url, id: res.id, timestamp: new Date().toISOString() };
                if (tipo === 'pre') {
                    imagenesPreUpload.push(imageData);
                } else {
                    imagenesPosUpload.push(imageData);
                }
                // Adiciona ao preview a imagem real do Drive
                adicionarImagemPreview(res.url, tipo, res.id);

            } catch (e) {
                removerImagemPreviewLoading(tempId, tipo); // Remove loading em caso de erro
                console.error('Erro ao fazer upload de imagem:', e);
                mostrarAlerta('Erro ao fazer upload de imagem: ' + e.message, 'Erro', 'erro');
            }
        }

       // Funções auxiliares para loading de imagem
       function adicionarImagemPreviewLoading(tempId, tipo) {
           const container = document.getElementById(`imagens-preview-${tipo}`);
           if (!container) return;
           const loadingContainer = document.createElement('div');
           loadingContainer.className = 'image-container text-center d-flex align-items-center justify-content-center border rounded image-loading'; // Add class
           loadingContainer.style.width = '150px';
           loadingContainer.style.height = '150px';
           loadingContainer.dataset.tempId = tempId; // Guarda o ID temporário
           loadingContainer.innerHTML = `
               <div class="spinner-border spinner-border-sm text-primary" role="status">
                   <span class="visually-hidden">Enviando...</span>
               </div>
           `;
           container.appendChild(loadingContainer);
       }

       function removerImagemPreviewLoading(tempId, tipo) {
           const container = document.getElementById(`imagens-preview-${tipo}`);
           if (!container) return;
           const loadingElement = container.querySelector(`.image-loading[data-temp-id="${tempId}"]`);
           if (loadingElement) {
               loadingElement.remove();
           }
       }


        // --- Inicialização e Event Listeners Principais ---
        document.addEventListener('DOMContentLoaded', () => {
            // Carregar dados iniciais
            carregarDadosIniciais(); // Esta função agora chama as outras

            // Navegação
            document.getElementById('nav-dashboard')?.addEventListener('click', e => { e.preventDefault(); mostrarTela('dashboard'); });
            document.getElementById('nav-lista')?.addEventListener('click', e => { e.preventDefault(); mostrarTela('lista'); });
            document.getElementById('nav-novo')?.addEventListener('click', e => {
                e.preventDefault();
                 // Limpar formulário pré
                document.getElementById('form-pre-manutencao')?.reset();
                document.getElementById('pre-id').value = '';
                document.getElementById('pre-placa').value = ''; // Limpa hidden
                document.getElementById('pre-modelo').value = ''; // Limpa hidden
                document.getElementById('motivo-outro-container').style.display = 'none';
                document.getElementById('imagens-preview-pre').innerHTML = '';
                document.getElementById('pre-placa-select').style.display = 'none'; // Esconde select de placa
                document.getElementById('pre-placa-outro-valor').style.display = 'none'; // Esconde input de placa
                document.getElementById('pre-placa-outro-valor').value = '';


                imagenesPreUpload = [];
                manutencaoAtual = null; // Garante que não há manutenção atual ao criar nova

                // Resetar checklist
                const checklistPreContainer = document.getElementById('pre-checklist-container');
                checklistPreContainer?.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);

                // Resetar selects para "Selecione..."
                document.getElementById('pre-tipo-equipamento').selectedIndex = 0;
                document.getElementById('pre-categoria-problema').selectedIndex = 0;
                document.getElementById('pre-urgencia').selectedIndex = 0;


                mostrarTela('preManu');
            });
             // Navegação Ferramentas
             document.getElementById('nav-ferramentas')?.addEventListener('click', e => { //
                 e.preventDefault(); //
                 mostrarTela('ferramentas'); //
             }); //


            document.getElementById('btn-nova-manutencao')?.addEventListener('click', () => {
                document.getElementById('nav-novo')?.click();
            });

            // Botões voltar
            document.querySelectorAll('.btn-voltar').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Decide para qual tela voltar (lista é o padrão)
                    mostrarTela('lista');
                });
            });

            // Botão de editar na visualização
            document.getElementById('btn-editar-manutencao')?.addEventListener('click', () => {
                if (manutencaoAtual && manutencaoAtual.ID) {
                    editarManutencao(manutencaoAtual.ID);
                } else {
                    mostrarAlerta("Nenhuma manutenção selecionada para editar.", "Aviso");
                }
            });

            // --- Event Listeners para Relatórios Avançados ---
            document.getElementById('btn-gerar-pdf-basico')?.addEventListener('click', function(e) {
                e.preventDefault();
                if (manutencaoAtual && manutencaoAtual.ID) {
                     gerarRelatorioTextoParaPdf(manutencaoAtual.ID); // Função auxiliar para gerar e baixar
                } else { mostrarAlerta("Selecione uma manutenção.", "Aviso"); }
            });

            document.getElementById('btn-gerar-pdf-avancado')?.addEventListener('click', function(e) {
                e.preventDefault();
                if (manutencaoAtual && manutencaoAtual.ID) {
                    gerarRelatorioAvancadoCliente(manutencaoAtual.ID, 'pdf'); // Nova função cliente
                } else { mostrarAlerta("Selecione uma manutenção.", "Aviso"); }
            });

            document.getElementById('btn-gerar-excel')?.addEventListener('click', function(e) {
                e.preventDefault();
                if (manutencaoAtual && manutencaoAtual.ID) {
                    gerarRelatorioAvancadoCliente(manutencaoAtual.ID, 'excel');
                } else { mostrarAlerta("Selecione uma manutenção.", "Aviso"); }
            });

            document.getElementById('btn-gerar-csv')?.addEventListener('click', function(e) {
                e.preventDefault();
                if (manutencaoAtual && manutencaoAtual.ID) {
                    gerarRelatorioAvancadoCliente(manutencaoAtual.ID, 'csv');
                } else { mostrarAlerta("Selecione uma manutenção.", "Aviso"); }
            });
            // --- Fim Relatórios ---


            // Filtro na lista
            document.getElementById('btn-filtrar')?.addEventListener('click', () => {
                carregarListaManutencoes();
            });

            document.getElementById('btn-limpar-filtro')?.addEventListener('click', () => {
                document.getElementById('filtro-status').value = '';
                document.getElementById('filtro-placa').value = '';
                carregarListaManutencoes();
            });

            // --- Lógica para Selects Dinâmicos de Equipamento ---
            const tipoEquipSelect = document.getElementById('pre-tipo-equipamento');
            const placaSelect = document.getElementById('pre-placa-select');
            const placaOutroInput = document.getElementById('pre-placa-outro-valor');
            const hiddenPlaca = document.getElementById('pre-placa');
            const hiddenModelo = document.getElementById('pre-modelo');

            tipoEquipSelect?.addEventListener('change', function() {
                 const tipoSelecionado = this.value;
                 placaSelect.innerHTML = '<option value="">Selecione o Equipamento...</option>'; // Limpa e adiciona placeholder
                 placaSelect.style.display = 'none';
                 placaOutroInput.style.display = 'none';
                 placaOutroInput.value = '';
                 placaOutroInput.required = false;
                 hiddenPlaca.value = ''; // Limpa hidden
                 hiddenModelo.value = ''; // Limpa hidden

                 if (tipoSelecionado) {
                     const opcoesPlaca = equipamentosData[tipoSelecionado] || [];

                     if (opcoesPlaca.length > 0) {
                         // Preenche o select de placas
                         opcoesPlaca.forEach(placa => {
                             const option = document.createElement('option');
                             option.value = placa;
                             option.textContent = placa;
                             placaSelect.appendChild(option);
                         });
                         placaSelect.style.display = 'block';
                         placaSelect.required = true; // Torna obrigatório
                         placaOutroInput.required = false; // Não é mais obrigatório
                     } else {
                         // Se não há opções pré-definidas (ex: Outro Tipo), mostra direto o input
                         placaOutroInput.style.display = 'block';
                         placaOutroInput.required = true;
                         placaSelect.required = false; // Não é obrigatório
                     }
                 } else {
                     // Se nenhum tipo selecionado, ambos ficam escondidos e não requeridos
                     placaSelect.required = false;
                     placaOutroInput.required = false;
                 }
            });

            placaSelect?.addEventListener('change', function() {
                 const placaSelecionada = this.value;
                 hiddenPlaca.value = placaSelecionada; // Atualiza hidden

                 if (placaSelecionada === 'OUTRO EQUIPAMENTO') {
                     placaOutroInput.style.display = 'block';
                     placaOutroInput.required = true;
                     placaOutroInput.value = ''; // Limpa valor anterior
                     placaOutroInput.focus();
                     hiddenPlaca.value = ''; // Limpa hidden temporariamente
                     hiddenModelo.value = ''; // Limpa modelo
                 } else if (placaSelecionada === '') {
                     // Se voltou para "Selecione..."
                     placaOutroInput.style.display = 'none';
                     placaOutroInput.required = false;
                     hiddenPlaca.value = '';
                     hiddenModelo.value = '';
                 } else {
                     placaOutroInput.style.display = 'none';
                     placaOutroInput.required = false;
                     // Tenta encontrar o modelo do equipamento selecionado
                     const tipoAtual = tipoEquipSelect.value;
                     const equipInfo = equipamentos.find(eq => eq.Placa === placaSelecionada && eq.Tipo_Equipamento === tipoAtual);
                     hiddenModelo.value = equipInfo?.Modelo || ''; // Preenche modelo no hidden
                 }
            });

            placaOutroInput?.addEventListener('input', function() {
                 // Quando o usuário digita em "Outro", atualiza o hidden
                 hiddenPlaca.value = this.value.trim(); // Usa o valor digitado
                 hiddenModelo.value = ''; // Modelo é desconhecido
            });
            // --- Fim Lógica Selects ---

            // Ao mudar categoria, mostrar/esconder campo de outro motivo
            document.getElementById('pre-categoria-problema')?.addEventListener('change', function() {
                const motivoOutroContainer = document.getElementById('motivo-outro-container');
                const motivoOutroInput = document.getElementById('pre-motivo-outro');
                if (this.value === 'Outro') {
                    motivoOutroContainer.style.display = 'block';
                    motivoOutroInput.required = true;
                } else {
                    motivoOutroContainer.style.display = 'none';
                    motivoOutroInput.required = false;
                    motivoOutroInput.value = ''; // Limpa o campo ao esconder
                }
            });

            // Submit do formulário pré-manutenção
            document.getElementById('form-pre-manutencao')?.addEventListener('submit', async function(e) {
                 e.preventDefault();
                 mostrarAlerta('Salvando registro pré-manutenção...', 'Aguarde', 'aguarde');

                 // Obter dados do formulário
                 const dados = obterDadosFormulario('form-pre-manutencao');

                 // Validar se placa/equipamento foi preenchido
                 if (!dados.placa) {
                     modals.alert.hide();
                     mostrarAlerta('Selecione ou informe o equipamento/placa.', 'Erro de Validação', 'erro');
                     // Tenta focar no campo problemático
                     document.getElementById('pre-placa-outro-valor').style.display !== 'none' ? document.getElementById('pre-placa-outro-valor').focus() : document.getElementById('pre-placa-select').focus();
                     return;
                 }
                 // Validar se tipo de equipamento foi selecionado
                 if (!dados.tipoEquipamento) {
                     modals.alert.hide();
                     mostrarAlerta('Selecione o Tipo de Equipamento.', 'Erro de Validação', 'erro');
                      document.getElementById('pre-tipo-equipamento').focus();
                     return;
                 }

                 try {
                     // Montar objeto para salvar, garantindo que temos ID se for edição
                     const payload = {
                         id: dados.id || undefined, // Envia ID se for edição
                         placa: dados.placa,
                         modelo: dados.modelo,
                         tipoEquipamento: dados.tipoEquipamento,
                         categoriaProblema: dados.categoriaProblema,
                         urgencia: dados.urgencia,
                         motivoOutro: dados.motivoOutro,
                         descricaoProblema: dados.descricaoProblema,
                         checklistPre: dados.checklistPre,
                         observacoesPre: dados.observacoesPre,
                         imagensPre: dados.imagensPre, // Array de {url, id, timestamp}
                         responsavel: dados.responsavel,
                         // Define status inicial apenas se for novo E não está definido nos dados
                         status: dados.id ? undefined : (dados.status || STATUS_AGUARDANDO)
                     };

                     // Salvar manutenção
                     const res = await apiRequest('salvarManutencao', {
                         dados: JSON.stringify(payload)
                     });

                     modals.alert.hide(); // Esconde "Aguarde"

                     if (!res || !res.success) {
                         throw new Error(res.message || 'Erro desconhecido ao salvar');
                     }

                     const savedId = res.id || dados.id; // Usa o ID retornado ou o ID existente

                     // Perguntar o que fazer agora
                     document.getElementById('btn-choice-lista').onclick = () => {
                         modals.choice.hide();
                         mostrarTela('lista');
                     };

                     document.getElementById('btn-choice-novo').onclick = () => {
                         modals.choice.hide();
                         document.getElementById('nav-novo')?.click();
                     };

                     document.getElementById('btn-choice-pos').onclick = async () => {
                         modals.choice.hide();
                         mostrarAlerta('Carregando dados para pós-manutenção...', 'Aguarde', 'aguarde');
                         try {
                             // Recarrega os dados da manutenção salva para garantir consistência
                             const resLoad = await apiRequest('obterManutencao', { id: savedId });
                             modals.alert.hide();

                             if (!resLoad.success || !resLoad.manutencao) {
                                 throw new Error("Erro ao recarregar dados para pós-manutenção.");
                             }
                             const manutencaoRecarregada = resLoad.manutencao;

                             // Carregar para o formulário pós
                             document.getElementById('pos-id').value = savedId;
                             document.getElementById('pos-placa-display').textContent = manutencaoRecarregada.Placa || 'N/A';
                             document.getElementById('pos-tipo-display').textContent = manutencaoRecarregada.Tipo_Equipamento || 'N/A';


                             // Limpar dados PÓS anteriores (caso esteja reeditando)
                             document.getElementById('pos-observacoes').value = manutencaoRecarregada.Observacoes_Pos || '';
                             document.getElementById('imagens-preview-pos').innerHTML = '';
                             imagenesPosUpload = Array.isArray(manutencaoRecarregada.Imagens_Pos) ? [...manutencaoRecarregada.Imagens_Pos] : [];
                             imagenesPosUpload.forEach(img => adicionarImagemPreview(img.url, 'pos', img.id)); // Adiciona imagens existentes

                             // Resetar checklist PÓS
                             const checklistPosContainer = document.getElementById('pos-checklist-container');
                             checklistPosContainer.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
                             const checklistPosData = manutencaoRecarregada.Checklist_Pos || {};
                             Object.entries(checklistPosData).forEach(([item, valor]) => {
                                 const radioToCheck = checklistPosContainer.querySelector(`input[type="radio"][data-item="${CSS.escape(item)}"][value="${CSS.escape(valor)}"]`);
                                 if (radioToCheck) radioToCheck.checked = true;
                             });

                             mostrarTela('posManu');
                         } catch (loadError) {
                             modals.alert.hide();
                             mostrarAlerta(loadError.message, "Erro");
                             mostrarTela('lista'); // Volta pra lista em caso de erro
                         }
                     };

                     modals.choice.show();

                 } catch (error) {
                     modals.alert.hide();
                     mostrarAlerta(`Erro ao salvar: ${error.message}`, 'Erro', 'erro');
                 }
            });


            // Submit do formulário pós-manutenção
            document.getElementById('form-pos-manutencao')?.addEventListener('submit', async function(e) {
                 e.preventDefault();
                 mostrarAlerta('Finalizando manutenção...', 'Aguarde', 'aguarde');

                 const id = document.getElementById('pos-id').value;
                 if (!id) {
                     modals.alert.hide();
                     mostrarAlerta('ID da manutenção não encontrado. Não é possível finalizar.', 'Erro Crítico', 'erro');
                     return;
                 }

                 // Obter dados do formulário PÓS
                 const dadosPos = obterDadosFormulario('form-pos-manutencao');

                 try {
                     // Obter dados PRE existentes para não sobrescrever
                     const resManutencao = await apiRequest('obterManutencao', { id });
                     if (!resManutencao.success || !resManutencao.manutencao) {
                         throw new Error('Erro ao carregar dados existentes da manutenção.');
                     }
                     const manutencaoExistente = resManutencao.manutencao;

                     // Montar objeto final para salvar, combinando dados existentes com os novos dados PÓS
                     const dadosParaSalvar = {
                         ...manutencaoExistente, // Mantém dados PRE e outros
                         id: id, // Garante o ID correto
                         dataManutencao: new Date().toISOString(), // Data atual para conclusão
                         checklistPos: dadosPos.checklistPos,
                         observacoesPos: dadosPos.observacoesPos,
                         imagensPos: dadosPos.imagensPos, // Já contém URLs e IDs
                         status: STATUS_CONCLUIDO // Define como concluído ao finalizar
                     };

                     // Salvar manutenção (atualização final)
                     const res = await apiRequest('salvarManutencao', {
                         dados: JSON.stringify(dadosParaSalvar)
                     });

                     modals.alert.hide(); // Esconde "Aguarde"

                     if (!res || !res.success) {
                         throw new Error(res.message || 'Erro desconhecido ao finalizar');
                     }

                     mostrarAlerta('Manutenção finalizada com sucesso!', 'Sucesso', 'sucesso');

                     // Voltar para a lista
                     mostrarTela('lista');

                 } catch (error) {
                     modals.alert.hide();
                     mostrarAlerta(`Erro ao finalizar: ${error.message}`, 'Erro', 'erro');
                 }
            });

            // Botão para voltar para pré-manutenção a partir da tela Pós
            document.getElementById('btn-voltar-pre')?.addEventListener('click', () => {
                const id = document.getElementById('pos-id').value;
                if (id) {
                    // Simula clique no botão de editar para recarregar na tela PRE
                    editarManutencao(id);
                } else {
                    mostrarTela('preManu'); // Se não tiver ID, vai para novo registro
                }
            });

            // Botões de atualização de status na Visualização
            document.querySelectorAll('#tela-visualizacao .btn-status').forEach(btn => {
                btn.addEventListener('click', async function() {
                     if (!manutencaoAtual || !manutencaoAtual.ID) {
                         mostrarAlerta("Nenhuma manutenção selecionada.", "Aviso");
                         return;
                     }

                     const status = this.dataset.status;
                     if (manutencaoAtual.Status === status) {
                         mostrarAlerta(`A manutenção já está com o status "${status}".`, "Informação");
                         return;
                     }

                     // Confirmar alteração
                     mostrarConfirmacao(`Deseja realmente alterar o status para "${status}"?`, async () => {
                         mostrarAlerta('Atualizando status...', 'Aguarde', 'aguarde');
                         try {
                             const res = await apiRequest('atualizarStatusManutencao', {
                                 id: manutencaoAtual.ID,
                                 status: status
                             });
                             modals.alert.hide(); // Esconde "Aguarde"

                             if (!res || !res.success) {
                                 throw new Error(res.message || 'Erro desconhecido ao atualizar status');
                             }

                             mostrarAlerta('Status atualizado com sucesso!', 'Sucesso', 'sucesso');

                             // Atualizar visualização
                             visualizarManutencao(manutencaoAtual.ID); // Recarrega a visualização
                         } catch (error) {
                              modals.alert.hide();
                              mostrarAlerta(`Erro ao atualizar status: ${error.message}`, 'Erro', 'erro');
                         }
                     });
                });
            });

            // --- Event Listeners Câmera ---
            document.getElementById('btn-abrir-camera-pre')?.addEventListener('click', () => abrirCamera('pre'));
            document.getElementById('btn-fechar-camera-pre')?.addEventListener('click', () => fecharCamera('pre'));
            document.getElementById('btn-capturar-pre')?.addEventListener('click', () => capturarImagem('pre'));

            document.getElementById('btn-abrir-camera-pos')?.addEventListener('click', () => abrirCamera('pos'));
            document.getElementById('btn-fechar-camera-pos')?.addEventListener('click', () => fecharCamera('pos'));
            document.getElementById('btn-capturar-pos')?.addEventListener('click', () => capturarImagem('pos'));

            // --- Event Listeners Galeria ---
            document.getElementById('btn-selecionar-imagem-pre')?.addEventListener('click', () => {
                document.getElementById('input-imagem-pre')?.click();
            });
             document.getElementById('input-imagem-pre')?.addEventListener('change', function() {
                 if (this.files) {
                     // Processa múltiplos arquivos
                     Array.from(this.files).forEach(file => {
                         if (file.size > 5 * 1024 * 1024) { // Limite de 5MB por exemplo
                             mostrarAlerta(`Arquivo ${file.name} é muito grande (max 5MB).`, 'Aviso', 'aviso');
                             return;
                         }
                         if (!file.type.startsWith('image/')) {
                              mostrarAlerta(`Arquivo ${file.name} não é uma imagem.`, 'Aviso', 'aviso');
                              return;
                         }
                         const reader = new FileReader();
                         reader.onload = async function(e) {
                             await uploadImagem(e.target.result, 'pre');
                         };
                         reader.onerror = (err) => {
                             console.error("Erro ao ler arquivo:", err);
                             mostrarAlerta(`Erro ao ler o arquivo ${file.name}.`, 'Erro', 'erro');
                         }
                         reader.readAsDataURL(file);
                     });
                     this.value = ''; // Limpa o input para permitir selecionar os mesmos arquivos novamente
                 }
             });

            document.getElementById('btn-selecionar-imagem-pos')?.addEventListener('click', () => {
                document.getElementById('input-imagem-pos')?.click();
            });
            document.getElementById('input-imagem-pos')?.addEventListener('change', function() {
                 if (this.files) {
                     Array.from(this.files).forEach(file => {
                         if (file.size > 5 * 1024 * 1024) {
                             mostrarAlerta(`Arquivo ${file.name} é muito grande (max 5MB).`, 'Aviso', 'aviso');
                             return;
                         }
                          if (!file.type.startsWith('image/')) {
                              mostrarAlerta(`Arquivo ${file.name} não é uma imagem.`, 'Aviso', 'aviso');
                              return;
                         }
                         const reader = new FileReader();
                         reader.onload = async function(e) {
                             await uploadImagem(e.target.result, 'pos');
                         };
                         reader.onerror = (err) => {
                             console.error("Erro ao ler arquivo:", err);
                             mostrarAlerta(`Erro ao ler o arquivo ${file.name}.`, 'Erro', 'erro');
                         }
                         reader.readAsDataURL(file);
                     });
                     this.value = ''; // Limpa o input
                 }
            });

            // --- Event Listeners para Ferramentas ---
            // Integração com Planilha de Turnos
            document.getElementById('btn-executar-integracao')?.addEventListener('click', async function() {
                 const idPlanilhaInput = document.getElementById('id-planilha-turnos');
                 const idPlanilha = idPlanilhaInput.value.trim();

                 if (!idPlanilha) {
                     mostrarAlerta('Por favor, informe o ID da planilha de turnos.', 'Aviso');
                     idPlanilhaInput.focus();
                     return;
                 }

                 mostrarAlerta('Executando integração com planilha de turnos...', 'Aguarde', 'aguarde');

                 try {
                     // Primeiro salva a configuração do ID no backend
                     await apiRequest('salvarConfiguracao', { chave: 'ID_PLANILHA_TURNOS', valor: idPlanilha });
                     // Tenta executar a integração
                     const res = await apiRequest('integrarComPlanilhaTurnos', { idPlanilha: idPlanilha }); // Passa o ID
                     modals.alert.hide();

                     if (res && res.success) {
                         mostrarAlerta(res.message || 'Integração concluída!', 'Sucesso', 'sucesso');
                     } else {
                         throw new Error(res.message || 'Erro desconhecido na integração');
                     }
                 } catch (error) {
                     modals.alert.hide();
                     console.error('Erro ao executar integração:', error);
                     mostrarAlerta(`Erro na integração: ${error.message}`, 'Erro', 'erro');
                 }
            });

            // Salvar configuração de e-mails
            document.getElementById('btn-salvar-emails')?.addEventListener('click', async function() {
                 const emails = document.getElementById('emails-notificacao').value.trim();
                 mostrarAlerta('Salvando configuração de e-mails...', 'Aguarde', 'aguarde');

                 try {
                     const res = await apiRequest('salvarConfiguracao', {
                         chave: 'EMAILS_NOTIFICACAO',
                         valor: emails
                     });
                     modals.alert.hide();

                     if (res && res.success) {
                         mostrarAlerta('Configuração de e-mails salva com sucesso!', 'Sucesso', 'sucesso');
                     } else {
                         throw new Error(res.message || 'Erro ao salvar configuração de e-mails');
                     }
                 } catch (error) {
                     modals.alert.hide();
                     console.error('Erro ao salvar e-mails:', error);
                     mostrarAlerta(`Erro ao salvar e-mails: ${error.message}`, 'Erro', 'erro');
                 }
            });

            // Salvar configuração de integração automática (ao mudar o switch)
            document.getElementById('integracao-automatica')?.addEventListener('change', async function() {
                 const valor = this.checked ? 'SIM' : 'NAO';
                 mostrarAlerta('Salvando preferência de integração...', 'Aguarde', 'aguarde');

                 try {
                     const res = await apiRequest('salvarConfiguracao', {
                         chave: 'INTEGRAÇÃO_AUTOMÁTICA',
                         valor: valor
                     });
                     modals.alert.hide();

                     if (res && res.success) {
                         mostrarAlerta(`Integração automática ${this.checked ? 'ativada' : 'desativada'}. Clique em '(Re)Configurar Tarefas Automáticas' para aplicar.`, 'Sucesso');
                     } else {
                         throw new Error(res.message || 'Erro ao salvar configuração de integração');
                     }
                 } catch (error) {
                     modals.alert.hide();
                     console.error('Erro ao atualizar configuração de integração:', error);
                     mostrarAlerta(`Erro ao salvar preferência: ${error.message}`, 'Erro', 'erro');
                     // Reverte visualmente se falhar
                     this.checked = !this.checked;
                 }
            });


            // Enviar e-mail de teste
            document.getElementById('btn-teste-email')?.addEventListener('click', async function() {
                const emailsTextarea = document.getElementById('emails-notificacao');
                const emails = emailsTextarea.value.trim();
                if (!emails) {
                    mostrarAlerta('Por favor, informe pelo menos um e-mail para teste no campo acima e salve.', 'Aviso');
                    emailsTextarea.focus();
                    return;
                }

                const tipoEmail = document.getElementById('tipo-email-teste').value;
                const emailList = emails.split(/[,;]+/).map(e => e.trim()).filter(e => e && e.includes('@'));

                if (emailList.length === 0) {
                    mostrarAlerta('Não foi possível identificar e-mails válidos para o teste.', 'Aviso');
                    return;
                }

                // Busca a primeira manutenção da lista atual
                 mostrarAlerta('Buscando manutenção para teste...', 'Aguarde', 'aguarde');
                const resManutencoesLista = await apiRequest('listarManutencoes');
                 modals.alert.hide(); // Esconde busca
                const manutencoesLista = resManutencoesLista.manutencoes || [];


                if (manutencoesLista.length === 0) {
                    mostrarAlerta('É necessário ter pelo menos uma manutenção registrada para enviar e-mail de teste.', 'Aviso');
                    return;
                }

                const idManutencaoTeste = manutencoesLista[0].ID; // Usa a primeira da lista

                mostrarAlerta(`Enviando e-mail de teste (${tipoEmail}) para ${emailList.length} destinatário(s)...`, 'Aguarde', 'aguarde');

                try {
                    const res = await apiRequest('enviarEmailNotificacao', {
                        id: idManutencaoTeste,
                        destinatarios: JSON.stringify(emailList), // Envia a lista como string JSON
                        tipo: tipoEmail
                    });
                    modals.alert.hide();

                    if (res && res.success) {
                        mostrarAlerta(`E-mail de teste enviado com sucesso para: ${emailList.join(', ')}`, 'Sucesso', 'sucesso');
                    } else {
                        throw new Error(res.message || 'Erro desconhecido ao enviar e-mail');
                    }
                } catch (error) {
                    modals.alert.hide();
                    console.error('Erro ao enviar e-mail de teste:', error);
                    mostrarAlerta(`Erro ao enviar e-mail de teste: ${error.message}`, 'Erro', 'erro');
                }
            });

            // Configurar gatilhos automáticos
            document.getElementById('btn-configurar-gatilhos')?.addEventListener('click', async function() {
                // A configuração da integração automática já foi salva pelo evento 'change' do switch
                // Este botão agora apenas chama a reconfiguração dos triggers no backend
                mostrarAlerta('Configurando/Reconfigurando tarefas automáticas do sistema...', 'Aguarde', 'aguarde');

                try {
                    const res = await apiRequest('configurarGatilhoAutomatico');
                    modals.alert.hide();

                    if (res && res.success) {
                        mostrarAlerta(res.message || 'Tarefas automáticas configuradas com sucesso!', 'Sucesso', 'sucesso');
                    } else {
                        throw new Error(res.message || 'Erro ao configurar tarefas automáticas');
                    }
                } catch (error) {
                    modals.alert.hide();
                    console.error('Erro ao configurar gatilhos:', error);
                    mostrarAlerta(`Erro na configuração das tarefas: ${error.message}`, 'Erro', 'erro');
                }
            });

            // Verificar atualizações (Placeholder)
            document.getElementById('btn-verificar-atualizacoes')?.addEventListener('click', function() {
                // Implementar lógica de verificação de versão se necessário
                 const versaoAtual = document.getElementById('versao-sistema')?.textContent || 'N/A';
                mostrarAlerta(`Você está usando a versão ${versaoAtual}. Verifique o repositório ou contato para novas versões.`, 'Informação');
            });
            // --- Fim Ferramentas ---

             // Evento de mudança no filtro de período do gráfico
             document.getElementById('filtro-periodo-grafico')?.addEventListener('change', function() {
                  carregarGraficoPeriodo(parseInt(this.value) || 30);
             });

            // Inicialização da ferramenta de anotação (se incluída)
             if (typeof ImageAnnotator !== 'undefined') {
                 anotadorImagem = new ImageAnnotator('annotation-container');
                 configurarSalvamentoAnotacao();
                 // Inicializar integração visual (adicionar botões às imagens existentes)
                 // É melhor chamar isso depois que os dados da visualização são carregados
             }


        }); // Fim DOMContentLoaded

        // --- Funções Auxiliares ---

        // Configura os selects dinâmicos de equipamento
        function configurarSelectsEquipamentos() {
             // Os listeners já são adicionados no DOMContentLoaded.
             // Apenas garante que o select de tipo tenha as opções corretas (se vierem do backend)
             // const tipoSelect = document.getElementById('pre-tipo-equipamento');
             // Exemplo: preencherSelect(tipoSelect.id, tiposEquipamentosOptions || []); // Se tipos viessem da API
        }


        // Função auxiliar para gerar PDF do relatório básico de texto via Backend
        async function gerarRelatorioTextoParaPdf(id) {
             mostrarAlerta('Gerando PDF básico...', 'Aguarde', 'aguarde');
             try {
                 // Chama a função backend que gera o texto E o PDF
                 const res = await apiRequest('gerarPDFTextoBackend', { id: id }); // Supõe que existe essa função no backend
                 modals.alert.hide();

                 if (res && res.success && res.url) {
                     window.open(res.url, '_blank'); // Abre o PDF gerado no Drive
                     mostrarAlerta('PDF Básico gerado com sucesso!', 'Sucesso', 'sucesso');
                 } else {
                     mostrarAlerta('Erro ao gerar o arquivo PDF no servidor: ' + (res?.message || 'Erro desconhecido'), 'Erro', 'erro');
                 }
             } catch (error) {
                 modals.alert.hide();
                 console.error("Erro ao gerar PDF básico:", error);
                 mostrarAlerta(`Erro ao gerar PDF: ${error.message}`, 'Erro', 'erro');
             }
        }


        // Função CLIENTE para chamar relatórios avançados
        async function gerarRelatorioAvancadoCliente(id, formato) {
             if (!id) return;
             mostrarAlerta(`Gerando relatório em formato ${formato.toUpperCase()}...`, 'Aguarde', 'aguarde');

             try {
                 const res = await apiRequest('gerarRelatorioAvancado', {
                     id: id,
                     formato: formato,
                     opcoes: JSON.stringify({ incluirImagens: true }) // Exemplo de opção
                 });
                 modals.alert.hide();

                 if (!res || !res.success) {
                     throw new Error(res.message || `Erro ao gerar relatório ${formato}`);
                 }

                 // Abrir relatório em nova aba (URL do Drive)
                 if (res.url) {
                     window.open(res.url, '_blank');
                     mostrarAlerta(`Relatório ${formato.toUpperCase()} gerado! Verifique a nova aba ou seu Google Drive.`, 'Sucesso', 'sucesso');
                 } else {
                     mostrarAlerta(`Relatório ${formato.toUpperCase()} gerado, mas URL não encontrada. Verifique o Drive.`, 'Aviso');
                 }

             } catch (error) {
                 modals.alert.hide();
                 console.error(`Erro ao gerar relatório ${formato}:`, error);
                 mostrarAlerta(`Erro ao gerar relatório ${formato}: ${error.message}`, 'Erro', 'erro');
             }
        }

        // Função para carregar dados na tela de Ferramentas
        async function carregarDadosFerramentas() {
             mostrarAlerta('Carregando configurações...', 'Aguarde', 'aguarde');
             try {
                 // Versão do sistema
                 document.getElementById('versao-sistema').textContent = VERSAO_APP || 'N/A'; // Usa variável global

                 const res = await apiRequest('obterConfiguracoes');
                 modals.alert.hide();

                 if (res && res.success && res.configuracoes) {
                     const configs = res.configuracoes;
                     // Preenche campos com valores da configuração
                     document.getElementById('id-planilha-turnos').value = configs['ID_PLANILHA_TURNOS'] || '';
                     document.getElementById('emails-notificacao').value = configs['EMAILS_NOTIFICACAO'] || '';
                     document.getElementById('integracao-automatica').checked = configs['INTEGRAÇÃO_AUTOMÁTICA'] === 'SIM';
                 } else {
                     mostrarAlerta('Não foi possível carregar as configurações do servidor.', 'Aviso');
                 }
             } catch (error) {
                 modals.alert.hide();
                 console.error('Erro ao carregar dados de ferramentas:', error);
                 mostrarAlerta(`Erro ao carregar configurações: ${error.message}`, 'Erro', 'erro');
             }
        }

        // --- Funções de Anotação ---
        function configurarSalvamentoAnotacao() {
             const btnSalvar = document.getElementById('btn-save-annotation');
             if (btnSalvar && anotadorImagem) {
                 btnSalvar.onclick = async () => { // Função anônima para garantir contexto
                     const annotatedImageBase64 = anotadorImagem.captureImage();
                     // const originalUrl = anotadorImagem.imageElement.src; // URL original
                     const tipoImagem = anotadorImagem.contextoTipo; // 'pre' ou 'pos'
                     const imageContainerElement = anotadorImagem.contextoContainer; // Elemento div da imagem
                     const idOriginal = anotadorImagem.contextoIdOriginal; // ID/URL original

                     modals.anotacao.hide(); // Fecha o modal
                     mostrarAlerta('Salvando imagem anotada...', 'Aguarde', 'aguarde');

                     try {
                         const idManutencao = manutencaoAtual?.ID;
                         if (!idManutencao) throw new Error("ID da manutenção não encontrado para salvar anotação.");

                         // Faz upload da *nova* imagem anotada
                         const resUpload = await apiRequest('uploadImagem', {
                             id: idManutencao,
                             imagem: annotatedImageBase64,
                             tipo: tipoImagem, // 'pre' ou 'pos'
                             idOriginalParaSubstituir: idOriginal // **NOVO**: Passa ID original para backend poder excluir/substituir
                         });

                         if (!resUpload || !resUpload.success) {
                             throw new Error(resUpload.message || "Falha no upload da imagem anotada.");
                         }

                         modals.alert.hide();
                         mostrarAlerta('Anotação salva com sucesso!', 'Sucesso', 'sucesso');

                         // Atualiza a imagem no preview com a nova URL do Drive
                         const imgElementPreview = imageContainerElement.querySelector('img');
                         if (imgElementPreview) {
                             imgElementPreview.src = resUpload.url; // Atualiza src da imagem
                             imgElementPreview.onclick = () => window.open(resUpload.url, '_blank'); // Atualiza link
                             const btnAnnotatePreview = imageContainerElement.querySelector('.btn-annotate');
                             if (btnAnnotatePreview) btnAnnotatePreview.dataset.imgSrc = resUpload.url; // Atualiza source para anotar novamente
                         }
                         imageContainerElement.dataset.fileId = resUpload.id; // Atualiza identificador do container

                         // Atualiza a lista de uploads (substitui a original pela anotada)
                         const listaUploads = tipoImagem === 'pre' ? imagenesPreUpload : imagenesPosUpload;
                         const indexOriginal = listaUploads.findIndex(img => (img.id || img.url) === idOriginal);

                         const novaImageData = { url: resUpload.url, id: resUpload.id, timestamp: new Date().toISOString() };
                         if (indexOriginal > -1) {
                             listaUploads[indexOriginal] = novaImageData; // Substitui
                         } else {
                             listaUploads.push(novaImageData); // Adiciona se não achou (improvável)
                         }

                        // Força atualização da manutenção no backend para salvar o novo array de imagens
                         await salvarAposAnotacao(idManutencao);


                     } catch (error) {
                         modals.alert.hide();
                         console.error("Erro ao salvar imagem anotada:", error);
                         mostrarAlerta(`Erro ao salvar anotação: ${error.message}`, 'Erro', 'erro');
                     }
                 };
             }
        }

        // Função auxiliar para salvar a manutenção após anotar uma imagem
        async function salvarAposAnotacao(idManutencao) {
             try {
                  const resManutencao = await apiRequest('obterManutencao', { id: idManutencao });
                  if (!resManutencao.success || !resManutencao.manutencao) {
                      throw new Error('Erro ao recarregar manutenção após anotar imagem.');
                  }
                  let dadosParaSalvar = {...resManutencao.manutencao}; // Copia dados atuais

                  // Atualiza os arrays de imagens com os dados globais modificados
                  dadosParaSalvar.Imagens_Pre = imagenesPreUpload.map(img => ({ url: img.url, id: img.id, timestamp: img.timestamp }));
                  dadosParaSalvar.Imagens_Pos = imagenesPosUpload.map(img => ({ url: img.url, id: img.id, timestamp: img.timestamp }));

                  // Salva a manutenção inteira novamente
                  await apiRequest('salvarManutencao', { dados: JSON.stringify(dadosParaSalvar) });
                  console.log("Manutenção atualizada após anotação.");

             } catch(error) {
                  console.error("Erro ao salvar manutenção após anotação:", error);
                  mostrarAlerta("Erro ao atualizar registro de imagens após anotação.", "Erro", "erro");
             }
        }


       function abrirEditorAnotacao(imgSrc, tipo, containerElement) {
            if (!anotadorImagem) {
                mostrarAlerta("Ferramenta de anotação não inicializada.", "Erro", "erro");
                return;
            }
            mostrarAlerta('Carregando imagem para anotação...', 'Aguarde', 'aguarde');
            anotadorImagem.loadImage(imgSrc).then(() => {
                // Guarda o contexto para saber qual imagem atualizar depois
                anotadorImagem.contextoTipo = tipo; // 'pre' ou 'pos'
                anotadorImagem.contextoContainer = containerElement; // O div .image-container
                anotadorImagem.contextoIdOriginal = containerElement.dataset.fileId; // ID original ou URL

                modals.alert.hide();
                modals.anotacao.show();
            }).catch(err => {
                modals.alert.hide();
                console.error('Erro ao carregar imagem para anotação:', err);
                mostrarAlerta('Erro ao carregar imagem para anotação.', 'Erro', 'erro');
            });
       }

       // === CORREÇÃO API REQUEST ===
       // Função para API usando Fetch (NECESSÁRIO SUBSTITUIR A URL)
       async function apiRequest(action, params = {}) {
           // !!! SUBSTITUA PELA URL DE IMPLANTAÇÃO DO SEU WEB APP !!!
           const SCRIPT_URL = 'URL_DO_SEU_WEB_APP_AQUI';
           // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

           if (SCRIPT_URL === 'URL_DO_SEU_WEB_APP_AQUI') {
               console.error("!!!! URGENTE: Defina a URL de implantação do seu Web App na variável SCRIPT_URL no código HTML !!!!");
               mostrarAlerta("Erro de configuração: A URL do Web App não foi definida no código HTML.", "Erro Crítico", "erro");
               return { success: false, message: "URL do Web App não configurada." };
           }

           // Adiciona a ação aos parâmetros
           params.action = action;

           // Constrói a URL com parâmetros de consulta
           const url = new URL(SCRIPT_URL);
           Object.keys(params).forEach(key => {
               // Trata valores que podem ser objetos/arrays (como 'dados' ou 'destinatarios')
               if (typeof params[key] === 'object' && params[key] !== null) {
                   url.searchParams.append(key, JSON.stringify(params[key]));
               } else if (params[key] !== undefined && params[key] !== null) {
                  url.searchParams.append(key, params[key]);
               }
           });


           try {
               const response = await fetch(url.toString(), {
                   method: 'GET', // Ou 'POST' se preferir enviar no corpo
                   // mode: 'cors', // Necessário se hospedado fora do Google
                   // headers: { // Headers podem ser necessários dependendo da configuração
                   //     'Content-Type': 'application/json',
                   // },
                   // body: JSON.stringify(params) // Se usar POST
               });

               if (!response.ok) {
                   let errorText = response.statusText;
                   try {
                       // Tenta pegar uma mensagem de erro mais detalhada do corpo, se houver
                       const errorBody = await response.text();
                       console.error("Erro na API - Corpo da resposta:", errorBody);
                       // Tenta parsear como JSON, pode falhar se for HTML de erro do Apps Script
                       try {
                           const errorJson = JSON.parse(errorBody);
                           if (errorJson && errorJson.message) {
                               errorText = errorJson.message;
                           }
                       } catch (parseError) {
                           // Se não for JSON, usa o texto do corpo se for curto, ou statusText
                           errorText = errorBody.length < 200 ? errorBody : errorText;
                       }
                   } catch (bodyError) { /* Ignora se não conseguir ler o corpo */ }
                   throw new Error(`Erro HTTP ${response.status}: ${errorText}`);
               }

               // Tenta parsear a resposta como JSON
               const result = await response.json();
               return result;

           } catch (error) {
               console.error('Erro na requisição fetch para', action, ':', error);
               mostrarAlerta(`Erro de comunicação (${action}): ${error.message}`, 'Erro de Rede', 'erro');
               // Retorna um objeto de erro padronizado
               return { success: false, message: `Erro de comunicação: ${error.message}` };
           }
       }


    </script>
</body>
</html>
