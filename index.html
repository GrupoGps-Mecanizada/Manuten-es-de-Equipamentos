<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Registro de Manutenções</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/responsive.css">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
      /* Feedback de validação visual para checklists */
      .checklist-item-wrapper .btn-group label.is-invalid {
         border-color: var(--bs-danger);
         color: var(--bs-danger);
         box-shadow: 0 0 0 .25rem rgba(var(--bs-danger-rgb),.25) !important; /* Adiciona sombra como inputs inválidos */
      }
      .checklist-item-wrapper .btn-group label.is-invalid:hover {
          background-color: var(--bs-danger-bg-subtle);
      }
      /* Mostra a mensagem de erro do checklist apenas se um radio required não foi marcado */
      .was-validated .checklist-item-wrapper .checklist-feedback {
          display: none; /* Esconde por padrão */
      }
      .was-validated .checklist-item-wrapper:has(input[type="radio"]:required:invalid) .checklist-feedback {
          display: block; /* Mostra se o grupo tem um required inválido */
      }
      .checklist-feedback {
           width: 100%;
           margin-top: .25rem;
           font-size: .875em;
           color: var(--bs-form-invalid-color);
       }
       /* Ajuste para thumbnail na visualização */
       .photo-thumbnail-view {
           border: 1px solid #dee2e6;
           padding: 0.25rem;
           background-color: #f8f9fa; /* Fundo leve */
           transition: transform 0.2s ease-in-out;
       }
       .photo-thumbnail-view:hover {
           transform: scale(1.05); /* Efeito de zoom leve */
       }
       /* Garante que o conteúdo principal ocupe o espaço restante */
       body, .container-fluid {
           min-height: 100vh;
       }
       .container-fluid {
            display: flex;
            flex-direction: column;
       }
       main {
            flex-grow: 1;
       }
       
       /* Garantir que o spinner de loading seja ocultado */
       #loadingSpinner {
         display: none !important;
         opacity: 0 !important;
         visibility: hidden !important;
         pointer-events: none !important;
       }
       
       /* Adicionar uma classe que pode ser aplicada via JS */
       .hidden-spinner {
         display: none !important;
         opacity: 0 !important;
         visibility: hidden !important;
         pointer-events: none !important;
       }
  </style>
</head>
<body>
  <div class="container-fluid p-0">

    <header class="bg-primary text-white py-3 px-4 shadow-sm sticky-top">
      <div class="d-flex justify-content-between align-items-center flex-wrap">
        <h1 class="h4 mb-0 me-3"><i class="bi bi-tools me-2"></i> Sistema de Registro</h1>
        <div class="d-flex align-items-center mt-2 mt-sm-0">
          <button class="btn btn-outline-light btn-sm me-2" id="btnListaRegistros" title="Ver Lista de Registros">
            <i class="bi bi-list-ul"></i> <span class="d-none d-md-inline">Registros</span>
          </button>
          <button class="btn btn-outline-light btn-sm me-2" id="btnNovoRegistro" title="Criar Novo Registro">
            <i class="bi bi-plus-circle"></i> <span class="d-none d-md-inline">Novo</span>
          </button>
          <div id="auth-container" class="d-flex align-items-center">
             <div class="spinner-border spinner-border-sm text-light ms-2" role="status">
                <span class="visually-hidden">Carregando autenticação...</span>
             </div>
          </div>
        </div>
      </div>
    </header>

    <main class="container py-4">

      <section id="dashboardSection" class="mb-4 tela-sistema" style="display: none;">
          <div class="card shadow-sm">
             <div class="card-header">
                 <h2 class="h5 mb-0"><i class="bi bi-bar-chart-line me-2"></i> Dashboard</h2>
             </div>
              <div class="card-body">
                  <div id="dashboard-container">
                      <p class="text-muted text-center py-3">Carregando dados do dashboard...</p>
                  </div>
              </div>
          </div>
      </section>

      <section id="telaListaRegistros" class="tela-sistema">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
              <h2 class="h5 mb-0">Registros de Manutenção</h2>
              <div class="input-group" style="max-width: 300px;">
                <input type="text" class="form-control form-control-sm" placeholder="Buscar por ID, Placa, Modelo..." id="buscaRegistro" aria-label="Campo de busca">
                <button class="btn btn-sm btn-outline-secondary" type="button" id="btnBuscar" title="Buscar">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>
          </div>
          <div class="card-body p-0 p-md-3">
            <div class="table-responsive">
              <table class="table table-hover table-striped mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col"><small>ID</small></th>
                    <th scope="col">Placa</th>
                    <th scope="col">Modelo</th>
                    <th scope="col">Data Criação</th>
                    <th scope="col">Status</th>
                    <th scope="col" class="text-center">Ações</th>
                  </tr>
                </thead>
                <tbody id="listaRegistrosBody">
                  <tr>
                    <td colspan="6" class="text-center py-4">
                      <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                      </div>
                      <span class="ms-2">Carregando registros...</span>
                    </td>
                  </tr>
                  </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section id="telaPreManutencao" class="tela-sistema" style="display: none;">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
              <h2 class="h5 mb-0"><i class="bi bi-clipboard-plus me-2"></i> Registro PRÉ-Manutenção</h2>
              <div id="registroIdDisplay" class="badge bg-light text-primary fs-6">Novo Registro</div>
            </div>
          </div>
          <div class="card-body">
            <form id="formPreManutencao" class="needs-validation" novalidate>
              <input type="hidden" id="registroId" name="registroId"> <fieldset class="mb-4 p-3 border rounded">
                <legend class="fs-6 fw-bold mb-3">Informações do Veículo</legend>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="placa" class="form-label">Placa <span class="text-danger">*</span></label>
                    <input type="text" class="form-control enhanced-input" id="placa" name="placa" required pattern="[A-Za-z]{3}-?[0-9][A-Za-z0-9]{3}" title="Formato AAA-1234 ou AAA1B34">
                    <div class="invalid-feedback">Informe uma placa válida (ex: AAA-1234 ou ABC1D23).</div>
                  </div>
                  <div class="col-md-6">
                    <label for="modelo" class="form-label">Modelo <span class="text-danger">*</span></label>
                    <input type="text" class="form-control enhanced-input" id="modelo" name="modelo" required maxlength="100">
                    <div class="invalid-feedback">Informe o modelo do veículo (máx. 100 caracteres).</div>
                  </div>
                  <div class="col-md-6">
                    <label for="idInterna" class="form-label">ID Interna <span class="text-danger">*</span></label>
                    <input type="text" class="form-control enhanced-input" id="idInterna" name="idInterna" required maxlength="50">
                    <div class="invalid-feedback">Informe a ID interna do equipamento (máx. 50 caracteres).</div>
                  </div>
                  <div class="col-md-6">
                    <label for="quilometragem" class="form-label">Quilometragem</label>
                    <input type="number" class="form-control enhanced-input" id="quilometragem" name="quilometragem" min="0" step="1">
                     <div class="invalid-feedback">Informe uma quilometragem válida (número positivo).</div>
                  </div>
                </div>
              </fieldset>

              <fieldset class="mb-4 p-3 border rounded">
                <legend class="fs-6 fw-bold mb-3">Detalhes do Problema</legend>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="categoriaProblema" class="form-label">Categoria <span class="text-danger">*</span></label>
                    <select class="form-select enhanced-input" id="categoriaProblema" name="categoriaProblema" required>
                      <option value="" selected disabled>Selecione...</option>
                      </select>
                    <div class="invalid-feedback">Selecione a categoria do problema.</div>
                  </div>
                  <div class="col-md-6">
                    <label for="urgencia" class="form-label">Urgência <span class="text-danger">*</span></label>
                    <select class="form-select enhanced-input" id="urgencia" name="urgencia" required>
                       <option value="" selected disabled>Selecione...</option>
                       </select>
                    <div class="invalid-feedback">Selecione o nível de urgência.</div>
                  </div>
                  <div class="col-12">
                    <label for="descricaoProblema" class="form-label">Descrição do Problema <span class="text-danger">*</span></label>
                    <textarea class="form-control enhanced-input" id="descricaoProblema" name="descricaoProblema" rows="3" required maxlength="500"></textarea>
                    <div class="invalid-feedback">Descreva o problema detalhadamente (máx. 500 caracteres).</div>
                  </div>
                </div>
              </fieldset>

              <fieldset class="mb-4 p-3 border rounded">
                   <legend class="fs-6 fw-bold mb-3">Checklist de Condições PRÉ <span class="text-danger">*</span></legend>
                   <div id="checklistPreContainer" class="row g-3">
                       <p class="text-muted small fst-italic col-12">Carregando checklist...</p>
                       </div>
               </fieldset>

              <fieldset class="mb-4 p-3 border rounded" id="photo-section-pre">
                 <legend class="fs-6 fw-bold mb-3">Registro Fotográfico PRÉ</legend>
                 <div id="photo-container-pre">
                    <p class="text-muted small fst-italic">Carregando gerenciador de fotos...</p>
                 </div>
               </fieldset>

              <fieldset class="mb-4 p-3 border rounded">
                <legend class="fs-6 fw-bold mb-3">Observações Adicionais PRÉ</legend>
                <textarea class="form-control enhanced-input" id="observacoesPre" name="observacoesPre" rows="2" maxlength="500"></textarea>
                 <div class="invalid-feedback">Máximo de 500 caracteres.</div>
              </fieldset>

              <fieldset class="mb-4 p-3 border rounded">
                <legend class="fs-6 fw-bold mb-3">Responsável pelo Registro</legend>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="responsavel" class="form-label">Nome <span class="text-danger">*</span></label>
                    <input type="text" class="form-control enhanced-input" id="responsavel" name="responsavel" required maxlength="100">
                    <div class="invalid-feedback">Informe o nome do responsável (máx. 100 caracteres).</div>
                  </div>
                  </div>
              </fieldset>

              <div class="text-end mt-4">
                <button type="button" class="btn btn-outline-secondary me-2" id="btnCancelarPre">Cancelar</button>
                <button type="submit" class="btn btn-primary">Salvar e Avançar para PÓS <i class="bi bi-arrow-right ms-1"></i></button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <section id="telaPosManutencao" class="tela-sistema" style="display: none;">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-success text-white">
            <div class="d-flex justify-content-between align-items-center">
              <h2 class="h5 mb-0"><i class="bi bi-check2-circle me-2"></i> Registro PÓS-Manutenção</h2>
              <div id="registroIdPosDisplay" class="badge bg-light text-success fs-6">ID: --</div>
            </div>
          </div>
          <div class="card-body">
            <form id="formPosManutencao" class="needs-validation" novalidate>
              <input type="hidden" id="registroIdPos" name="registroId"> <fieldset class="mb-4 p-3 border rounded bg-light">
                 <legend class="fs-6 fw-bold mb-3">Resumo do Veículo</legend>
                 <div class="row g-2">
                    <div class="col-sm-4"><strong>Placa:</strong> <span id="placaPos">--</span></div>
                    <div class="col-sm-4"><strong>Modelo:</strong> <span id="modeloPos">--</span></div>
                    <div class="col-sm-4"><strong>ID Interna:</strong> <span id="idInternaPos">--</span></div>
                 </div>
              </fieldset>

              <fieldset class="mb-4 p-3 border rounded">
                <legend class="fs-6 fw-bold mb-3">Checklist de Condições PÓS <span class="text-danger">*</span></legend>
                 <div id="checklistPosContainer" class="row g-3">
                    <p class="text-muted small fst-italic col-12">Carregando checklist...</p>
                    </div>
              </fieldset>

              <fieldset class="mb-4 p-3 border rounded" id="photo-section-pos">
                 <legend class="fs-6 fw-bold mb-3">Registro Fotográfico PÓS</legend>
                  <div id="photo-container-pos">
                     <p class="text-muted small fst-italic">Carregando gerenciador de fotos...</p>
                  </div>
               </fieldset>

              <fieldset class="mb-4 p-3 border rounded">
                <legend class="fs-6 fw-bold mb-3">Observações Pós-Manutenção</legend>
                <textarea class="form-control enhanced-input" id="observacoesPos" name="observacoesPos" rows="3" maxlength="500"></textarea>
                 <div class="invalid-feedback">Máximo de 500 caracteres.</div>
              </fieldset>

              <div class="text-end mt-4">
                <button type="button" class="btn btn-outline-secondary me-2" id="btnVoltarPre"><i class="bi bi-arrow-left me-1"></i> Voltar para PRÉ</button>
                <button type="submit" class="btn btn-success"> <i class="bi bi-check-lg me-1"></i> Finalizar e Salvar Registro</button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <section id="telaVisualizacao" class="tela-sistema" style="display: none;">
         <div class="card shadow-sm mb-4">
             <div class="card-header bg-light d-flex justify-content-between align-items-center flex-wrap gap-2">
                 <h2 class="h5 mb-0"><i class="bi bi-eye me-2"></i> Visualização do Registro</h2>
                 <div class="d-flex align-items-center">
                     <span id="registroIdVisualizar" class="badge bg-secondary me-3 fs-6">ID: --</span>
                     <button class="btn btn-sm btn-outline-secondary me-2" id="btnVoltarLista" title="Voltar para a Lista">
                         <i class="bi bi-arrow-left"></i> <span class="d-none d-md-inline">Voltar</span>
                     </button>
                     <button class="btn btn-sm btn-warning" id="btnEditarVisualizacao" title="Editar este Registro">
                         <i class="bi bi-pencil"></i> <span class="d-none d-md-inline">Editar</span>
                     </button>
                     </div>
             </div>
             <div class="card-body">
                 <fieldset class="mb-4 p-3 border rounded">
                     <legend class="fs-6 fw-bold mb-3">Informações Gerais</legend>
                     <div class="row g-3">
                         <div class="col-md-4 col-sm-6"><strong>Placa:</strong> <span id="placaView">--</span></div>
                         <div class="col-md-4 col-sm-6"><strong>Modelo:</strong> <span id="modeloView">--</span></div>
                         <div class="col-md-4 col-sm-6"><strong>ID Interna:</strong> <span id="idInternaView">--</span></div>
                         <div class="col-md-4 col-sm-6"><strong>Data Criação:</strong> <span id="dataView">--</span></div>
                         <div class="col-md-4 col-sm-6"><strong>Responsável:</strong> <span id="responsavelView">--</span></div>
                         <div class="col-md-4 col-sm-6"><strong>Status:</strong> <span id="statusView" class="badge">--</span></div>
                         <div class="col-md-4 col-sm-6"><strong>Quilometragem:</strong> <span id="quilometragemView">--</span></div>
                         <div class="col-md-4 col-sm-6"><strong>Categoria:</strong> <span id="categoriaView">--</span></div>
                         <div class="col-md-4 col-sm-6"><strong>Urgência:</strong> <span id="urgenciaView">--</span></div>
                         <div class="col-12"><strong>Descrição do Problema:</strong> <p id="descricaoProblemaView" class="bg-light p-2 rounded mb-0 text-break">--</p></div>
                     </div>
                 </fieldset>

                 <div class="row g-3">
                     <div class="col-lg-6">
                         <div class="card h-100">
                             <div class="card-header bg-primary text-white">
                                 <h6 class="mb-0"><i class="bi bi-clipboard-plus me-1"></i> Detalhes PRÉ-Manutenção</h6>
                             </div>
                             <div class="card-body">
                                 <h6 class="mb-2 fw-bold">Checklist PRÉ:</h6>
                                 <div class="table-responsive mb-3">
                                     <table class="table table-sm table-bordered mb-0">
                                         <tbody id="checklistPreView">
                                             <tr><td class="text-muted small fst-italic">Carregando...</td></tr>
                                         </tbody>
                                     </table>
                                 </div>
                                 <h6 class="mb-2 fw-bold">Fotos PRÉ:</h6>
                                 <div id="fotosPreView" class="row g-2 mb-3">
                                      <p class="text-muted small fst-italic col-12">Carregando...</p>
                                 </div>
                                 <h6 class="mb-1 fw-bold">Observações PRÉ:</h6>
                                 <p id="observacoesPreView" class="text-muted bg-light p-2 rounded text-break mb-0">--</p>
                             </div>
                         </div>
                     </div>
                     <div class="col-lg-6">
                         <div class="card h-100">
                             <div class="card-header bg-success text-white">
                                 <h6 class="mb-0"><i class="bi bi-check2-circle me-1"></i> Detalhes PÓS-Manutenção</h6>
                             </div>
                             <div class="card-body">
                                 <h6 class="mb-2 fw-bold">Checklist PÓS:</h6>
                                  <div class="table-responsive mb-3">
                                     <table class="table table-sm table-bordered mb-0">
                                         <tbody id="checklistPosView">
                                             <tr><td class="text-muted small fst-italic">Carregando...</td></tr>
                                         </tbody>
                                     </table>
                                 </div>
                                 <h6 class="mb-2 fw-bold">Fotos PÓS:</h6>
                                 <div id="fotosPosView" class="row g-2 mb-3">
                                      <p class="text-muted small fst-italic col-12">Carregando...</p>
                                 </div>
                                 <h6 class="mb-1 fw-bold">Observações PÓS:</h6>
                                 <p id="observacoesPosView" class="text-muted bg-light p-2 rounded text-break mb-0">--</p>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
         </div>
     </section>
    </main>

    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
       </div>

    <div id="loadingSpinner" class="position-fixed top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center bg-dark bg-opacity-75 hidden-spinner" style="display: none !important; z-index: 9999; backdrop-filter: blur(2px);">
      <div class="spinner-border text-primary mb-2" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <p class="text-white loading-message mb-0">Carregando...</p>
    </div>

    <!-- Script inline para garantir que o spinner seja ocultado -->
    <script>
      (function() {
        document.getElementById('loadingSpinner').style.display = 'none';
        setTimeout(function() {
          var spinner = document.getElementById('loadingSpinner');
          if (spinner) {
            spinner.style.display = 'none';
            spinner.setAttribute('style', 'display: none !important');
          }
        }, 500);
      })();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/config.js"></script>
    <script src="js/utils-novo.js"></script>
    <!-- <script src="js/utils.js"></script> --> <!-- Comente a linha original -->
    

    <script src="js/core/module-loader.js"></script>

    <script src="js/core/state.js"></script>
    <script src="js/core/cache-manager.js"></script>
    <script src="js/core/security.js"></script>
    <script src="js/core/performance-monitor.js"></script>

    <script src="js/api-client.js"></script> <script src="js/ui/theme-manager.js"></script> <script src="js/features/notifications.js"></script> <script src="js/auth/google-auth.js"></script> <script src="js/photo-handler.js"></script> <script src="js/form-handler.js"></script> <script src="js/features/dashboard.js"></script> <script src="js/main.js"></script>

    <script src="js/app.js"></script>
    
    <!-- Script de correção para problemas de loading -->
    <script>
    /**
     * Solução para resolver o problema do loading infinito
     */
    (function() {
      // Executar imediatamente após carregar
      function hideLoadingSpinner() {
        const spinner = document.getElementById('loadingSpinner');
        if (spinner) {
          // Tentar todas as abordagens possíveis para ocultar/remover o spinner
          spinner.style.display = 'none';
          spinner.style.opacity = '0';
          spinner.style.visibility = 'hidden';
          spinner.classList.add('hidden-spinner');
          
          // Registrar que o spinner foi ocultado
          console.log('Spinner ocultado forçadamente');
          
          // Remover completamente depois de um pequeno atraso
          setTimeout(() => {
            if (spinner.parentNode) {
              spinner.parentNode.removeChild(spinner);
              console.log('Spinner removido completamente do DOM');
            }
          }, 500);
        }
      }
      
      // Tentar ocultar imediatamente
      hideLoadingSpinner();
      
      // Tentar novamente após um curto atraso
      setTimeout(hideLoadingSpinner, 1000);
      
      // E mais uma vez após carregamento completo
      window.addEventListener('load', hideLoadingSpinner);
      
      // Redefinir a função hideLoading global para ter certeza
      if (window.Utils) {
        const originalHideLoading = window.Utils.hideLoading;
        window.Utils.hideLoading = function() {
          // Chamar a implementação original
          if (typeof originalHideLoading === 'function') {
            originalHideLoading.call(window.Utils);
          }
          
          // E então forçar a remoção completa
          const spinner = document.getElementById('loadingSpinner');
          if (spinner) {
            spinner.style.display = 'none';
            spinner.style.opacity = '0';
            spinner.style.visibility = 'hidden';
            
            // Remover completamente após um pequeno atraso
            setTimeout(() => {
              if (spinner && spinner.parentNode) {
                spinner.parentNode.removeChild(spinner);
                console.log('Spinner removido completamente do DOM');
              }
            }, 100);
          }
        };
        console.log('Utils.hideLoading substituído com versão mais robusta');
      }
      
      // Adicionar evento ao documento para garantir que o spinner seja removido quando o usuário interage
      document.addEventListener('click', hideLoadingSpinner);
    })();
    </script>
    </div> 
</body>
</html>
