<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Manutenção de Equipamentos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --info-color: #0dcaf0;
        }

        body {
            background-color: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 40px; /* Espaço para o rodapé */
        }

        .navbar {
            background-color: var(--primary-color);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.4rem;
            color: white !important;
        }

        .card {
            border-radius: 8px;
            border: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
        }

        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
            padding: 15px 20px;
            font-weight: bold;
            border-radius: 8px 8px 0 0 !important;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }

        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .list-group-item {
            border-left: none;
            border-right: none;
            padding: 15px 20px;
        }

        .status-badge {
            font-size: 0.8em;
            padding: 5px 10px;
            border-radius: 20px;
        }

        .checklist-item {
            margin-bottom: 15px;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
        }

        .checklist-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .image-preview {
            max-width: 100%;
            height: auto;
            object-fit: cover;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .image-container {
            display: inline-block;
            margin: 5px;
            position: relative;
        }

        .image-container img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ddd;
            cursor: pointer; /* Para indicar que é clicável */
        }

        .image-container .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(255, 0, 0, 0.7); /* Vermelho para destaque */
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: none;
            padding: 0;
            font-size: 14px;
            line-height: 1;
        }
        .image-container .delete-btn:hover {
             background-color: rgba(255, 0, 0, 0.9);
        }

        /* Botão de anotação */
        .image-container .btn-annotate {
             position: absolute;
             top: 5px;
             left: 5px; /* Ajustado para esquerda */
             background-color: rgba(0, 123, 255, 0.7); /* Azul */
             color: white;
             border-radius: 50%;
             width: 25px;
             height: 25px;
             display: flex;
             align-items: center;
             justify-content: center;
             cursor: pointer;
             border: none;
             padding: 0;
             font-size: 12px; /* Ícone menor */
             line-height: 1;
        }
        .image-container .btn-annotate:hover {
             background-color: rgba(0, 123, 255, 0.9);
        }


        /* Status colors */
        .status-aguardando {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-em-manutencao {
            background-color: #cce5ff;
            color: #004085;
        }

        .status-concluido {
            background-color: #d4edda;
            color: #155724;
        }

        .status-disponivel {
            background-color: #d1e7dd;
            color: #0f5132;
        }

        /* Dashboard */
        .stat-card {
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            min-height: 120px;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card .stat-title {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 10px;
        }

        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .recent-activity {
            max-height: 400px;
            overflow-y: auto;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }

        /* Mobile Optimization */
        @media (max-width: 768px) {
            .card-body {
                padding: 15px;
            }

            .container {
                padding-left: 10px;
                padding-right: 10px;
            }

            .btn {
                padding: 0.375rem 0.75rem;
            }

            .stat-card {
                padding: 10px;
                min-height: 100px;
            }

            .stat-card .stat-value {
                font-size: 1.5rem;
            }

            .image-container img {
                width: 100px;
                height: 100px;
            }
            .navbar-nav {
                text-align: center; /* Centraliza itens no mobile */
            }
        }

        /* Camera styles */
        .camera-container {
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
        }

        #camera-preview {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .camera-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Anotação */
         #annotation-container {
             overflow: auto; /* Permite scroll se a imagem for grande */
             max-height: 60vh; /* Limita altura no modal */
             text-align: center; /* Centraliza a imagem/canvas */
         }
        #annotation-canvas {
             cursor: crosshair;
        }
        .annotation-controls .btn.active {
             background-color: var(--primary-color);
             color: white;
        }

        /* Footer */
        .footer-dev {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #f8f9fa; /* Cor de fundo suave */
            padding: 5px 0;
            text-align: center;
            font-size: 0.8em;
            color: #6c757d; /* Cinza secundário */
            border-top: 1px solid #dee2e6;
        }

        /* Outros ajustes */
        .checklist-item .btn-group .btn {
             padding: 0.25rem 0.5rem; /* Menor padding nos botões do checklist */
             font-size: 0.8rem; /* Fonte menor */
        }
        .checklist-item .btn-group .btn i {
             margin-right: 3px !important; /* Espaço menor para ícone */
        }

        /* Classe para indicar loading de imagem */
        .image-loading {
            background-color: #f8f9fa; /* Fundo suave */
            border: 1px dashed #ced4da; /* Borda tracejada */
        }

        /* Ajuste de estilo para os previews de imagem */
        .photo-preview-img {
            max-width: 150px; /* Garante tamanho consistente */
            max-height: 150px;
            object-fit: cover;
            margin: 5px; /* Adiciona margem entre as imagens */
        }

    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-tools me-2"></i>Sistema de Manutenção
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" id="nav-dashboard">
                            <i class="bi bi-speedometer2 me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-lista">
                            <i class="bi bi-list-ul me-1"></i>Lista
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-novo">
                            <i class="bi bi-plus-circle me-1"></i>Nova Manutenção
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="nav-ferramentas">
                            <i class="bi bi-tools me-1"></i>Ferramentas
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="conteudo-principal">

            <!-- Tela Dashboard -->
            <div id="tela-dashboard" class="view-content">
                <h2 class="mb-4">Dashboard de Manutenções</h2>

                <div class="row mb-4">
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card bg-light">
                            <div class="stat-title">Equipamentos</div>
                            <div class="stat-value" id="total-equipamentos">0</div>
                            <div>Total cadastrado</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card bg-light">
                            <div class="stat-title">Aguardando</div>
                            <div class="stat-value text-warning" id="total-aguardando">0</div>
                            <div>Manutenções pendentes</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card bg-light">
                            <div class="stat-title">Em Manutenção</div>
                            <div class="stat-value text-primary" id="total-em-manutencao">0</div>
                            <div>Em andamento</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-sm-6">
                        <div class="stat-card bg-light">
                            <div class="stat-title">Concluídas</div>
                            <div class="stat-value text-success" id="total-concluidas">0</div>
                            <div>Finalizadas</div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-wrench me-2"></i>Manutenções Recentes
                            </div>
                            <div class="card-body p-0">
                                <ul class="list-group list-group-flush" id="manutencoes-recentes">
                                    <!-- Itens serão adicionados via JS -->
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-activity me-2"></i>Atividade Recente
                            </div>
                            <div class="card-body p-0 recent-activity">
                                <ul class="list-group list-group-flush" id="atividade-recente">
                                    <!-- Itens serão adicionados via JS -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-bar-chart me-2"></i>Manutenções por Tipo de Equipamento
                            </div>
                            <div class="card-body" id="grafico-tipos" style="min-height: 300px;">
                                <!-- Gráfico será adicionado via JS -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-pie-chart me-2"></i>Manutenções por Categoria
                            </div>
                            <div class="card-body" id="grafico-categorias" style="min-height: 300px;">
                                <!-- Gráfico será adicionado via JS -->
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-clock-history me-2"></i>Tempo Médio de Manutenção
                            </div>
                           <div class="card-body" id="grafico-tempo-medio" style="min-height: 300px;">
                               <!-- Gráfico será adicionado via JS -->
                           </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-4">
                            <div class="card-header">
                                <i class="bi bi-calendar-check me-2"></i>Manutenções por Período
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-end mb-3">
                                    <select id="filtro-periodo-grafico" class="form-select form-select-sm" style="width: auto;">
                                        <option value="7">Últimos 7 dias</option>
                                        <option value="30" selected>Últimos 30 dias</option>
                                        <option value="90">Últimos 90 dias</option>
                                        <option value="365">Último ano</option>
                                    </select>
                                </div>
                                <div id="grafico-periodo" style="min-height: 250px;">
                                    <!-- Gráfico será adicionado via JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-truck me-2"></i>Status dos Equipamentos
                    </div>
                    <div class="card-body">
                        <div class="row" id="status-equipamentos">
                            <!-- Status serão adicionados via JS -->
                        </div>
                    </div>
                </div>

            </div> <!-- Fim tela-dashboard -->

            <!-- Tela Lista -->
            <div id="tela-lista" class="view-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Lista de Manutenções</h2>
                    <button class="btn btn-primary" id="btn-nova-manutencao">
                        <i class="bi bi-plus-circle me-1"></i>Nova Manutenção
                    </button>
                </div>

                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select" id="filtro-status">
                                    <option value="">Todos os Status</option>
                                    <option value="Aguardando Manutenção">Aguardando</option>
                                    <option value="Em Manutenção">Em Manutenção</option>
                                    <option value="Manutenção Concluída">Concluídas</option>
                                    <option value="Equipamento Disponível">Disponíveis</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" id="filtro-placa" placeholder="Filtrar por Placa">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100" id="btn-filtrar">
                                    <i class="bi bi-search me-1"></i>Filtrar
                                </button>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-outline-secondary w-100" id="btn-limpar-filtro">
                                    <i class="bi bi-x-circle me-1"></i>Limpar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Placa</th>
                                        <th>Tipo</th>
                                        <th>Data</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-manutencoes">
                                    <!-- Linhas serão adicionadas via JS -->
                                </tbody>
                            </table>
                        </div>
                        <div id="sem-registros" class="text-center py-4" style="display: none;">
                            <i class="bi bi-exclamation-circle fs-1 text-muted"></i>
                            <p class="mt-2 text-muted">Nenhum registro encontrado</p>
                        </div>
                    </div>
                </div>
            </div> <!-- Fim tela-lista -->

            <!-- Tela Pré-Manutenção -->
            <div id="tela-pre-manutencao" class="view-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Registro de Pré-Manutenção</h2>
                    <button class="btn btn-outline-secondary btn-voltar">
                        <i class="bi bi-arrow-left me-1"></i>Voltar
                    </button>
                </div>

                <form id="form-pre-manutencao">
                    <input type="hidden" id="pre-id" name="id">

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-truck me-2"></i>Informações do Equipamento
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="pre-tipo-equipamento" class="form-label">Tipo de Equipamento*</label>
                                    <select class="form-select" id="pre-tipo-equipamento" name="tipoEquipamento" required>
                                        <option value="">Selecione...</option>
                                        <option value="Caminhão Alta Pressão">Caminhão Alta Pressão</option>
                                        <option value="Caminhão Auto Vácuo">Caminhão Auto Vácuo</option>
                                        <option value="Caminhão Hiper Vácuo">Caminhão Hiper Vácuo</option>
                                        <option value="Caminhão Conjugado">Caminhão Conjugado</option>
                                        <option value="Caminhão Brook">Caminhão Brook</option>
                                        <option value="Aspirador de Pó">Aspirador de Pó</option>
                                        <option value="Outro Tipo">Outro Tipo</option>
                                        <!-- Outras opções podem ser adicionadas dinamicamente -->
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="pre-placa-select" class="form-label">Equipamento/Placa*</label>
                                    <select class="form-select" id="pre-placa-select" style="display: none;">
                                        <option value="">Selecione o Equipamento...</option>
                                        <!-- Opções preenchidas via JS -->
                                    </select>
                                    <input type="text" class="form-control mt-2" id="pre-placa-outro-valor" style="display: none;" placeholder="Digite a placa ou nome do equipamento">
                                    <input type="hidden" id="pre-placa" name="placa" required>
                                    <input type="hidden" id="pre-modelo" name="modelo">
                                </div>
                            </div>
                        </div>
                    </div> <!-- Fim card equipamento -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-exclamation-triangle me-2"></i>Detalhes do Problema
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="pre-categoria-problema" class="form-label">Categoria do Problema*</label>
                                    <select class="form-select" id="pre-categoria-problema" name="categoriaProblema" required>
                                        <option value="">Selecione...</option>
                                        <!-- Opções preenchidas via JS -->
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="pre-urgencia" class="form-label">Urgência*</label>
                                    <select class="form-select" id="pre-urgencia" name="urgencia" required>
                                        <option value="">Selecione...</option>
                                        <!-- Opções preenchidas via JS -->
                                    </select>
                                </div>
                                <div class="col-12" id="motivo-outro-container" style="display: none;">
                                    <label for="pre-motivo-outro" class="form-label">Especifique o Problema*</label>
                                    <input type="text" class="form-control" id="pre-motivo-outro" name="motivoOutro">
                                </div>
                                <div class="col-12">
                                    <label for="pre-descricao-problema" class="form-label">Descrição do Problema*</label>
                                    <textarea class="form-control" id="pre-descricao-problema" name="descricaoProblema" rows="3" required></textarea>
                                </div>
                            </div>
                        </div>
                    </div> <!-- Fim card problema -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-check-square me-2"></i>Checklist Pré-Manutenção
                        </div>
                        <div class="card-body">
                            <div id="pre-checklist-container">
                                <!-- Checklist gerado via JS -->
                            </div>
                            <div class="mb-3">
                                <label for="pre-observacoes" class="form-label">Observações Adicionais</label>
                                <textarea class="form-control" id="pre-observacoes" name="observacoesPre" rows="3"></textarea>
                            </div>
                        </div>
                    </div> <!-- Fim card checklist pre -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-camera me-2"></i>Registro Fotográfico
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="d-flex gap-2 mb-3 flex-wrap">
                                    <button type="button" class="btn btn-primary" id="btn-abrir-camera-pre">
                                        <i class="bi bi-camera-fill me-1"></i>Abrir Câmera
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="btn-selecionar-imagem-pre">
                                        <i class="bi bi-image me-1"></i>Da Galeria
                                    </button>
                                    <input type="file" id="input-imagem-pre" accept="image/*" multiple style="display: none;">
                                </div>

                                <div id="camera-container-pre" class="camera-container" style="display: none;">
                                    <video id="camera-preview-pre" autoplay playsinline></video>
                                    <div class="camera-controls">
                                        <button type="button" class="btn btn-primary" id="btn-capturar-pre">
                                            <i class="bi bi-camera-fill me-1"></i>Capturar
                                        </button>
                                        <button type="button" class="btn btn-danger" id="btn-fechar-camera-pre">
                                            <i class="bi bi-x-circle me-1"></i>Fechar
                                        </button>
                                    </div>
                                </div>

                                <div id="imagens-preview-pre" class="d-flex flex-wrap gap-2 mt-3">
                                    <!-- Imagens serão adicionadas via JS -->
                                </div>
                            </div>
                        </div>
                    </div> <!-- Fim card fotos pre -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-person me-2"></i>Responsável pelo Registro
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="pre-responsavel" class="form-label">Nome do Responsável*</label>
                                <input type="text" class="form-control" id="pre-responsavel" name="responsavel" required>
                            </div>
                        </div>
                    </div> <!-- Fim card responsável -->

                    <div class="d-flex justify-content-between mb-4">
                        <button type="button" class="btn btn-outline-secondary btn-voltar">
                            <i class="bi bi-arrow-left me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-1"></i>Salvar e Avançar
                        </button>
                    </div>
                </form>
            </div> <!-- Fim tela-pre-manutencao -->

            <!-- Tela Pós-Manutenção -->
            <div id="tela-pos-manutencao" class="view-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Registro de Pós-Manutenção</h2>
                    <button class="btn btn-outline-secondary btn-voltar">
                        <i class="bi bi-arrow-left me-1"></i>Voltar
                    </button>
                </div>

                <form id="form-pos-manutencao">
                    <input type="hidden" id="pos-id" name="id">

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-truck me-2"></i>Resumo do Equipamento
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <p class="form-label mb-1">Placa/Equipamento</p>
                                    <p class="form-control-plaintext ps-0" id="pos-placa-display"></p>
                                </div>
                                <div class="col-md-6">
                                    <p class="form-label mb-1">Tipo de Equipamento</p>
                                    <p class="form-control-plaintext ps-0" id="pos-tipo-display"></p>
                                </div>
                            </div>
                        </div>
                    </div> <!-- Fim card resumo -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-check-square me-2"></i>Checklist Pós-Manutenção
                        </div>
                        <div class="card-body">
                            <div id="pos-checklist-container">
                                <!-- Checklist gerado via JS -->
                            </div>
                            <div class="mb-3">
                                <label for="pos-observacoes" class="form-label">Observações da Manutenção</label>
                                <textarea class="form-control" id="pos-observacoes" name="observacoesPos" rows="3"></textarea>
                            </div>
                        </div>
                    </div> <!-- Fim card checklist pos -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-camera me-2"></i>Registro Fotográfico Pós-Manutenção
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <div class="d-flex gap-2 mb-3 flex-wrap">
                                    <button type="button" class="btn btn-primary" id="btn-abrir-camera-pos">
                                        <i class="bi bi-camera-fill me-1"></i>Abrir Câmera
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" id="btn-selecionar-imagem-pos">
                                        <i class="bi bi-image me-1"></i>Da Galeria
                                    </button>
                                    <input type="file" id="input-imagem-pos" accept="image/*" multiple style="display: none;">
                                </div>

                                <div id="camera-container-pos" class="camera-container" style="display: none;">
                                    <video id="camera-preview-pos" autoplay playsinline></video>
                                    <div class="camera-controls">
                                        <button type="button" class="btn btn-primary" id="btn-capturar-pos">
                                            <i class="bi bi-camera-fill me-1"></i>Capturar
                                        </button>
                                        <button type="button" class="btn btn-danger" id="btn-fechar-camera-pos">
                                            <i class="bi bi-x-circle me-1"></i>Fechar
                                        </button>
                                    </div>
                                </div>

                                <div id="imagens-preview-pos" class="d-flex flex-wrap gap-2 mt-3">
                                    <!-- Imagens serão adicionadas via JS -->
                                </div>
                            </div>
                        </div>
                    </div> <!-- Fim card fotos pos -->

                    <div class="d-flex justify-content-between mb-4">
                        <button type="button" class="btn btn-outline-secondary" id="btn-voltar-pre">
                            <i class="bi bi-arrow-left me-1"></i>Voltar para Pré-Manutenção
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-check-circle me-1"></i>Finalizar Manutenção
                        </button>
                    </div>
                </form>
            </div> <!-- Fim tela-pos-manutencao -->

            <!-- Tela Visualização -->
            <div id="tela-visualizacao" class="view-content" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
                    <h2>Detalhes da Manutenção</h2>
                    <div class="btn-group flex-wrap">
                        <button class="btn btn-outline-secondary btn-voltar">
                            <i class="bi bi-arrow-left me-1"></i>Voltar
                        </button>
                        <button class="btn btn-outline-primary" id="btn-editar-manutencao">
                            <i class="bi bi-pencil me-1"></i>Editar
                        </button>
                         <div class="dropdown d-inline-block">
                          <button class="btn btn-outline-primary dropdown-toggle" type="button" id="btnRelatorioOpcoes" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-file-earmark me-1"></i>Relatórios
                          </button>
                          <ul class="dropdown-menu" aria-labelledby="btnRelatorioOpcoes">
                            <li><a class="dropdown-item" href="#" id="btn-gerar-pdf-basico">Relatório PDF Básico</a></li>
                            <li><a class="dropdown-item" href="#" id="btn-gerar-pdf-avancado">Relatório PDF Avançado</a></li>
                            <li><a class="dropdown-item" href="#" id="btn-gerar-excel">Exportar para Excel</a></li>
                            <li><a class="dropdown-item" href="#" id="btn-gerar-csv">Exportar para CSV</a></li>
                          </ul>
                        </div>
                    </div>
                </div>

                <div id="detalhes-manutencao">
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-info-circle me-2"></i>Informações Gerais
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <h6 class="text-muted">ID da Manutenção</h6>
                                    <p id="view-id"></p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <h6 class="text-muted">Data de Abertura</h6>
                                    <p id="view-data-criacao"></p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <h6 class="text-muted">Status</h6>
                                    <p><span class="badge" id="view-status"></span></p>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <h6 class="text-muted">Responsável</h6>
                                    <p id="view-responsavel"></p>
                                </div>
                            </div>
                            <hr>
                             <div class="row">
                                <div class="col-md-6 mb-3">
                                    <h6 class="text-muted">Placa do Equipamento</h6>
                                    <p id="view-placa"></p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <h6 class="text-muted">Tipo de Equipamento</h6>
                                    <p id="view-tipo-equipamento"></p>
                                </div>
                            </div>
                        </div>
                    </div> <!-- Fim card geral -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-exclamation-triangle me-2"></i>Detalhes do Problema
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <h6 class="text-muted">Categoria do Problema</h6>
                                    <p id="view-categoria-problema"></p>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <h6 class="text-muted">Urgência</h6>
                                    <p id="view-urgencia"></p>
                                </div>
                            </div>
                            <div class="row mb-3" id="view-motivo-outro-container" style="display: none;">
                                <div class="col-12">
                                    <h6 class="text-muted">Especificação do Problema</h6>
                                    <p id="view-motivo-outro"></p>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <h6 class="text-muted">Descrição do Problema</h6>
                                    <p id="view-descricao-problema" style="white-space: pre-wrap;"></p>
                                </div>
                            </div>
                        </div>
                    </div> <!-- Fim card problema -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-clipboard-check me-2"></i>Registro Pré-Manutenção
                        </div>
                        <div class="card-body">
                            <h6 class="mb-3">Checklist Pré-Manutenção</h6>
                            <div id="view-checklist-pre" class="mb-4">
                                <!-- Checklist preenchido via JS -->
                            </div>

                            <h6 class="mb-2">Observações</h6>
                            <p id="view-observacoes-pre" class="mb-4" style="white-space: pre-wrap;"></p>
                            <h6 class="mb-2">Imagens</h6>
                            <div id="view-imagens-pre" class="d-flex flex-wrap gap-2">
                                <!-- Imagens preenchidas via JS -->
                            </div>
                        </div>
                    </div> <!-- Fim card pre -->

                    <div class="card mb-4" id="view-section-pos-manutencao" style="display: none;">
                        <div class="card-header">
                            <i class="bi bi-clipboard-check me-2"></i>Registro Pós-Manutenção
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <h6 class="mb-2">Data da Manutenção</h6>
                                    <p id="view-data-manutencao"></p>
                                </div>
                            </div>

                            <h6 class="mb-3">Checklist Pós-Manutenção</h6>
                            <div id="view-checklist-pos" class="mb-4">
                                <!-- Checklist preenchido via JS -->
                            </div>

                            <h6 class="mb-2">Observações</h6>
                            <p id="view-observacoes-pos" class="mb-4" style="white-space: pre-wrap;"></p>
                            <h6 class="mb-2">Imagens</h6>
                            <div id="view-imagens-pos" class="d-flex flex-wrap gap-2">
                                <!-- Imagens preenchidas via JS -->
                            </div>
                        </div>
                    </div> <!-- Fim card pos -->

                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="bi bi-arrow-repeat me-2"></i>Atualizar Status
                        </div>
                        <div class="card-body">
                            <div class="d-flex gap-2 flex-wrap">
                                <button class="btn btn-outline-warning btn-status" data-status="Aguardando Manutenção">
                                    <i class="bi bi-hourglass me-1"></i>Aguardando
                                </button>
                                <button class="btn btn-outline-primary btn-status" data-status="Em Manutenção">
                                    <i class="bi bi-tools me-1"></i>Em Manutenção
                                </button>
                                <button class="btn btn-outline-success btn-status" data-status="Manutenção Concluída">
                                    <i class="bi bi-check-circle me-1"></i>Concluído
                                </button>
                                <button class="btn btn-outline-info btn-status" data-status="Equipamento Disponível">
                                    <i class="bi bi-check-all me-1"></i>Disponível
                                </button>
                            </div>
                        </div>
                    </div> <!-- Fim card status -->
                </div> <!-- Fim #detalhes-manutencao -->
            </div> <!-- Fim tela-visualizacao -->

            <!-- Tela Ferramentas -->
            <div id="tela-ferramentas" class="view-content" style="display: none;">
                <h2 class="mb-4">Ferramentas e Integrações</h2>

                <div class="row">
                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="bi bi-table me-2"></i>Integração com Planilha de Turnos
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    Transfira automaticamente os dados de equipamentos em manutenção para a planilha de turnos.
                                </p>
                                <div class="mb-3">
                                    <label for="id-planilha-turnos" class="form-label">ID da Planilha de Turnos</label>
                                    <input type="text" class="form-control" id="id-planilha-turnos" placeholder="Cole o ID da planilha aqui">
                                    <div class="form-text">
                                        Para encontrar o ID, abra a planilha de turnos e copie o código da URL entre /d/ e /edit
                                    </div>
                                </div>
                                 <div class="d-grid">
                                    <button class="btn btn-primary" id="btn-executar-integracao">
                                        <i class="bi bi-arrow-repeat me-1"></i>Executar Integração Agora
                                    </button>
                                </div>
                                <div class="mt-3 small">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="integracao-automatica" checked>
                                        <label class="form-check-label" for="integracao-automatica">
                                            Ativar integração automática diária
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer text-muted small">
                                A integração automática (se ativada) transfere dados todos os dias às 6h.
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                <i class="bi bi-envelope me-2"></i>Notificações por E-mail
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    Configure e-mails para receber atualizações e alertas sobre manutenções.
                                </p>
                                <div class="mb-3">
                                    <label for="emails-notificacao" class="form-label">E-mails para Notificação</label>
                                    <textarea class="form-control" id="emails-notificacao" rows="3" placeholder="exemplo@empresa.com, gerente@empresa.com"></textarea>
                                    <div class="form-text">
                                        Separe múltiplos e-mails por vírgula ou ponto-e-vírgula
                                    </div>
                                </div>
                                 <div class="d-grid">
                                    <button class="btn btn-primary" id="btn-salvar-emails">
                                        <i class="bi bi-save me-1"></i>Salvar Configuração de E-mails
                                    </button>
                                 </div>
                                <div class="mt-3">
                                    <div class="form-text mb-2">
                                        Enviar e-mail de teste para verificar a configuração (usa a primeira manutenção encontrada):
                                     </div>
                                    <div class="input-group">
                                        <select class="form-select" id="tipo-email-teste">
                                            <option value="nova">Nova Manutenção</option>
                                            <option value="atualizacao">Atualização de Status</option>
                                            <option value="conclusao">Conclusão</option>
                                            <option value="alerta">Alerta Urgente</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" id="btn-teste-email">
                                            <i class="bi bi-send me-1"></i>Enviar Teste
                                         </button>
                                    </div>
                                </div>
                            </div>
                             <div class="card-footer text-muted small">
                                Notificações automáticas são enviadas em eventos importantes de manutenção.
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-header">
                                 <i class="bi bi-gear me-2"></i>Configurações do Sistema
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    Configure e atualize parâmetros e tarefas automáticas do sistema.
                                </p>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary" id="btn-configurar-gatilhos">
                                        <i class="bi bi-clock-history me-1"></i>(Re)Configurar Tarefas Automáticas
                                     </button>
                                    <button class="btn btn-outline-primary" id="btn-verificar-atualizacoes">
                                        <i class="bi bi-cloud-download me-1"></i>Verificar Atualizações
                                    </button>
                                 </div>
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">Versão do Sistema:</span>
                                         <span class="badge bg-info" id="versao-sistema"><?= VERSAO_APP ?></span>
                                    </div>
                                    <div class="progress" style="height: 5px;">
                                         <div class="progress-bar" role="progressbar" style="width: 100%;" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer text-muted small">
                                   Mantenha o sistema atualizado e configure as tarefas automáticas.
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!-- Fim tela-ferramentas -->

        </div> <!-- Fim #conteudo-principal -->
    </div> <!-- Fim .container -->

    <!-- Modals -->
    <div class="modal fade" id="cameraModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Capturar Imagem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="camera-container">
                        <video id="camera-modal-preview" autoplay playsinline></video>
                        <canvas id="camera-canvas" style="display: none;"></canvas>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-capturar-modal">
                        <i class="bi bi-camera-fill me-1"></i>Capturar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmação</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="confirm-message">Tem certeza que deseja realizar esta ação?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirm-yes">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alert-title">Aviso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="alert-message" style="white-space: pre-wrap;"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="choiceModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Registro Salvo com Sucesso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>O registro de pré-manutenção foi salvo com sucesso!</p>
                    <p>O que deseja fazer agora?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" id="btn-choice-lista">
                        <i class="bi bi-list-ul me-1"></i>Ir para Lista
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="btn-choice-novo">
                        <i class="bi bi-plus-circle me-1"></i>Novo Registro
                    </button>
                    <button type="button" class="btn btn-primary" id="btn-choice-pos">
                        <i class="bi bi-arrow-right me-1"></i>Continuar para Pós-Manutenção
                    </button>
                </div>
            </div>
        </div>
    </div>

     <div class="modal fade" id="modal-anotacao" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Anotar Imagem</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                 </div>
                <div class="modal-body">
                    <div id="annotation-container">
                         <!-- Conteúdo do anotador será inserido via JS -->
                    </div>
                </div>
                 <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btn-save-annotation">Salvar Anotação</button>
                </div>
             </div>
        </div>
    </div>

    <footer class="footer-dev">
        &lt;/> Desenvolvido por Warlison Abreu
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        /**
         * ImageAnnotator - Ferramenta para anotações em imagens
         * Permite circular e desenhar retângulos em imagens
         */
        class ImageAnnotator {
            constructor(containerId) {
                this.container = document.getElementById(containerId);
                if (!this.container) {
                    console.error(`Container #${containerId} não encontrado`);
                    return;
                }
                this.imageElement = null;
                this.canvas = null;
                this.context = null;
                this.isDrawing = false;
                this.startX = 0;
                this.startY = 0;
                this.currentShape = 'circle'; // circle ou rectangle
                this.history = []; // Para armazenar anotações
                this.contextoTipo = null; // 'pre' ou 'pos'
                this.contextoContainer = null; // Elemento div da imagem
                this.contextoIdOriginal = null; // ID/URL original da imagem

                this.initContainer();
            }

            initContainer() {
                // Limpar container
                this.container.innerHTML = '';
                // Criar estrutura
                this.container.innerHTML = `
                    <div class="annotation-controls text-center mb-2">
                        <div class="btn-group" role="group" aria-label="Ferramentas de Anotação">
                            <button type="button" class="btn btn-sm btn-outline-primary active" id="btn-circle-${this.container.id}">
                                <i class="bi bi-circle"></i> Círculo
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-primary" id="btn-rectangle-${this.container.id}">
                                <i class="bi bi-square"></i> Retângulo
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" id="btn-clear-${this.container.id}">
                                <i class="bi bi-trash"></i> Limpar Última
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-clear-all-${this.container.id}">
                                <i class="bi bi-x-octagon"></i> Limpar Todas
                            </button>
                        </div>
                    </div>
                    <div class="image-container position-relative text-center">
                        <img src="" id="annotation-image-${this.container.id}" style="display: none; max-width: 100%; vertical-align: top;">
                        <canvas id="annotation-canvas-${this.container.id}" style="position: absolute; top: 0; left: 0; max-width: 100%; display: none;"></canvas>
                    </div>
                `;
                // Obter referências
                this.imageElement = document.getElementById(`annotation-image-${this.container.id}`);
                this.canvas = document.getElementById(`annotation-canvas-${this.container.id}`);
                this.context = this.canvas.getContext('2d');

                // Configurar event listeners dos botões
                 document.getElementById(`btn-circle-${this.container.id}`).addEventListener('click', () => this.setShape('circle'));
                 document.getElementById(`btn-rectangle-${this.container.id}`).addEventListener('click', () => this.setShape('rectangle'));
                 document.getElementById(`btn-clear-${this.container.id}`).addEventListener('click', () => this.clearLastAnnotation());
                 document.getElementById(`btn-clear-all-${this.container.id}`).addEventListener('click', () => this.clearAllAnnotations());


                // Listeners de desenho no canvas
                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', (e) => this.stopDrawing(e));
                this.canvas.addEventListener('mouseout', () => { if (this.isDrawing) this.stopDrawing(); }); // Cancela se sair com botão pressionado

                // Versão touch
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    this.startDrawing(this.getTouchPos(e));
                }, { passive: false });
                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    this.draw(this.getTouchPos(e));
                }, { passive: false });
                this.canvas.addEventListener('touchend', (e) => {
                     e.preventDefault();
                     this.stopDrawing(this.getTouchPos(e, true)); // Passa a posição final do toque
                 });
            }

            // Carrega uma imagem para anotação
            loadImage(src) {
                return new Promise((resolve, reject) => {
                    this.imageElement.onload = () => {
                        // Redimensionar canvas para tamanho da imagem
                        this.canvas.width = this.imageElement.naturalWidth; // Usar naturalWidth/Height
                        this.canvas.height = this.imageElement.naturalHeight;

                        // Ajustar estilo do canvas para sobrepor a imagem corretamente
                        // Calcula a posição left para centralizar o canvas se a imagem for menor que o container
                        const containerWidth = this.canvas.parentElement.clientWidth;
                        const imageWidth = this.imageElement.width; // Display width
                        const offsetLeft = (containerWidth > imageWidth) ? (containerWidth - imageWidth) / 2 : 0;

                        this.canvas.style.position = 'absolute';
                        this.canvas.style.top = this.imageElement.offsetTop + 'px';
                        this.canvas.style.left = (this.imageElement.offsetLeft + offsetLeft) + 'px'; // Ajusta left
                        this.canvas.style.width = this.imageElement.width + 'px'; // Match display size
                        this.canvas.style.height = this.imageElement.height + 'px'; // Match display size

                        this.canvas.style.display = 'block';
                        this.imageElement.style.display = 'block';
                        this.history = []; // Limpa histórico ao carregar nova imagem
                        this.redrawAnnotations(); // Redesenha (nenhuma no início)
                        resolve();
                    };
                    this.imageElement.onerror = (err) => {
                        console.error("Erro ao carregar imagem no anotador:", src, err);
                        reject(err);
                    };
                    this.imageElement.src = src;
                });
            }

            // Define a forma de desenho atual
            setShape(shape) {
                this.currentShape = shape;
                // Atualizar UI
                document.getElementById(`btn-circle-${this.container.id}`).classList.toggle('active', shape === 'circle');
                document.getElementById(`btn-rectangle-${this.container.id}`).classList.toggle('active', shape === 'rectangle');
            }

             // Redesenha todas as anotações do histórico
            redrawAnnotations() {
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.context.strokeStyle = 'red';
                this.context.lineWidth = 2;

                this.history.forEach(annotation => {
                    this.context.beginPath();
                    if (annotation.shape === 'circle') {
                        const radius = Math.sqrt(Math.pow(annotation.endX - annotation.startX, 2) + Math.pow(annotation.endY - annotation.startY, 2));
                        this.context.arc(annotation.startX, annotation.startY, radius, 0, Math.PI * 2);
                    } else if (annotation.shape === 'rectangle') {
                        const width = annotation.endX - annotation.startX;
                        const height = annotation.endY - annotation.startY;
                        this.context.rect(annotation.startX, annotation.startY, width, height);
                    }
                    this.context.stroke();
                });
            }

            // Limpa a última anotação
             clearLastAnnotation() {
                 if (this.history.length > 0) {
                     this.history.pop(); // Remove a última do histórico
                     this.redrawAnnotations(); // Redesenha sem a última
                 }
             }

            // Limpa todas as anotações
            clearAllAnnotations() {
                this.history = []; // Limpa histórico
                this.redrawAnnotations(); // Redesenha (canvas vazio)
            }


            // Inicia o desenho
            startDrawing(e) {
                 if (!e) return; // Safety check for touch events ending outside
                this.isDrawing = true;
                // Obter coordenadas relativas ao canvas
                const rect = this.canvas.getBoundingClientRect();
                const scaleX = this.canvas.width / rect.width; // Fator de escala X
                const scaleY = this.canvas.height / rect.height; // Fator de escala Y
                this.startX = (e.clientX - rect.left) * scaleX;
                this.startY = (e.clientY - rect.top) * scaleY;
            }

            // Desenha enquanto o mouse/touch se move
            draw(e) {
                 if (!this.isDrawing || !e) return;
                // Limpar canvas e redesenhar histórico antes de desenhar a forma atual
                this.redrawAnnotations();

                // Obter coordenadas atuais relativas ao canvas
                 const rect = this.canvas.getBoundingClientRect();
                 const scaleX = this.canvas.width / rect.width;
                 const scaleY = this.canvas.height / rect.height;
                 const x = (e.clientX - rect.left) * scaleX;
                 const y = (e.clientY - rect.top) * scaleY;


                // Configurar estilo para a forma atual
                this.context.strokeStyle = 'red';
                this.context.lineWidth = 2;

                // Desenhar forma atual (temporária)
                this.context.beginPath();
                if (this.currentShape === 'circle') {
                    const radius = Math.sqrt(Math.pow(x - this.startX, 2) + Math.pow(y - this.startY, 2));
                    this.context.arc(this.startX, this.startY, radius, 0, Math.PI * 2);
                } else if (this.currentShape === 'rectangle') {
                    const width = x - this.startX;
                    const height = y - this.startY;
                    this.context.rect(this.startX, this.startY, width, height);
                }
                 this.context.stroke();
            }

            // Finaliza o desenho e armazena no histórico
            stopDrawing(e) {
                 if (!this.isDrawing) return;
                this.isDrawing = false;

                 // Obter coordenadas finais relativas ao canvas
                 let endX = this.startX; // Default se não houver evento final (mouseout)
                 let endY = this.startY;
                 if (e) {
                     const rect = this.canvas.getBoundingClientRect();
                     const scaleX = this.canvas.width / rect.width;
                     const scaleY = this.canvas.height / rect.height;
                     endX = (e.clientX - rect.left) * scaleX;
                     endY = (e.clientY - rect.top) * scaleY;
                 }

                 // Evitar pontos ou formas muito pequenas
                 if (Math.abs(endX - this.startX) < 5 && Math.abs(endY - this.startY) < 5) {
                     this.redrawAnnotations(); // Apenas redesenha o histórico
                     return;
                 }

                 // Adiciona a anotação ao histórico
                 this.history.push({
                     shape: this.currentShape,
                     startX: this.startX,
                     startY: this.startY,
                     endX: endX,
                     endY: endY
                 });

                 // Redesenha todas as anotações do histórico
                 this.redrawAnnotations();
            }

            // Obtém posição do toque
            getTouchPos(touchEvent, isEndEvent = false) {
                 const touches = isEndEvent ? touchEvent.changedTouches : touchEvent.touches;
                 if (!touches || touches.length === 0) return null;
                 const touch = touches[0];
                return {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                };
            }

            // Captura a imagem com anotações
            captureImage() {
                // Criar canvas temporário
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = this.canvas.width; // Usar tamanho original
                tempCanvas.height = this.canvas.height;
                const tempContext = tempCanvas.getContext('2d');
                // Desenhar imagem original
                tempContext.drawImage(this.imageElement, 0, 0, this.canvas.width, this.canvas.height);
                // Desenhar anotações do canvas final (histórico redesenhado)
                tempContext.drawImage(this.canvas, 0, 0);

                // Retornar como data URL JPEG com qualidade
                return tempCanvas.toDataURL('image/jpeg', 0.9); // Qualidade 0.9
            }
        }

        // Inicialização e exportação da função construtora (se necessário globalmente)
        // window.ImageAnnotator = ImageAnnotator; // Descomente se precisar acessar de fora
    </script>

    <script>
        // --- Variáveis Globais ---
        let tiposEquipamentosOptions = [];
        let categoriasProblemas = [];
        let niveisUrgencia = [];
        let checklistItens = [];
        let equipamentos = []; // Lista completa de equipamentos cadastrados
        let manutencoes = []; // Lista de manutenções carregadas
        let manutencaoAtual = null; // Armazena a manutenção sendo visualizada/editada
        let imagenesPreUpload = []; // Armazena { url: '...', id: '...', timestamp: '...', isLocal?: true }
        let imagenesPosUpload = [];
        let mediaStream = null; // Stream da câmera
        let anotadorImagem = null; // Instância do ImageAnnotator
        // let imagemOriginalParaSalvar = null; // Guarda a URL original ao editar - Removido, não necessário com fluxo atual

        // --- Constantes Globais ---
        const STATUS_AGUARDANDO = 'Aguardando Manutenção';
        const STATUS_EM_MANUTENCAO = 'Em Manutenção';
        const STATUS_CONCLUIDO = 'Manutenção Concluída';
        const STATUS_DISPONIVEL = 'Equipamento Disponível';
        const VERSAO_APP = '1.1'; // Definir versão aqui ou buscar de algum lugar


        // Dados dos equipamentos para os selects dinâmicos (Exemplo)
         const equipamentosData = {
            "Caminhão Alta Pressão": [
                'PUB-2G02', 'LUX-3201', 'FLX7617', 'EZS-8765', 'EZS-8764', 'EVK-0291',
                'EOF-5C06', 'EOF-5208', 'EGC-2989', 'EGC-2985', 'EGC-2983', 'EGC-2978',
                'EAM-3262', 'EAM-3256', 'EAM-3255', 'EAM-3253', 'EAM-3010', 'DSY-6475',
                'DSY-6474', 'DSY-6472', 'CZC-0453'
            ],
             "Caminhão Auto Vácuo": [ // Combina Auto e Hiper aqui se a lógica for a mesma
                 'PUB-2F80', 'NFF-0235', 'HJS-1097', 'FSA-3D71', 'EGC-2993', 'EGC-2979',
                 'EAM-3257', 'EAM-3251', 'DYB-7210', 'DSY-6577', 'DSY-6473', 'CUB-0763',
                 'ANF-2676', 'FTW-4D99', 'FTD-6368', 'FMD-2200', 'FHD-9264', 'EZS-9753'
             ],
             "Caminhão Hiper Vácuo": [ // Pode repetir ou ter lista diferente
                 'PUB-2F80', 'NFF-0235', 'HJS-1097', 'FSA-3D71', 'EGC-2993', 'EGC-2979',
                 'EAM-3257', 'EAM-3251', 'DYB-7210', 'DSY-6577', 'DSY-6473', 'CUB-0763',
                 'ANF-2676', 'FTW-4D99', 'FTD-6368', 'FMD-2200', 'FHD-9264', 'EZS-9753'
             ],
             "Caminhão Conjugado": [], // Adicionar placas se houver
             "Caminhão Brook": [], // Adicionar placas se houver
             "Aspirador de Pó": [], // Adicionar nomes/ids se houver
             "Outro Tipo": [] // Para equipamentos não listados
        };
        // Adiciona a opção 'OUTRO EQUIPAMENTO' a todas as listas
         Object.keys(equipamentosData).forEach(tipo => {
             if(Array.isArray(equipamentosData[tipo])) { // Verifica se é um array
                equipamentosData[tipo].push('OUTRO EQUIPAMENTO');
             }
         });


        // --- Elementos da Interface (DOM Cache) ---
        const views = {
            dashboard: document.getElementById('tela-dashboard'),
            lista: document.getElementById('tela-lista'),
            preManu: document.getElementById('tela-pre-manutencao'),
            posManu: document.getElementById('tela-pos-manutencao'),
            visualizacao: document.getElementById('tela-visualizacao'),
            ferramentas: document.getElementById('tela-ferramentas')
        };

        // --- Modals (Bootstrap Instances) ---
        const modals = {
            camera: new bootstrap.Modal(document.getElementById('cameraModal')),
            confirm: new bootstrap.Modal(document.getElementById('confirmModal')),
            alert: new bootstrap.Modal(document.getElementById('alertModal')),
            choice: new bootstrap.Modal(document.getElementById('choiceModal')),
            anotacao: new bootstrap.Modal(document.getElementById('modal-anotacao'))
        };

        // --- Gráficos (Chart.js Instances) ---
        let graficoTipos = null;
        let graficoCategorias = null;
        let graficoTempoMedio = null;
        let graficoPeriodo = null;

        // --- Constante para Versão (se necessário no JS) ---
        const VERSAO_APP_JS = '<?= VERSAO_APP ?>'; // Tenta pegar do backend - Deixado como está

        // --- Funções de Controle de Interface ---

        /**
         * Mostra uma tela específica e esconde as outras. Atualiza a navegação.
         * @param {string} telaId Chave do objeto 'views' (ex: 'dashboard', 'lista')
         */
        function mostrarTela(telaId) {
            const tela = views[telaId];
            if (!tela) {
                console.error("Tela não encontrada:", telaId);
                return;
            }

            // Esconde todas as telas
            Object.values(views).forEach(view => {
                 if (view) view.style.display = 'none';
            });
            // Mostra a tela desejada
            tela.style.display = 'block';

            // Atualizar classe ativa no menu de navegação
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });

            const navLink = document.getElementById(`nav-${telaId}`);
             if (navLink) {
                 navLink.classList.add('active');
             } else if (telaId === 'preManu' || telaId === 'posManu' || telaId === 'visualizacao') {
                 // Se for tela de formulário/visualização, manter 'Lista' ativo no menu
                 const navLista = document.getElementById('nav-lista');
                 if (navLista) navLista.classList.add('active');
             }

            // Ações específicas ao mostrar tela (carregar dados)
            if (telaId === 'dashboard') {
                carregarDashboard();
            } else if (telaId === 'lista') {
                carregarListaManutencoes();
            } else if (telaId === 'ferramentas') {
                carregarDadosFerramentas(); // Carrega dados ao abrir ferramentas
            }
        }

        /**
         * Exibe um modal de alerta customizável.
         * @param {string} mensagem Mensagem a ser exibida.
         * @param {string} [titulo='Aviso'] Título do modal.
         * @param {'info'|'sucesso'|'erro'|'aviso'|'aguarde'} [tipo='info'] Tipo do alerta para estilização.
         */
        function mostrarAlerta(mensagem, titulo = 'Aviso', tipo = 'info') {
             const alertTitle = document.getElementById('alert-title');
             const alertMessage = document.getElementById('alert-message');
             const alertModalHeader = document.querySelector('#alertModal .modal-header');
             const alertModalFooter = document.querySelector('#alertModal .modal-footer');
             const alertOkButton = alertModalFooter.querySelector('button');

             alertTitle.textContent = titulo;
             alertMessage.innerHTML = mensagem.replace(/\n/g, '<br>'); // Permite quebras de linha

             // Remover classes de cor anteriores
             alertModalHeader.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info', 'text-white');
             alertTitle.classList.remove('text-white'); // Garante que o título não fique branco em fundos claros
             alertTitle.innerHTML = titulo; // Resetar HTML do título (remove spinner)

             // Esconder botão OK para 'aguarde'
             alertOkButton.style.display = 'block';


             // Adicionar classe de cor baseada no tipo
             switch (tipo.toLowerCase()) {
                 case 'sucesso':
                     alertModalHeader.classList.add('bg-success', 'text-white');
                     alertTitle.classList.add('text-white');
                     break;
                 case 'erro':
                     alertModalHeader.classList.add('bg-danger', 'text-white');
                      alertTitle.classList.add('text-white');
                     break;
                 case 'aviso':
                     alertModalHeader.classList.add('bg-warning');
                     // Não adiciona text-white para melhor contraste
                     break;
                 case 'aguarde': // Estilo para "Aguarde"
                      alertTitle.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>${titulo}`;
                      alertModalHeader.classList.add('bg-info', 'text-white');
                      alertTitle.classList.add('text-white');
                      alertOkButton.style.display = 'none'; // Esconde o botão OK
                      break;
                 default: // Info ou padrão
                      alertModalHeader.classList.add('bg-info', 'text-white');
                      alertTitle.classList.add('text-white');
             }

             // Garante que o modal não seja fechável no modo 'aguarde'
             const modalInstance = bootstrap.Modal.getInstance(document.getElementById('alertModal')) || modals.alert;
             const modalElement = document.getElementById('alertModal');
             if (tipo === 'aguarde') {
                 modalElement.setAttribute('data-bs-backdrop', 'static'); // Impede fechar clicando fora
                 modalElement.setAttribute('data-bs-keyboard', 'false'); // Impede fechar com ESC
             } else {
                 modalElement.removeAttribute('data-bs-backdrop');
                 modalElement.removeAttribute('data-bs-keyboard');
             }


            modals.alert.show();
        }

        /**
         * Exibe um modal de confirmação com callback para ação.
         * @param {string} mensagem Mensagem da confirmação.
         * @param {function} callback Função a ser executada se o usuário confirmar.
         */
        function mostrarConfirmacao(mensagem, callback) {
            document.getElementById('confirm-message').textContent = mensagem;
             // Remove listener antigo antes de adicionar novo para evitar duplicação
             const confirmBtn = document.getElementById('confirm-yes');
             const newConfirmBtn = confirmBtn.cloneNode(true); // Clona para remover listeners
             confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

             newConfirmBtn.addEventListener('click', () => {
                 modals.confirm.hide();
                 if (typeof callback === 'function') {
                    callback(); // Executa o callback original
                 }
             }, { once: true }); // Adiciona listener uma vez para evitar problemas se o modal for reutilizado rapidamente
            modals.confirm.show();
        }

        // --- Comunicação com Backend (Google Apps Script via Fetch) ---

        /**
         * Função centralizada para fazer requisições ao Google Apps Script Web App.
         * @param {string} action Nome da função a ser chamada no backend (Apps Script).
         * @param {object} [params={}] Parâmetros a serem enviados para a função.
         * @returns {Promise<object>} Promise que resolve com a resposta do backend ou rejeita com erro.
         */
        async function apiRequest(action, params = {}) {
             // !!! SUBSTITUA PELA URL DE IMPLANTAÇÃO DO SEU WEB APP !!!
             const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbykKeYl-qzP35Q3SXN3ytIGri__TAoRqXN1qucLKDAqT9ecJWfE1S0PrdhFMWKYvxb-/exec'; // <<< COLOQUE SUA URL AQUI
             // !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

             if (SCRIPT_URL === '' || !SCRIPT_URL) {
                 console.error("!!!! URGENTE: Defina a URL de implantação do seu Web App na variável SCRIPT_URL no código HTML !!!!");
                 mostrarAlerta("Erro de configuração: A URL do Web App não foi definida no código HTML.", "Erro Crítico", "erro");
                 return Promise.resolve({ success: false, message: "URL do Web App não configurada." }); // Retorna promise resolvida com erro
             }

             // Adiciona a ação aos parâmetros
             params.action = action;

             // Constrói a URL com parâmetros de consulta
             const url = new URL(SCRIPT_URL);
             let containsLargeData = false; // Flag para verificar se há dados grandes (ex: imagem base64)

             Object.keys(params).forEach(key => {
                 const value = params[key];
                 // Trata valores que podem ser objetos/arrays (como 'dados' ou 'destinatarios')
                 if (typeof value === 'object' && value !== null) {
                     const jsonValue = JSON.stringify(value);
                     // Se o valor for muito grande (ex: base64), marcamos para usar POST
                     if (jsonValue.length > 1500) { // Limite aproximado para URL GET
                         containsLargeData = true;
                     }
                     url.searchParams.append(key, jsonValue);
                 } else if (value !== undefined && value !== null) {
                     // Se o valor for muito grande, marcamos para usar POST
                     if (String(value).length > 1500) {
                         containsLargeData = true;
                     }
                    url.searchParams.append(key, value);
                 }
             });

             // Define o método e o corpo da requisição
             const method = containsLargeData ? 'POST' : 'GET';
             let body = null;
             let requestUrl = SCRIPT_URL; // URL base para POST

             if (method === 'POST') {
                 // Para POST, enviamos os dados no corpo como JSON
                 body = JSON.stringify(params);
             } else {
                 // Para GET, usamos a URL com parâmetros
                 requestUrl = url.toString();
             }

             const fetchOptions = {
                 method: method,
                 // mode: 'cors', // Geralmente não necessário para Apps Script Web App se chamado do mesmo domínio ou configurado corretamente
                 headers: {},
             };

             if (method === 'POST') {
                 fetchOptions.headers['Content-Type'] = 'application/json';
                 fetchOptions.body = body;
                 // Para evitar redirecionamento que causa erro CORS em POST para Apps Script
                 // Isso instrui o Apps Script a retornar a resposta diretamente
                 fetchOptions.redirect = 'follow';
                 fetchOptions.muteHttpExceptions = true; // Para GAS, ajuda a obter o erro real
             }


             try {
                 const response = await fetch(requestUrl, fetchOptions);

                 // Tenta obter o corpo da resposta independentemente do status
                 let responseBodyText = '';
                 try {
                      responseBodyText = await response.text();
                 } catch (textError) {
                      console.warn("Não foi possível ler o corpo da resposta:", textError);
                 }

                 if (!response.ok) {
                     let errorText = `Erro HTTP ${response.status}: ${response.statusText}`;
                     // Tenta extrair mensagem de erro do corpo (se for JSON ou texto curto)
                     try {
                         const errorJson = JSON.parse(responseBodyText);
                         if (errorJson && errorJson.message) {
                             errorText = errorJson.message;
                         } else if (responseBodyText && responseBodyText.length < 300) {
                             // Se não for JSON mas for curto, pode ser uma mensagem de erro útil
                             errorText += ` - ${responseBodyText}`;
                         }
                     } catch (parseError) {
                          // Se não for JSON e for longo, usa o statusText padrão
                          if (responseBodyText && responseBodyText.length < 300) {
                              errorText += ` - ${responseBodyText}`;
                          }
                     }
                     console.error('Erro na API:', action, params, 'Status:', response.status, 'Resposta:', responseBodyText);
                     throw new Error(errorText);
                 }

                 // Tenta parsear a resposta como JSON
                 try {
                    const result = JSON.parse(responseBodyText);
                    return result;
                 } catch (jsonError) {
                     console.error('Erro ao parsear resposta JSON:', responseBodyText, jsonError);
                     throw new Error('Resposta inválida do servidor (não JSON).');
                 }

             } catch (error) {
                 console.error(`Erro na requisição ${method} para`, action, ':', error);
                 mostrarAlerta(`Erro de comunicação (${action}): ${error.message}`, 'Erro de Rede', 'erro');
                 // Retorna um objeto de erro padronizado para consistência
                 return { success: false, message: `Erro de comunicação: ${error.message}` };
             }
        }


        // --- Funções de Carregamento e Preparação ---

        /**
         * Carrega dados iniciais essenciais (configurações, equipamentos) ao iniciar.
         */
        async function carregarDadosIniciais() {
            mostrarAlerta('Carregando dados iniciais...', 'Aguarde', 'aguarde');
            try {
                // Carregar configurações primeiro (tipos, categorias, urgência, checklist)
                const resConfig = await apiRequest('obterTiposEquipamentos'); // <--- Mude aqui
                
                if (resConfig.success) {
                    tiposEquipamentosOptions = resConfig.tiposEquipamentos || [];
                    categoriasProblemas = resConfig.categoriasProblemas || [];
                    niveisUrgencia = resConfig.niveisUrgencia || [];
                    checklistItens = resConfig.checklistItens || [];

                    // Preencher selects fixos
                    preencherSelect('pre-tipo-equipamento', tiposEquipamentosOptions); // Preenche tipos principais
                    preencherSelect('pre-categoria-problema', categoriasProblemas);
                    preencherSelect('pre-urgencia', niveisUrgencia);

                    // Criar estruturas de checklist
                    criarChecklist('pre-checklist-container', 'pre', checklistItens);
                    criarChecklist('pos-checklist-container', 'pos', checklistItens);
                } else {
                     mostrarAlerta('Falha ao carregar configurações básicas do sistema. Verifique a conexão ou contate o suporte.', 'Erro Crítico', 'erro');
                     // Poderia desabilitar partes da interface aqui
                     return; // Impede a continuação se configs falharem
                }

                 // Carregar lista de equipamentos cadastrados (se houver)
                 // Idealmente, isso viria da API também, mas usamos o objeto local 'equipamentosData' como fallback/exemplo
                 // const resEquip = await apiRequest('obterEquipamentos');
                 // if (resEquip.success) {
                 //     equipamentos = resEquip.equipamentos || [];
                 //     // Aqui você poderia atualizar equipamentosData se viesse da API
                 // } else {
                 //      console.warn('Falha ao carregar lista de equipamentos da API, usando dados locais.');
                 //      // Usar equipamentosData como padrão
                 // }
                 // A função configurarSelectsEquipamentos agora só adiciona listeners
                 configurarSelectsEquipamentos();


                // Iniciar na tela de dashboard após carregar tudo
                modals.alert.hide(); // Esconde o "Aguarde"
                mostrarTela('dashboard');

            } catch (error) {
                modals.alert.hide(); // Esconde o "Aguarde" mesmo em erro
                console.error("Erro crítico ao carregar dados iniciais:", error);
                mostrarAlerta(`Erro crítico ao carregar dados: ${error.message}. A aplicação pode não funcionar corretamente.`, 'Erro Fatal', 'erro');
            }
        }

        /**
         * Preenche um elemento <select> com opções.
         * @param {string} elementId ID do select.
         * @param {Array<string|{value: string, text: string}>} options Array de opções.
         * @param {boolean} [addEmptyOption=true] Adiciona uma opção vazia inicial ("Selecione...").
         */
        function preencherSelect(elementId, options, addEmptyOption = true) {
            const select = document.getElementById(elementId);
            if (!select) {
                console.warn("Elemento select não encontrado:", elementId);
                return;
            }
            select.innerHTML = ''; // Limpa opções existentes

            if (addEmptyOption) {
                 const emptyOpt = document.createElement('option');
                 emptyOpt.value = "";
                 emptyOpt.textContent = "Selecione...";
                 select.appendChild(emptyOpt);
            }

            if (!Array.isArray(options)) {
                console.warn("Opções inválidas para preencher select:", elementId, options);
                return;
            }

            options.forEach(option => {
                const optElement = document.createElement('option');
                 if (typeof option === 'object' && option !== null && option.value !== undefined) {
                     optElement.value = option.value;
                     optElement.textContent = option.text || option.value;
                 } else { // Assume que é string
                     optElement.value = String(option); // Garante que é string
                     optElement.textContent = String(option);
                 }
                select.appendChild(optElement);
            });
        }

        /**
         * Cria a estrutura HTML do checklist em um container.
         * @param {string} containerId ID do container do checklist.
         * @param {'pre'|'pos'} prefix Prefixo para nomes e IDs dos inputs ('pre' ou 'pos').
         * @param {Array<string>} itens Lista dos itens do checklist.
         */
        function criarChecklist(containerId, prefix, itens) {
            const container = document.getElementById(containerId);
             if (!container) {
                 console.error("Container do checklist não encontrado:", containerId);
                 return;
             }
             if (!Array.isArray(itens)) {
                 console.error("Itens do checklist inválidos:", itens);
                 return;
             }

            container.innerHTML = ''; // Limpa container

            itens.forEach((item, index) => {
                 if (!item || typeof item !== 'string') return; // Pular itens inválidos

                const itemDiv = document.createElement('div');
                itemDiv.className = 'checklist-item mb-3 p-3 border rounded bg-light'; // Melhor espaçamento e visual

                const title = document.createElement('div');
                title.className = 'checklist-title mb-2';
                title.textContent = item;

                const radioGroup = document.createElement('div');
                radioGroup.className = 'btn-group w-100'; // Ocupa largura total para melhor toque
                radioGroup.setAttribute('role', 'group');
                 radioGroup.setAttribute('aria-label', `Status para ${item}`);

                const options = [
                    { value: 'OK', label: 'OK', icon: 'bi-check-circle-fill', className: 'btn-outline-success' },
                    { value: 'Danificado', label: 'Danificado', icon: 'bi-exclamation-triangle-fill', className: 'btn-outline-danger' },
                    { value: 'N/A', label: 'N/A', icon: 'bi-slash-circle-fill', className: 'btn-outline-secondary' } // Ícone melhor para N/A
                ];

                options.forEach(option => {
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.className = 'btn-check';
                    input.name = `${prefix}-checklist-${index}`; // Nome comum para o grupo
                    input.id = `${prefix}-checklist-${index}-${option.value.toLowerCase().replace(/[^a-z0-9]/gi, '')}`; // ID único e seguro
                    input.value = option.value;
                    input.dataset.item = item; // Guarda o nome exato do item
                     input.autocomplete = 'off';

                    const label = document.createElement('label');
                    // Usa classes Bootstrap para botão, ajusta padding e largura
                    label.className = `btn ${option.className} flex-fill`; // flex-fill distribui espaço
                    label.setAttribute('for', input.id);

                    const icon = document.createElement('i');
                    icon.className = `bi ${option.icon} me-1`;

                    label.appendChild(icon);
                    label.appendChild(document.createTextNode(` ${option.label}`)); // Espaço antes do texto

                    radioGroup.appendChild(input); // Input primeiro no DOM para btn-check
                    radioGroup.appendChild(label);
                });

                itemDiv.appendChild(title);
                itemDiv.appendChild(radioGroup);
                container.appendChild(itemDiv);
            });
        }

        /**
         * Obtém os dados de um formulário, incluindo checklist e imagens.
         * @param {string} formId ID do formulário ('form-pre-manutencao' ou 'form-pos-manutencao').
         * @returns {object} Objeto com os dados do formulário.
         */
        function obterDadosFormulario(formId) {
            const form = document.getElementById(formId);
             if (!form) {
                 console.error("Formulário não encontrado:", formId);
                 return {};
             }
            const formData = new FormData(form);
            const dados = {};

             // Processa entradas normais e hidden
             for (const [key, value] of formData.entries()) {
                 dados[key] = value.trim(); // Remove espaços extras
             }

            // Processar checklist
            const isPreForm = formId === 'form-pre-manutencao';
            const checklistContainerId = isPreForm ? 'pre-checklist-container' : 'pos-checklist-container';
            const checklistContainer = document.getElementById(checklistContainerId);
            const checklist = {};

            if (checklistContainer) {
                 // Seleciona apenas os radios checados dentro do container específico
                 checklistContainer.querySelectorAll('input[type="radio"]:checked').forEach(radio => {
                     if (radio.dataset.item) {
                         checklist[radio.dataset.item] = radio.value;
                     } else {
                         console.warn("Radio do checklist sem data-item:", radio);
                     }
                 });
            }

             // Adiciona o checklist aos dados principais
             if (isPreForm) {
                 dados.checklistPre = checklist;
             } else {
                 dados.checklistPos = checklist;
             }


             // Adiciona as imagens processadas (apenas url, id, timestamp)
             if (isPreForm) {
                 // Filtra para remover a flag 'isLocal' antes de salvar
                 dados.imagensPre = imagenesPreUpload.map(({ url, id, timestamp }) => ({ url, id, timestamp }));
             } else {
                 dados.imagensPos = imagenesPosUpload.map(({ url, id, timestamp }) => ({ url, id, timestamp }));
             }

            // Tratamento especial para placa/equipamento "Outro"
             const placaSelect = document.getElementById('pre-placa-select');
             if (isPreForm && placaSelect && placaSelect.value === 'OUTRO EQUIPAMENTO') {
                 const outroValorInput = document.getElementById('pre-placa-outro-valor');
                 dados.placa = outroValorInput ? outroValorInput.value.trim() : 'Outro - Não especificado';
                 // O campo 'placa-outro-valor' não é necessário nos dados finais
                 delete dados['placa-outro-valor'];
                 // Garante que modelo esteja vazio ou como 'Outro'
                 dados.modelo = dados.modelo || 'Outro';
             } else if (isPreForm) {
                 // Garante que o campo 'placa' venha do select se não for 'OUTRO'
                 dados.placa = document.getElementById('pre-placa')?.value || '';
                 dados.modelo = document.getElementById('pre-modelo')?.value || '';
             }
             // Remove o campo auxiliar se existir (caso não tenha sido tratado acima)
             delete dados['placa-outro-valor'];


             // Garante que campos essenciais existam, mesmo que vazios, para consistência
             dados.id = dados.id || '';
             dados.tipoEquipamento = dados.tipoEquipamento || '';
             dados.placa = dados.placa || '';
             dados.modelo = dados.modelo || '';
             dados.categoriaProblema = dados.categoriaProblema || '';
             dados.urgencia = dados.urgencia || '';
             dados.motivoOutro = dados.motivoOutro || '';
             dados.descricaoProblema = dados.descricaoProblema || '';
             dados.responsavel = dados.responsavel || '';
             if (isPreForm) {
                dados.observacoesPre = dados.observacoesPre || '';
             } else {
                dados.observacoesPos = dados.observacoesPos || '';
             }


            // console.log("Dados do formulário obtidos:", formId, dados); // Debug
            return dados;
        }

        /**
         * Configura os listeners para os selects dinâmicos de tipo e placa/equipamento.
         */
        function configurarSelectsEquipamentos() {
            const tipoEquipSelect = document.getElementById('pre-tipo-equipamento');
            const placaSelect = document.getElementById('pre-placa-select');
            const placaOutroInput = document.getElementById('pre-placa-outro-valor');
            const hiddenPlaca = document.getElementById('pre-placa');
            const hiddenModelo = document.getElementById('pre-modelo');

            if (!tipoEquipSelect || !placaSelect || !placaOutroInput || !hiddenPlaca || !hiddenModelo) {
                console.warn("Elementos dos selects dinâmicos não encontrados. Funcionalidade comprometida.");
                return;
            }

            // Listener para mudança no TIPO de equipamento
            tipoEquipSelect.addEventListener('change', function() {
                 const tipoSelecionado = this.value;

                 // Limpa e reseta campos dependentes
                 placaSelect.innerHTML = '<option value="">Selecione o Equipamento...</option>'; // Limpa e adiciona placeholder
                 placaSelect.value = ''; // Garante que "Selecione..." esteja selecionado
                 placaSelect.style.display = 'none';
                 placaSelect.required = false;
                 placaOutroInput.style.display = 'none';
                 placaOutroInput.required = false;
                 placaOutroInput.value = '';
                 hiddenPlaca.value = '';
                 hiddenModelo.value = '';

                 if (tipoSelecionado) {
                     // Busca opções de placa/equipamento para o tipo selecionado (do objeto local)
                     const opcoesPlaca = equipamentosData[tipoSelecionado] || [];

                     if (opcoesPlaca.length > 0) {
                         // Preenche o select de placas
                         opcoesPlaca.forEach(placa => {
                             if (!placa) return; // Pula opções vazias
                             const option = document.createElement('option');
                             option.value = placa;
                             option.textContent = placa;
                             placaSelect.appendChild(option);
                         });
                         placaSelect.style.display = 'block';
                         placaSelect.required = true; // Torna obrigatório selecionar uma placa
                     } else {
                         // Se não há opções pré-definidas (ex: 'Outro Tipo' ou tipo não encontrado), mostra o input de texto
                         placaOutroInput.style.display = 'block';
                         placaOutroInput.required = true; // Torna o input de texto obrigatório
                         placaOutroInput.focus();
                     }
                 }
            });

            // Listener para mudança na PLACA/EQUIPAMENTO selecionado
            placaSelect.addEventListener('change', function() {
                 const placaSelecionada = this.value;
                 hiddenPlaca.value = placaSelecionada; // Atualiza hidden com o valor do select

                 if (placaSelecionada === 'OUTRO EQUIPAMENTO') {
                     placaOutroInput.style.display = 'block';
                     placaOutroInput.required = true;
                     placaOutroInput.value = ''; // Limpa valor anterior
                     placaOutroInput.focus();
                     hiddenPlaca.value = ''; // Limpa hidden temporariamente (será preenchido pelo input)
                     hiddenModelo.value = 'Outro'; // Modelo é Outro
                 } else if (placaSelecionada) {
                     // Se selecionou uma placa específica
                     placaOutroInput.style.display = 'none';
                     placaOutroInput.required = false;
                     placaOutroInput.value = ''; // Limpa input caso estivesse visível
                     // Tenta encontrar o modelo (se equipamentos da API estivessem carregados)
                     // const tipoAtual = tipoEquipSelect.value;
                     // const equipInfo = equipamentos.find(eq => eq.Placa === placaSelecionada && eq.Tipo_Equipamento === tipoAtual);
                     // hiddenModelo.value = equipInfo?.Modelo || ''; // Preenche modelo no hidden
                     hiddenModelo.value = ''; // Por enquanto, deixamos vazio se não for 'Outro'
                 } else {
                     // Se voltou para "Selecione..."
                     placaOutroInput.style.display = 'none';
                     placaOutroInput.required = false;
                     hiddenPlaca.value = '';
                     hiddenModelo.value = '';
                 }
            });

            // Listener para digitação no input de "Outro Equipamento"
            placaOutroInput.addEventListener('input', function() {
                 // Quando o usuário digita em "Outro", atualiza o hidden de placa
                 hiddenPlaca.value = this.value.trim();
                 hiddenModelo.value = 'Outro'; // Modelo é Outro
            });
        }


        // --- Funções do Dashboard ---

        /**
         * Carrega e atualiza os dados da tela de Dashboard.
         */
        async function carregarDashboard() {
            mostrarAlerta('Carregando dashboard...', 'Aguarde', 'aguarde');
             try {
                 const resDashboard = await apiRequest('obterDadosDashboard');
                 modals.alert.hide(); // Esconde o "Aguarde"

                 if (!resDashboard || !resDashboard.success) {
                      mostrarAlerta('Erro ao carregar dados do dashboard: ' + (resDashboard?.message || 'Erro desconhecido'), 'Erro', 'erro');
                     return;
                 }

                 const data = resDashboard.dados || {}; // Assume que os dados estão em 'dados'

                 // --- Atualizar Contadores ---
                 const contadoresStatus = data.contadores?.statusManutencao || {};
                 document.getElementById('total-equipamentos').textContent = data.statusEquipamentos?.total ?? '0';
                 document.getElementById('total-aguardando').textContent = contadoresStatus[STATUS_AGUARDANDO] ?? '0';
                 document.getElementById('total-em-manutencao').textContent = contadoresStatus[STATUS_EM_MANUTENCAO] ?? '0';
                 // Soma Concluído e Disponível para o total finalizado
                 const totalConcluidas = (contadoresStatus[STATUS_CONCLUIDO] ?? 0) + (contadoresStatus[STATUS_DISPONIVEL] ?? 0);
                 document.getElementById('total-concluidas').textContent = totalConcluidas;


                 // --- Manutenções Recentes ---
                 const listaRecentes = document.getElementById('manutencoes-recentes');
                 listaRecentes.innerHTML = ''; // Limpa antes de adicionar

                 if (!data.manutencoesRecentes || data.manutencoesRecentes.length === 0) {
                     listaRecentes.innerHTML = '<li class="list-group-item text-center text-muted">Nenhuma manutenção recente</li>';
                 } else {
                     data.manutencoesRecentes.forEach(manutencao => {
                         const statusClass = getStatusClass(manutencao.status || '');
                         const dataFormatada = formatarData(manutencao.dataCriacao);

                         const item = document.createElement('li');
                         // Adiciona ação para clique
                         item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                         item.style.cursor = 'pointer';
                         item.onclick = () => visualizarManutencao(manutencao.id); // Usa ID para visualizar

                         const divInfo = document.createElement('div');
                         divInfo.innerHTML = `
                             <strong>${manutencao.placa || 'Sem Placa'}</strong> (${manutencao.tipoEquipamento || 'N/A'})
                             <small class="text-muted d-block">Aberto em: ${dataFormatada}</small>
                         `;

                         const badgeStatus = document.createElement('span');
                         badgeStatus.className = `badge ${statusClass} status-badge`; // Usa classe CSS
                         badgeStatus.textContent = manutencao.status || 'N/A';

                         item.appendChild(divInfo);
                         item.appendChild(badgeStatus);
                         listaRecentes.appendChild(item);
                     });
                 }

                 // --- Atividade Recente ---
                 const listaAtividade = document.getElementById('atividade-recente');
                 listaAtividade.innerHTML = '';

                 if (!data.atividadeRecente || data.atividadeRecente.length === 0) {
                     listaAtividade.innerHTML = '<li class="list-group-item text-center text-muted">Nenhuma atividade registrada</li>';
                 } else {
                     data.atividadeRecente.forEach(atividade => {
                         const dataFormatada = formatarDataHora(atividade.data); // Usa hora também
                         const item = document.createElement('li');
                         item.className = 'list-group-item';

                         const row = document.createElement('div');
                         row.className = 'd-flex align-items-start'; // Alinha no topo

                         const avatar = document.createElement('div');
                         avatar.className = 'avatar bg-light text-secondary me-3 flex-shrink-0'; // Evita que avatar encolha
                         // Ícone baseado na ação (exemplo simples)
                         const iconClass = atividade.statusNovo === STATUS_CONCLUIDO || atividade.statusNovo === STATUS_DISPONIVEL ? 'bi-check-lg' : 'bi-pencil-fill';
                         avatar.innerHTML = `<i class="bi ${iconClass}"></i>`;

                         const content = document.createElement('div');
                         content.innerHTML = `
                             <div><strong>${atividade.placa || 'Sem Placa'}</strong>: Status alterado</div>
                             <div><small class="text-muted">${atividade.statusAnterior || 'Novo'} <i class="bi bi-arrow-right-short"></i> ${atividade.statusNovo || 'N/A'}</small></div>
                             <div class="text-muted small mt-1"><i class="bi bi-clock me-1"></i>${dataFormatada}</div>
                         `;

                         row.appendChild(avatar);
                         row.appendChild(content);
                         item.appendChild(row);
                         listaAtividade.appendChild(item);
                     });
                 }

                // --- Carregar Gráficos ---
                // Destroi gráficos antigos antes de criar novos para evitar problemas
                if (graficoTipos) graficoTipos.destroy();
                if (graficoCategorias) graficoCategorias.destroy();
                if (graficoTempoMedio) graficoTempoMedio.destroy();
                if (graficoPeriodo) graficoPeriodo.destroy();

                carregarGraficoTipos(data.contadores?.tipoEquipamento || {});
                carregarGraficoCategorias(data.contadores?.categoriaProblema || {});
                carregarGraficoTempoMedio(data.tempoMedioPorTipo || {}); // Passa dados de tempo médio
                carregarGraficoPeriodo(); // Chama sem argumento para usar filtro padrão

                // --- Status dos Equipamentos (Exemplo) ---
                const statusContainer = document.getElementById('status-equipamentos');
                statusContainer.innerHTML = ''; // Limpa
                const statusEquip = data.statusEquipamentos || {};
                // Exemplo: Criar cards ou lista com status
                const statusMap = {
                    total: { label: 'Total', icon: 'bi-truck', color: 'text-secondary' },
                    disponivel: { label: 'Disponível', icon: 'bi-check-circle-fill', color: 'text-success' },
                    em_manutencao: { label: 'Em Manutenção', icon: 'bi-tools', color: 'text-primary' },
                    aguardando: { label: 'Aguardando', icon: 'bi-hourglass-split', color: 'text-warning' },
                };

                Object.entries(statusMap).forEach(([key, config]) => {
                    const count = statusEquip[key] ?? 0;
                    const col = document.createElement('div');
                    col.className = 'col-md-3 col-6 mb-3'; // Ajuste responsivo
                    col.innerHTML = `
                        <div class="text-center p-3 bg-light rounded shadow-sm h-100">
                             <i class="bi ${config.icon} fs-2 mb-2 ${config.color}"></i>
                            <h5 class="mb-1">${count}</h5>
                            <small class="text-muted">${config.label}</small>
                        </div>
                    `;
                    statusContainer.appendChild(col);
                });


             } catch (error) {
                 modals.alert.hide();
                 console.error('Erro ao carregar dashboard:', error);
                 mostrarAlerta(`Erro ao carregar dashboard: ${error.message}`, 'Erro', 'erro');
             }
        }

        /** Carrega o gráfico de barras para Tipos de Equipamento */
        function carregarGraficoTipos(dados) {
            const container = document.getElementById('grafico-tipos');
            if (!container) return;
            container.innerHTML = '<canvas id="chart-tipos"></canvas>'; // Recria canvas
            const ctx = document.getElementById('chart-tipos')?.getContext('2d');
            if (!ctx || !dados || Object.keys(dados).length === 0) {
                container.innerHTML = '<p class="text-center text-muted mt-3">Sem dados para exibir.</p>';
                return;
            }

            const labels = Object.keys(dados);
            const dataValues = Object.values(dados);

            graficoTipos = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Manutenções por Tipo',
                        data: dataValues,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)', // Azul
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } } // Garante números inteiros no eixo Y
                    },
                    plugins: { legend: { display: false } } // Oculta legenda se houver só 1 dataset
                }
            });
        }

        /** Carrega o gráfico de pizza para Categorias de Problema */
        function carregarGraficoCategorias(dados) {
             const container = document.getElementById('grafico-categorias');
             if (!container) return;
             container.innerHTML = '<canvas id="chart-categorias"></canvas>';
             const ctx = document.getElementById('chart-categorias')?.getContext('2d');
             if (!ctx || !dados || Object.keys(dados).length === 0) {
                 container.innerHTML = '<p class="text-center text-muted mt-3">Sem dados para exibir.</p>';
                 return;
             }

            const labels = Object.keys(dados);
            const dataValues = Object.values(dados);
            // Cores variadas para gráfico de pizza
            const backgroundColors = [
                 'rgba(255, 99, 132, 0.6)', 'rgba(54, 162, 235, 0.6)', 'rgba(255, 206, 86, 0.6)',
                 'rgba(75, 192, 192, 0.6)', 'rgba(153, 102, 255, 0.6)', 'rgba(255, 159, 64, 0.6)',
                 'rgba(201, 203, 207, 0.6)' // Cinza para outros
             ];
             const borderColors = backgroundColors.map(color => color.replace('0.6', '1')); // Cores sólidas para borda

            graficoCategorias = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Manutenções por Categoria',
                        data: dataValues,
                        backgroundColor: backgroundColors.slice(0, labels.length), // Usa apenas cores necessárias
                        borderColor: borderColors.slice(0, labels.length),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }, // Posição da legenda
                        tooltip: {
                            callbacks: { // Formata tooltip para mostrar porcentagem
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed !== null) {
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) + '%' : '0%';
                                        label += context.parsed + ' (' + percentage + ')';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        /** Carrega o gráfico de tempo médio de manutenção por tipo */
        function carregarGraficoTempoMedio(dados) {
             const container = document.getElementById('grafico-tempo-medio');
             if (!container) return;
             container.innerHTML = '<canvas id="chart-tempo-medio"></canvas>';
             const ctx = document.getElementById('chart-tempo-medio')?.getContext('2d');
             if (!ctx || !dados || Object.keys(dados).length === 0) {
                  container.innerHTML = '<p class="text-center text-muted mt-3">Sem dados de tempo médio para exibir.</p>';
                 return;
             }

            const labels = Object.keys(dados);
             // Assume que dados é { "Tipo1": { mediaHoras: X, contagem: Y }, ... }
            const dataValues = labels.map(label => dados[label]?.mediaHoras ?? 0); // Pega a média em horas

            graficoTempoMedio = new Chart(ctx, {
                type: 'bar', // Ou 'line' se preferir
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Tempo Médio (horas)',
                        data: dataValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)', // Laranja
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Horas' } // Título eixo Y
                         }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     let label = context.dataset.label || '';
                                     if (label) { label += ': '; }
                                     if (context.parsed.y !== null) {
                                         // Mostra horas e talvez dias
                                         const horas = context.parsed.y;
                                         const dias = Math.floor(horas / 24);
                                         const horasRestantes = (horas % 24).toFixed(1);
                                         let formatted = `${horas.toFixed(1)}h`;
                                         if (dias > 0) {
                                             formatted += ` (${dias}d ${horasRestantes}h)`;
                                         }
                                         label += formatted;
                                     }
                                     // Adiciona contagem se disponível
                                     const contagem = dados[context.label]?.contagem;
                                     if (contagem) {
                                          label += ` [${contagem} registros]`;
                                     }
                                     return label;
                                 }
                             }
                         }
                    }
                }
            });
        }

        /** Carrega o gráfico de linha de manutenções por período */
        async function carregarGraficoPeriodo() {
            const dias = parseInt(document.getElementById('filtro-periodo-grafico')?.value || '30');
            const container = document.getElementById('grafico-periodo');
            if (!container) return;

            // Mostra um spinner enquanto carrega
            container.innerHTML = '<div class="text-center mt-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Carregando...</span></div></div>';

             try {
                 // Busca dados específicos para este gráfico no backend
                 const res = await apiRequest('obterManutencoesPorPeriodo', { dias: dias });

                 if (!res || !res.success || !res.dados) {
                     throw new Error(res.message || "Erro ao buscar dados do período.");
                 }

                 container.innerHTML = '<canvas id="chart-periodo"></canvas>'; // Recria canvas
                 const ctx = document.getElementById('chart-periodo')?.getContext('2d');
                 if (!ctx) throw new Error("Elemento canvas do gráfico não encontrado.");

                 const dados = res.dados; // Ex: { '2023-10-20': 5, '2023-10-21': 3, ... }

                 // Ordena as datas (chaves)
                 const labels = Object.keys(dados).sort();
                 const dataValues = labels.map(label => dados[label]);


                 if (labels.length === 0) {
                     container.innerHTML = '<p class="text-center text-muted mt-3">Nenhuma manutenção encontrada no período selecionado.</p>';
                     return;
                 }

                 graficoPeriodo = new Chart(ctx, {
                     type: 'line',
                     data: {
                         labels: labels.map(l => formatarData(l)), // Formata data para exibição
                         datasets: [{
                             label: `Manutenções nos Últimos ${dias} Dias`,
                             data: dataValues,
                             fill: true, // Preenche área abaixo da linha
                             borderColor: 'rgb(75, 192, 192)', // Verde azulado
                             backgroundColor: 'rgba(75, 192, 192, 0.2)', // Cor de preenchimento
                             tension: 0.1 // Suaviza a linha
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         scales: {
                             y: { beginAtZero: true, ticks: { stepSize: 1 } }
                         },
                         plugins: {
                            legend: { display: false }
                         }
                     }
                 });

             } catch (error) {
                 console.error("Erro ao carregar gráfico de período:", error);
                 container.innerHTML = `<p class="text-center text-danger mt-3"><i class="bi bi-exclamation-triangle me-1"></i> Erro ao carregar gráfico: ${error.message}</p>`;
             }
        }


        // --- Funções da Lista de Manutenções ---

        /**
         * Carrega e exibe a lista de manutenções, aplicando filtros.
         */
        async function carregarListaManutencoes() {
            const filtroStatus = document.getElementById('filtro-status')?.value || '';
            const filtroPlaca = document.getElementById('filtro-placa')?.value.trim() || '';
            const tbody = document.getElementById('lista-manutencoes');
            const semRegistrosDiv = document.getElementById('sem-registros');

            if (!tbody || !semRegistrosDiv) return;

            // Mostra um indicador de loading na tabela
            tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Carregando...</span></div></td></tr>';
            semRegistrosDiv.style.display = 'none';

             try {
                 const res = await apiRequest('listarManutencoes', {
                     status: filtroStatus,
                     placa: filtroPlaca
                 });

                 if (!res || !res.success) {
                     throw new Error(res.message || 'Erro ao carregar lista');
                 }

                 manutencoes = res.manutencoes || []; // Atualiza a lista global
                 tbody.innerHTML = ''; // Limpa a tabela

                 if (manutencoes.length === 0) {
                     semRegistrosDiv.style.display = 'block'; // Mostra mensagem "sem registros"
                 } else {
                     semRegistrosDiv.style.display = 'none';
                     manutencoes.forEach(manutencao => {
                         const tr = document.createElement('tr');
                         const statusClass = getStatusClass(manutencao.Status || '');
                         const dataFormatada = formatarData(manutencao.Data_Criacao); // Usa a data de criação

                         tr.innerHTML = `
                             <td>${manutencao.Placa || 'N/A'}</td>
                             <td>${manutencao.Tipo_Equipamento || 'N/A'}</td>
                             <td>${dataFormatada}</td>
                             <td><span class="badge ${statusClass} status-badge">${manutencao.Status || 'N/A'}</span></td>
                             <td>
                                 <button class="btn btn-sm btn-outline-primary btn-visualizar" title="Visualizar" data-id="${manutencao.ID}">
                                     <i class="bi bi-eye"></i>
                                 </button>
                                 <button class="btn btn-sm btn-outline-secondary btn-editar" title="Editar" data-id="${manutencao.ID}">
                                     <i class="bi bi-pencil"></i>
                                 </button>
                                 <button class="btn btn-sm btn-outline-danger btn-excluir" title="Excluir" data-id="${manutencao.ID}">
                                     <i class="bi bi-trash"></i>
                                 </button>
                             </td>
                         `;
                         tbody.appendChild(tr);
                     });

                     // Adiciona listeners aos botões de ação após criar a tabela
                     adicionarListenersAcoesLista();
                 }

             } catch (error) {
                 console.error('Erro ao carregar lista de manutenções:', error);
                 tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger py-4">Erro ao carregar dados: ${error.message}</td></tr>`;
                 semRegistrosDiv.style.display = 'none';
             }
        }

        /**
         * Adiciona event listeners aos botões de ação (visualizar, editar, excluir) da lista.
         */
        function adicionarListenersAcoesLista() {
            document.querySelectorAll('.btn-visualizar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.dataset.id;
                    visualizarManutencao(id);
                });
            });

            document.querySelectorAll('.btn-editar').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.dataset.id;
                    editarManutencao(id);
                });
            });

            document.querySelectorAll('.btn-excluir').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.dataset.id;
                    excluirManutencao(id);
                });
            });
        }

        // --- Funções CRUD (Visualizar, Editar, Excluir) ---

        /**
         * Carrega e exibe os detalhes de uma manutenção específica na tela de visualização.
         * @param {string} id ID da manutenção.
         */
        async function visualizarManutencao(id) {
             if (!id) return;
             mostrarAlerta('Carregando detalhes...', 'Aguarde', 'aguarde');

             try {
                 const res = await apiRequest('obterManutencao', { id: id });
                 modals.alert.hide();

                 if (!res || !res.success || !res.manutencao) {
                     throw new Error(res.message || 'Manutenção não encontrada');
                 }

                 manutencaoAtual = res.manutencao; // Armazena na variável global
                 const manut = manutencaoAtual;

                 // --- Preencher Campos Gerais ---
                 document.getElementById('view-id').textContent = manut.ID || 'N/A';
                 document.getElementById('view-data-criacao').textContent = formatarDataHora(manut.Data_Criacao);
                 const statusBadge = document.getElementById('view-status');
                 statusBadge.textContent = manut.Status || 'N/A';
                 statusBadge.className = `badge ${getStatusClass(manut.Status || '')} status-badge`; // Atualiza classe
                 document.getElementById('view-responsavel').textContent = manut.Responsavel || 'N/A';
                 document.getElementById('view-placa').textContent = manut.Placa || 'N/A';
                 document.getElementById('view-tipo-equipamento').textContent = manut.Tipo_Equipamento || 'N/A';

                 // --- Preencher Detalhes do Problema ---
                 document.getElementById('view-categoria-problema').textContent = manut.Categoria_Problema || 'N/A';
                 document.getElementById('view-urgencia').textContent = manut.Urgencia || 'N/A';
                 const motivoOutroContainer = document.getElementById('view-motivo-outro-container');
                 if (manut.Categoria_Problema === 'Outro' && manut.Motivo_Outro) {
                     document.getElementById('view-motivo-outro').textContent = manut.Motivo_Outro;
                     motivoOutroContainer.style.display = 'block';
                 } else {
                     motivoOutroContainer.style.display = 'none';
                 }
                 document.getElementById('view-descricao-problema').textContent = manut.Descricao_Problema || 'Nenhuma descrição fornecida.';

                 // --- Preencher Pré-Manutenção ---
                 const checklistPreContainer = document.getElementById('view-checklist-pre');
                 checklistPreContainer.innerHTML = ''; // Limpa
                 preencherChecklistVisualizacao(checklistPreContainer, manut.Checklist_Pre);
                 document.getElementById('view-observacoes-pre').textContent = manut.Observacoes_Pre || 'Nenhuma observação.';
                 const imagensPreContainer = document.getElementById('view-imagens-pre');
                 imagensPreContainer.innerHTML = ''; // Limpa
                 preencherImagensVisualizacao(imagensPreContainer, manut.Imagens_Pre);

                 // --- Preencher Pós-Manutenção (se houver) ---
                 const posSection = document.getElementById('view-section-pos-manutencao');
                 if (manut.Status === STATUS_CONCLUIDO || manut.Status === STATUS_DISPONIVEL || manut.Data_Manutencao) {
                     document.getElementById('view-data-manutencao').textContent = formatarDataHora(manut.Data_Manutencao) || 'Não registrada';
                     const checklistPosContainer = document.getElementById('view-checklist-pos');
                     checklistPosContainer.innerHTML = ''; // Limpa
                     preencherChecklistVisualizacao(checklistPosContainer, manut.Checklist_Pos);
                     document.getElementById('view-observacoes-pos').textContent = manut.Observacoes_Pos || 'Nenhuma observação.';
                     const imagensPosContainer = document.getElementById('view-imagens-pos');
                     imagensPosContainer.innerHTML = ''; // Limpa
                     preencherImagensVisualizacao(imagensPosContainer, manut.Imagens_Pos);
                     posSection.style.display = 'block';
                 } else {
                     posSection.style.display = 'none'; // Esconde seção Pós se não concluído
                 }

                 // --- Configurar Botões de Status ---
                 document.querySelectorAll('#tela-visualizacao .btn-status').forEach(btn => {
                     // Desabilita o botão correspondente ao status atual
                     btn.disabled = (btn.dataset.status === manut.Status);
                 });

                 mostrarTela('visualizacao'); // Mostra a tela de visualização

             } catch (error) {
                 modals.alert.hide();
                 console.error(`Erro ao visualizar manutenção ${id}:`, error);
                 mostrarAlerta(`Erro ao carregar detalhes: ${error.message}`, 'Erro', 'erro');
                 // Volta para a lista em caso de erro
                 mostrarTela('lista');
             }
        }

        /**
         * Preenche a área de checklist na tela de visualização.
         * @param {HTMLElement} container Elemento onde o checklist será inserido.
         * @param {object} checklistData Objeto com os dados do checklist { Item: Valor }.
         */
        function preencherChecklistVisualizacao(container, checklistData) {
            if (!container) return;
            container.innerHTML = ''; // Limpa

            if (!checklistData || typeof checklistData !== 'object' || Object.keys(checklistData).length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhum item de checklist registrado.</p>';
                return;
            }

            const list = document.createElement('ul');
            list.className = 'list-group list-group-flush'; // Estilo de lista

            Object.entries(checklistData).forEach(([item, valor]) => {
                if (!item) return; // Pula itens sem nome

                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';

                const spanItem = document.createElement('span');
                spanItem.textContent = item;

                const spanValor = document.createElement('span');
                let badgeClass = 'bg-secondary'; // Padrão
                let iconClass = 'bi-question-circle'; // Padrão
                switch (String(valor).toUpperCase()) { // Garante comparação case-insensitive
                    case 'OK':
                        badgeClass = 'bg-success';
                        iconClass = 'bi-check-circle-fill';
                        break;
                    case 'DANIFICADO':
                        badgeClass = 'bg-danger';
                        iconClass = 'bi-exclamation-triangle-fill';
                        break;
                    case 'N/A':
                        badgeClass = 'bg-secondary';
                        iconClass = 'bi-slash-circle-fill';
                        break;
                }
                spanValor.className = `badge ${badgeClass} rounded-pill`;
                spanValor.innerHTML = `<i class="bi ${iconClass} me-1"></i>${valor || 'N/A'}`;

                li.appendChild(spanItem);
                li.appendChild(spanValor);
                list.appendChild(li);
            });
            container.appendChild(list);
        }

        /**
         * Preenche a área de imagens na tela de visualização.
         * @param {HTMLElement} container Elemento onde as imagens serão inseridas.
         * @param {Array<{url: string, id: string, timestamp?: string}>} imagens Array de objetos de imagem.
         */
        function preencherImagensVisualizacao(container, imagens) {
            if (!container) return;
            container.innerHTML = ''; // Limpa

            if (!Array.isArray(imagens) || imagens.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhuma imagem registrada.</p>';
                return;
            }

            imagens.forEach(imgData => {
                if (!imgData || !imgData.url) return; // Pula imagens inválidas

                const imgContainer = document.createElement('div');
                imgContainer.className = 'image-container position-relative d-inline-block me-2 mb-2'; // Estilo para container

                const img = document.createElement('img');
                img.src = imgData.url;
                img.alt = `Imagem ${imgData.id || ''}`;
                img.className = 'img-thumbnail photo-preview-img'; // Reutiliza classe de preview
                img.style.cursor = 'pointer';
                img.loading = 'lazy'; // Carregamento lento para performance
                img.onclick = () => window.open(imgData.url, '_blank'); // Abre em nova aba

                // Opcional: Adicionar timestamp
                if (imgData.timestamp) {
                    const timestampDiv = document.createElement('div');
                    timestampDiv.className = 'small text-muted text-center mt-1';
                    timestampDiv.textContent = formatarDataHora(imgData.timestamp);
                    imgContainer.appendChild(timestampDiv); // Adiciona abaixo da imagem
                }


                imgContainer.insertBefore(img, imgContainer.firstChild); // Adiciona imagem no início
                container.appendChild(imgContainer);
            });
        }

        /**
         * Carrega os dados de uma manutenção no formulário Pré para edição.
         * @param {string} id ID da manutenção.
         */
        async function editarManutencao(id) {
            if (!id) return;
             mostrarAlerta('Carregando dados para edição...', 'Aguarde', 'aguarde');

             try {
                 const res = await apiRequest('obterManutencao', { id: id });
                 modals.alert.hide();

                 if (!res || !res.success || !res.manutencao) {
                     throw new Error(res.message || 'Manutenção não encontrada para edição');
                 }

                 manutencaoAtual = res.manutencao; // Armazena na variável global
                 const manut = manutencaoAtual;

                 // --- Limpar Formulário Pré ANTES de preencher ---
                 document.getElementById('form-pre-manutencao').reset();
                 document.getElementById('motivo-outro-container').style.display = 'none';
                 document.getElementById('imagens-preview-pre').innerHTML = '';
                 imagenesPreUpload = []; // Limpa array global
                 // Resetar selects de placa
                 document.getElementById('pre-placa-select').innerHTML = '<option value="">Selecione o Equipamento...</option>';
                 document.getElementById('pre-placa-select').style.display = 'none';
                 document.getElementById('pre-placa-outro-valor').style.display = 'none';


                 // --- Preencher Formulário Pré com dados da manutenção ---
                 document.getElementById('pre-id').value = manut.ID || '';
                 document.getElementById('pre-tipo-equipamento').value = manut.Tipo_Equipamento || '';

                 // Disparar evento 'change' no tipo para carregar as placas corretas
                 const tipoSelect = document.getElementById('pre-tipo-equipamento');
                 tipoSelect.dispatchEvent(new Event('change')); // Simula a mudança feita pelo usuário

                 // Aguardar um instante para o select de placa ser preenchido (se aplicável)
                 await new Promise(resolve => setTimeout(resolve, 100)); // Pequeno delay

                 // Agora, tenta selecionar a placa ou preencher o 'outro'
                 const placaSelect = document.getElementById('pre-placa-select');
                 const outroInput = document.getElementById('pre-placa-outro-valor');
                 const hiddenPlaca = document.getElementById('pre-placa');
                 const hiddenModelo = document.getElementById('pre-modelo');

                 // Verifica se a placa existe nas opções do select
                 let placaEncontradaNoSelect = false;
                 if (placaSelect) {
                     for (let option of placaSelect.options) {
                         if (option.value === manut.Placa) {
                             placaSelect.value = manut.Placa;
                             placaEncontradaNoSelect = true;
                             break;
                         }
                     }
                 }

                 if (placaEncontradaNoSelect) {
                     // Se encontrou no select, dispara o evento change dele também
                     placaSelect.dispatchEvent(new Event('change'));
                 } else if (manut.Placa) {
                     // Se não encontrou (ou o tipo não tem select), assume que é 'Outro'
                     if (placaSelect) placaSelect.value = 'OUTRO EQUIPAMENTO'; // Marca 'OUTRO' no select se ele existe
                     if(outroInput) {
                         outroInput.value = manut.Placa; // Preenche o input de texto
                         outroInput.style.display = 'block'; // Mostra o input
                         outroInput.required = true;
                         if (placaSelect) placaSelect.dispatchEvent(new Event('change')); // Dispara change para esconder/mostrar corretamente
                     }
                 }
                 // Atualiza os hiddens com os valores carregados
                 hiddenPlaca.value = manut.Placa || '';
                 hiddenModelo.value = manut.Modelo || '';


                 document.getElementById('pre-categoria-problema').value = manut.Categoria_Problema || '';
                 document.getElementById('pre-urgencia').value = manut.Urgencia || '';
                 // Mostrar/preencher 'Outro Motivo' se necessário
                 const motivoOutroInput = document.getElementById('pre-motivo-outro');
                 const motivoOutroContainer = document.getElementById('motivo-outro-container');
                 if (manut.Categoria_Problema === 'Outro') {
                     motivoOutroInput.value = manut.Motivo_Outro || '';
                     motivoOutroContainer.style.display = 'block';
                     motivoOutroInput.required = true;
                 } else {
                      motivoOutroContainer.style.display = 'none';
                      motivoOutroInput.required = false;
                 }
                 document.getElementById('pre-descricao-problema').value = manut.Descricao_Problema || '';
                 document.getElementById('pre-responsavel').value = manut.Responsavel || '';
                 document.getElementById('pre-observacoes').value = manut.Observacoes_Pre || '';

                 // --- Preencher Checklist Pré ---
                 const checklistPreContainer = document.getElementById('pre-checklist-container');
                 checklistPreContainer.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false); // Limpa radios
                 const checklistPreData = manut.Checklist_Pre || {};
                 Object.entries(checklistPreData).forEach(([item, valor]) => {
                     // Tenta encontrar o radio correspondente usando data-item e valor
                     // CSS.escape é importante para nomes de itens com caracteres especiais
                     const radioToCheck = checklistPreContainer.querySelector(`input[type="radio"][data-item="${CSS.escape(item)}"][value="${CSS.escape(valor)}"]`);
                     if (radioToCheck) {
                         radioToCheck.checked = true;
                     } else {
                         console.warn(`Radio não encontrado para checklist pré: Item="${item}", Valor="${valor}"`);
                     }
                 });

                 // --- Preencher Imagens Pré ---
                 const imagensPreContainer = document.getElementById('imagens-preview-pre');
                 imagenesPreUpload = Array.isArray(manut.Imagens_Pre) ? [...manut.Imagens_Pre] : []; // Carrega no array global
                 imagenesPreUpload.forEach(imgData => {
                     if (imgData && imgData.url && imgData.id) {
                         adicionarImagemPreview(imgData.url, 'pre', imgData.id); // Adiciona ao preview
                     }
                 });

                 // --- Mostrar tela Pré ---
                 mostrarTela('preManu');

             } catch (error) {
                 modals.alert.hide();
                 console.error(`Erro ao carregar manutenção ${id} para edição:`, error);
                 mostrarAlerta(`Erro ao carregar dados para edição: ${error.message}`, 'Erro', 'erro');
                 // Volta para a lista em caso de erro
                 mostrarTela('lista');
             }
        }

        /**
         * Exclui uma manutenção após confirmação do usuário.
         * @param {string} id ID da manutenção a ser excluída.
         */
        function excluirManutencao(id) {
            if (!id) return;

             // Encontra os dados da manutenção na lista local para mostrar na confirmação
            const manutencao = manutencoes.find(m => m.ID === id);
            const placa = manutencao?.Placa || `ID ${id}`;

            mostrarConfirmacao(`Tem certeza que deseja excluir permanentemente a manutenção para "${placa}"? Esta ação não pode ser desfeita.`, async () => {
                mostrarAlerta('Excluindo manutenção...', 'Aguarde', 'aguarde');
                try {
                    const res = await apiRequest('excluirManutencao', { id: id });
                    modals.alert.hide();

                    if (!res || !res.success) {
                        throw new Error(res.message || 'Erro desconhecido ao excluir');
                    }

                    mostrarAlerta('Manutenção excluída com sucesso!', 'Sucesso', 'sucesso');
                    // Recarrega a lista para refletir a exclusão
                    carregarListaManutencoes();

                } catch (error) {
                    modals.alert.hide();
                    console.error(`Erro ao excluir manutenção ${id}:`, error);
                    mostrarAlerta(`Erro ao excluir: ${error.message}`, 'Erro', 'erro');
                }
            });
        }


        // --- Funções de Câmera e Upload ---

        /**
         * Abre a câmera do dispositivo para captura.
         * @param {'pre'|'pos'} tipo Indica se é para o formulário pré ou pós.
         */
        async function abrirCamera(tipo) {
            const videoElementId = `camera-preview-${tipo}`;
            const containerId = `camera-container-${tipo}`;
            const video = document.getElementById(videoElementId);
            const container = document.getElementById(containerId);

            if (!video || !container) {
                console.error("Elementos da câmera não encontrados para tipo:", tipo);
                mostrarAlerta('Erro interno: Interface da câmera não encontrada.', 'Erro', 'erro');
                return;
            }

            // Fecha câmera anterior, se estiver aberta
            fecharCamera('pre');
            fecharCamera('pos');

            try {
                // Tenta câmera traseira primeiro, fallback para qualquer câmera
                const constraints = {
                    video: { facingMode: { exact: "environment" } } // Força traseira
                };

                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    try {
                        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch (errEnv) {
                        console.warn("Câmera traseira não encontrada ou erro:", errEnv.name, "Tentando câmera frontal.");
                        // Fallback para câmera frontal (ou qualquer disponível)
                        const fallbackConstraints = { video: true };
                         try {
                             mediaStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                         } catch (errAny) {
                              console.error("Nenhuma câmera acessível:", errAny);
                              throw errAny; // Re-lança o erro para ser pego pelo catch principal
                         }
                    }

                    video.srcObject = mediaStream;
                    video.onloadedmetadata = () => { // Garante que metadados estão carregados
                        video.play();
                        container.style.display = 'block';
                    };
                    video.onerror = (e) => {
                        console.error("Erro no elemento de vídeo:", e);
                        mostrarAlerta("Erro ao exibir o stream da câmera.", "Erro", "erro");
                        fecharCamera(tipo);
                    };

                } else {
                    mostrarAlerta('Seu navegador não suporta acesso à câmera.', 'Erro de Compatibilidade', 'erro');
                }
            } catch (err) {
                console.error('Erro ao abrir câmera:', err);
                let errorMsg = 'Erro desconhecido ao abrir câmera.';
                if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                    errorMsg = 'Permissão para acessar a câmera foi negada. Verifique as configurações do navegador/dispositivo.';
                } else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") {
                    errorMsg = 'Nenhuma câmera compatível foi encontrada no dispositivo.';
                } else if (err.name === "NotReadableError" || err.name === "TrackStartError") {
                    errorMsg = 'Não foi possível acessar a câmera. Pode estar sendo usada por outro aplicativo ou houve um erro de hardware.';
                } else if (err.name === "OverconstrainedError" || err.name === "ConstraintNotSatisfiedError") {
                    errorMsg = 'A câmera traseira não pôde ser utilizada. Tentando outra câmera.'; // Mensagem já tratada no fallback
                } else if (err.name === "AbortError") {
                    errorMsg = 'Acesso à câmera foi abortado.';
                } else if (err.name === "TypeError") {
                     errorMsg = 'Erro de tipo ao acessar a câmera. Verifique se está em um contexto seguro (HTTPS).';
                 }
                mostrarAlerta(errorMsg, 'Erro Câmera', 'erro');
                fecharCamera(tipo); // Garante que a interface da câmera seja fechada
            }
        }

        /**
         * Fecha a stream da câmera e esconde a interface.
         * @param {'pre'|'pos'} tipo Indica qual interface de câmera fechar.
         */
        function fecharCamera(tipo) {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null; // Limpa a stream
            }
            const container = document.getElementById(`camera-container-${tipo}`);
            if (container) container.style.display = 'none';
            const video = document.getElementById(`camera-preview-${tipo}`);
            if(video) {
                video.srcObject = null; // Limpa o source object do vídeo
                video.pause(); // Pausa o vídeo
                video.load(); // Pode ajudar a liberar recursos
            }
        }

        /**
         * Captura um quadro do vídeo da câmera e inicia o upload.
         * @param {'pre'|'pos'} tipo Indica de qual câmera capturar.
         */
        async function capturarImagem(tipo) {
            const video = document.getElementById(`camera-preview-${tipo}`);
            if (!mediaStream || !video || !video.videoWidth || !video.videoHeight || video.readyState < video.HAVE_CURRENT_DATA) {
                 mostrarAlerta("A câmera não está pronta ou não foi iniciada corretamente.", 'Erro Captura', 'erro');
                 fecharCamera(tipo);
                 return;
            }

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');

            try {
                 // Desenha o quadro atual do vídeo no canvas
                 ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                 // Converte para base64 JPEG com qualidade 90%
                 const base64 = canvas.toDataURL('image/jpeg', 0.9);

                 fecharCamera(tipo); // Fecha a interface da câmera após captura

                 // Inicia o upload da imagem capturada
                 await uploadImagem(base64, tipo);

            } catch (e) {
                 console.error('Erro ao capturar ou processar imagem da câmera:', e);
                 mostrarAlerta('Erro ao processar a imagem capturada: ' + e.message, 'Erro', 'erro');
                 fecharCamera(tipo); // Fecha a câmera mesmo em erro
            }
        }

        /**
         * Processa a seleção de arquivos da galeria e inicia o upload.
         * @param {Event} event Evento 'change' do input file.
         * @param {'pre'|'pos'} tipo Tipo de formulário.
         */
        function processarGaleria(event, tipo) {
             const files = event.target.files;
             if (!files || files.length === 0) return;

             // Processa múltiplos arquivos selecionados
             Array.from(files).forEach(file => {
                 // Validação básica
                 if (!file.type.startsWith('image/')) {
                     mostrarAlerta(`Arquivo "${file.name}" não é uma imagem válida.`, 'Arquivo Inválido', 'aviso');
                     return; // Pula este arquivo
                 }
                 if (file.size > 10 * 1024 * 1024) { // Limite de 10MB (ajustar conforme necessário)
                     mostrarAlerta(`Arquivo "${file.name}" é muito grande (máx 10MB).`, 'Arquivo Grande', 'aviso');
                     return; // Pula este arquivo
                 }

                 const reader = new FileReader();
                 reader.onload = async (e) => {
                     if (e.target && typeof e.target.result === 'string') {
                         await uploadImagem(e.target.result, tipo); // Envia base64 para upload
                     } else {
                         console.error("Erro ao ler arquivo, resultado inválido:", file.name);
                         mostrarAlerta(`Erro ao processar o arquivo ${file.name}.`, 'Erro Leitura', 'erro');
                     }
                 };
                 reader.onerror = (err) => {
                     console.error("Erro ao ler arquivo da galeria:", file.name, err);
                     mostrarAlerta(`Erro ao ler o arquivo ${file.name}. Tente novamente.`, 'Erro Leitura', 'erro');
                 }
                 reader.readAsDataURL(file); // Lê o arquivo como Base64
             });

             // Limpa o input para permitir selecionar os mesmos arquivos novamente
             event.target.value = '';
        }


        /**
         * Faz o upload de uma imagem (base64) para o backend ou armazena localmente se for novo registro.
         * @param {string} base64 Imagem em formato base64 data URL.
         * @param {'pre'|'pos'} tipo Tipo de formulário.
         */
        async function uploadImagem(base64, tipo) {
             // Adiciona um placeholder de loading no preview
             const tempId = `temp-${Date.now()}-${Math.random().toString(36).substring(2, 7)}`;
             adicionarImagemPreviewLoading(tempId, tipo);

             try {
                 const idManutencao = manutencaoAtual?.ID || document.getElementById(tipo === 'pre' ? 'pre-id' : 'pos-id').value;
                 const isEditing = !!idManutencao; // É edição se já existe um ID

                 // Se NÃO está editando (é um registro novo), armazena localmente
                 if (!isEditing) {
                     const imageData = {
                         url: base64, // Usa base64 como URL temporária
                         id: tempId,
                         timestamp: new Date().toISOString(),
                         isLocal: true // Marca como local para upload posterior
                     };
                     if (tipo === 'pre') {
                         imagenesPreUpload.push(imageData);
                     } else {
                         // Teoricamente, não deveria adicionar imagem PÓS em um registro novo, mas por segurança:
                         imagenesPosUpload.push(imageData);
                         console.warn("Imagem PÓS adicionada a um registro novo. Será salva junto com o registro PRE.");
                     }
                     // Remove o loading e adiciona o preview com a imagem base64
                     removerImagemPreviewLoading(tempId, tipo);
                     adicionarImagemPreview(base64, tipo, tempId); // Usa tempId como identificador
                     console.log("Imagem adicionada localmente (registro novo):", tempId);
                     return; // Não faz upload para o servidor ainda
                 }

                 // Se ESTÁ editando, faz o upload para o servidor imediatamente
                 console.log(`Iniciando upload para manutenção ID: ${idManutencao}, tipo: ${tipo}`);
                 const res = await apiRequest('uploadImagem', {
                     id: idManutencao, // ID da manutenção existente
                     imagem: base64,    // Imagem em base64
                     tipo: tipo         // 'pre' ou 'pos'
                 });

                 removerImagemPreviewLoading(tempId, tipo); // Remove loading

                 if (!res || !res.success || !res.url || !res.id) {
                     throw new Error(res.message || 'Falha no upload da imagem para o servidor.');
                 }

                 console.log("Upload concluído:", res);

                 // Adiciona à lista global correta com URL e ID do Drive
                 const imageData = { url: res.url, id: res.id, timestamp: res.timestamp || new Date().toISOString() };
                 if (tipo === 'pre') {
                     imagenesPreUpload.push(imageData);
                 } else {
                     imagenesPosUpload.push(imageData);
                 }

                 // Adiciona o preview com a imagem real do Drive
                 adicionarImagemPreview(res.url, tipo, res.id);

                 // **Importante:** Salva a manutenção novamente para atualizar a lista de imagens no backend
                 await salvarAposUploadImagem(idManutencao);


             } catch (e) {
                 removerImagemPreviewLoading(tempId, tipo); // Remove loading em caso de erro
                 console.error('Erro durante o upload ou processamento da imagem:', e);
                 mostrarAlerta('Erro ao fazer upload da imagem: ' + e.message, 'Erro Upload', 'erro');
             }
        }

        /**
         * Salva a manutenção atual no backend para persistir a lista de imagens atualizada
         * após um upload bem-sucedido durante a *edição*.
         * @param {string} idManutencao ID da manutenção a ser atualizada.
         */
        async function salvarAposUploadImagem(idManutencao) {
            if (!idManutencao || !manutencaoAtual || manutencaoAtual.ID !== idManutencao) {
                 console.warn("Não foi possível salvar após upload: ID ou manutenção atual inválidos.");
                 // Poderia tentar recarregar a manutenção, mas é mais seguro avisar.
                 mostrarAlerta("A imagem foi enviada, mas houve um problema ao atualizar o registro principal. Recarregue a página ou tente editar novamente.", "Aviso", "aviso");
                 return;
            }

            console.log("Atualizando manutenção após upload de imagem...");
            try {
                 // Cria um payload com os dados ATUAIS da manutenção, mas com as listas de imagens ATUALIZADAS
                 const dadosParaSalvar = { ...manutencaoAtual }; // Copia dados existentes
                 // Atualiza os arrays de imagens com os dados globais
                 dadosParaSalvar.Imagens_Pre = imagenesPreUpload.map(({ url, id, timestamp }) => ({ url, id, timestamp }));
                 dadosParaSalvar.Imagens_Pos = imagenesPosUpload.map(({ url, id, timestamp }) => ({ url, id, timestamp }));

                 // Remove campos que não devem ser enviados ou que são apenas de frontend
                 delete dadosParaSalvar.Checklist_Pre; // Exemplo, backend deve buscar checklist pelo ID
                 delete dadosParaSalvar.Checklist_Pos;

                 // Envia para salvar (atualizar)
                 const res = await apiRequest('salvarManutencao', {
                     dados: JSON.stringify({
                        id: idManutencao, // Garante o ID
                        imagensPre: dadosParaSalvar.Imagens_Pre, // Envia apenas os campos necessários
                        imagensPos: dadosParaSalvar.Imagens_Pos
                     }) // Envia apenas ID e arrays de imagens para atualização
                 });

                 if (!res || !res.success) {
                     throw new Error(res.message || "Erro ao atualizar o registro após upload de imagem.");
                 }
                 console.log("Manutenção atualizada com sucesso após upload.");

                 // Atualiza a 'manutencaoAtual' local com as novas listas de imagem
                 manutencaoAtual.Imagens_Pre = dadosParaSalvar.Imagens_Pre;
                 manutencaoAtual.Imagens_Pos = dadosParaSalvar.Imagens_Pos;

            } catch(error) {
                 console.error("Erro ao salvar manutenção após upload:", error);
                 mostrarAlerta("Erro ao atualizar o registro de imagens da manutenção: " + error.message, "Erro", "erro");
            }
        }

        /**
         * Adiciona um placeholder visual de loading para uma imagem sendo enviada.
         * @param {string} tempId ID temporário para identificar o placeholder.
         * @param {'pre'|'pos'} tipo Tipo de formulário.
         */
       function adicionarImagemPreviewLoading(tempId, tipo) {
           const container = document.getElementById(`imagens-preview-${tipo}`);
           if (!container) return;
           const loadingContainer = document.createElement('div');
           // Usa classes de container e loading
           loadingContainer.className = 'image-container image-loading text-center d-flex align-items-center justify-content-center border rounded me-2 mb-2';
           loadingContainer.style.width = '150px'; // Tamanho consistente
           loadingContainer.style.height = '150px';
           loadingContainer.dataset.tempId = tempId; // Guarda o ID temporário
           loadingContainer.innerHTML = `
               <div class="spinner-border text-primary" role="status" style="width: 2rem; height: 2rem;">
                   <span class="visually-hidden">Enviando...</span>
               </div>
           `;
           container.appendChild(loadingContainer);
       }

       /**
        * Remove o placeholder de loading de imagem.
        * @param {string} tempId ID temporário do placeholder a ser removido.
        * @param {'pre'|'pos'} tipo Tipo de formulário.
        */
       function removerImagemPreviewLoading(tempId, tipo) {
           const container = document.getElementById(`imagens-preview-${tipo}`);
           if (!container) return;
           // Seleciona pelo data attribute
           const loadingElement = container.querySelector(`.image-loading[data-temp-id="${tempId}"]`);
           if (loadingElement) {
               loadingElement.remove();
           }
       }

        /**
         * Adiciona um preview de imagem (com botões de deletar/anotar) a um container.
         * @param {string} src URL da imagem (pode ser base64 para previews locais).
         * @param {'pre'|'pos'} tipo Tipo de formulário.
         * @param {string} imageIdentifier ID da imagem no Drive ou ID temporário para base64.
         */
       function adicionarImagemPreview(src, tipo, imageIdentifier) {
            const containerId = `imagens-preview-${tipo}`;
            const container = document.getElementById(containerId);
            if (!container) {
                console.error("Container de preview não encontrado:", containerId);
                return;
            }

            const imgContainer = document.createElement('div');
            // Adiciona classe 'image-container' e outras classes Bootstrap para layout
            imgContainer.className = 'image-container position-relative d-inline-block me-2 mb-2';
            imgContainer.dataset.fileId = imageIdentifier; // Armazena o ID da imagem (Drive ou temp)

            const img = document.createElement('img');
            img.src = src; // URL ou base64
            img.alt = 'Preview da Imagem';
            img.className = 'img-thumbnail photo-preview-img'; // Classe para estilização e seleção
            img.style.cursor = 'pointer';
            img.loading = 'lazy'; // Melhora performance inicial
            // Abre imagem em nova aba ao clicar
            img.onclick = () => window.open(src, '_blank');

            // --- Botão Deletar ---
            const deleteBtn = document.createElement('button');
            deleteBtn.type = 'button'; // Evita submissão de formulário
            // Estilo Bootstrap para botão de fechar, posicionado absolutamente
            deleteBtn.className = 'btn-close delete-btn bg-danger p-1'; // Usa btn-close com fundo vermelho
            deleteBtn.style.position = 'absolute';
            deleteBtn.style.top = '5px';
            deleteBtn.style.right = '5px';
            deleteBtn.style.opacity = '0.85'; // Levemente transparente
            deleteBtn.setAttribute('aria-label', 'Remover Imagem');
            deleteBtn.title = 'Remover Imagem';

            deleteBtn.onclick = function(e) {
                e.stopPropagation(); // Evita abrir a imagem ao clicar no X
                const currentIdentifier = imgContainer.dataset.fileId;

                // Confirmação antes de excluir
                mostrarConfirmacao("Tem certeza que deseja remover esta imagem?", async () => {
                    // 1. Remover visualmente
                    imgContainer.remove();

                    // 2. Remover da lista global correspondente
                    let listaGlobal;
                    if (tipo === 'pre') {
                        listaGlobal = imagenesPreUpload;
                        imagenesPreUpload = listaGlobal.filter(imgData => (imgData.id || imgData.url) !== currentIdentifier);
                    } else {
                        listaGlobal = imagenesPosUpload;
                        imagenesPosUpload = listaGlobal.filter(imgData => (imgData.id || imgData.url) !== currentIdentifier);
                    }

                    // 3. Tentar excluir do Drive SE NÃO for uma imagem local (base64)
                    const imagemParaExcluir = listaGlobal.find(imgData => (imgData.id || imgData.url) === currentIdentifier);
                    // Verifica se NÃO é local (isLocal não é true) E se estamos editando
                    if (manutencaoAtual?.ID && (!imagemParaExcluir || !imagemParaExcluir.isLocal) ) {
                        console.log(`Tentando excluir imagem do Drive: ID=${currentIdentifier}`);
                        mostrarAlerta('Excluindo imagem do servidor...', 'Aguarde', 'aguarde');
                        try {
                             const resDelete = await apiRequest('excluirImagem', {
                                 idManutencao: manutencaoAtual.ID, // ID da manutenção
                                 idImagem: currentIdentifier,     // ID do arquivo da imagem
                                 tipo: tipo                       // 'pre' ou 'pos'
                             });
                             modals.alert.hide();
                             if (resDelete && resDelete.success) {
                                 console.log("Imagem excluída do Drive com sucesso:", currentIdentifier);
                                 // Atualiza a manutenção no backend para refletir a exclusão
                                 await salvarAposUploadImagem(manutencaoAtual.ID); // Reutiliza função para salvar
                             } else {
                                 throw new Error(resDelete.message || "Erro ao excluir imagem do servidor.");
                             }
                        } catch (deleteError) {
                             modals.alert.hide();
                             console.error("Erro ao excluir imagem do Drive:", deleteError);
                             mostrarAlerta(`Não foi possível excluir a imagem do servidor: ${deleteError.message}. A imagem foi removida apenas visualmente.`, "Erro Exclusão", "erro");
                             // Opcional: Adicionar a imagem de volta ao preview se a exclusão falhar?
                        }
                    } else {
                        console.log("Imagem removida apenas localmente (registro novo ou base64).");
                        // Se for registro novo, a imagem (base64) simplesmente não será enviada.
                    }
                });
            };

            // --- Botão Anotar (se ImageAnnotator estiver disponível) ---
            if (typeof ImageAnnotator !== 'undefined' && anotadorImagem) {
                const btnAnnotate = document.createElement('button');
                btnAnnotate.type = 'button';
                // Estilo Bootstrap para botão de ação, posicionado
                btnAnnotate.className = 'btn btn-sm btn-info btn-annotate p-1';
                btnAnnotate.style.position = 'absolute';
                btnAnnotate.style.top = '5px';
                btnAnnotate.style.left = '5px'; // Canto superior esquerdo
                btnAnnotate.style.opacity = '0.85';
                btnAnnotate.innerHTML = '<i class="bi bi-pencil-fill"></i>'; // Ícone de lápis
                btnAnnotate.title = 'Anotar imagem';
                // Guarda dados necessários para a função de anotar
                btnAnnotate.dataset.imgSrc = src; // URL atual (pode ser base64 ou Drive)
                btnAnnotate.dataset.originalId = imageIdentifier; // ID original (Drive ou temp)

                btnAnnotate.addEventListener('click', (e) => {
                    e.stopPropagation(); // Evita abrir imagem
                    // Só permite anotar se estiver editando uma manutenção existente
                    if (!manutencaoAtual || !manutencaoAtual.ID) {
                        mostrarAlerta("Salve a manutenção primeiro para poder anotar imagens.", "Aviso", "aviso");
                        return;
                    }
                    // Abre o editor de anotação passando o contexto
                    abrirEditorAnotacao(src, tipo, imgContainer);
                });
                imgContainer.appendChild(btnAnnotate); // Adiciona botão de anotar
            }

           // Adiciona a imagem e o botão de deletar ao container
           imgContainer.appendChild(img);
           imgContainer.appendChild(deleteBtn);
           // Adiciona o container da imagem ao container principal de previews
           container.appendChild(imgContainer);
       }


        // --- Funções de Anotação de Imagem ---

        /**
         * Abre o modal de anotação com a imagem selecionada.
         * @param {string} imgSrc URL da imagem a ser anotada.
         * @param {'pre'|'pos'} tipo Tipo de formulário.
         * @param {HTMLElement} containerElement O elemento div.image-container da imagem clicada.
         */
       function abrirEditorAnotacao(imgSrc, tipo, containerElement) {
            if (!anotadorImagem) {
                mostrarAlerta("Ferramenta de anotação não inicializada.", "Erro Interno", "erro");
                return;
            }
            if (!manutencaoAtual || !manutencaoAtual.ID) {
                mostrarAlerta("É necessário estar editando uma manutenção salva para anotar imagens.", "Aviso", "aviso");
                return;
            }

            mostrarAlerta('Carregando imagem para anotação...', 'Aguarde', 'aguarde');
            anotadorImagem.loadImage(imgSrc).then(() => {
                // Guarda o contexto necessário para salvar a anotação depois
                anotadorImagem.contextoTipo = tipo; // 'pre' ou 'pos'
                anotadorImagem.contextoContainer = containerElement; // O div .image-container
                anotadorImagem.contextoIdOriginal = containerElement.dataset.fileId; // ID original (Drive ou temp)

                modals.alert.hide();
                modals.anotacao.show(); // Mostra o modal de anotação
            }).catch(err => {
                modals.alert.hide();
                console.error('Erro ao carregar imagem para anotação:', err);
                mostrarAlerta('Erro ao carregar a imagem para anotação. Tente novamente.', 'Erro', 'erro');
            });
       }

       /**
        * Configura o listener para o botão de salvar anotação no modal.
        */
        function configurarSalvamentoAnotacao() {
             const btnSalvar = document.getElementById('btn-save-annotation');
             if (btnSalvar && anotadorImagem) {
                 btnSalvar.addEventListener('click', async () => {
                     // Captura a imagem com as anotações como base64
                     const annotatedImageBase64 = anotadorImagem.captureImage();

                     // Recupera o contexto salvo ao abrir o editor
                     const tipoImagem = anotadorImagem.contextoTipo;
                     const imageContainerElement = anotadorImagem.contextoContainer;
                     const idOriginal = anotadorImagem.contextoIdOriginal; // ID da imagem que foi anotada

                     if (!tipoImagem || !imageContainerElement || !idOriginal || !manutencaoAtual?.ID) {
                         console.error("Contexto de anotação inválido ou manutenção não definida.");
                         mostrarAlerta("Erro interno ao tentar salvar anotação. Contexto perdido.", "Erro", "erro");
                         return;
                     }

                     modals.anotacao.hide(); // Fecha o modal de anotação
                     mostrarAlerta('Salvando imagem anotada...', 'Aguarde', 'aguarde');

                     try {
                         const idManutencao = manutencaoAtual.ID;

                         // Faz upload da *nova* imagem (anotada) para o backend
                         // Passa o ID original para que o backend possa substituir/excluir o arquivo antigo no Drive
                         const resUpload = await apiRequest('uploadImagem', {
                             id: idManutencao,
                             imagem: annotatedImageBase64,      // Nova imagem base64
                             tipo: tipoImagem,                  // 'pre' ou 'pos'
                             idOriginalParaSubstituir: idOriginal // ID do arquivo a ser substituído
                         });

                         if (!resUpload || !resUpload.success || !resUpload.url || !resUpload.id) {
                             throw new Error(resUpload.message || "Falha no upload da imagem anotada.");
                         }

                         modals.alert.hide(); // Esconde "Aguarde"

                         // --- Atualizar Interface ---
                         // Atualiza o preview na tela com a nova imagem anotada
                         const imgElementPreview = imageContainerElement.querySelector('img');
                         if (imgElementPreview) {
                             imgElementPreview.src = resUpload.url; // Nova URL do Drive
                             // Atualiza o dataset do botão de anotar para permitir anotar novamente a nova imagem
                             const btnAnnotatePreview = imageContainerElement.querySelector('.btn-annotate');
                             if (btnAnnotatePreview) {
                                 btnAnnotatePreview.dataset.imgSrc = resUpload.url;
                                 btnAnnotatePreview.dataset.originalId = resUpload.id; // Atualiza ID original
                             }
                         }
                         // Atualiza o ID do container da imagem
                         imageContainerElement.dataset.fileId = resUpload.id;

                         // --- Atualizar Lista Global ---
                         // Encontra e substitui a imagem antiga pela nova na lista global
                         const listaUploads = tipoImagem === 'pre' ? imagenesPreUpload : imagenesPosUpload;
                         const indexOriginal = listaUploads.findIndex(img => img.id === idOriginal);

                         const novaImageData = {
                             url: resUpload.url,
                             id: resUpload.id,
                             timestamp: resUpload.timestamp || new Date().toISOString()
                         };

                         if (indexOriginal > -1) {
                             listaUploads[indexOriginal] = novaImageData; // Substitui
                         } else {
                             // Se não encontrou a original (improvável), apenas adiciona a nova
                             listaUploads.push(novaImageData);
                             console.warn("Imagem original não encontrada na lista global ao salvar anotação. Nova imagem adicionada.");
                         }

                         // --- Persistir no Backend ---
                         // Salva a manutenção novamente para atualizar o array de imagens no backend
                         await salvarAposAnotacao(idManutencao);

                         mostrarAlerta('Anotação salva e imagem atualizada com sucesso!', 'Sucesso', 'sucesso');


                     } catch (error) {
                         modals.alert.hide();
                         console.error("Erro ao salvar imagem anotada:", error);
                         mostrarAlerta(`Erro ao salvar anotação: ${error.message}`, 'Erro', 'erro');
                     }
                 });
             } else {
                 console.warn("Botão de salvar anotação ou instância do anotador não encontrados.");
             }
        }

        /**
         * Função auxiliar para salvar a manutenção DEPOIS de anotar uma imagem.
         * Garante que a lista de imagens (com a nova imagem anotada) seja salva no backend.
         * @param {string} idManutencao ID da manutenção.
         */
        async function salvarAposAnotacao(idManutencao) {
             if (!idManutencao || !manutencaoAtual || manutencaoAtual.ID !== idManutencao) {
                 console.warn("Não foi possível salvar após anotação: ID ou manutenção atual inválidos.");
                 mostrarAlerta("A anotação foi processada, mas houve um problema ao atualizar o registro principal. Recarregue ou edite novamente.", "Aviso", "aviso");
                 return;
             }
             console.log("Atualizando manutenção após anotação de imagem...");
             try {
                  // Pega as listas globais ATUALIZADAS
                  const imagensPreAtualizadas = imagenesPreUpload.map(({ url, id, timestamp }) => ({ url, id, timestamp }));
                  const imagensPosAtualizadas = imagenesPosUpload.map(({ url, id, timestamp }) => ({ url, id, timestamp }));

                  // Envia para salvar (atualizar APENAS os arrays de imagens)
                  const res = await apiRequest('salvarManutencao', {
                      dados: JSON.stringify({
                         id: idManutencao,               // ID da manutenção
                         imagensPre: imagensPreAtualizadas, // Novo array PRE
                         imagensPos: imagensPosAtualizadas  // Novo array POS
                      })
                  });

                  if (!res || !res.success) {
                      throw new Error(res.message || "Erro ao atualizar o registro após anotação.");
                  }
                  console.log("Manutenção atualizada com sucesso após anotação.");

                  // Atualiza a 'manutencaoAtual' local para refletir a mudança
                  manutencaoAtual.Imagens_Pre = imagensPreAtualizadas;
                  manutencaoAtual.Imagens_Pos = imagensPosAtualizadas;

             } catch(error) {
                  console.error("Erro ao salvar manutenção após anotação:", error);
                  mostrarAlerta("Erro ao salvar a atualização das imagens no registro: " + error.message, "Erro", "erro");
             }
        }


        // --- Funções de Ferramentas e Configuração ---

        /**
         * Carrega os dados atuais das configurações na tela de Ferramentas.
         */
        async function carregarDadosFerramentas() {
             mostrarAlerta('Carregando configurações...', 'Aguarde', 'aguarde');
             try {
                 // Versão do sistema (busca do backend ou usa constante)
                 const versaoSistemaSpan = document.getElementById('versao-sistema');
                 if (versaoSistemaSpan) {
                    // Tenta buscar do backend, se falhar usa a constante JS
                    const resVersao = await apiRequest('obterVersaoApp');
                    versaoSistemaSpan.textContent = (resVersao && resVersao.success && resVersao.versao) ? resVersao.versao : VERSAO_APP;
                 }


                 // Busca outras configurações
                 const res = await apiRequest('obterConfiguracoes'); // Função backend para buscar todas as configs

                 if (res && res.success && res.configuracoes) {
                     const configs = res.configuracoes;
                     // Preenche campos com valores da configuração
                     const idPlanilhaInput = document.getElementById('id-planilha-turnos');
                     const emailsTextarea = document.getElementById('emails-notificacao');
                     const integracaoSwitch = document.getElementById('integracao-automatica');

                     if(idPlanilhaInput) idPlanilhaInput.value = configs['ID_PLANILHA_TURNOS'] || '';
                     if(emailsTextarea) emailsTextarea.value = configs['EMAILS_NOTIFICACAO'] || '';
                     if(integracaoSwitch) integracaoSwitch.checked = configs['INTEGRACAO_AUTOMATICA'] === 'SIM';

                     modals.alert.hide(); // Esconde "Aguarde" só depois de preencher tudo
                 } else {
                     modals.alert.hide();
                     mostrarAlerta('Não foi possível carregar as configurações do servidor. ' + (res?.message || ''), 'Aviso');
                 }
             } catch (error) {
                 modals.alert.hide();
                 console.error('Erro ao carregar dados de ferramentas:', error);
                 mostrarAlerta(`Erro ao carregar configurações: ${error.message}`, 'Erro', 'erro');
             }
        }

        /**
         * Salva uma configuração específica no backend.
         * @param {string} chave Nome da chave de configuração.
         * @param {string} valor Valor da configuração.
         * @param {string} [mensagemSucesso] Mensagem a ser exibida em caso de sucesso.
         */
        async function salvarConfiguracao(chave, valor, mensagemSucesso) {
            mostrarAlerta(`Salvando configuração (${chave})...`, 'Aguarde', 'aguarde');
            try {
                const res = await apiRequest('salvarConfiguracao', { chave: chave, valor: valor });
                modals.alert.hide();

                if (res && res.success) {
                    if (mensagemSucesso) {
                        mostrarAlerta(mensagemSucesso, 'Sucesso', 'sucesso');
                    } else {
                         console.log(`Configuração "${chave}" salva com sucesso.`);
                    }
                } else {
                    throw new Error(res.message || `Erro ao salvar configuração "${chave}"`);
                }
                return true; // Indica sucesso
            } catch (error) {
                modals.alert.hide();
                console.error(`Erro ao salvar configuração ${chave}:`, error);
                mostrarAlerta(`Erro ao salvar configuração: ${error.message}`, 'Erro', 'erro');
                return false; // Indica falha
            }
        }


        // --- Funções de Geração de Relatórios (Chamadas) ---

        /**
         * Chama a função backend para gerar um PDF básico e abre o link retornado.
         * @param {string} id ID da manutenção.
         */
        async function gerarRelatorioTextoParaPdf(id) {
             if (!id) return;
             mostrarAlerta('Gerando PDF básico...', 'Aguarde', 'aguarde');
             try {
                 const res = await apiRequest('gerarPDFTextoBackend', { id: id });
                 modals.alert.hide();

                 if (res && res.success && res.url) {
                     window.open(res.url, '_blank'); // Abre o PDF gerado (link do Drive)
                     mostrarAlerta('PDF Básico gerado com sucesso! Verifique a nova aba.', 'Sucesso', 'sucesso');
                 } else {
                     throw new Error(res.message || 'Não foi possível gerar o link do PDF.');
                 }
             } catch (error) {
                 modals.alert.hide();
                 console.error("Erro ao gerar PDF básico:", error);
                 mostrarAlerta(`Erro ao gerar PDF básico: ${error.message}`, 'Erro', 'erro');
             }
        }

        /**
         * Chama a função backend para gerar relatórios avançados (PDF, Excel, CSV) e abre o link.
         * @param {string} id ID da manutenção.
         * @param {'pdf'|'excel'|'csv'} formato Formato desejado.
         */
        async function gerarRelatorioAvancadoCliente(id, formato) {
             if (!id) return;
             const formatoUpper = formato.toUpperCase();
             mostrarAlerta(`Gerando relatório ${formatoUpper}...`, 'Aguarde', 'aguarde');

             try {
                 const res = await apiRequest('gerarRelatorioAvancado', {
                     id: id,
                     formato: formato,
                     opcoes: JSON.stringify({ incluirImagens: true }) // Exemplo de opção
                 });
                 modals.alert.hide();

                 if (!res || !res.success) {
                     throw new Error(res.message || `Erro ao gerar relatório ${formatoUpper}`);
                 }

                 // Abrir relatório em nova aba (URL do Drive)
                 if (res.url) {
                     window.open(res.url, '_blank');
                     mostrarAlerta(`Relatório ${formatoUpper} gerado! Verifique a nova aba ou seu Google Drive.`, 'Sucesso', 'sucesso');
                 } else {
                     // Se não retornou URL, pode ter salvo apenas no Drive
                     mostrarAlerta(`Relatório ${formatoUpper} gerado no Google Drive (nenhum link de visualização retornado).`, 'Sucesso', 'sucesso');
                 }

             } catch (error) {
                 modals.alert.hide();
                 console.error(`Erro ao gerar relatório ${formatoUpper}:`, error);
                 mostrarAlerta(`Erro ao gerar relatório ${formatoUpper}: ${error.message}`, 'Erro', 'erro');
             }
        }


        // --- Funções Utilitárias ---

        /**
         * Retorna a classe CSS correspondente ao status da manutenção.
         * @param {string} status Status da manutenção.
         * @returns {string} Classe CSS do Bootstrap (ex: 'status-aguardando').
         */
        function getStatusClass(status) {
            switch (status) {
                case STATUS_AGUARDANDO: return 'status-aguardando';
                case STATUS_EM_MANUTENCAO: return 'status-em-manutencao';
                case STATUS_CONCLUIDO: return 'status-concluido';
                case STATUS_DISPONIVEL: return 'status-disponivel';
                default: return 'bg-secondary text-white'; // Cinza para status desconhecido
            }
        }

        /**
         * Formata uma data (string ISO ou Date) para o formato DD/MM/YYYY.
         * @param {string|Date} dateString Data a ser formatada.
         * @returns {string} Data formatada ou 'Data inválida'.
         */
        function formatarData(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                 // Verifica se a data é válida (não é NaN)
                if (isNaN(date.getTime())) return 'Data inválida';

                const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
                return date.toLocaleDateString('pt-BR', options);
            } catch (e) {
                console.error("Erro ao formatar data:", dateString, e);
                return 'Erro data';
            }
        }

        /**
         * Formata uma data (string ISO ou Date) para o formato DD/MM/YYYY HH:MM.
         * @param {string|Date} dateString Data a ser formatada.
         * @returns {string} Data e hora formatada ou 'Data inválida'.
         */
        function formatarDataHora(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return 'Data inválida';

                const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
                return date.toLocaleTimeString('pt-BR', options); // Usa toLocaleTimeString que inclui data e hora
            } catch (e) {
                console.error("Erro ao formatar data/hora:", dateString, e);
                return 'Erro data/hora';
            }
        }


        // --- Inicialização e Event Listeners Principais ---
        document.addEventListener('DOMContentLoaded', () => {
            // Carregar dados iniciais essenciais
            carregarDadosIniciais();

            // --- Navegação Principal ---
            document.getElementById('nav-dashboard')?.addEventListener('click', e => { e.preventDefault(); mostrarTela('dashboard'); });
            document.getElementById('nav-lista')?.addEventListener('click', e => { e.preventDefault(); mostrarTela('lista'); });
            document.getElementById('nav-ferramentas')?.addEventListener('click', e => { e.preventDefault(); mostrarTela('ferramentas'); });

            // Botão "Nova Manutenção" na Navegação e na Lista
            const setupNovoForm = () => {
                 // Limpar formulário pré completo
                const formPre = document.getElementById('form-pre-manutencao');
                if (formPre) formPre.reset(); // Reseta valores dos campos

                // Limpar campos específicos e estado
                document.getElementById('pre-id').value = '';
                document.getElementById('pre-placa').value = '';
                document.getElementById('pre-modelo').value = '';
                document.getElementById('motivo-outro-container').style.display = 'none';
                document.getElementById('pre-motivo-outro').value = '';
                 document.getElementById('pre-motivo-outro').required = false;
                document.getElementById('imagens-preview-pre').innerHTML = '';
                document.getElementById('pre-placa-select').innerHTML = '<option value="">Selecione o Equipamento...</option>';
                document.getElementById('pre-placa-select').style.display = 'none';
                 document.getElementById('pre-placa-select').required = false;
                document.getElementById('pre-placa-outro-valor').style.display = 'none';
                document.getElementById('pre-placa-outro-valor').value = '';
                 document.getElementById('pre-placa-outro-valor').required = false;


                imagenesPreUpload = []; // Limpa array de imagens
                imagenesPosUpload = []; // Limpa array pós também (segurança)
                manutencaoAtual = null; // Garante que não há manutenção atual ao criar nova

                // Resetar radios do checklist pré
                const checklistPreContainer = document.getElementById('pre-checklist-container');
                checklistPreContainer?.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);

                // Resetar selects para "Selecione..." (índice 0)
                document.getElementById('pre-tipo-equipamento').selectedIndex = 0;
                document.getElementById('pre-categoria-problema').selectedIndex = 0;
                document.getElementById('pre-urgencia').selectedIndex = 0;

                // Fecha qualquer interface de câmera aberta
                fecharCamera('pre');
                fecharCamera('pos');

                mostrarTela('preManu'); // Mostra o formulário limpo
            };

            document.getElementById('nav-novo')?.addEventListener('click', e => {
                e.preventDefault();
                setupNovoForm();
            });
            document.getElementById('btn-nova-manutencao')?.addEventListener('click', setupNovoForm);


            // --- Botões Voltar ---
            document.querySelectorAll('.btn-voltar').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Decide para qual tela voltar (lista é o padrão)
                    // Se estiver na tela Pós, o botão "Voltar para Pré" tem seu próprio listener
                    mostrarTela('lista');
                    // Limpa manutenção atual ao voltar para lista
                    manutencaoAtual = null;
                    // Fecha câmeras ao voltar
                    fecharCamera('pre');
                    fecharCamera('pos');
                });
            });

            // Botão Voltar para Pré (na tela Pós)
            document.getElementById('btn-voltar-pre')?.addEventListener('click', () => {
                const id = document.getElementById('pos-id').value;
                if (id && manutencaoAtual && manutencaoAtual.ID === id) {
                     // Recarrega os dados da manutenção atual na tela PRE
                     editarManutencao(id);
                 } else {
                     // Se não tiver ID ou manutencaoAtual, volta para lista (mais seguro)
                     console.warn("Tentando voltar para pré sem ID ou dados. Voltando para lista.");
                     mostrarTela('lista');
                 }
                 fecharCamera('pos'); // Fecha câmera pós ao voltar
            });


            // --- Botões de Ação na Visualização ---
            document.getElementById('btn-editar-manutencao')?.addEventListener('click', () => {
                if (manutencaoAtual && manutencaoAtual.ID) {
                    editarManutencao(manutencaoAtual.ID);
                } else {
                    mostrarAlerta("Nenhuma manutenção selecionada para editar.", "Aviso", "aviso");
                    mostrarTela('lista'); // Volta para lista se não houver nada para editar
                }
            });

            // Botões de Atualização de Status na Visualização
            document.querySelectorAll('#tela-visualizacao .btn-status').forEach(btn => {
                btn.addEventListener('click', async function() {
                     if (!manutencaoAtual || !manutencaoAtual.ID) {
                         mostrarAlerta("Nenhuma manutenção selecionada para atualizar status.", "Aviso", "aviso");
                         return;
                     }

                     const novoStatus = this.dataset.status;
                     const statusAtual = manutencaoAtual.Status;

                     if (statusAtual === novoStatus) {
                         // Já está no status desejado, apenas informa
                         // mostrarAlerta(`A manutenção já está com o status "${novoStatus}".`, "Informação");
                         return; // Não faz nada
                     }

                     // Confirmação
                     mostrarConfirmacao(`Deseja realmente alterar o status de "${statusAtual}" para "${novoStatus}"?`, async () => {
                         mostrarAlerta('Atualizando status...', 'Aguarde', 'aguarde');
                         try {
                             const res = await apiRequest('atualizarStatusManutencao', {
                                 id: manutencaoAtual.ID,
                                 status: novoStatus
                             });

                             if (!res || !res.success) {
                                 throw new Error(res.message || 'Erro desconhecido ao atualizar status');
                             }

                             modals.alert.hide(); // Esconde "Aguarde"
                             mostrarAlerta('Status atualizado com sucesso!', 'Sucesso', 'sucesso');

                             // Atualiza a visualização com os dados atualizados
                             // Poderia apenas atualizar o status localmente, mas recarregar garante consistência
                             await visualizarManutencao(manutencaoAtual.ID);

                         } catch (error) {
                              modals.alert.hide(); // Garante que esconde o "Aguarde" em erro
                              console.error(`Erro ao atualizar status para ${novoStatus}:`, error);
                              mostrarAlerta(`Erro ao atualizar status: ${error.message}`, 'Erro', 'erro');
                         }
                     });
                });
            });


            // --- Botões de Relatórios na Visualização ---
            document.getElementById('btn-gerar-pdf-basico')?.addEventListener('click', function(e) {
                e.preventDefault();
                if (manutencaoAtual && manutencaoAtual.ID) {
                     gerarRelatorioTextoParaPdf(manutencaoAtual.ID);
                } else { mostrarAlerta("Selecione uma manutenção para gerar o relatório.", "Aviso", "aviso"); }
            });
            document.getElementById('btn-gerar-pdf-avancado')?.addEventListener('click', function(e) {
                e.preventDefault();
                if (manutencaoAtual && manutencaoAtual.ID) {
                    gerarRelatorioAvancadoCliente(manutencaoAtual.ID, 'pdf');
                } else { mostrarAlerta("Selecione uma manutenção para gerar o relatório.", "Aviso", "aviso"); }
            });
            document.getElementById('btn-gerar-excel')?.addEventListener('click', function(e) {
                e.preventDefault();
                if (manutencaoAtual && manutencaoAtual.ID) {
                    gerarRelatorioAvancadoCliente(manutencaoAtual.ID, 'excel');
                } else { mostrarAlerta("Selecione uma manutenção para gerar o relatório.", "Aviso", "aviso"); }
            });
            document.getElementById('btn-gerar-csv')?.addEventListener('click', function(e) {
                e.preventDefault();
                if (manutencaoAtual && manutencaoAtual.ID) {
                    gerarRelatorioAvancadoCliente(manutencaoAtual.ID, 'csv');
                } else { mostrarAlerta("Selecione uma manutenção para gerar o relatório.", "Aviso", "aviso"); }
            });


            // --- Filtros da Lista ---
            document.getElementById('btn-filtrar')?.addEventListener('click', () => {
                carregarListaManutencoes(); // Recarrega a lista aplicando os filtros
            });
            document.getElementById('btn-limpar-filtro')?.addEventListener('click', () => {
                document.getElementById('filtro-status').value = '';
                document.getElementById('filtro-placa').value = '';
                carregarListaManutencoes(); // Recarrega a lista sem filtros
            });
            // Permitir filtrar pressionando Enter no campo de placa
            document.getElementById('filtro-placa')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    carregarListaManutencoes();
                }
            });


            // --- Lógica dos Selects Dinâmicos (já configurada em configurarSelectsEquipamentos) ---


            // --- Listener para Categoria 'Outro' ---
            document.getElementById('pre-categoria-problema')?.addEventListener('change', function() {
                const motivoOutroContainer = document.getElementById('motivo-outro-container');
                const motivoOutroInput = document.getElementById('pre-motivo-outro');
                if (this.value === 'Outro') {
                    motivoOutroContainer.style.display = 'block';
                    motivoOutroInput.required = true;
                    motivoOutroInput.focus();
                } else {
                    motivoOutroContainer.style.display = 'none';
                    motivoOutroInput.required = false;
                    motivoOutroInput.value = ''; // Limpa o campo ao esconder
                }
            });


            // --- Submit Formulário Pré-Manutenção ---
            document.getElementById('form-pre-manutencao')?.addEventListener('submit', async function(e) {
                 e.preventDefault();
                 mostrarAlerta('Salvando registro pré-manutenção...', 'Aguarde', 'aguarde');

                 // Obter dados do formulário, incluindo checklist e imagens (locais ou não)
                 const dados = obterDadosFormulario('form-pre-manutencao');

                 // --- Validações Essenciais ---
                 if (!dados.tipoEquipamento) {
                     modals.alert.hide();
                     mostrarAlerta('Selecione o Tipo de Equipamento.', 'Campo Obrigatório', 'aviso');
                      document.getElementById('pre-tipo-equipamento')?.focus();
                     return;
                 }
                 if (!dados.placa) {
                     modals.alert.hide();
                     mostrarAlerta('Selecione ou informe o Equipamento/Placa.', 'Campo Obrigatório', 'aviso');
                     // Tenta focar no campo relevante
                     const outroInput = document.getElementById('pre-placa-outro-valor');
                     const placaSelect = document.getElementById('pre-placa-select');
                     if (outroInput && outroInput.style.display !== 'none') {
                         outroInput.focus();
                     } else if (placaSelect) {
                         placaSelect.focus();
                     }
                     return;
                 }
                 if (!dados.categoriaProblema) {
                     modals.alert.hide();
                     mostrarAlerta('Selecione a Categoria do Problema.', 'Campo Obrigatório', 'aviso');
                     document.getElementById('pre-categoria-problema')?.focus();
                     return;
                 }
                 if (!dados.urgencia) {
                      modals.alert.hide();
                      mostrarAlerta('Selecione a Urgência.', 'Campo Obrigatório', 'aviso');
                      document.getElementById('pre-urgencia')?.focus();
                      return;
                 }
                  if (!dados.descricaoProblema) {
                      modals.alert.hide();
                      mostrarAlerta('Descreva o Problema encontrado.', 'Campo Obrigatório', 'aviso');
                      document.getElementById('pre-descricao-problema')?.focus();
                      return;
                  }
                   if (!dados.responsavel) {
                       modals.alert.hide();
                       mostrarAlerta('Informe o Nome do Responsável.', 'Campo Obrigatório', 'aviso');
                       document.getElementById('pre-responsavel')?.focus();
                       return;
                   }

                 try {
                     // Montar objeto para salvar
                     const payload = {
                         id: dados.id || null, // Envia ID se for edição, null se for novo
                         placa: dados.placa,
                         modelo: dados.modelo,
                         tipoEquipamento: dados.tipoEquipamento,
                         categoriaProblema: dados.categoriaProblema,
                         urgencia: dados.urgencia,
                         motivoOutro: dados.motivoOutro,
                         descricaoProblema: dados.descricaoProblema,
                         checklistPre: dados.checklistPre,
                         observacoesPre: dados.observacoesPre,
                         // Envia TODAS as imagens pré (incluindo as locais com base64)
                         // O backend decidirá se faz upload ou usa as existentes
                         imagensPre: imagenesPreUpload,
                         responsavel: dados.responsavel,
                         // Define status inicial APENAS se for novo registro
                         status: dados.id ? undefined : STATUS_AGUARDANDO, // Não envia status se for edição
                         // Se for edição, inclui dados POS existentes para não perdê-los
                         checklistPos: dados.id ? (manutencaoAtual?.Checklist_Pos || {}) : undefined,
                         observacoesPos: dados.id ? (manutencaoAtual?.Observacoes_Pos || '') : undefined,
                         imagensPos: dados.id ? (manutencaoAtual?.Imagens_Pos || []) : undefined,
                         dataManutencao: dados.id ? (manutencaoAtual?.Data_Manutencao || null) : null,
                     };

                     // Salvar/Atualizar manutenção no backend
                     const res = await apiRequest('salvarManutencao', {
                         dados: JSON.stringify(payload) // Envia payload completo
                     });

                     modals.alert.hide(); // Esconde "Aguarde"

                     if (!res || !res.success || !res.id) { // Espera um ID de volta
                         throw new Error(res.message || 'Erro desconhecido ao salvar. ID não retornado.');
                     }

                     const savedId = res.id; // ID da manutenção salva/atualizada
                     manutencaoAtual = res.manutencao || null; // Atualiza a manutenção atual com dados retornados (se houver)

                     // --- Modal de Escolha Pós-Salvamento ---
                     document.getElementById('btn-choice-lista').onclick = () => {
                         modals.choice.hide();
                         mostrarTela('lista');
                     };
                     document.getElementById('btn-choice-novo').onclick = () => {
                         modals.choice.hide();
                         setupNovoForm(); // Limpa e prepara para novo registro
                     };
                     document.getElementById('btn-choice-pos').onclick = async () => {
                         modals.choice.hide();
                         // Carrega os dados da manutenção recém-salva/atualizada na tela Pós
                         await carregarParaPosManutencao(savedId);
                     };

                     modals.choice.show(); // Mostra opções ao usuário

                 } catch (error) {
                     modals.alert.hide();
                     console.error("Erro ao salvar formulário pré:", error);
                     mostrarAlerta(`Erro ao salvar: ${error.message}`, 'Erro Salvar', 'erro');
                 }
            });


            // --- Submit Formulário Pós-Manutenção ---
            document.getElementById('form-pos-manutencao')?.addEventListener('submit', async function(e) {
                 e.preventDefault();
                 mostrarAlerta('Finalizando manutenção...', 'Aguarde', 'aguarde');

                 const id = document.getElementById('pos-id').value;
                 if (!id || !manutencaoAtual || manutencaoAtual.ID !== id) {
                     modals.alert.hide();
                     mostrarAlerta('ID da manutenção ou dados atuais inválidos. Não é possível finalizar. Volte para a lista e tente novamente.', 'Erro Crítico', 'erro');
                     mostrarTela('lista'); // Volta para lista por segurança
                     return;
                 }

                 // Obter dados APENAS do formulário PÓS
                 const dadosPos = obterDadosFormulario('form-pos-manutencao');

                 try {
                     // Montar objeto final para salvar, combinando dados PRE existentes com os novos dados PÓS
                     const dadosParaSalvar = {
                         id: id, // Garante o ID correto
                         // Mantém dados PRE e gerais da 'manutencaoAtual'
                         placa: manutencaoAtual.Placa,
                         modelo: manutencaoAtual.Modelo,
                         tipoEquipamento: manutencaoAtual.Tipo_Equipamento,
                         categoriaProblema: manutencaoAtual.Categoria_Problema,
                         urgencia: manutencaoAtual.Urgencia,
                         motivoOutro: manutencaoAtual.Motivo_Outro,
                         descricaoProblema: manutencaoAtual.Descricao_Problema,
                         checklistPre: manutencaoAtual.Checklist_Pre,
                         observacoesPre: manutencaoAtual.Observacoes_Pre,
                         imagensPre: manutencaoAtual.Imagens_Pre, // Usa imagens pré já existentes
                         responsavel: manutencaoAtual.Responsavel,
                         dataCriacao: manutencaoAtual.Data_Criacao, // Mantém data de criação
                         // Adiciona/Atualiza dados PÓS
                         dataManutencao: new Date().toISOString(), // Data atual para conclusão
                         checklistPos: dadosPos.checklistPos,
                         observacoesPos: dadosPos.observacoesPos,
                         // Envia imagens PÓS (backend trata upload/links)
                         imagensPos: imagenesPosUpload, // Usa array global atualizado
                         status: STATUS_CONCLUIDO // Define como concluído ao finalizar
                     };

                     // Salvar atualização final no backend
                     const res = await apiRequest('salvarManutencao', {
                         dados: JSON.stringify(dadosParaSalvar)
                     });

                     modals.alert.hide(); // Esconde "Aguarde"

                     if (!res || !res.success) {
                         throw new Error(res.message || 'Erro desconhecido ao finalizar');
                     }

                     mostrarAlerta('Manutenção finalizada com sucesso!', 'Sucesso', 'sucesso');
                     manutencaoAtual = null; // Limpa manutenção atual
                     mostrarTela('lista'); // Voltar para a lista

                 } catch (error) {
                     modals.alert.hide();
                     console.error("Erro ao finalizar manutenção:", error);
                     mostrarAlerta(`Erro ao finalizar: ${error.message}`, 'Erro Finalizar', 'erro');
                 }
            });


            // --- Listeners para Câmera e Galeria ---
            // Pré-Manutenção
            document.getElementById('btn-abrir-camera-pre')?.addEventListener('click', () => abrirCamera('pre'));
            document.getElementById('btn-fechar-camera-pre')?.addEventListener('click', () => fecharCamera('pre'));
            document.getElementById('btn-capturar-pre')?.addEventListener('click', () => capturarImagem('pre'));
            document.getElementById('btn-selecionar-imagem-pre')?.addEventListener('click', () => {
                document.getElementById('input-imagem-pre')?.click(); // Abre seletor de arquivo
            });
            document.getElementById('input-imagem-pre')?.addEventListener('change', (e) => processarGaleria(e, 'pre'));

            // Pós-Manutenção
            document.getElementById('btn-abrir-camera-pos')?.addEventListener('click', () => abrirCamera('pos'));
            document.getElementById('btn-fechar-camera-pos')?.addEventListener('click', () => fecharCamera('pos'));
            document.getElementById('btn-capturar-pos')?.addEventListener('click', () => capturarImagem('pos'));
            document.getElementById('btn-selecionar-imagem-pos')?.addEventListener('click', () => {
                document.getElementById('input-imagem-pos')?.click(); // Abre seletor de arquivo
            });
            document.getElementById('input-imagem-pos')?.addEventListener('change', (e) => processarGaleria(e, 'pos'));


            // --- Listeners da Tela de Ferramentas ---
            // Executar Integração Planilha
            document.getElementById('btn-executar-integracao')?.addEventListener('click', async function() {
                 const idPlanilhaInput = document.getElementById('id-planilha-turnos');
                 const idPlanilha = idPlanilhaInput?.value.trim();
                 if (!idPlanilha) {
                     mostrarAlerta('Por favor, informe o ID da planilha de turnos.', 'Aviso', 'aviso');
                     idPlanilhaInput?.focus();
                     return;
                 }
                 // Salva o ID antes de executar
                 const saved = await salvarConfiguracao('ID_PLANILHA_TURNOS', idPlanilha);
                 if (!saved) return; // Não continua se falhou ao salvar

                 mostrarAlerta('Executando integração com planilha de turnos...', 'Aguarde', 'aguarde');
                 try {
                     const res = await apiRequest('integrarComPlanilhaTurnos', { idPlanilha: idPlanilha });
                     modals.alert.hide();
                     if (res && res.success) {
                         mostrarAlerta(res.message || 'Integração concluída com sucesso!', 'Sucesso', 'sucesso');
                     } else {
                         throw new Error(res.message || 'Erro desconhecido na integração');
                     }
                 } catch (error) {
                     modals.alert.hide();
                     console.error('Erro ao executar integração:', error);
                     mostrarAlerta(`Erro na integração: ${error.message}`, 'Erro', 'erro');
                 }
            });

            // Salvar E-mails
            document.getElementById('btn-salvar-emails')?.addEventListener('click', async function() {
                 const emails = document.getElementById('emails-notificacao')?.value.trim() || '';
                 await salvarConfiguracao('EMAILS_NOTIFICACAO', emails, 'Configuração de e-mails salva com sucesso!');
            });

            // Switch Integração Automática
            document.getElementById('integracao-automatica')?.addEventListener('change', async function() {
                 const valor = this.checked ? 'SIM' : 'NAO';
                 await salvarConfiguracao('INTEGRACAO_AUTOMATICA', valor, `Integração automática ${this.checked ? 'ativada' : 'desativada'}. Lembre-se de (Re)Configurar as Tarefas Automáticas para aplicar.`);
                 // Reverte visualmente se falhar (a função salvarConfiguracao já mostra o erro)
                 // if (!success) this.checked = !this.checked;
            });

            // Enviar E-mail de Teste
            document.getElementById('btn-teste-email')?.addEventListener('click', async function() {
                const emailsTextarea = document.getElementById('emails-notificacao');
                const emails = emailsTextarea?.value.trim();
                if (!emails) {
                    mostrarAlerta('Informe e salve os e-mails para notificação antes de testar.', 'Aviso', 'aviso');
                    emailsTextarea?.focus();
                    return;
                }
                const tipoEmail = document.getElementById('tipo-email-teste')?.value || 'nova';
                const emailList = emails.split(/[,;\s]+/).map(e => e.trim()).filter(e => e && e.includes('@'));
                if (emailList.length === 0) {
                    mostrarAlerta('Nenhum e-mail válido encontrado para o teste.', 'Aviso', 'aviso');
                    return;
                }

                 mostrarAlerta('Buscando uma manutenção para usar no teste...', 'Aguarde', 'aguarde');
                 try {
                    // Busca a primeira manutenção da lista (ou qualquer uma)
                    const resLista = await apiRequest('listarManutencoes', { limite: 1 });
                    if (!resLista || !resLista.success || !resLista.manutencoes || resLista.manutencoes.length === 0) {
                         modals.alert.hide();
                         mostrarAlerta('Nenhuma manutenção encontrada para usar no e-mail de teste. Crie uma primeiro.', 'Aviso', 'aviso');
                         return;
                    }
                    const idManutencaoTeste = resLista.manutencoes[0].ID;

                    modals.alert.hide(); // Esconde busca
                    mostrarAlerta(`Enviando e-mail de teste (${tipoEmail}) para ${emailList.join(', ')}...`, 'Aguarde', 'aguarde');

                    const resEnvio = await apiRequest('enviarEmailNotificacao', {
                        id: idManutencaoTeste,
                        destinatarios: JSON.stringify(emailList), // Envia lista como JSON
                        tipo: tipoEmail
                    });
                    modals.alert.hide();

                    if (resEnvio && resEnvio.success) {
                        mostrarAlerta(`E-mail de teste (${tipoEmail}) enviado com sucesso! Verifique a caixa de entrada de: ${emailList.join(', ')}`, 'Sucesso', 'sucesso');
                    } else {
                        throw new Error(resEnvio.message || 'Erro desconhecido ao enviar e-mail');
                    }
                } catch (error) {
                    modals.alert.hide();
                    console.error('Erro no processo de envio de e-mail de teste:', error);
                    mostrarAlerta(`Erro ao enviar e-mail de teste: ${error.message}`, 'Erro', 'erro');
                }
            });

            // Configurar Gatilhos Automáticos
            document.getElementById('btn-configurar-gatilhos')?.addEventListener('click', async function() {
                mostrarConfirmacao("Isso irá configurar ou reconfigurar as tarefas automáticas (como integração diária) no servidor. Deseja continuar?", async () => {
                     mostrarAlerta('Configurando tarefas automáticas do sistema...', 'Aguarde', 'aguarde');
                     try {
                         const res = await apiRequest('configurarGatilhoAutomatico'); // Chama função no backend
                         modals.alert.hide();
                         if (res && res.success) {
                             mostrarAlerta(res.message || 'Tarefas automáticas configuradas com sucesso!', 'Sucesso', 'sucesso');
                         } else {
                             throw new Error(res.message || 'Erro ao configurar tarefas automáticas');
                         }
                     } catch (error) {
                         modals.alert.hide();
                         console.error('Erro ao configurar gatilhos:', error);
                         mostrarAlerta(`Erro na configuração das tarefas: ${error.message}`, 'Erro', 'erro');
                     }
                 });
            });

            // Verificar Atualizações (Simples)
            document.getElementById('btn-verificar-atualizacoes')?.addEventListener('click', async function() {
                mostrarAlerta('Verificando versão...', 'Aguarde', 'aguarde');
                try {
                    const resVersao = await apiRequest('obterVersaoApp');
                    const versaoServidor = (resVersao && resVersao.success && resVersao.versao) ? resVersao.versao : 'N/A';
                    const versaoLocal = VERSAO_APP; // Constante definida no início do script
                    modals.alert.hide();
                    if (versaoServidor === 'N/A') {
                        mostrarAlerta(`Versão local: ${versaoLocal}. Não foi possível verificar a versão do servidor.`, 'Informação');
                    } else if (versaoServidor === versaoLocal) {
                         mostrarAlerta(`Você está usando a versão mais recente: ${versaoLocal}`, 'Atualizado', 'sucesso');
                    } else {
                         mostrarAlerta(`Nova versão disponível: ${versaoServidor} (Você está usando: ${versaoLocal}). Considere atualizar.`, 'Atualização', 'info');
                    }
                } catch (error) {
                    modals.alert.hide();
                     mostrarAlerta(`Não foi possível verificar atualizações: ${error.message}`, 'Erro', 'erro');
                }
            });


            // --- Filtro de Período do Gráfico ---
            document.getElementById('filtro-periodo-grafico')?.addEventListener('change', function() {
                 carregarGraficoPeriodo(); // Recarrega o gráfico com o novo período selecionado
            });


            // --- Inicialização do Anotador (se a classe existir) ---
             if (typeof ImageAnnotator !== 'undefined') {
                 anotadorImagem = new ImageAnnotator('annotation-container');
                 configurarSalvamentoAnotacao(); // Configura o botão de salvar do modal
             } else {
                 console.warn("Classe ImageAnnotator não definida. Funcionalidade de anotação desabilitada.");
                 // Opcional: Esconder botões de anotar nas imagens
                 // document.querySelectorAll('.btn-annotate').forEach(btn => btn.style.display = 'none');
             }

        }); // Fim DOMContentLoaded


         /**
          * Carrega os dados da manutenção na tela Pós. Chamada após salvar/editar Pré.
          * @param {string} id ID da manutenção.
          */
         async function carregarParaPosManutencao(id) {
             if (!id) {
                 mostrarAlerta("ID inválido para carregar pós-manutenção.", "Erro Interno", "erro");
                 mostrarTela('lista');
                 return;
             }
             mostrarAlerta('Carregando dados para pós-manutenção...', 'Aguarde', 'aguarde');
             try {
                 // Busca os dados mais recentes da manutenção
                 const resLoad = await apiRequest('obterManutencao', { id: id });
                 if (!resLoad.success || !resLoad.manutencao) {
                     throw new Error(resLoad.message || "Erro ao recarregar dados para pós-manutenção.");
                 }
                 manutencaoAtual = resLoad.manutencao; // Atualiza dados globais

                 modals.alert.hide(); // Esconde "Aguarde"

                 // --- Preencher Formulário Pós ---
                 document.getElementById('pos-id').value = id;
                 document.getElementById('pos-placa-display').textContent = manutencaoAtual.Placa || 'N/A';
                 document.getElementById('pos-tipo-display').textContent = manutencaoAtual.Tipo_Equipamento || 'N/A';

                 // Limpa e preenche campos PÓS
                 document.getElementById('pos-observacoes').value = manutencaoAtual.Observacoes_Pos || '';
                 document.getElementById('imagens-preview-pos').innerHTML = '';
                 imagenesPosUpload = Array.isArray(manutencaoAtual.Imagens_Pos) ? [...manutencaoAtual.Imagens_Pos] : [];
                 imagenesPosUpload.forEach(img => adicionarImagemPreview(img.url, 'pos', img.id)); // Adiciona imagens PÓS existentes

                 // Preenche checklist PÓS
                 const checklistPosContainer = document.getElementById('pos-checklist-container');
                 checklistPosContainer.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false); // Limpa radios
                 const checklistPosData = manutencaoAtual.Checklist_Pos || {};
                 Object.entries(checklistPosData).forEach(([item, valor]) => {
                     const radioToCheck = checklistPosContainer.querySelector(`input[type="radio"][data-item="${CSS.escape(item)}"][value="${CSS.escape(valor)}"]`);
                     if (radioToCheck) radioToCheck.checked = true;
                 });

                 mostrarTela('posManu'); // Mostra a tela Pós

             } catch (loadError) {
                 modals.alert.hide();
                 console.error("Erro ao carregar para pós-manutenção:", loadError);
                 mostrarAlerta(loadError.message, "Erro Carregar Pós", "erro");
                 mostrarTela('lista'); // Volta pra lista em caso de erro
             }
         }

    </script>
</body>
</html>
